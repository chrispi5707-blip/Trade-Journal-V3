<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade Journal</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=JetBrains+Mono:wght@600;700&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0e17;color:#e0e6ed;font-family:'IBM Plex Sans',-apple-system,sans-serif;font-size:13px}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none}
input[type=number]{-moz-appearance:textfield}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#0a0e17}::-webkit-scrollbar-thumb{background:#1e2d3d;border-radius:3px}
select{background:#1a2435;border:1px solid #1e2d3d;border-radius:6px;padding:6px 10px;color:#e0e6ed;font-size:12px;outline:none}
.tip{position:relative;display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:#1e2d3d;color:#6b7a8d;font-size:8px;cursor:help;margin-left:4px;flex-shrink:0}
.tip:hover::after{content:attr(data-t);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#1a2435;border:1px solid #1e2d3d;color:#e0e6ed;padding:6px 10px;border-radius:6px;font-size:10px;white-space:normal;width:220px;z-index:9000;line-height:1.4;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,.5)}
.tip:hover::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:#1e2d3d;z-index:9001}
</style>
</head><body>
<div id="root"></div>
<script>
try{
var h=React.createElement,us=React.useState,ue=React.useEffect,uc=React.useCallback,ur=React.useRef,um=React.useMemo;
// === DATA MODEL ===
var E={id:"",date:"",time:"",exitTime:"",direction:"L",type:"Rev",ticker:"TSLA",mode:"live",timeframe:"3m",
entry:"",stop:"",exit:"",shares:"",mfePrice:"",maePrice:"",maeTiming:"",
adxAtEntry:"",cloudThickness:"",cloudDirection:"",rsiAtEntry:"",rsiAtPeak:"",
divBefore:"",divDuring:"",
tradeNumOfDay:"",sessionRead:"",confidence:"",emotion:"calm",emotionDuring:"",emotionAfter:"",followedRules:"",
screenshotUrl:"",screenshotData:"",
hasPartial:"",partialExitPrice:"",partialPct:"",
trailTimeframe:"",trailStopPrice:"",trendEndPrice:"",
rules:{ultHL:"",lhHL:"",chanBreak:"",chanRetest:"",candleOff10:"",secondCandle:"",macdCross:"",cloudAlign:"",rsiExtreme:"",cloud15m:""},
stopMgmt:{initStop:"",stopChan:"",trailHL:"",trailFailHL:"",stopMoved:"",reentry:""},
exitType:"",rsiAtExit:"",volAtExit:"",notes:""};
var RL={ultHL:"Ultimate H/L",lhHL:"LH / HL",chanBreak:"Chan Break",chanRetest:"Chan Retest",candleOff10:"1st Candle 10EMA",secondCandle:"2nd Candle Entry",macdCross:"MACD Cross",cloudAlign:"Cloud Align",rsiExtreme:"RSI Extreme",cloud15m:"15m Cloud"};
var DIVS=[{v:"",l:"None"},{v:"bull",l:"Bullish",c:"#2ed573"},{v:"bear",l:"Bearish",c:"#ff4757"}];
var SL={initStop:"Init Stop HL",stopChan:"Stop\u2192Chan",trailHL:"Trail H/L",trailFailHL:"Trail Failed H/L",stopMoved:"Stop Moved",reentry:"Re-entry"};
var RK=Object.keys(RL);
var TFS=["1m","3m","5m","15m","1h","2h","4h","1D","1W"];
var EMOTIONS=["calm","eager","fomo","frustrated","revenge","bored"];
var EMOTIONS_DURING=["calm","confident","anxious","impatient","greedy","panicked"];
var EMOTIONS_AFTER=["satisfied","relieved","frustrated","regret","revenge","neutral"];
var TRAIL_TFS=["1m","3m","5m","same"];
var PARTIAL_PCTS=["25","33","50","75"];
var SESSIONS=["trending","ranging","choppy","breakout","reversal"];
var K={bg:"#0a0e17",cd:"#0f1923",bd:"#1e2d3d",g:"#2ed573",r:"#ff4757",go:"#ffa502",cy:"#1e90ff",pu:"#a855f7",tx:"#e0e6ed",dm:"#6b7a8d",inp:"#1a2435"};
// === UTILS ===
function gid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}
function dc(o){return JSON.parse(JSON.stringify(o))}
function cPL(t){if(!t.entry||!t.exit||!t.shares)return{pl:0,pp:0,rm:0};var e=+t.entry,x=+t.exit,s=+t.stop,sh=+t.shares;var pl=t.direction==="L"?(x-e)*sh:(e-x)*sh;var rk=Math.abs(e-s);return{pl:pl,pp:t.direction==="L"?(x-e)/e:(e-x)/e,rm:rk>0?(t.direction==="L"?(x-e)/rk:(e-x)/rk):0}}
function cMFE(t){if(!t.entry||!t.mfePrice)return null;var e=+t.entry,m=+t.mfePrice,x=t.exit?+t.exit:null;var md=t.direction==="L"?m-e:e-m;var ed=x?(t.direction==="L"?x-e:e-x):null;return{md:md,cp:ed!==null&&md>0?ed/md:null}}
function cMAE(t){if(!t.entry||!t.maePrice)return null;return{md:t.direction==="L"?+t.entry-+t.maePrice:+t.maePrice-+t.entry}}
function cDur(t){if(!t.time||!t.exitTime)return null;function tm(s){var p=s.split(":");return parseInt(p[0])*60+parseInt(p[1]||0)}var d=tm(t.exitTime)-tm(t.time);if(d<=0)return null;return{m:d,l:Math.floor(d/60)>0?Math.floor(d/60)+"h "+d%60+"m":d%60+"m"}}
function gs(a){if(!a.length)return{n:0,wr:0,ar:0,ap:0,tp:0};var r=a.map(cPL),w=r.filter(function(x){return x.pl>0});return{n:a.length,wr:w.length/a.length,ar:r.reduce(function(s,x){return s+x.rm},0)/a.length,ap:r.reduce(function(s,x){return s+x.pl},0)/a.length,tp:r.reduce(function(s,x){return s+x.pl},0)}}
function ruleCount(t){var c=0;RK.forEach(function(k){if(t.rules&&t.rules[k]==="Y")c++});return c}
// System session read from avg ADX + cloud width for a day
function sysSession(dayTrades){
var adxs=dayTrades.filter(function(t){return t.adxAtEntry}).map(function(t){return+t.adxAtEntry});
var cws=dayTrades.filter(function(t){return t.cloudThickness}).map(function(t){return+t.cloudThickness});
if(!adxs.length&&!cws.length)return"unknown";
var avgAdx=adxs.length?adxs.reduce(function(a,b){return a+b},0)/adxs.length:null;
var avgCw=cws.length?cws.reduce(function(a,b){return a+b},0)/cws.length:null;
if(avgAdx!==null&&avgAdx<18&&avgCw!==null&&avgCw<0.15)return"ranging";
if(avgAdx!==null&&avgAdx<20)return"choppy";
if(avgAdx!==null&&avgAdx>=25)return"trending";
return"choppy"}
// === COMPONENTS ===
function Pl(p){return h("div",{style:{display:"flex",gap:2,background:K.bg,borderRadius:6,padding:2,flexWrap:"wrap"}},p.options.map(function(o){return h("button",{key:o.v,onClick:function(){p.onChange(o.v)},style:{padding:"5px 10px",borderRadius:5,border:"none",fontSize:12,fontWeight:600,cursor:"pointer",background:p.v===o.v?(o.c||K.cy):"transparent",color:p.v===o.v?"#fff":K.dm,transition:"all .15s"}},o.l)}))}
function YN(p){return h(Pl,{v:p.v,onChange:p.onChange,options:[{v:"Y",l:"Y",c:K.g},{v:"N",l:"N",c:K.r},{v:"",l:"-",c:K.dm}]})}
function Ip(p){return h("input",{type:p.type||"text",value:p.value||"",onChange:function(e){p.onChange(e.target.value)},placeholder:p.placeholder,step:p.step,style:Object.assign({background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"7px 10px",color:K.tx,fontSize:13,width:"100%",outline:"none"},p.style||{})})}
function SC(p){return h("div",{style:{background:K.cd,border:"1px solid "+K.bd,borderRadius:8,padding:"10px 14px",flex:1,minWidth:100}},h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},p.label),h("div",{style:{fontSize:18,fontWeight:700,color:p.color||K.tx,fontFamily:"JetBrains Mono,monospace"}},p.value),p.sub?h("div",{style:{fontSize:10,color:K.dm,marginTop:2}},p.sub):null)}
function Sel(p){return h("select",{value:p.value||"",onChange:function(e){p.onChange(e.target.value)},style:Object.assign({background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"6px 10px",color:K.tx,fontSize:12,width:"100%",outline:"none"},p.style||{})},p.options.map(function(o){return h("option",{key:o.v,value:o.v},o.l)}))}
// Mini bar for bucket display
function Bar(p){return h("div",{style:{height:4,background:K.bd,borderRadius:2,marginTop:4,overflow:"hidden"}},h("div",{style:{height:"100%",width:Math.max(p.pct,1)+"%",background:p.color||K.g,borderRadius:2}}))}
function Tip(p){return h("span",{className:"tip","data-t":p.t},"\u24d8")}
function Tip(p){return h("span",{className:"tip","data-t":p.t},"\u24D8")}
// === APP STATE ===
function App(){
var _t=us(function(){try{return JSON.parse(localStorage.getItem("tj5")||"[]")}catch(e){return[]}});
var trades=_t[0],setTr=_t[1];
var _v=us("log"),vw=_v[0],setVw=_v[1];
var _e=us(null),et=_e[0],setEt=_e[1];
var _sf=us(false),sf=_sf[0],setSf=_sf[1];
var _lb=us(null),lb=_lb[0],setLb=_lb[1];
var _fd=us("ALL"),fd=_fd[0],sFd=_fd[1];
var _ft=us("ALL"),ft=_ft[0],sFt=_ft[1];
var _fk=us("ALL"),fk=_fk[0],sFk=_fk[1];
var _qm=us(false),qm=_qm[0],sQm=_qm[1];
var _sort=us("date_desc"),sortBy=_sort[0],setSort=_sort[1];
var _md=us("live"),md=_md[0],sMd=_md[1];
var _plPeriod=us("daily"),plP=_plPeriod[0],sPlP=_plPeriod[1];
var _plAdj=us({}),plAdj=_plAdj[0],sPlAdj=_plAdj[1];
var fr=ur(null),ir=ur(null);
ue(function(){try{localStorage.setItem("tj5",JSON.stringify(trades))}catch(e){}},[trades]);

function mkN(){var t=dc(E);t.id=gid();var today=new Date().toISOString().slice(0,10);t.date=today;t.mode=md==="all"?"live":md;var todayCount=trades.filter(function(tr){return tr.date===today&&(tr.mode||"live")===(md==="all"?"live":md)}).length;t.tradeNumOfDay=String(todayCount+1);return t}
function oN(){setEt(mkN());setSf(true);sQm(false)}
function oQ(){setEt(mkN());setSf(true);sQm(true)}
function oE(t){var c=dc(t);c.rules=Object.assign(dc(E.rules),c.rules||{});c.stopMgmt=Object.assign(dc(E.stopMgmt),c.stopMgmt||{});
["rsiAtEntry","rsiAtPeak","tradeNumOfDay","sessionRead","confidence","emotion","emotionDuring","emotionAfter","followedRules","timeframe","maeTiming","divBefore","divDuring","cloudDirection","hasPartial","partialExitPrice","partialPct","trailTimeframe","trailStopPrice","trendEndPrice"].forEach(function(k){if(c[k]===undefined)c[k]=E[k]});
if(!c.stopMgmt.trailFailHL)c.stopMgmt.trailFailHL="";setEt(c);setSf(true);sQm(false)}
function sv(){if(!et)return;setTr(function(p){var i=-1;for(var j=0;j<p.length;j++)if(p[j].id===et.id){i=j;break}if(i>=0){var n=p.slice();n[i]=et;return n}return p.concat([et])});setSf(false);setEt(null)}
function dl(id){if(confirm("Delete?")){setTr(function(p){return p.filter(function(t){return t.id!==id})})}}
function hF(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){setEt(function(p){var c=dc(p);c.screenshotData=ev.target.result;return c})};r.readAsDataURL(f)}
var hD=uc(function(e){e.preventDefault();var f=e.dataTransfer.files[0];if(!f||!f.type.startsWith("image/"))return;var r=new FileReader();r.onload=function(ev){setEt(function(p){var c=dc(p);c.screenshotData=ev.target.result;return c})};r.readAsDataURL(f)},[]);

// FILTERED DATA
var mf=um(function(){if(md==="all")return trades;return trades.filter(function(t){return(t.mode||"live")===md})},[trades,md]);
var fl=um(function(){return mf.filter(function(t){if(fd!=="ALL"&&t.direction!==fd)return false;if(ft!=="ALL"&&t.type!==ft)return false;if(fk!=="ALL"&&t.ticker!==fk)return false;return true}).sort(function(a,b){
var pa=cPL(a),pb=cPL(b);
if(sortBy==="date_desc")return(b.date+b.time).localeCompare(a.date+a.time);
if(sortBy==="date_asc")return(a.date+a.time).localeCompare(b.date+b.time);
if(sortBy==="pl_best")return pb.pl-pa.pl;
if(sortBy==="pl_worst")return pa.pl-pb.pl;
if(sortBy==="r_best")return pb.rm-pa.rm;
if(sortBy==="r_worst")return pa.rm-pb.rm;
if(sortBy==="trade_num_asc")return(+a.tradeNumOfDay||0)-(+b.tradeNumOfDay||0);
if(sortBy==="trade_num_desc")return(+b.tradeNumOfDay||0)-(+a.tradeNumOfDay||0);
if(sortBy==="wins")return(pb.pl>0?1:0)-(pa.pl>0?1:0);
if(sortBy==="losses")return(pa.pl<0?1:0)-(pb.pl<0?1:0);
return(b.date+b.time).localeCompare(a.date+a.time)})},[mf,fd,ft,fk,sortBy]);
var tks=um(function(){var s={};mf.forEach(function(t){if(t.ticker)s[t.ticker]=1});return Object.keys(s)},[mf]);
var cp=um(function(){return mf.filter(function(t){return t.entry&&t.exit&&t.shares})},[mf]);
// === STATS ENGINE ===
var st=um(function(){
var t=fl.filter(function(x){return x.entry&&x.exit&&x.shares});if(!t.length)return null;
var rs=t.map(function(x){var p=cPL(x);return{pl:p.pl,rm:p.rm,mfe:cMFE(x),dur:cDur(x)}});
var w=rs.filter(function(r){return r.pl>0}),l=rs.filter(function(r){return r.pl<0});
var ds=rs.map(function(r){return r.dur}).filter(Boolean);
var cs=rs.map(function(r){return r.mfe&&r.mfe.cp}).filter(function(c){return c!=null});
return{n:rs.length,w:w.length,l:l.length,wr:w.length/rs.length,
tp:rs.reduce(function(s,r){return s+r.pl},0),
aw:w.length?w.reduce(function(s,r){return s+r.pl},0)/w.length:0,
al:l.length?l.reduce(function(s,r){return s+r.pl},0)/l.length:0,
ar:rs.reduce(function(s,r){return s+r.rm},0)/rs.length,
pf:l.length?Math.abs(w.reduce(function(s,r){return s+r.pl},0)/l.reduce(function(s,r){return s+r.pl},0)):w.length?999:0,
ad:ds.length?ds.reduce(function(s,d){return s+d.m},0)/ds.length:null,
ac:cs.length?cs.reduce(function(s,c){return s+c},0)/cs.length:null}},[fl]);
// === RULE ANALYSIS ENGINE ===
var ra=um(function(){if(!cp.length)return{yn:[],num:[],combos:[],minRule:[],corr:[],scores:[],cond:[]};
// Y/N edge for setup rules
var yn=RK.map(function(k){var wi=cp.filter(function(t){return t.rules[k]==="Y"}),wo=cp.filter(function(t){return t.rules[k]==="N"});return{key:k,label:RL[k],w:gs(wi),wo:gs(wo),edge:gs(wi).wr-gs(wo).wr}});
// Stop mgmt rules
Object.keys(SL).forEach(function(k){var wi=cp.filter(function(t){return t.stopMgmt&&t.stopMgmt[k]==="Y"}),wo=cp.filter(function(t){return t.stopMgmt&&t.stopMgmt[k]==="N"});if(wi.length+wo.length>=2)yn.push({key:"sm_"+k,label:"Stop: "+SL[k],w:gs(wi),wo:gs(wo),edge:gs(wi).wr-gs(wo).wr})});
// Followed rules
var fr=cp.filter(function(t){return t.followedRules==="Y"}),fn=cp.filter(function(t){return t.followedRules==="N"});
if(fr.length+fn.length>=2)yn.push({key:"followedRules",label:"\u2605 Followed Rules",w:gs(fr),wo:gs(fn),edge:gs(fr).wr-gs(fn).wr});
yn.sort(function(a,b){return Math.abs(b.edge)-Math.abs(a.edge)});

// Numeric buckets
var num=[];
var at=cp.filter(function(t){return t.adxAtEntry});
if(at.length>=3)num.push({label:"ADX at Entry",bk:[{l:"< 20",s:gs(at.filter(function(t){return+t.adxAtEntry<20}))},{l:"20-25",s:gs(at.filter(function(t){var v=+t.adxAtEntry;return v>=20&&v<25}))},{l:"25+",s:gs(at.filter(function(t){return+t.adxAtEntry>=25}))}]});
var ct=cp.filter(function(t){return t.cloudThickness});
if(ct.length>=3)num.push({label:"Cloud Width %",bk:[{l:"< 0.15%",s:gs(ct.filter(function(t){return+t.cloudThickness<0.15}))},{l:"0.15-0.35%",s:gs(ct.filter(function(t){var v=+t.cloudThickness;return v>=0.15&&v<0.35}))},{l:"0.35%+",s:gs(ct.filter(function(t){return+t.cloudThickness>=0.35}))}]});
var re=cp.filter(function(t){return t.rsiAtEntry});
if(re.length>=3){num.push({label:"RSI at Entry",bk:[{l:"< 30",s:gs(re.filter(function(t){return+t.rsiAtEntry<30}))},{l:"30-50",s:gs(re.filter(function(t){var v=+t.rsiAtEntry;return v>=30&&v<50}))},{l:"50-70",s:gs(re.filter(function(t){var v=+t.rsiAtEntry;return v>=50&&v<70}))},{l:"70+",s:gs(re.filter(function(t){return+t.rsiAtEntry>=70}))}]});
var lo=re.filter(function(t){return t.direction==="L"}),sh=re.filter(function(t){return t.direction==="S"});
if(lo.length>=3)num.push({label:"RSI Entry (Longs)",bk:[{l:"< 30",s:gs(lo.filter(function(t){return+t.rsiAtEntry<30}))},{l:"30-50",s:gs(lo.filter(function(t){var v=+t.rsiAtEntry;return v>=30&&v<50}))},{l:"50+",s:gs(lo.filter(function(t){return+t.rsiAtEntry>=50}))}]});
if(sh.length>=3)num.push({label:"RSI Entry (Shorts)",bk:[{l:"< 50",s:gs(sh.filter(function(t){return+t.rsiAtEntry<50}))},{l:"50-70",s:gs(sh.filter(function(t){var v=+t.rsiAtEntry;return v>=50&&v<70}))},{l:"70+",s:gs(sh.filter(function(t){return+t.rsiAtEntry>=70}))}]})}
var rp=cp.filter(function(t){return t.rsiAtPeak});
if(rp.length>=3)num.push({label:"RSI at Peak (MFE)",bk:[{l:"< 65",s:gs(rp.filter(function(t){return+t.rsiAtPeak<65}))},{l:"65-75",s:gs(rp.filter(function(t){var v=+t.rsiAtPeak;return v>=65&&v<75}))},{l:"75-85",s:gs(rp.filter(function(t){var v=+t.rsiAtPeak;return v>=75&&v<85}))},{l:"85+",s:gs(rp.filter(function(t){return+t.rsiAtPeak>=85}))}]});
var ve=cp.filter(function(t){return t.volAtExit});
if(ve.length>=3)num.push({label:"Volume at Exit",bk:[{l:"Below",s:gs(ve.filter(function(t){return t.volAtExit==="B"}))},{l:"At Avg",s:gs(ve.filter(function(t){return t.volAtExit==="A"}))},{l:"Above",s:gs(ve.filter(function(t){return t.volAtExit==="H"}))}]});
// Divergence Before Entry
var db=cp.filter(function(t){return t.divBefore});
if(db.length>=3){var dbDir={};db.forEach(function(t){var k=t.divBefore+(t.direction==="L"?" (Long)":" (Short)");if(!dbDir[k])dbDir[k]=[];dbDir[k].push(t)});num.push({label:"Div Before Entry",bk:Object.keys(dbDir).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(dbDir[k])}})})}
// Divergence During Trade
var dd=cp.filter(function(t){return t.divDuring});
if(dd.length>=3){var ddDir={};dd.forEach(function(t){var aligned=(t.direction==="L"&&t.divDuring==="bull")||(t.direction==="S"&&t.divDuring==="bear");var k=t.divDuring+(aligned?" (aligned)":" (against)");if(!ddDir[k])ddDir[k]=[];ddDir[k].push(t)});num.push({label:"Div During Trade",bk:Object.keys(ddDir).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(ddDir[k])}})})}
// MAE Timing
var mt=cp.filter(function(t){return t.maeTiming});
if(mt.length>=3)num.push({label:"MAE Timing",bk:[{l:"Dip First",s:gs(mt.filter(function(t){return t.maeTiming==="dip1st"}))},{l:"Run First",s:gs(mt.filter(function(t){return t.maeTiming==="run1st"}))}]});
var dt=cp.filter(function(t){return cDur(t)});
if(dt.length>=3)num.push({label:"Duration",bk:[{l:"< 10m",s:gs(dt.filter(function(t){return cDur(t).m<10}))},{l:"10-30m",s:gs(dt.filter(function(t){var m=cDur(t).m;return m>=10&&m<30}))},{l:"30m+",s:gs(dt.filter(function(t){return cDur(t).m>=30}))}]});
// Timeframe buckets
var tf=cp.filter(function(t){return t.timeframe});
if(tf.length>=3){var tfBk={};tf.forEach(function(t){if(!tfBk[t.timeframe])tfBk[t.timeframe]=[];tfBk[t.timeframe].push(t)});var bks=Object.keys(tfBk).map(function(k){return{l:k,s:gs(tfBk[k])}});if(bks.length>=2)num.push({label:"Timeframe",bk:bks})}
// Trade # of day
var tn=cp.filter(function(t){return t.tradeNumOfDay});
if(tn.length>=3)num.push({label:"Trade # of Day",bk:[{l:"#1-2",s:gs(tn.filter(function(t){return+t.tradeNumOfDay<=2}))},{l:"#3-4",s:gs(tn.filter(function(t){var v=+t.tradeNumOfDay;return v>=3&&v<=4}))},{l:"#5+",s:gs(tn.filter(function(t){return+t.tradeNumOfDay>=5}))}]});
// Confidence
var cf=cp.filter(function(t){return t.confidence});
if(cf.length>=3)num.push({label:"Confidence",bk:[{l:"1-2 (Low)",s:gs(cf.filter(function(t){return+t.confidence<=2}))},{l:"3 (Med)",s:gs(cf.filter(function(t){return+t.confidence===3}))},{l:"4-5 (High)",s:gs(cf.filter(function(t){return+t.confidence>=4}))}]});
// Emotion
var em=cp.filter(function(t){return t.emotion&&t.emotion!=="calm"});
if(em.length>=2){var emBk={};cp.filter(function(t){return t.emotion}).forEach(function(t){var e=t.emotion;if(!emBk[e])emBk[e]=[];emBk[e].push(t)});var eBks=Object.keys(emBk).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(emBk[k])}});num.push({label:"Emotional State",bk:eBks})}
// Session read
var sr=cp.filter(function(t){return t.sessionRead});
if(sr.length>=3){var srBk={};sr.forEach(function(t){var s=t.sessionRead;if(!srBk[s])srBk[s]=[];srBk[s].push(t)});num.push({label:"Session Read (Yours)",bk:Object.keys(srBk).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(srBk[k])}})})}
// System session vs your read
var dayMap={};cp.forEach(function(t){if(!dayMap[t.date])dayMap[t.date]=[];dayMap[t.date].push(t)});
var matchTrades=[],mismatchTrades=[];
cp.filter(function(t){return t.sessionRead}).forEach(function(t){var sys=sysSession(dayMap[t.date]||[]);if(sys==="unknown")return;if(t.sessionRead===sys)matchTrades.push(t);else mismatchTrades.push(t)});
if(matchTrades.length+mismatchTrades.length>=3)num.push({label:"Your Read vs System",bk:[{l:"Match",s:gs(matchTrades)},{l:"Mismatch",s:gs(mismatchTrades)}]});

// === COMBO ANALYSIS (top 2, 3, 4, 5 rule combos) ===
var combos=[];
if(cp.length>=5){
var activeRules=RK.filter(function(k){return cp.filter(function(t){return t.rules[k]==="Y"}).length>=2});
// 2-rule combos
for(var i=0;i<activeRules.length;i++){for(var j=i+1;j<activeRules.length;j++){
var both=cp.filter(function(t){return t.rules[activeRules[i]]==="Y"&&t.rules[activeRules[j]]==="Y"});
if(both.length>=3){var s=gs(both);combos.push({rules:[RL[activeRules[i]],RL[activeRules[j]]],stats:s,count:2})}}}
// 3-rule combos (only from top 6 rules by edge)
var topRules=activeRules.slice().sort(function(a,b){var ae=Math.abs(yn.find(function(r){return r.key===a})||{edge:0}).edge||0;var be=Math.abs(yn.find(function(r){return r.key===b})||{edge:0}).edge||0;return be-ae}).slice(0,6);
for(var i=0;i<topRules.length;i++){for(var j=i+1;j<topRules.length;j++){for(var k=j+1;k<topRules.length;k++){
var tri=cp.filter(function(t){return t.rules[topRules[i]]==="Y"&&t.rules[topRules[j]]==="Y"&&t.rules[topRules[k]]==="Y"});
if(tri.length>=2){var s=gs(tri);combos.push({rules:[RL[topRules[i]],RL[topRules[j]],RL[topRules[k]]],stats:s,count:3})}}}}
// 4-rule combos (only from top 5 rules, min 4 trades)
var top5=topRules.slice(0,5);
if(cp.length>=10){for(var i=0;i<top5.length;i++){for(var j=i+1;j<top5.length;j++){for(var k=j+1;k<top5.length;k++){for(var l=k+1;l<top5.length;l++){
var quad=cp.filter(function(t){return t.rules[top5[i]]==="Y"&&t.rules[top5[j]]==="Y"&&t.rules[top5[k]]==="Y"&&t.rules[top5[l]]==="Y"});
if(quad.length>=4){var s=gs(quad);combos.push({rules:[RL[top5[i]],RL[top5[j]],RL[top5[k]],RL[top5[l]]],stats:s,count:4})}}}}}}
// 5-rule combos (only from top 5 rules, min 5 trades)
if(cp.length>=15&&top5.length>=5){
var quint=cp.filter(function(t){return top5.every(function(r){return t.rules[r]==="Y"})});
if(quint.length>=5){var s=gs(quint);combos.push({rules:top5.map(function(r){return RL[r]}),stats:s,count:5})}}
combos.sort(function(a,b){if(b.stats.wr!==a.stats.wr)return b.stats.wr-a.stats.wr;return b.stats.ar-a.stats.ar});
combos=combos.slice(0,20)}

// === MIN RULE COUNT CURVE ===
var minRule=[];
for(var n=0;n<=8;n++){var tr=cp.filter(function(t){return ruleCount(t)>=n});if(tr.length>=2)minRule.push({min:n,stats:gs(tr)})}

// === CORRELATION MATRIX ===
var corr=[];
if(cp.length>=5){
var ar2=activeRules||RK.filter(function(k){return cp.filter(function(t){return t.rules[k]==="Y"}).length>=2});
for(var i=0;i<ar2.length;i++){for(var j=i+1;j<ar2.length;j++){
var bothY=cp.filter(function(t){return t.rules[ar2[i]]==="Y"&&t.rules[ar2[j]]==="Y"}).length;
var eitherY=cp.filter(function(t){return t.rules[ar2[i]]==="Y"||t.rules[ar2[j]]==="Y"}).length;
if(eitherY>0){corr.push({a:RL[ar2[i]],b:RL[ar2[j]],overlap:bothY/eitherY,bothN:bothY})}}}
corr.sort(function(a,b){return b.overlap-a.overlap})}

// === ENTRY QUALITY SCORE ===
var scores=[];
if(cp.length>=5&&yn.length>=3){
// Weight = normalized edge for each rule
var maxEdge=Math.max.apply(null,yn.filter(function(r){return RK.indexOf(r.key)>=0}).map(function(r){return Math.abs(r.edge)}));
if(maxEdge>0){
var weights={};yn.forEach(function(r){if(RK.indexOf(r.key)>=0)weights[r.key]=r.edge/maxEdge});
scores=cp.map(function(t){var score=0,maxScore=0;
RK.forEach(function(k){if(weights[k]!==undefined){var w=Math.abs(weights[k]);maxScore+=w;if(t.rules[k]==="Y"&&weights[k]>0)score+=w;else if(t.rules[k]==="Y"&&weights[k]<0)score-=w*0.5}});
var pct=maxScore>0?Math.round(score/maxScore*100):0;
return{id:t.id,score:pct,pl:cPL(t).pl,rm:cPL(t).rm,date:t.date,ticker:t.ticker}}).sort(function(a,b){return b.score-a.score})}}

// === CONDITIONAL EDGE ===
var cond=[];
if(cp.length>=8){
var topYN=yn.filter(function(r){return RK.indexOf(r.key)>=0}).slice(0,6);
for(var i=0;i<topYN.length;i++){for(var j=0;j<topYN.length;j++){if(i===j)continue;
var base=cp.filter(function(t){return t.rules[topYN[i].key]==="Y"});
var added=base.filter(function(t){return t.rules[topYN[j].key]==="Y"});
var without=base.filter(function(t){return t.rules[topYN[j].key]==="N"});
if(added.length>=2&&without.length>=2){var inc=gs(added).wr-gs(without).wr;
cond.push({base:topYN[i].label,add:topYN[j].label,incr:inc,addStats:gs(added),woStats:gs(without)})}}}}
cond.sort(function(a,b){return Math.abs(b.incr)-Math.abs(a.incr)});
cond=cond.slice(0,12);

return{yn:yn,num:num,combos:combos,minRule:minRule,corr:corr,scores:scores,cond:cond}},[cp]);
// === TIME AUTO-FORMAT ===
function fmtTime(v){var d=v.replace(/\D/g,"");if(d.length>=4){return d.slice(0,2)+":"+d.slice(2,4)}return v}
// === FORM ===
function rF(){if(!et)return null;var t=et;
function u(k,v){setEt(function(p){var c=dc(p);c[k]=v;return c})}
function uR(k,v){setEt(function(p){var c=dc(p);c.rules[k]=v;return c})}
function uS(k,v){setEt(function(p){var c=dc(p);c.stopMgmt[k]=v;return c})}
function onTimeBlur(field,v){if(/^\d{3,4}$/.test(v.replace(/\D/g,""))){u(field,fmtTime(v))}}
var img=t.screenshotData||t.screenshotUrl;
var pp=(t.entry&&t.exit&&t.shares)?cPL(t):null;
var mf=(t.entry&&t.mfePrice)?cMFE(t):null;
var ma=(t.entry&&t.maePrice)?cMAE(t):null;
var du=cDur(t);
var pv=[];
if(pp){pv.push(h("div",{key:"pl",style:{flex:1,textAlign:"center",minWidth:55}},h("div",{style:{fontSize:8,color:K.dm}},"P/L"),h("div",{style:{fontSize:13,fontWeight:700,color:pp.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},"$"+pp.pl.toFixed(2))));pv.push(h("div",{key:"r",style:{flex:1,textAlign:"center",minWidth:45}},h("div",{style:{fontSize:8,color:K.dm}},"R"),h("div",{style:{fontSize:13,fontWeight:700,color:pp.rm>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},pp.rm.toFixed(2)+"R")))}
if(du)pv.push(h("div",{key:"d",style:{flex:1,textAlign:"center",minWidth:50}},h("div",{style:{fontSize:8,color:K.dm}},"Dur"),h("div",{style:{fontSize:13,fontWeight:700,color:K.go,fontFamily:"JetBrains Mono,monospace"}},du.l)));
if(mf&&mf.cp!==null)pv.push(h("div",{key:"c",style:{flex:1,textAlign:"center",minWidth:50}},h("div",{style:{fontSize:8,color:K.dm}},"Cap"),h("div",{style:{fontSize:13,fontWeight:700,color:mf.cp>=.7?K.g:mf.cp>=.5?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},(mf.cp*100).toFixed(0)+"%")));
if(ma)pv.push(h("div",{key:"m",style:{flex:1,textAlign:"center",minWidth:50}},h("div",{style:{fontSize:8,color:K.dm}},"MAE"),h("div",{style:{fontSize:13,fontWeight:700,color:K.r,fontFamily:"JetBrains Mono,monospace"}},"-$"+ma.md.toFixed(2))));
var re=RK.map(function(k){return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"3px 7px",background:K.bg,borderRadius:6}},h("span",{style:{fontSize:10,color:K.dm}},RL[k]),h(YN,{v:t.rules[k],onChange:function(v){uR(k,v)}}))});
var se=Object.keys(SL).map(function(k){return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"3px 7px",background:K.bg,borderRadius:6}},h("span",{style:{fontSize:10,color:K.dm}},SL[k]),h(YN,{v:t.stopMgmt[k],onChange:function(v){uS(k,v)}}))});
var qe=["macdCross","rsiExtreme","cloudAlign","chanRetest","cloud15m"].map(function(k){return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"3px 7px",background:K.bg,borderRadius:6}},h("span",{style:{fontSize:10,color:K.dm}},RL[k]),h(YN,{v:t.rules[k],onChange:function(v){uR(k,v)}}))});
var g4="1fr 1fr 1fr 1fr",g3="1fr 1fr 1fr";
// Section label helper
function SL2(label,color,tip){return h("div",{style:{fontSize:10,fontWeight:700,color:color||K.go,marginBottom:5,marginTop:4,display:"flex",alignItems:"center",borderBottom:"1px solid "+K.bd,paddingBottom:4}},label,tip?h(Tip,{t:tip}):null)}
return h("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.85)",zIndex:1000,overflow:"auto",padding:"16px 8px"}},
h("div",{style:{maxWidth:qm?580:880,margin:"0 auto",background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:20}},
// Header
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14,flexWrap:"wrap",gap:6}},
h("div",{style:{display:"flex",alignItems:"center",gap:8}},h("h2",{style:{color:K.go,fontSize:15,margin:0,fontFamily:"JetBrains Mono,monospace"}},qm?"QUICK ENTRY":"TRADE ENTRY"),h("span",{style:{fontSize:9,padding:"2px 8px",borderRadius:4,background:t.mode==="backtest"?K.pu:K.cy,color:"#fff",fontWeight:600}},t.mode==="backtest"?"BT":"LIVE")),
h("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},h(Pl,{v:t.mode,onChange:function(v){u("mode",v)},options:[{v:"live",l:"Live",c:K.cy},{v:"backtest",l:"BT",c:K.pu}]}),h("button",{onClick:function(){sQm(!qm)},style:{padding:"4px 8px",background:qm?K.cy:K.pu,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer"}},qm?"Full":"Quick"),h("button",{onClick:function(){setSf(false);setEt(null)},style:{padding:"4px 8px",background:K.r,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer"}},"Cancel"))),

// === BLOCK 1: IDENTITY — Direction + Type ===
SL2("TRADE IDENTITY",K.go),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:12}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Direction",h(Tip,{t:"Long = betting price goes up. Short = betting price goes down."})),h(Pl,{v:t.direction,onChange:function(v){u("direction",v)},options:[{v:"L",l:"LONG",c:K.g},{v:"S",l:"SHORT",c:K.r}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Type",h(Tip,{t:"Reversal = entering against the prior trend. Continuation = entering in the direction of the trend."})),h(Pl,{v:t.type,onChange:function(v){u("type",v)},options:[{v:"Rev",l:"Reversal",c:K.cy},{v:"Cont",l:"Continuation",c:K.go}]}))),

// === BLOCK 2: CAN'T RECOVER LATER ===
SL2("NOW — CAN'T RECOVER LATER",K.r,"Fill these in real-time. Emotion, confidence, and session read cannot be reconstructed from broker records or screenshots."),
h("div",{style:{display:"grid",gridTemplateColumns:"60px 1fr 1fr 1fr 80px",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trade#",h(Tip,{t:"Which trade is this in your session today? Auto-generated but you can correct it."})),h(Ip,{value:t.tradeNumOfDay,onChange:function(v){u("tradeNumOfDay",v)},type:"number",placeholder:"1"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Session",h(Tip,{t:"Your read of the overall market session. Trending = clear direction. Ranging = bouncing. Choppy = no clean moves. Breakout = breaking key level. Reversal = changing direction."})),h(Sel,{value:t.sessionRead,onChange:function(v){u("sessionRead",v)},options:[{v:"",l:"--"}].concat(SESSIONS.map(function(s){return{v:s,l:s.charAt(0).toUpperCase()+s.slice(1)}}))})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Confidence",h(Tip,{t:"How confident were you in this setup at entry? 1 = very unsure, 5 = high conviction."})),h(Pl,{v:t.confidence,onChange:function(v){u("confidence",v)},options:[{v:"1",l:"1"},{v:"2",l:"2"},{v:"3",l:"3"},{v:"4",l:"4"},{v:"5",l:"5"}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Emotion",h(Tip,{t:"Your emotional state at entry. Calm = ideal. FOMO = fear of missing out. Revenge = trading to recover losses."})),h(Sel,{value:t.emotion,onChange:function(v){u("emotion",v)},options:EMOTIONS.map(function(e){return{v:e,l:e.charAt(0).toUpperCase()+e.slice(1)}})})),
h("div",null,h("div",{style:{fontSize:10,color:K.go,marginBottom:3}},"Followed?",h(Tip,{t:"Did this trade meet your minimum entry criteria? The most powerful metric in the journal — measures the real cost of breaking discipline."})),h(YN,{v:t.followedRules,onChange:function(v){u("followedRules",v)}}))),

// === BLOCK 3: MARKET CONTEXT ===
SL2("MARKET CONTEXT",K.pu,"Technical conditions at entry. Can be filled from screenshots after the session."),
h("div",{style:{display:"grid",gridTemplateColumns:"80px 1fr 1fr 1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"TF",h(Tip,{t:"Timeframe you used for entry."})),h(Sel,{value:t.timeframe,onChange:function(v){u("timeframe",v)},options:TFS.map(function(tf){return{v:tf,l:tf}})})),
h("div",null,h("div",{style:{fontSize:10,color:K.pu,marginBottom:3}},"Cloud Dir",h(Tip,{t:"EMA cloud direction at entry. Bullish = cloud sloping up. Bearish = cloud sloping down."})),h(Pl,{v:t.cloudDirection,onChange:function(v){u("cloudDirection",v)},options:[{v:"",l:"--"},{v:"bull",l:"Bull",c:K.g},{v:"bear",l:"Bear",c:K.r}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.pu,marginBottom:3}},"Cloud W%",h(Tip,{t:"Width of the EMA cloud as a percentage of price. Wider cloud = stronger trend. Example: 0.25 = 0.25% wide."})),h(Ip,{value:t.cloudThickness,onChange:function(v){u("cloudThickness",v)},type:"number",step:"0.01",placeholder:"0.25"})),
h("div",null,h("div",{style:{fontSize:10,color:K.go,marginBottom:3}},"ADX",h(Tip,{t:"Average Directional Index at entry. Measures trend strength. Under 20 = weak/choppy. 20-25 = developing. 25+ = strong trend."})),h(Ip,{value:t.adxAtEntry,onChange:function(v){u("adxAtEntry",v)},type:"number",step:"0.1",placeholder:"25"})),
h("div",null,h("div",{style:{fontSize:10,color:K.go,marginBottom:3}},"RSI Entry",h(Tip,{t:"RSI value at your entry. Under 30 = oversold. 30-50 = bearish zone. 50-70 = bullish zone. 70+ = overbought."})),h(Ip,{value:t.rsiAtEntry,onChange:function(v){u("rsiAtEntry",v)},type:"number",step:"0.1",placeholder:"45"}))),

// === BLOCK 4: REAL TRADE DATA ===
SL2("TRADE DATA","#e0e6ed","Prices, times, and execution data. Recoverable from broker records after the session."),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Date"),h(Ip,{value:t.date,onChange:function(v){u("date",v)},type:"date"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Entry Time",h(Tip,{t:"Time you entered the trade. Type 1032 and it auto-formats to 10:32."})),h(Ip,{value:t.time,onChange:function(v){u("time",v)},onBlur:function(e){onTimeBlur("time",e.target.value)},placeholder:"10:32"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Exit Time"),h(Ip,{value:t.exitTime,onChange:function(v){u("exitTime",v)},onBlur:function(e){onTimeBlur("exitTime",e.target.value)},placeholder:"10:47"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Ticker"),h(Ip,{value:t.ticker,onChange:function(v){u("ticker",v.toUpperCase())},placeholder:"TSLA"}))),
h("div",{style:{display:"grid",gridTemplateColumns:g4,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Entry $",h(Tip,{t:"Your fill price when entering the trade."})),h(Ip,{value:t.entry,onChange:function(v){u("entry",v)},type:"number",step:"0.01",placeholder:"452.30"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Stop $",h(Tip,{t:"Your initial stop loss price. Used to calculate R-multiple (risk unit)."})),h(Ip,{value:t.stop,onChange:function(v){u("stop",v)},type:"number",step:"0.01",placeholder:"451.10"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Exit $",h(Tip,{t:"Your fill price when exiting the trade."})),h(Ip,{value:t.exit,onChange:function(v){u("exit",v)},type:"number",step:"0.01",placeholder:"454.80"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Shares",h(Tip,{t:"Number of shares or contracts traded."})),h(Ip,{value:t.shares,onChange:function(v){u("shares",v)},type:"number",placeholder:"400"}))),
h("div",{style:{display:"grid",gridTemplateColumns:g4,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.cy,marginBottom:3}},t.direction==="L"?"MFE — High $":"MFE — Low $",h(Tip,{t:"Maximum Favorable Excursion — the best price the trade reached while you were in it. For longs: highest price. For shorts: lowest price."})),h(Ip,{value:t.mfePrice,onChange:function(v){u("mfePrice",v)},type:"number",step:"0.01"})),
h("div",null,h("div",{style:{fontSize:10,color:K.r,marginBottom:3}},t.direction==="L"?"MAE — Low $":"MAE — High $",h(Tip,{t:"Maximum Adverse Excursion — the worst drawdown price while you were in the trade. For longs: lowest price hit. For shorts: highest price hit."})),h(Ip,{value:t.maePrice,onChange:function(v){u("maePrice",v)},type:"number",step:"0.01"})),
h("div",null,h("div",{style:{fontSize:10,color:K.cy,marginBottom:3}},"RSI at Peak",h(Tip,{t:"RSI value at the MFE — the best price. Helps identify when RSI signals a reversal from the peak."})),h(Ip,{value:t.rsiAtPeak,onChange:function(v){u("rsiAtPeak",v)},type:"number",step:"0.1",placeholder:"78"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"RSI at Exit",h(Tip,{t:"RSI value at your exit price."})),h(Ip,{value:t.rsiAtExit,onChange:function(v){u("rsiAtExit",v)},type:"number",step:"0.1",placeholder:"72"}))),
// MAE Timing + Div Before + Div During
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{display:"flex",alignItems:"center",fontSize:10,color:K.dm,marginBottom:3}},"MAE Timing",h(Tip,{t:"Did the worst drawdown happen before or after the best price? Dip First = hit stop area then ran. Run First = ran to MFE then pulled back. Measures momentum quality."})),h(Pl,{v:t.maeTiming,onChange:function(v){u("maeTiming",v)},options:[{v:"",l:"--"},{v:"dip1st",l:"Dip First",c:K.go},{v:"run1st",l:"Run First",c:K.cy}]})),
h("div",null,h("div",{style:{display:"flex",alignItems:"center",fontSize:10,color:K.go,marginBottom:3}},"Div Before Entry",h(Tip,{t:"Was divergence building before your entry? Bullish div = price making lower lows but RSI making higher lows. Bearish = opposite."})),h(Pl,{v:t.divBefore,onChange:function(v){u("divBefore",v)},options:DIVS})),
h("div",null,h("div",{style:{display:"flex",alignItems:"center",fontSize:10,color:K.cy,marginBottom:3}},"Div During Trade",h(Tip,{t:"Did divergence form while in the trade? Signals potential exit point."})),h(Pl,{v:t.divDuring,onChange:function(v){u("divDuring",v)},options:DIVS}))),
// Exit details row
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Exit Type",h(Tip,{t:"How did you exit? Trail = trailing stop hit. Limit = hit your target. Stopped = initial stop hit."})),h(Pl,{v:t.exitType,onChange:function(v){u("exitType",v)},options:[{v:"Trail",l:"Trail",c:K.g},{v:"Limit",l:"Limit",c:K.go},{v:"Stop",l:"Stopped",c:K.r}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Vol at Exit",h(Tip,{t:"Volume at time of exit relative to average. High volume exits on wins = strong momentum. Low volume = potential for more."})),h(Pl,{v:t.volAtExit,onChange:function(v){u("volAtExit",v)},options:[{v:"B",l:"Below",c:K.r},{v:"A",l:"At Avg",c:K.go},{v:"H",l:"Above",c:K.g}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trend End $",h(Tip,{t:"Where did the move ultimately top or bottom AFTER you exited? Shows how much you left on the table post-exit."})),h(Ip,{value:t.trendEndPrice,onChange:function(v){u("trendEndPrice",v)},type:"number",step:"0.01",placeholder:"456.20"}))),
// Trail details (only if exit type is Trail)
t.exitType==="Trail"?h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trail TF",h(Tip,{t:"Which timeframe chart did you use to trail your stop?"})),h(Pl,{v:t.trailTimeframe,onChange:function(v){u("trailTimeframe",v)},options:[{v:"",l:"--"},{v:"1m",l:"1m",c:K.g},{v:"3m",l:"3m",c:K.go},{v:"5m",l:"5m",c:K.cy},{v:"same",l:"Same",c:K.pu}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trail Stop $",h(Tip,{t:"The actual trailing stop price when it was hit. Combined with MFE shows exactly how much you gave back from peak."})),h(Ip,{value:t.trailStopPrice,onChange:function(v){u("trailStopPrice",v)},type:"number",step:"0.01"}))):null,
// Partial exit
h("div",{style:{marginBottom:8}},
h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
h("div",{style:{fontSize:10,color:K.dm,fontWeight:700}},"Partial Exit?",h(Tip,{t:"Did you take a partial exit on this trade? Analysis will compare blended R of partial strategy vs full exit."})),
h(Pl,{v:t.hasPartial,onChange:function(v){u("hasPartial",v)},options:[{v:"",l:"--"},{v:"Y",l:"Yes",c:K.g},{v:"N",l:"No",c:K.dm}]})),
t.hasPartial==="Y"?h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Partial Exit $",h(Tip,{t:"Price at which you took your partial exit."})),h(Ip,{value:t.partialExitPrice,onChange:function(v){u("partialExitPrice",v)},type:"number",step:"0.01"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"% Exited",h(Tip,{t:"What percentage of your position did you exit partially?"})),h(Pl,{v:t.partialPct,onChange:function(v){u("partialPct",v)},options:[{v:"",l:"--"},{v:"25",l:"25%",c:K.go},{v:"33",l:"33%",c:K.go},{v:"50",l:"50%",c:K.cy},{v:"75",l:"75%",c:K.pu}]}))):null),
// Emotion During + After
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Emotion During",h(Tip,{t:"How did you feel while in the trade? Anxious/Impatient often leads to early exits. Greedy can lead to late exits."})),h(Sel,{value:t.emotionDuring,onChange:function(v){u("emotionDuring",v)},options:[{v:"",l:"--"}].concat(EMOTIONS_DURING.map(function(e){return{v:e,l:e.charAt(0).toUpperCase()+e.slice(1)}}))})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Emotion After",h(Tip,{t:"How did you feel after the trade closed? Regret and revenge are the two most expensive emotions in trading."})),h(Sel,{value:t.emotionAfter,onChange:function(v){u("emotionAfter",v)},options:[{v:"",l:"--"}].concat(EMOTIONS_AFTER.map(function(e){return{v:e,l:e.charAt(0).toUpperCase()+e.slice(1)}}))})),
),

// P/L preview
pv.length?h("div",{style:{display:"flex",gap:4,marginBottom:10,padding:6,background:K.bg,borderRadius:8,flexWrap:"wrap"}},pv):null,

// === BLOCK 5: SCREENSHOT ===
SL2("SCREENSHOT",K.cy),
h("div",{style:{marginBottom:12}},h("div",{style:{display:"flex",gap:4,marginBottom:3}},h(Ip,{value:t.screenshotUrl,onChange:function(v){u("screenshotUrl",v)},placeholder:"Paste TradingView URL...",style:{flex:1}}),h("button",{onClick:function(){fr.current&&fr.current.click()},style:{padding:"4px 10px",background:K.cy,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer"}},"Upload"),h("input",{ref:fr,type:"file",accept:"image/*",onChange:hF,style:{display:"none"}})),h("div",{onDrop:hD,onDragOver:function(e){e.preventDefault()},style:{border:"2px dashed "+K.bd,borderRadius:8,padding:img?4:14,textAlign:"center",color:K.dm,fontSize:10,cursor:"pointer",minHeight:img?36:44,display:"flex",alignItems:"center",justifyContent:"center",background:K.bg}},img?h("img",{src:img,alt:"",onClick:function(){setLb(img)},style:{maxWidth:"100%",maxHeight:140,borderRadius:6,cursor:"zoom-in"}}):"Drag & drop")),

// === BLOCK 6: RULES (Full mode only) ===
!qm?h("div",null,
SL2("SETUP RULES",K.go,"Mark Y/N for each rule present in your setup. This data feeds the Rule Edge Analysis to show which rules matter most."),
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:4,marginBottom:10}},re),
SL2("STOP MANAGEMENT",K.r,"Track how you managed your stop on this trade. The analysis will show which stop strategies protect profits best."),
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:4,marginBottom:10}},se),
h("div",{style:{marginBottom:10}},h("div",{style:{fontSize:10,color:K.dm,marginBottom:2}},"Notes"),h(Ip,{value:t.notes,onChange:function(v){u("notes",v)},placeholder:"Trade notes..."}))):null,
qm?h("div",{style:{marginBottom:10}},
SL2("QUICK RULES",K.go),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4}},qe)):null,
h("button",{onClick:sv,style:{width:"100%",padding:"10px",background:K.g,border:"none",borderRadius:8,color:"#000",fontSize:13,fontWeight:700,cursor:"pointer"}},"SAVE TRADE")))}
// === LOG VIEW ===
function rL(){
var rows=fl.map(function(t){var p=cPL(t),mfe=cMFE(t),dur=cDur(t),img=t.screenshotData||t.screenshotUrl,w=p.pl>0;
var mi=[h("span",{key:"e"},"E:"+t.entry),h("span",{key:"x"},"X:"+t.exit),h("span",{key:"s"},"\u00d7"+t.shares)];
if(dur)mi.push(h("span",{key:"d",style:{color:K.go}},dur.l));
if(mfe&&mfe.cp!==null)mi.push(h("span",{key:"c",style:{color:mfe.cp>=.7?K.g:K.go}},(mfe.cp*100).toFixed(0)+"%"));
if(t.adxAtEntry)mi.push(h("span",{key:"a",style:{color:+t.adxAtEntry>=25?K.g:K.go}},"ADX"+t.adxAtEntry));
if(t.rsiAtEntry)mi.push(h("span",{key:"ri"},"RSI"+t.rsiAtEntry));
if(t.timeframe&&t.timeframe!=="3m")mi.push(h("span",{key:"tf",style:{color:K.pu}},t.timeframe));
if(t.followedRules==="N")mi.push(h("span",{key:"fr",style:{color:K.r,fontWeight:700}},"\u2717rules"));
return h("div",{key:t.id,onClick:function(){oE(t)},style:{display:"flex",alignItems:"center",gap:6,padding:"7px 8px",background:K.cd,borderRadius:8,border:"1px solid "+K.bd,borderLeft:"3px solid "+(w?K.g:p.pl<0?K.r:K.bd),cursor:"pointer"}},
h("div",{style:{width:20,textAlign:"center",flexShrink:0}},h("span",{style:{fontSize:10,fontWeight:700,color:K.dm,fontFamily:"JetBrains Mono,monospace"}},t.tradeNumOfDay||"")),
h("div",{style:{width:44,height:32,borderRadius:4,overflow:"hidden",flexShrink:0,background:K.bg,display:"flex",alignItems:"center",justifyContent:"center"}},img?h("img",{src:img,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"},onClick:function(e){e.stopPropagation();setLb(img)}}):h("span",{style:{fontSize:7,color:K.dm}},"\u2014")),
h("div",{style:{minWidth:36,textAlign:"center"}},h("span",{style:{fontSize:13,fontWeight:700,color:t.direction==="L"?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},t.direction==="L"?"L":"S"),h("div",{style:{fontSize:8,color:K.dm}},t.type),(t.mode||"live")==="backtest"?h("div",{style:{fontSize:7,color:K.pu,fontWeight:600}},"BT"):null),
h("div",{style:{minWidth:44}},h("div",{style:{fontSize:12,fontWeight:600,color:K.tx}},t.ticker),h("div",{style:{fontSize:9,color:K.dm}},t.date)),
h("div",{style:{flex:1,display:"flex",gap:10,alignItems:"center",fontSize:12,fontFamily:"JetBrains Mono,monospace",color:K.dm,flexWrap:"wrap"}},mi),
h("div",{style:{textAlign:"right",minWidth:72}},h("div",{style:{fontSize:15,fontWeight:700,color:w?K.g:p.pl<0?K.r:K.dm,fontFamily:"JetBrains Mono,monospace"}},"$"+p.pl.toFixed(2)),h("div",{style:{fontSize:9,color:w?K.g:p.pl<0?K.r:K.dm}},p.rm.toFixed(2)+"R")),
h("button",{onClick:function(e){e.stopPropagation();dl(t.id)},style:{padding:"2px 5px",background:"transparent",border:"1px solid "+K.bd,borderRadius:4,color:K.r,fontSize:9,cursor:"pointer"}},"\u00d7"))});
var sc=[];
if(st){sc.push(h(SC,{key:"wr",label:"Win Rate",value:(st.wr*100).toFixed(1)+"%",color:st.wr>=.5?K.g:K.r,sub:st.w+"W/"+st.l+"L"}));sc.push(h(SC,{key:"tp",label:"Total P/L",value:"$"+st.tp.toFixed(0),color:st.tp>=0?K.g:K.r}));sc.push(h(SC,{key:"ar",label:"Avg R",value:st.ar.toFixed(2)+"R",color:st.ar>=0?K.g:K.r}));sc.push(h(SC,{key:"pf",label:"PF",value:st.pf>=999?"\u221e":st.pf.toFixed(2),color:st.pf>=1.5?K.g:st.pf>=1?K.go:K.r}));sc.push(h(SC,{key:"aw",label:"Avg W/L",value:"$"+st.aw.toFixed(0),color:K.g,sub:"L: $"+st.al.toFixed(0)}));if(st.ad!==null)sc.push(h(SC,{key:"ad",label:"Avg Dur",value:st.ad.toFixed(0)+"m",color:K.go}));if(st.ac!==null)sc.push(h(SC,{key:"ac",label:"Capture",value:(st.ac*100).toFixed(0)+"%",color:st.ac>=.7?K.g:st.ac>=.5?K.go:K.r}))}
return h("div",null,
h("div",{style:{display:"flex",gap:6,marginBottom:10,flexWrap:"wrap",alignItems:"center"}},h(Pl,{v:fd,onChange:sFd,options:[{v:"ALL",l:"All"},{v:"L",l:"Longs",c:K.g},{v:"S",l:"Shorts",c:K.r}]}),h(Pl,{v:ft,onChange:sFt,options:[{v:"ALL",l:"All"},{v:"Rev",l:"Rev",c:K.cy},{v:"Cont",l:"Cont",c:K.go}]}),tks.length>1?h("select",{value:fk,onChange:function(e){sFk(e.target.value)},style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"4px 8px",color:K.tx,fontSize:10}},[h("option",{key:"ALL",value:"ALL"},"All")].concat(tks.map(function(t){return h("option",{key:t,value:t},t)}))):null,
h("select",{value:sortBy,onChange:function(e){setSort(e.target.value)},style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"4px 8px",color:K.tx,fontSize:10}},
h("option",{value:"date_desc"},"Newest First"),h("option",{value:"date_asc"},"Oldest First"),h("option",{value:"trade_num_asc"},"Trade # (1 first)"),h("option",{value:"trade_num_desc"},"Trade # (Last first)"),h("option",{value:"pl_best"},"Best P/L"),h("option",{value:"pl_worst"},"Worst P/L"),h("option",{value:"r_best"},"Best R"),h("option",{value:"r_worst"},"Worst R"),h("option",{value:"wins"},"Wins First"),h("option",{value:"losses"},"Losses First")),
h("div",{style:{flex:1}}),h("span",{style:{fontSize:10,color:K.dm}},fl.length+" trades")),
sc.length?h("div",{style:{display:"flex",gap:5,marginBottom:10,flexWrap:"wrap"}},sc):null,
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},rows),
!fl.length?h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"No trades yet."):null)}
// === RULES VIEW ===
function rR(){
var d=ra;if(!d.yn.length&&!d.num.length)return h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"Log trades with rules to see analysis.");
function bkRow(b,i){return h("div",{key:i,style:{flex:1,minWidth:100,padding:6,background:K.bg,borderRadius:6}},h("div",{style:{fontSize:9,fontWeight:600,color:K.tx,marginBottom:3}},b.l),h("div",{style:{fontSize:10,color:K.dm}},b.s.n+"tr ",h("span",{style:{color:b.s.wr>=.5?K.g:K.r,fontWeight:600}},(b.s.wr*100).toFixed(0)+"%")," ",h("span",{style:{color:b.s.ar>=0?K.g:K.r}},b.s.ar.toFixed(2)+"R")," ",h("span",{style:{color:b.s.ap>=0?K.g:K.r}},"$"+b.s.ap.toFixed(0))),h(Bar,{pct:b.s.wr*100,color:b.s.wr>=.5?K.g:K.r}))}
var sections=[];
// Y/N Rules
sections.push(h("div",{key:"yn",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:8}},"RULE EDGE ANALYSIS",h(Tip,{t:"Compares win rate when each rule is marked Y vs N. Edge % shows the difference. Higher = that rule matters more for your setups."})),d.yn.map(function(r){var ep=(r.edge*100).toFixed(1);
return h("div",{key:r.key,style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"8px 12px",marginBottom:4}},h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}},h("span",{style:{fontSize:11,fontWeight:600,color:K.tx}},r.label),h("span",{style:{fontSize:14,fontWeight:700,color:r.edge>.05?K.g:r.edge<-.05?K.r:K.dm,fontFamily:"JetBrains Mono,monospace"}},(r.edge>0?"+":"")+ep+"%")),h("div",{style:{display:"flex",gap:12,fontSize:9}},h("div",{style:{flex:1}},h("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:2}},h("span",{style:{color:K.g}},"Y:"+r.w.n),h("span",{style:{color:K.g,fontFamily:"JetBrains Mono,monospace"}},(r.w.wr*100).toFixed(0)+"% "+r.w.ar.toFixed(2)+"R $"+r.w.ap.toFixed(0))),h(Bar,{pct:r.w.wr*100,color:K.g})),h("div",{style:{flex:1}},h("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:2}},h("span",{style:{color:K.r}},"N:"+r.wo.n),h("span",{style:{color:K.r,fontFamily:"JetBrains Mono,monospace"}},(r.wo.wr*100).toFixed(0)+"% "+r.wo.ar.toFixed(2)+"R $"+r.wo.ap.toFixed(0))),h(Bar,{pct:r.wo.wr*100,color:K.r}))))})));
// Numeric buckets
if(d.num.length)sections.push(h("div",{key:"num",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.pu,fontWeight:700,marginBottom:8}},"BUCKET ANALYSIS",h(Tip,{t:"Groups trades by numeric ranges (ADX, RSI, duration, etc) and shows performance for each bucket. Helps identify optimal conditions for your trades."})),d.num.map(function(n,ni){return h("div",{key:ni,style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"10px 12px",marginBottom:4}},h("div",{style:{fontSize:11,fontWeight:600,color:K.tx,marginBottom:6}},n.label),h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},n.bk.map(bkRow)))})));
// Combo Analysis
if(d.combos.length)sections.push(h("div",{key:"combo",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.cy,fontWeight:700,marginBottom:8}},"TOP SETUP COMBOS",h(Tip,{t:"Ranks 2, 3, 4, and 5 rule combinations by win rate and R. These are your best setups \u2014 the specific combos that produce the highest edge when present together. Higher rule counts require more trades to activate."})),d.combos.slice(0,15).map(function(c,i){return h("div",{key:i,style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 10px",background:K.cd,borderRadius:6,border:"1px solid "+K.bd,marginBottom:3}},h("div",{style:{flex:1}},h("span",{style:{fontSize:9,padding:"1px 5px",borderRadius:3,background:c.count===2?K.bd:c.count===3?K.pu:c.count===4?K.go:K.cy,color:"#fff",fontWeight:700,marginRight:6}},c.count+"R"),h("span",{style:{fontSize:10,color:K.tx}},c.rules.join(" + ")),h("span",{style:{fontSize:10,color:K.dm,marginLeft:6}},c.stats.n+" trades")),h("div",{style:{display:"flex",gap:10,fontFamily:"JetBrains Mono,monospace",fontSize:11}},h("span",{style:{color:c.stats.wr>=.6?K.g:c.stats.wr>=.45?K.go:K.r,fontWeight:700}},(c.stats.wr*100).toFixed(0)+"%"),h("span",{style:{color:c.stats.ar>=0?K.g:K.r}},c.stats.ar.toFixed(2)+"R"),h("span",{style:{color:c.stats.ap>=0?K.g:K.r}},"$"+c.stats.ap.toFixed(0))))})));
// Min Rule Count
if(d.minRule.length>1)sections.push(h("div",{key:"minr",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:8}},"MIN RULE COUNT THRESHOLD",h(Tip,{t:"Shows performance at each minimum rule count. Use this to set your 'don\u2019t trade' threshold \u2014 e.g. if 4+ rules = 70% WR but 2 rules = 35%, stop taking trades under 4 rules."})),h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},d.minRule.map(function(m){return h("div",{key:m.min,style:{flex:1,minWidth:80,padding:8,background:K.cd,borderRadius:8,border:"1px solid "+K.bd,textAlign:"center"}},h("div",{style:{fontSize:10,color:K.dm}},m.min+"+ rules"),h("div",{style:{fontSize:14,fontWeight:700,color:m.stats.wr>=.6?K.g:m.stats.wr>=.45?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},(m.stats.wr*100).toFixed(0)+"%"),h("div",{style:{fontSize:10,color:K.dm}},m.stats.n+"tr "+m.stats.ar.toFixed(2)+"R"),h(Bar,{pct:m.stats.wr*100,color:m.stats.wr>=.5?K.g:K.r}))}))));
// Correlation
if(d.corr.length)sections.push(h("div",{key:"corr",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.dm,fontWeight:700,marginBottom:8}},"RULE CORRELATION",h(Tip,{t:"Shows which rules fire together most often. High overlap (red) = redundant signals, essentially the same edge. Low overlap (green) = independent edges that stack."})),d.corr.slice(0,8).map(function(c,i){return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:8,padding:"4px 10px",background:K.cd,borderRadius:6,marginBottom:2,fontSize:10}},h("span",{style:{flex:1,color:K.tx}},c.a+" \u2194 "+c.b),h("span",{style:{color:c.overlap>.7?K.r:c.overlap>.4?K.go:K.g,fontFamily:"JetBrains Mono,monospace",fontWeight:600}},(c.overlap*100).toFixed(0)+"% overlap"),h("span",{style:{color:K.dm}},c.bothN+" both Y"))})));
// Conditional Edge
if(d.cond.length)sections.push(h("div",{key:"cond",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.cy,fontWeight:700,marginBottom:8}},"CONDITIONAL EDGE",h(Tip,{t:"Shows the incremental value of adding one rule when another is already present. Answers: 'Given I have Rule A, does adding Rule B actually improve my results?'"})),d.cond.slice(0,8).map(function(c,i){return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:6,padding:"4px 10px",background:K.cd,borderRadius:6,marginBottom:2,fontSize:10}},h("span",{style:{flex:1,color:K.tx}},"When ",h("span",{style:{color:K.go}},c.base)," \u2192 adding ",h("span",{style:{color:K.cy}},c.add)),h("span",{style:{color:c.incr>.05?K.g:c.incr<-.05?K.r:K.dm,fontFamily:"JetBrains Mono,monospace",fontWeight:700}},(c.incr>0?"+":"")+(c.incr*100).toFixed(0)+"% WR"))})));
// Entry Quality Scores
if(d.scores.length)sections.push(h("div",{key:"score",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:4}},"ENTRY QUALITY SCORES",h(Tip,{t:"Each trade scored 0-100 based on which rules were present, weighted by each rule\u2019s independent edge. Compare scores to outcomes \u2014 high scores should produce better results over time."})),h("div",{style:{fontSize:10,color:K.dm,marginBottom:8}},"Score vs actual P/L and R-multiple."),h("div",{style:{display:"flex",flexDirection:"column",gap:2}},d.scores.slice(0,15).map(function(s){return h("div",{key:s.id,style:{display:"flex",alignItems:"center",gap:8,padding:"3px 8px",background:K.cd,borderRadius:4,fontSize:10}},h("div",{style:{width:40,fontWeight:700,color:s.score>=70?K.g:s.score>=45?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},s.score),h("div",{style:{flex:1,height:6,background:K.bg,borderRadius:3,overflow:"hidden"}},h("div",{style:{width:s.score+"%",height:"100%",background:s.score>=70?K.g:s.score>=45?K.go:K.r,borderRadius:3}})),h("span",{style:{color:K.dm,width:50}},s.date.slice(5)),h("span",{style:{color:s.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace",width:60,textAlign:"right"}},"$"+s.pl.toFixed(0)+" "+s.rm.toFixed(1)+"R"))}))));
return h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:10}},"Viewing "+(md==="all"?"ALL":md.toUpperCase())+" \u2022 "+cp.length+" completed trades"),sections)}
// === EQUITY VIEW ===
function rEq(){
if(!cp.length)return h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"Log completed trades to see equity.");
var sorted=cp.slice().sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)});
// Cumulative
var cum=0,maxC=0,minC=0;
var pts=sorted.map(function(t,i){var p=cPL(t);cum+=p.pl;if(cum>maxC)maxC=cum;if(cum<minC)minC=cum;return{i:i+1,pl:p.pl,cum:cum,d:t.date}});
var range=Math.max(maxC-minC,1);
// Period grouping
function getKey(d){
if(plP==="daily")return d;
if(plP==="weekly"){var dt=new Date(d);var day=dt.getDay();var diff=dt.getDate()-day+(day===0?-6:1);dt.setDate(diff);return dt.toISOString().slice(0,10)}
if(plP==="monthly")return d.slice(0,7);
if(plP==="quarterly"){var m=parseInt(d.slice(5,7));var q=Math.ceil(m/3);return d.slice(0,4)+"-Q"+q}
return d}
var periods={};sorted.forEach(function(t){var k=getKey(t.date);if(!periods[k])periods[k]={key:k,pl:0,n:0,w:0};var p=cPL(t);periods[k].pl+=p.pl;periods[k].n++;if(p.pl>0)periods[k].w++});
// Apply manual adjustments
var pArr=Object.keys(periods).sort().map(function(k){var adj=plAdj[k]||{amount:0,notes:""};return Object.assign({},periods[k],{adjAmount:adj.amount||0,adjNotes:adj.notes||"",displayPl:(periods[k].pl+(parseFloat(adj.amount)||0))})});
var maxPPL=Math.max.apply(null,pArr.map(function(p){return Math.abs(p.displayPl)}).concat([1]));
return h("div",null,
// Cumulative chart
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:14,marginBottom:12}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}},h("div",{style:{fontSize:11,color:K.dm,display:"flex",alignItems:"center"}},"CUMULATIVE P/L",h(Tip,{t:"Running total of your P/L across all completed trades, in chronological order. Shows your equity curve \u2014 consistent upward = edge is working."})),h("div",{style:{fontSize:18,fontWeight:700,color:cum>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},"$"+cum.toFixed(2))),
function(){if(pts.length<2)return h("div",{style:{textAlign:"center",padding:20,color:K.dm}},"2+ trades to see line chart");
var svgW=600,svgH=160,pd=30,W=pts.length-1;
var xS=function(i){return pd+(i/W)*(svgW-pd*2)};
var yS=function(v){return pd+(maxC-v)/range*(svgH-pd*2)};
var ln=pts.map(function(p,i){return(i===0?"M":"L")+xS(i).toFixed(1)+","+yS(p.cum).toFixed(1)}).join(" ");
var ar=ln+" L"+xS(W).toFixed(1)+","+(svgH-pd)+" L"+xS(0).toFixed(1)+","+(svgH-pd)+" Z";
var zY=Math.min(Math.max(yS(0),pd),svgH-pd);
return h("div",{style:{background:K.bg,borderRadius:6,padding:4}},h("svg",{viewBox:"0 0 "+svgW+" "+svgH,style:{width:"100%",height:160}},
h("line",{x1:pd,y1:zY,x2:svgW-pd,y2:zY,stroke:K.dm,strokeWidth:.5,strokeDasharray:"4 3"}),
h("path",{d:ar,fill:cum>=0?"rgba(46,213,115,.1)":"rgba(255,71,87,.1)"}),
h("path",{d:ln,fill:"none",stroke:cum>=0?K.g:K.r,strokeWidth:2,strokeLinejoin:"round",strokeLinecap:"round"}),
pts.map(function(p,i){return h("circle",{key:i,cx:xS(i),cy:yS(p.cum),r:pts.length>30?2:3,fill:p.cum>=0?K.g:K.r},h("title",null,"#"+p.i+" "+p.d+": $"+p.cum.toFixed(2)))})))}()),
// Period selector + summary
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:14}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}},h("div",{style:{fontSize:11,color:K.dm,display:"flex",alignItems:"center"}},"P/L BREAKDOWN",h(Tip,{t:"Your profit/loss grouped by time period. Switch between daily, weekly, monthly, and quarterly views to spot patterns in your performance over time."})),h(Pl,{v:plP,onChange:sPlP,options:[{v:"daily",l:"Day"},{v:"weekly",l:"Week"},{v:"monthly",l:"Month"},{v:"quarterly",l:"Qtr"}]})),
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},pArr.map(function(p){
var lbl=plP==="daily"?p.key.slice(5):plP==="weekly"?"Wk "+p.key.slice(5):plP==="monthly"?p.key:p.key;
return h("div",{key:p.key,style:{display:"flex",alignItems:"center",gap:6,padding:"4px 8px",background:K.bg,borderRadius:6}},
h("div",{style:{width:65,fontSize:10,color:K.dm,fontFamily:"JetBrains Mono,monospace",flexShrink:0}},lbl),
h("div",{style:{flex:1,height:14,background:K.cd,borderRadius:3,overflow:"hidden"}},h("div",{style:{width:Math.max(Math.abs(p.displayPl)/maxPPL*100,3)+"%",height:"100%",background:p.displayPl>=0?K.g:K.r,borderRadius:3,opacity:.7}})),
h("div",{style:{width:70,textAlign:"right",fontSize:11,fontWeight:700,color:p.displayPl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},"$"+p.displayPl.toFixed(0)),
h("div",{style:{width:55,fontSize:10,color:K.dm,textAlign:"right"}},p.n+"tr "+p.w+"W"),
h("input",{type:"number",value:p.adjAmount||"",onChange:function(e){var v=e.target.value;sPlAdj(function(prev){var n=Object.assign({},prev);n[p.key]=Object.assign({},n[p.key]||{},{amount:v});return n})},placeholder:"+/-",step:"0.01",title:"Manual P/L adjustment for this period (display only, does not affect analysis)",style:{width:52,background:K.inp,border:"1px solid "+K.bd,borderRadius:4,padding:"2px 5px",color:p.adjAmount&&parseFloat(p.adjAmount)!==0?(parseFloat(p.adjAmount)>0?K.g:K.r):K.dm,fontSize:9,fontFamily:"JetBrains Mono,monospace",outline:"none",textAlign:"right"}}))}))),
// Period stats summary
pArr.length>=2?h("div",{style:{display:"flex",gap:6,marginTop:10,flexWrap:"wrap"}},
h(SC,{label:"Best "+plP,value:"$"+Math.max.apply(null,pArr.map(function(p){return p.displayPl})).toFixed(0),color:K.g}),
h(SC,{label:"Worst "+plP,value:"$"+Math.min.apply(null,pArr.map(function(p){return p.displayPl})).toFixed(0),color:K.r}),
h(SC,{label:"Win "+plP+"s",value:pArr.filter(function(p){return p.displayPl>0}).length+"/"+pArr.length,color:pArr.filter(function(p){return p.displayPl>0}).length/pArr.length>=.5?K.g:K.r}),
h(SC,{label:"Avg "+plP,value:"$"+(pArr.reduce(function(s,p){return s+p.displayPl},0)/pArr.length).toFixed(0),color:pArr.reduce(function(s,p){return s+p.displayPl},0)>=0?K.g:K.r})):null)}
// === EXPORT/IMPORT ===
function expJ(){var b=new Blob([JSON.stringify(trades,null,2)],{type:"application/json"});var u=URL.createObjectURL(b);var a=document.createElement("a");a.href=u;a.download="trade_journal_"+new Date().toISOString().slice(0,10)+".json";a.click();URL.revokeObjectURL(u)}
function impJ(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){try{var d=JSON.parse(ev.target.result);if(Array.isArray(d))setTr(d)}catch(err){alert("Bad JSON")}};r.readAsText(f)}
// Lightbox
if(lb)return h("div",null,h("div",{onClick:function(){setLb(null)},style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.92)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",cursor:"zoom-out"}},h("img",{src:lb,alt:"",style:{maxWidth:"94vw",maxHeight:"94vh",borderRadius:8}}),h("div",{style:{position:"absolute",top:16,right:24,color:"#fff",fontSize:28,cursor:"pointer",fontWeight:700}},"\u00d7")));
var lc=trades.filter(function(t){return(t.mode||"live")==="live"}).length;
var bc=trades.filter(function(t){return(t.mode||"live")==="backtest"}).length;
return h("div",{style:{background:K.bg,minHeight:"100vh",color:K.tx,fontFamily:"'IBM Plex Sans',-apple-system,sans-serif"}},
sf?rF():null,
h("div",{style:{padding:"8px 12px",borderBottom:"1px solid "+K.bd,display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}},
h("h1",{style:{margin:0,fontSize:14,fontFamily:"JetBrains Mono,monospace",color:K.go}},"TRADE JOURNAL"),
h("div",{style:{display:"flex",gap:2,background:K.cd,borderRadius:8,padding:2}},
h("button",{onClick:function(){sMd("live")},style:{padding:"3px 8px",borderRadius:6,border:"none",fontSize:11,fontWeight:600,cursor:"pointer",background:md==="live"?K.cy:"transparent",color:md==="live"?"#fff":K.dm}},"Live("+lc+")"),
h("button",{onClick:function(){sMd("backtest")},style:{padding:"3px 8px",borderRadius:6,border:"none",fontSize:11,fontWeight:600,cursor:"pointer",background:md==="backtest"?K.pu:"transparent",color:md==="backtest"?"#fff":K.dm}},"BT("+bc+")"),
h("button",{onClick:function(){sMd("all")},style:{padding:"3px 8px",borderRadius:6,border:"none",fontSize:11,fontWeight:600,cursor:"pointer",background:md==="all"?K.go:"transparent",color:md==="all"?"#fff":K.dm}},"All")),
h("div",{style:{display:"flex",gap:2,background:K.cd,borderRadius:8,padding:2}},[["log","Log"],["rules","Analysis"],["equity","Equity"]].map(function(x){return h("button",{key:x[0],onClick:function(){setVw(x[0])},style:{padding:"4px 10px",borderRadius:6,border:"none",fontSize:11,fontWeight:600,cursor:"pointer",background:vw===x[0]?K.cy:"transparent",color:vw===x[0]?"#fff":K.dm}},x[1])})),
h("div",{style:{flex:1}}),
h("button",{onClick:oQ,style:{padding:"5px 10px",background:K.pu,border:"none",borderRadius:8,color:"#fff",fontSize:11,fontWeight:600,cursor:"pointer"}},"Quick"),
h("button",{onClick:oN,style:{padding:"5px 10px",background:K.g,border:"none",borderRadius:8,color:"#000",fontSize:11,fontWeight:600,cursor:"pointer"}},"+ Trade"),
h("div",{style:{display:"flex",gap:3}},h("button",{onClick:expJ,style:{padding:"3px 7px",background:"transparent",border:"1px solid "+K.bd,borderRadius:6,color:K.dm,fontSize:9,cursor:"pointer"}},"Export"),h("button",{onClick:function(){ir.current&&ir.current.click()},style:{padding:"3px 7px",background:"transparent",border:"1px solid "+K.bd,borderRadius:6,color:K.dm,fontSize:9,cursor:"pointer"}},"Import"),h("input",{ref:ir,type:"file",accept:".json",onChange:impJ,style:{display:"none"}}))),
h("div",{style:{padding:12,maxWidth:1200,margin:"0 auto"}},vw==="log"?rL():null,vw==="rules"?rR():null,vw==="equity"?rEq():null))}
ReactDOM.createRoot(document.getElementById("root")).render(h(App));
}catch(err){document.getElementById("root").innerHTML='<div style="color:#ff4757;padding:20px;font-family:monospace">Error: '+err.message+'<br><pre>'+err.stack+'</pre></div>'}
</script>
</body></html>
