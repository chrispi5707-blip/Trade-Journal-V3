<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade Journal v7</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=JetBrains+Mono:wght@600;700&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0e17;color:#e0e6ed;font-family:'IBM Plex Sans',-apple-system,sans-serif;font-size:13px}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none}
input[type=number]{-moz-appearance:textfield}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#0a0e17}::-webkit-scrollbar-thumb{background:#1e2d3d;border-radius:3px}
select{background:#1a2435;border:1px solid #1e2d3d;border-radius:6px;padding:6px 10px;color:#e0e6ed;font-size:12px;outline:none}
.tip{position:relative;display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:#1e2d3d;color:#6b7a8d;font-size:8px;cursor:help;margin-left:4px;flex-shrink:0}
.tip:hover::after{content:attr(data-t);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#1a2435;border:1px solid #1e2d3d;color:#e0e6ed;padding:6px 10px;border-radius:6px;font-size:10px;white-space:normal;width:220px;z-index:9000;line-height:1.4;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,.5)}
.tip:hover::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:#1e2d3d;z-index:9001}
</style>
</head><body>
<div id="root"></div>
<script>
try{
var h=React.createElement,us=React.useState,ue=React.useEffect,uc=React.useCallback,ur=React.useRef,um=React.useMemo;

// === TIER CONSTANTS ===
var TIERS={FREE:{id:"free",label:"Free",color:"#6b7a8d",maxStrategies:1},T1:{id:"t1",label:"Tier 1",color:"#1e90ff",maxStrategies:3},T2:{id:"t2",label:"Tier 2",color:"#a855f7",maxStrategies:999},T3:{id:"t3",label:"Tier 3",color:"#ffa502",maxStrategies:999}};
function TierBadge(p){var colors={t1:"#1e90ff",t2:"#a855f7",t3:"#ffa502"};var c=colors[p.tier]||"#6b7a8d";return h("span",{title:"Available on "+p.tier.toUpperCase(),style:{fontSize:8,padding:"1px 5px",borderRadius:3,background:c+"22",color:c,border:"1px solid "+c+"44",fontWeight:700,marginLeft:5,verticalAlign:"middle",cursor:"default"}},"\uD83D\uDD12 "+p.tier.toUpperCase())}

// === MARKET CONDITIONS ===
var CONDITIONS={trending:{l:"Trending",c:"#2ed573"},ranging:{l:"Range Bound",c:"#1e90ff"},breakout:{l:"Breakout",c:"#ffa502"},choppy:{l:"Choppy",c:"#ff4757"},flat:{l:"Flat/Low Vol",c:"#6b7a8d"}};

// === INDICATOR LIBRARY (Add-on Cloud) ===
var IND_LIBRARY={
trend:[
{k:"ema_align_multi",l:"EMA Multi-TF Aligned",tip:"Multiple timeframe EMAs all pointing same direction"},
{k:"ema_slope",l:"EMA Slope Direction",tip:"EMA is sloping in direction of trade"},
{k:"price_above_ema",l:"Price Above/Below EMA",tip:"Price is on correct side of key EMA"},
{k:"htf_trend",l:"Higher TF Trend Aligned",tip:"Higher timeframe trend matches your entry direction"},
{k:"adx_threshold",l:"ADX Threshold Met",tip:"ADX above your minimum threshold for trend strength"},
{k:"trendline_intact",l:"Trend Line Intact",tip:"Key trend line has not been broken"},
{k:"hh_hl",l:"HH/HL Structure (Longs)",tip:"Price making higher highs and higher lows"}],
momentum:[
{k:"macd_cross",l:"MACD Cross",tip:"MACD line crossed signal line in trade direction"},
{k:"macd_hist",l:"MACD Histogram Direction",tip:"Histogram bars expanding in trade direction"},
{k:"rsi_level",l:"RSI Threshold",tip:"RSI is at a meaningful level for your setup"},
{k:"rsi_div",l:"RSI Divergence",tip:"RSI diverging from price action"},
{k:"stoch_cross",l:"Stochastic Cross",tip:"Stochastic crossed in trade direction"},
{k:"momentum_inc",l:"Momentum Increasing",tip:"Price momentum accelerating in trade direction"}],
volume:[
{k:"vol_above_avg",l:"Volume Above Average",tip:"Current volume exceeds average"},
{k:"vol_spike",l:"Volume Spike on Move",tip:"Significant volume spike confirming the move"},
{k:"vol_dry",l:"Volume Drying on Pullback",tip:"Volume decreasing on the pullback — weak counter move"},
{k:"vwap_pos",l:"VWAP Position",tip:"Price is on correct side of VWAP"},
{k:"vwap_retest",l:"VWAP Retest",tip:"Price retested VWAP before continuing"},
{k:"vol_at_level",l:"Volume at Key Level",tip:"Volume confirming reaction at support/resistance"}],
structure:[
{k:"sr_level",l:"S/R Level Hit",tip:"Price reached a key support or resistance level"},
{k:"level_retest",l:"Prior Level Retested",tip:"Price retesting a previously broken level"},
{k:"swing_break",l:"Swing High/Low Broken",tip:"Prior swing point has been taken out"},
{k:"inside_bar",l:"Inside Bar Present",tip:"Current bar is inside prior bar — compression before move"},
{k:"fvg",l:"Fair Value Gap Present",tip:"Imbalance gap in price that price may return to fill"},
{k:"order_block",l:"Order Block Identified",tip:"Institutional order block identified at entry area"},
{k:"liq_sweep",l:"Liquidity Sweep Confirmed",tip:"Stop hunt / liquidity grab confirmed before entry"}],
candle:[
{k:"engulfing",l:"Engulfing Candle",tip:"Candle engulfs prior candle body"},
{k:"pin_bar",l:"Pin Bar / Hammer",tip:"Long wick rejection candle at key level"},
{k:"doji_level",l:"Doji at Level",tip:"Indecision candle at key support/resistance"},
{k:"candle_close",l:"Candle Close Confirmation",tip:"Candle closed above/below key level"},
{k:"first_candle",l:"First Candle Off Level",tip:"First candle reaction at key level"},
{k:"second_candle",l:"Second Candle Entry",tip:"Entry on second candle confirmation"}],
timeframe:[
{k:"htf_aligned",l:"Higher TF Aligned",tip:"Higher timeframe chart supports your direction"},
{k:"mid_tf_aligned",l:"Mid TF Aligned",tip:"Intermediate timeframe confirms setup"},
{k:"entry_tf_confirmed",l:"Entry TF Confirmed",tip:"Entry timeframe shows clean setup"},
{k:"tf_confluence",l:"TF Confluence Present",tip:"Multiple timeframes all aligned at same level"}],
pattern:[
{k:"fib_level",l:"Fibonacci Level Hit",tip:"Price at key Fibonacci retracement level"},
{k:"fib_confluence",l:"Fibonacci Confluence",tip:"Multiple Fibonacci levels converging"},
{k:"harmonic_complete",l:"Harmonic Pattern Complete",tip:"Harmonic pattern (Gartley/Bat/Crab) at completion point"},
{k:"elliott_count",l:"Elliott Wave Count Valid",tip:"Wave count supports entry"},
{k:"wyckoff_phase",l:"Wyckoff Phase ID'd",tip:"Wyckoff phase clearly identified"},
{k:"bb_extreme",l:"Bollinger Band Extreme",tip:"Price at outer Bollinger Band"},
{k:"bb_squeeze",l:"Bollinger Squeeze Present",tip:"Bands are contracted — compression before expansion"}],
risk:[
{k:"clean_stop",l:"Clean Stop Location",tip:"Stop has a logical price structure behind it"},
{k:"min_r_clear",l:"Min R Target Clear",tip:"Minimum R multiple target is identifiable"},
{k:"risk_within_limit",l:"Risk Within Daily Limit",tip:"This trade keeps you within your daily risk rules"},
{k:"size_within_rules",l:"Position Size Within Rules",tip:"Share size follows your sizing rules"}]};

var IND_CAT_LABELS={trend:"Trend",momentum:"Momentum",volume:"Volume",structure:"Price Structure",candle:"Candle Patterns",timeframe:"Multi-Timeframe",pattern:"Pattern Specific",risk:"Risk & Setup"};

// === BUILT-IN STRATEGY TEMPLATES ===
var STRATEGY_TEMPLATES=[
{id:"chan_rev",name:"Channel Reversal",desc:"Fade moves at the boundaries of an established price channel. Enter when price hits channel resistance/support with confirmation of rejection.",conditions:{best:["ranging","choppy"],avoid:["trending","breakout"]},coreRules:{ultHL:"Ultimate H/L",lhHL:"LH / HL",chanBreak:"Chan Break",chanRetest:"Chan Retest",candleOff10:"1st Candle 10EMA",secondCandle:"2nd Candle Entry",macdCross:"MACD Cross",cloudAlign:"Cloud Align",rsiExtreme:"RSI Extreme",cloud15m:"15m Cloud"},stopMgmt:true},
{id:"chan_cont",name:"Channel Continuation",desc:"Trade in the direction of the dominant trend within a channel structure. Enter on pullbacks to channel midline or support.",conditions:{best:["trending","breakout"],avoid:["ranging","flat"]},coreRules:{ultHL:"Ultimate H/L",lhHL:"LH / HL",chanBreak:"Chan Break",chanRetest:"Chan Retest",candleOff10:"1st Candle 10EMA",secondCandle:"2nd Candle Entry",macdCross:"MACD Cross",cloudAlign:"Cloud Align",rsiExtreme:"RSI Extreme",cloud15m:"15m Cloud"},stopMgmt:true},
{id:"ema_system",name:"EMA / Moving Average",desc:"Trade price reactions to key EMAs. Enter when price pulls back to EMA in a trending market with momentum confirmation.",conditions:{best:["trending"],avoid:["choppy","flat","ranging"]},coreRules:{ema_slope:"EMA Slope Direction",price_above_ema:"Price Above/Below EMA",htf_trend:"Higher TF Trend Aligned",candle_close:"Candle Close Confirmation",vol_above_avg:"Volume Above Average"},stopMgmt:true},
{id:"wyckoff",name:"Wyckoff Method",desc:"Trade the phases of market cycles — accumulation, markup, distribution, markdown. Enter on Springs (longs) or Upthrusts (shorts) with volume confirmation.",conditions:{best:["ranging","trending"],avoid:["choppy"]},coreRules:{wyckoff_phase:"Wyckoff Phase ID'd",liq_sweep:"Liquidity Sweep Confirmed",vol_at_level:"Volume at Key Level",sr_level:"S/R Level Hit",vol_spike:"Volume Spike on Move"},stopMgmt:true},
{id:"fibonacci",name:"Fibonacci Retracement",desc:"Enter at key Fibonacci retracement levels within a trend. Look for confluence with S/R and candle confirmation at the level.",conditions:{best:["trending","ranging"],avoid:["choppy","flat"]},coreRules:{fib_level:"Fibonacci Level Hit",fib_confluence:"Fibonacci Confluence",htf_aligned:"Higher TF Aligned",candle_close:"Candle Close Confirmation",sr_level:"S/R Level Hit"},stopMgmt:false},
{id:"bollinger",name:"Bollinger Band System",desc:"Trade mean reversion from band extremes or breakouts from band squeezes. Enter at outer bands with reversal confirmation or on squeeze expansion.",conditions:{best:["ranging","breakout"],avoid:["strong trend"]},coreRules:{bb_extreme:"Bollinger Band Extreme",bb_squeeze:"Bollinger Squeeze Present",rsi_div:"RSI Divergence",vol_spike:"Volume Spike on Move",candle_close:"Candle Close Confirmation"},stopMgmt:false},
{id:"elliott",name:"Elliott Wave",desc:"Trade high-probability wave structures. Primary entries on Wave 3 (strongest wave) or at completion of corrective ABC patterns.",conditions:{best:["trending"],avoid:["choppy","ranging"]},coreRules:{elliott_count:"Elliott Wave Count Valid",fib_confluence:"Fibonacci Confluence",htf_aligned:"Higher TF Aligned",momentum_inc:"Momentum Increasing",vol_above_avg:"Volume Above Average"},stopMgmt:false},
{id:"ict_smc",name:"ICT / Smart Money",desc:"Trade with institutional order flow. Look for liquidity sweeps, order blocks, and fair value gaps within kill zone timing windows.",conditions:{best:["trending","breakout"],avoid:["choppy"]},coreRules:{liq_sweep:"Liquidity Sweep Confirmed",order_block:"Order Block Identified",fvg:"Fair Value Gap Present",htf_aligned:"Higher TF Aligned",vwap_pos:"VWAP Position"},stopMgmt:false},
{id:"vwap",name:"VWAP / Volume",desc:"Use VWAP as dynamic support/resistance. Trade rejections from VWAP or breakouts through VWAP with volume confirmation.",conditions:{best:["trending","ranging"],avoid:["flat"]},coreRules:{vwap_pos:"VWAP Position",vwap_retest:"VWAP Retest",vol_spike:"Volume Spike on Move",vol_above_avg:"Volume Above Average",htf_trend:"Higher TF Trend Aligned"},stopMgmt:false},
{id:"harmonic",name:"Harmonic Patterns",desc:"Trade precise geometric price patterns (Gartley, Bat, Crab, Butterfly) at completion zones. High accuracy when pattern ratios are valid.",conditions:{best:["ranging","trending"],avoid:["choppy","flat"]},coreRules:{harmonic_complete:"Harmonic Pattern Complete",fib_confluence:"Fibonacci Confluence",rsi_div:"RSI Divergence",sr_level:"S/R Level Hit",candle_close:"Candle Close Confirmation"},stopMgmt:false}
];

// === DATA MODEL ===
var TARGET_TYPES=[
{v:"",l:"Select type..."},
{v:"ma_10",l:"10 EMA"},{v:"ma_20",l:"20 EMA"},{v:"ma_50",l:"50 EMA"},{v:"ma_200",l:"200 EMA"},{v:"ma_vwap",l:"VWAP"},
{v:"fib_236",l:"Fib 23.6%"},{v:"fib_382",l:"Fib 38.2%"},{v:"fib_50",l:"Fib 50%"},{v:"fib_618",l:"Fib 61.8%"},{v:"fib_786",l:"Fib 78.6%"},{v:"fib_100",l:"Fib 100%"},{v:"fib_127",l:"Fib 127%"},{v:"fib_162",l:"Fib 161.8%"},
{v:"prior_high",l:"Prior High"},{v:"prior_low",l:"Prior Low"},{v:"daily_high",l:"Daily High"},{v:"daily_low",l:"Daily Low"},{v:"weekly_high",l:"Weekly High"},{v:"weekly_low",l:"Weekly Low"},{v:"swing_high",l:"Swing High"},{v:"swing_low",l:"Swing Low"},
{v:"chan_top",l:"Channel Top"},{v:"chan_bottom",l:"Channel Bottom"},{v:"chan_mid",l:"Channel Mid"},
{v:"round_num",l:"Round Number"},{v:"custom",l:"Custom Level"}];
var TARGET_TF_LABELS={v:"--",options:[{v:"",l:"--"},{v:"1m",l:"1m"},{v:"3m",l:"3m"},{v:"5m",l:"5m"},{v:"15m",l:"15m"},{v:"1h",l:"1h"},{v:"4h",l:"4h"},{v:"1D",l:"Daily"},{v:"1W",l:"Weekly"}]};
var TARGET_CAT_LABELS={"ma":"Moving Averages","fib":"Fibonacci","price_level":"Price Levels","channel":"Channel","other":"Other"};
function mkTarget(){return{id:gid(),type:"",tf:"",price:"",notes:"",isHit:""}};

var E={id:"",date:"",time:"",exitTime:"",direction:"L",type:"Rev",ticker:"TSLA",mode:"live",timeframe:"3m",
strategyId:"",
entry:"",stop:"",exit:"",shares:"",mfePrice:"",maePrice:"",maeTiming:"",
adxAtEntry:"",cloudThickness:"",cloudDirection:"",rsiAtEntry:"",rsiAtPeak:"",
divBefore:"",divDuring:"",
tradeNumOfDay:"",sessionRead:"",confidence:"",emotion:"calm",emotionDuring:"",emotionAfter:"",followedRules:"",
screenshotUrl:"",screenshotData:"",exitScreenshotUrl:"",exitScreenshotData:"",
hasPartial:"",partialExitPrice:"",partialPct:"",
targets:[],
trailTimeframe:"",trailStopPrice:"",trendEndPrice:"",
rules:{},
stopMgmt:{initStop:"",stopChan:"",trailHL:"",trailFailHL:"",stopMoved:"",reentry:""},
exitType:"",rsiAtExit:"",volAtExit:"",notes:""};
var RL={ultHL:"Ultimate H/L",lhHL:"LH / HL",chanBreak:"Chan Break",chanRetest:"Chan Retest",candleOff10:"1st Candle 10EMA",secondCandle:"2nd Candle Entry",macdCross:"MACD Cross",cloudAlign:"Cloud Align",rsiExtreme:"RSI Extreme",cloud15m:"15m Cloud"};
var DIVS=[{v:"",l:"None"},{v:"bull",l:"Bullish",c:"#2ed573"},{v:"bear",l:"Bearish",c:"#ff4757"}];
var SL={initStop:"Init Stop HL",stopChan:"Stop\u2192Chan",trailHL:"Trail H/L",trailFailHL:"Trail Failed H/L",stopMoved:"Stop Moved",reentry:"Re-entry"};
var RK=Object.keys(RL);
var TFS=["1m","3m","5m","15m","1h","2h","4h","1D","1W"];
var EMOTIONS=["calm","eager","fomo","frustrated","revenge","bored"];
var EMOTIONS_DURING=["calm","confident","anxious","impatient","greedy","panicked"];
var EMOTIONS_AFTER=["satisfied","relieved","frustrated","regret","revenge","neutral"];
var TRAIL_TFS=["1m","3m","5m","same"];
var PARTIAL_PCTS=["25","33","50","75"];
var SESSIONS=["trending","ranging","choppy","breakout","reversal"];
var K={bg:"#0a0e17",cd:"#0f1923",bd:"#1e2d3d",g:"#2ed573",r:"#ff4757",go:"#ffa502",cy:"#1e90ff",pu:"#a855f7",tx:"#e0e6ed",dm:"#6b7a8d",inp:"#1a2435"};

// === STRATEGY HELPERS ===
function getStrategyRules(strat){
if(!strat)return{core:{},addons:{}};
var core=Object.assign({},strat.coreRules||{});
var addons=strat.addons||{};
return{core:core,addons:addons}}
function getAllStratRuleKeys(strat){
if(!strat)return[];
var keys=Object.keys(strat.coreRules||{});
(strat.addons||[]).forEach(function(k){keys.push(k)});
return keys}
function getIndLabel(k){
var found=null;
Object.keys(IND_LIBRARY).forEach(function(cat){IND_LIBRARY[cat].forEach(function(ind){if(ind.k===k)found=ind})});
return found?found.l:(RL[k]||k)}
function getIndTip(k){
var found=null;
Object.keys(IND_LIBRARY).forEach(function(cat){IND_LIBRARY[cat].forEach(function(ind){if(ind.k===k)found=ind})});
return found?found.tip:""}

// === UTILS ===
function gid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}
function dc(o){return JSON.parse(JSON.stringify(o))}
function cPL(t){if(!t.entry||!t.exit||!t.shares)return{pl:0,pp:0,rm:0};var e=+t.entry,x=+t.exit,s=+t.stop,sh=+t.shares;var pl=t.direction==="L"?(x-e)*sh:(e-x)*sh;var rk=Math.abs(e-s);return{pl:pl,pp:t.direction==="L"?(x-e)/e:(e-x)/e,rm:rk>0?(t.direction==="L"?(x-e)/rk:(e-x)/rk):0}}
function cMFE(t){if(!t.entry||!t.mfePrice)return null;var e=+t.entry,m=+t.mfePrice,x=t.exit?+t.exit:null;var md=t.direction==="L"?m-e:e-m;var ed=x?(t.direction==="L"?x-e:e-x):null;return{md:md,cp:ed!==null&&md>0?ed/md:null}}
function cMAE(t){if(!t.entry||!t.maePrice)return null;return{md:t.direction==="L"?+t.entry-+t.maePrice:+t.maePrice-+t.entry}}
function cDur(t){if(!t.time||!t.exitTime)return null;function tm(s){var p=s.split(":");return parseInt(p[0])*60+parseInt(p[1]||0)}var d=tm(t.exitTime)-tm(t.time);if(d<=0)return null;return{m:d,l:Math.floor(d/60)>0?Math.floor(d/60)+"h "+d%60+"m":d%60+"m"}}
function gs(a){if(!a.length)return{n:0,wr:0,ar:0,ap:0,tp:0};var r=a.map(cPL),w=r.filter(function(x){return x.pl>0});return{n:a.length,wr:w.length/a.length,ar:r.reduce(function(s,x){return s+x.rm},0)/a.length,ap:r.reduce(function(s,x){return s+x.pl},0)/a.length,tp:r.reduce(function(s,x){return s+x.pl},0)}}
function ruleCount(t){var c=0;RK.forEach(function(k){if(t.rules&&t.rules[k]==="Y")c++});return c}
// System session read from avg ADX + cloud width for a day
function sysSession(dayTrades){
var adxs=dayTrades.filter(function(t){return t.adxAtEntry}).map(function(t){return+t.adxAtEntry});
var cws=dayTrades.filter(function(t){return t.cloudThickness}).map(function(t){return+t.cloudThickness});
if(!adxs.length&&!cws.length)return"unknown";
var avgAdx=adxs.length?adxs.reduce(function(a,b){return a+b},0)/adxs.length:null;
var avgCw=cws.length?cws.reduce(function(a,b){return a+b},0)/cws.length:null;
if(avgAdx!==null&&avgAdx<18&&avgCw!==null&&avgCw<0.15)return"ranging";
if(avgAdx!==null&&avgAdx<20)return"choppy";
if(avgAdx!==null&&avgAdx>=25)return"trending";
return"choppy"}
// === COMPONENTS ===
function Pl(p){return h("div",{style:{display:"flex",gap:2,background:K.bg,borderRadius:6,padding:2,flexWrap:"wrap"}},p.options.map(function(o){return h("button",{key:o.v,onClick:function(){p.onChange(o.v)},style:{padding:"5px 10px",borderRadius:5,border:"none",fontSize:12,fontWeight:600,cursor:"pointer",background:p.v===o.v?(o.c||K.cy):"transparent",color:p.v===o.v?"#fff":K.dm,transition:"all .15s"}},o.l)}))}
function YN(p){return h(Pl,{v:p.v,onChange:p.onChange,options:[{v:"Y",l:"Y",c:K.g},{v:"N",l:"N",c:K.r},{v:"",l:"-",c:K.dm}]})}
function Ip(p){return h("input",{type:p.type||"text",value:p.value||"",onChange:function(e){p.onChange(e.target.value)},placeholder:p.placeholder,step:p.step,style:Object.assign({background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"7px 10px",color:K.tx,fontSize:13,width:"100%",outline:"none"},p.style||{})})}
function SC(p){return h("div",{style:{background:K.cd,border:"1px solid "+K.bd,borderRadius:8,padding:"10px 14px",flex:1,minWidth:100}},h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},p.label),h("div",{style:{fontSize:18,fontWeight:700,color:p.color||K.tx,fontFamily:"JetBrains Mono,monospace"}},p.value),p.sub?h("div",{style:{fontSize:10,color:K.dm,marginTop:2}},p.sub):null)}
function Sel(p){return h("select",{value:p.value||"",onChange:function(e){p.onChange(e.target.value)},style:Object.assign({background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"6px 10px",color:K.tx,fontSize:12,width:"100%",outline:"none"},p.style||{})},p.options.map(function(o){return h("option",{key:o.v,value:o.v},o.l)}))}
// Mini bar for bucket display
function Bar(p){return h("div",{style:{height:4,background:K.bd,borderRadius:2,marginTop:4,overflow:"hidden"}},h("div",{style:{height:"100%",width:Math.max(p.pct,1)+"%",background:p.color||K.g,borderRadius:2}}))}
function Tip(p){return h("span",{className:"tip","data-t":p.t},"\u24d8")}
function Tip(p){return h("span",{className:"tip","data-t":p.t},"\u24D8")}
// === APP STATE ===
function App(){
var _t=us(function(){try{return JSON.parse(localStorage.getItem("tj5")||"[]")}catch(e){return[]}});
var trades=_t[0],setTr=_t[1];
var _strats=us(function(){try{return JSON.parse(localStorage.getItem("tj5_strats")||"[]")}catch(e){return[]}});
var userStrats=_strats[0],setStrats=_strats[1];
var _v=us("log"),vw=_v[0],setVw=_v[1];
var _stratV=us(false),stratV=_stratV[0],setStratV=_stratV[1];
var _editStrat=us(null),editStrat=_editStrat[0],setEditStrat=_editStrat[1];
var _e=us(null),et=_e[0],setEt=_e[1];
var _sf=us(false),sf=_sf[0],setSf=_sf[1];
var _lb=us(null),lb=_lb[0],setLb=_lb[1];
var _fd=us("ALL"),fd=_fd[0],sFd=_fd[1];
var _ft=us("ALL"),ft=_ft[0],sFt=_ft[1];
var _fk=us("ALL"),fk=_fk[0],sFk=_fk[1];
var _qm=us(false),qm=_qm[0],sQm=_qm[1];
var _sort=us("date_desc"),sortBy=_sort[0],setSort=_sort[1];
var _md=us("live"),md=_md[0],sMd=_md[1];
var _plPeriod=us("daily"),plP=_plPeriod[0],sPlP=_plPeriod[1];
var _plAdj=us({}),plAdj=_plAdj[0],sPlAdj=_plAdj[1];
var fr=ur(null),fr2=ur(null),ir=ur(null),cr=ur(null);
ue(function(){try{localStorage.setItem("tj5",JSON.stringify(trades))}catch(e){}},[trades]);
ue(function(){try{localStorage.setItem("tj5_strats",JSON.stringify(userStrats))}catch(e){}},[userStrats]);

function mkN(){var t=dc(E);t.id=gid();var today=new Date().toISOString().slice(0,10);t.date=today;t.mode=md==="all"?"live":md;var todayCount=trades.filter(function(tr){return tr.date===today&&(tr.mode||"live")===(md==="all"?"live":md)}).length;t.tradeNumOfDay=String(todayCount+1);return t}
function oN(){setEt(mkN());setSf(true);sQm(false)}
function oQ(){setEt(mkN());setSf(true);sQm(true)}
function oE(t){var c=dc(t);c.rules=Object.assign(dc(E.rules),c.rules||{});c.stopMgmt=Object.assign(dc(E.stopMgmt),c.stopMgmt||{});
if(!c.targets)c.targets=[];
["rsiAtEntry","rsiAtPeak","tradeNumOfDay","sessionRead","confidence","emotion","emotionDuring","emotionAfter","followedRules","timeframe","maeTiming","divBefore","divDuring","cloudDirection","hasPartial","partialExitPrice","partialPct","trailTimeframe","trailStopPrice","trendEndPrice","exitScreenshotUrl","exitScreenshotData"].forEach(function(k){if(c[k]===undefined)c[k]=E[k]});
if(!c.stopMgmt.trailFailHL)c.stopMgmt.trailFailHL="";setEt(c);setSf(true);sQm(false)}
function sv(){if(!et)return;setTr(function(p){var i=-1;for(var j=0;j<p.length;j++)if(p[j].id===et.id){i=j;break}if(i>=0){var n=p.slice();n[i]=et;return n}return p.concat([et])});setSf(false);setEt(null)}
function dl(id){if(confirm("Delete?")){setTr(function(p){return p.filter(function(t){return t.id!==id})})}}
function hF(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){setEt(function(p){var c=dc(p);c.screenshotData=ev.target.result;return c})};r.readAsDataURL(f)}
function hF2(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){setEt(function(p){var c=dc(p);c.exitScreenshotData=ev.target.result;return c})};r.readAsDataURL(f)}
var hD=uc(function(e){e.preventDefault();var f=e.dataTransfer.files[0];if(!f||!f.type.startsWith("image/"))return;var r=new FileReader();r.onload=function(ev){setEt(function(p){var c=dc(p);c.screenshotData=ev.target.result;return c})};r.readAsDataURL(f)},[]);
var hD2=uc(function(e){e.preventDefault();var f=e.dataTransfer.files[0];if(!f||!f.type.startsWith("image/"))return;var r=new FileReader();r.onload=function(ev){setEt(function(p){var c=dc(p);c.exitScreenshotData=ev.target.result;return c})};r.readAsDataURL(f)},[]);

// FILTERED DATA
var mf=um(function(){if(md==="all")return trades;return trades.filter(function(t){return(t.mode||"live")===md})},[trades,md]);
var fl=um(function(){return mf.filter(function(t){if(fd!=="ALL"&&t.direction!==fd)return false;if(ft!=="ALL"&&t.type!==ft)return false;if(fk!=="ALL"&&t.ticker!==fk)return false;return true}).sort(function(a,b){
var pa=cPL(a),pb=cPL(b);
if(sortBy==="date_desc")return(b.date+b.time).localeCompare(a.date+a.time);
if(sortBy==="date_asc")return(a.date+a.time).localeCompare(b.date+b.time);
if(sortBy==="pl_best")return pb.pl-pa.pl;
if(sortBy==="pl_worst")return pa.pl-pb.pl;
if(sortBy==="r_best")return pb.rm-pa.rm;
if(sortBy==="r_worst")return pa.rm-pb.rm;
if(sortBy==="trade_num_asc")return(+a.tradeNumOfDay||0)-(+b.tradeNumOfDay||0);
if(sortBy==="trade_num_desc")return(+b.tradeNumOfDay||0)-(+a.tradeNumOfDay||0);
if(sortBy==="wins")return(pb.pl>0?1:0)-(pa.pl>0?1:0);
if(sortBy==="losses")return(pa.pl<0?1:0)-(pb.pl<0?1:0);
return(b.date+b.time).localeCompare(a.date+a.time)})},[mf,fd,ft,fk,sortBy]);
var tks=um(function(){var s={};mf.forEach(function(t){if(t.ticker)s[t.ticker]=1});return Object.keys(s)},[mf]);
var cp=um(function(){return mf.filter(function(t){return t.entry&&t.exit&&t.shares})},[mf]);
// === STATS ENGINE ===
var st=um(function(){
var t=fl.filter(function(x){return x.entry&&x.exit&&x.shares});if(!t.length)return null;
var rs=t.map(function(x){var p=cPL(x);return{pl:p.pl,rm:p.rm,mfe:cMFE(x),dur:cDur(x)}});
var w=rs.filter(function(r){return r.pl>0}),l=rs.filter(function(r){return r.pl<0});
var ds=rs.map(function(r){return r.dur}).filter(Boolean);
var cs=rs.map(function(r){return r.mfe&&r.mfe.cp}).filter(function(c){return c!=null});
return{n:rs.length,w:w.length,l:l.length,wr:w.length/rs.length,
tp:rs.reduce(function(s,r){return s+r.pl},0),
aw:w.length?w.reduce(function(s,r){return s+r.pl},0)/w.length:0,
al:l.length?l.reduce(function(s,r){return s+r.pl},0)/l.length:0,
ar:rs.reduce(function(s,r){return s+r.rm},0)/rs.length,
pf:l.length?Math.abs(w.reduce(function(s,r){return s+r.pl},0)/l.reduce(function(s,r){return s+r.pl},0)):w.length?999:0,
ad:ds.length?ds.reduce(function(s,d){return s+d.m},0)/ds.length:null,
ac:cs.length?cs.reduce(function(s,c){return s+c},0)/cs.length:null}},[fl]);
// === RULE ANALYSIS ENGINE ===
var ra=um(function(){if(!cp.length)return{yn:[],num:[],combos:[],minRule:[],corr:[],scores:[],cond:[]};
// Y/N edge for setup rules
var yn=RK.map(function(k){var wi=cp.filter(function(t){return t.rules[k]==="Y"}),wo=cp.filter(function(t){return t.rules[k]==="N"});return{key:k,label:RL[k],w:gs(wi),wo:gs(wo),edge:gs(wi).wr-gs(wo).wr}});
// Stop mgmt rules
Object.keys(SL).forEach(function(k){var wi=cp.filter(function(t){return t.stopMgmt&&t.stopMgmt[k]==="Y"}),wo=cp.filter(function(t){return t.stopMgmt&&t.stopMgmt[k]==="N"});if(wi.length+wo.length>=2)yn.push({key:"sm_"+k,label:"Stop: "+SL[k],w:gs(wi),wo:gs(wo),edge:gs(wi).wr-gs(wo).wr})});
// Followed rules
var fr=cp.filter(function(t){return t.followedRules==="Y"}),fn=cp.filter(function(t){return t.followedRules==="N"});
if(fr.length+fn.length>=2)yn.push({key:"followedRules",label:"\u2605 Followed Rules",w:gs(fr),wo:gs(fn),edge:gs(fr).wr-gs(fn).wr});
yn.sort(function(a,b){return Math.abs(b.edge)-Math.abs(a.edge)});

// Numeric buckets
var num=[];
var at=cp.filter(function(t){return t.adxAtEntry});
if(at.length>=3)num.push({label:"ADX at Entry",bk:[{l:"< 20",s:gs(at.filter(function(t){return+t.adxAtEntry<20}))},{l:"20-25",s:gs(at.filter(function(t){var v=+t.adxAtEntry;return v>=20&&v<25}))},{l:"25+",s:gs(at.filter(function(t){return+t.adxAtEntry>=25}))}]});
var ct=cp.filter(function(t){return t.cloudThickness});
if(ct.length>=3)num.push({label:"Cloud Width %",bk:[{l:"< 0.15%",s:gs(ct.filter(function(t){return+t.cloudThickness<0.15}))},{l:"0.15-0.35%",s:gs(ct.filter(function(t){var v=+t.cloudThickness;return v>=0.15&&v<0.35}))},{l:"0.35%+",s:gs(ct.filter(function(t){return+t.cloudThickness>=0.35}))}]});
var re=cp.filter(function(t){return t.rsiAtEntry});
if(re.length>=3){num.push({label:"RSI at Entry",bk:[{l:"< 30",s:gs(re.filter(function(t){return+t.rsiAtEntry<30}))},{l:"30-50",s:gs(re.filter(function(t){var v=+t.rsiAtEntry;return v>=30&&v<50}))},{l:"50-70",s:gs(re.filter(function(t){var v=+t.rsiAtEntry;return v>=50&&v<70}))},{l:"70+",s:gs(re.filter(function(t){return+t.rsiAtEntry>=70}))}]});
var lo=re.filter(function(t){return t.direction==="L"}),sh=re.filter(function(t){return t.direction==="S"});
if(lo.length>=3)num.push({label:"RSI Entry (Longs)",bk:[{l:"< 30",s:gs(lo.filter(function(t){return+t.rsiAtEntry<30}))},{l:"30-50",s:gs(lo.filter(function(t){var v=+t.rsiAtEntry;return v>=30&&v<50}))},{l:"50+",s:gs(lo.filter(function(t){return+t.rsiAtEntry>=50}))}]});
if(sh.length>=3)num.push({label:"RSI Entry (Shorts)",bk:[{l:"< 50",s:gs(sh.filter(function(t){return+t.rsiAtEntry<50}))},{l:"50-70",s:gs(sh.filter(function(t){var v=+t.rsiAtEntry;return v>=50&&v<70}))},{l:"70+",s:gs(sh.filter(function(t){return+t.rsiAtEntry>=70}))}]})}
var rp=cp.filter(function(t){return t.rsiAtPeak});
if(rp.length>=3)num.push({label:"RSI at Peak (MFE)",bk:[{l:"< 65",s:gs(rp.filter(function(t){return+t.rsiAtPeak<65}))},{l:"65-75",s:gs(rp.filter(function(t){var v=+t.rsiAtPeak;return v>=65&&v<75}))},{l:"75-85",s:gs(rp.filter(function(t){var v=+t.rsiAtPeak;return v>=75&&v<85}))},{l:"85+",s:gs(rp.filter(function(t){return+t.rsiAtPeak>=85}))}]});
var ve=cp.filter(function(t){return t.volAtExit});
if(ve.length>=3)num.push({label:"Volume at Exit",bk:[{l:"Below",s:gs(ve.filter(function(t){return t.volAtExit==="B"}))},{l:"At Avg",s:gs(ve.filter(function(t){return t.volAtExit==="A"}))},{l:"Above",s:gs(ve.filter(function(t){return t.volAtExit==="H"}))}]});
// Divergence Before Entry
var db=cp.filter(function(t){return t.divBefore});
if(db.length>=3){var dbDir={};db.forEach(function(t){var k=t.divBefore+(t.direction==="L"?" (Long)":" (Short)");if(!dbDir[k])dbDir[k]=[];dbDir[k].push(t)});num.push({label:"Div Before Entry",bk:Object.keys(dbDir).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(dbDir[k])}})})}
// Divergence During Trade
var dd=cp.filter(function(t){return t.divDuring});
if(dd.length>=3){var ddDir={};dd.forEach(function(t){var aligned=(t.direction==="L"&&t.divDuring==="bull")||(t.direction==="S"&&t.divDuring==="bear");var k=t.divDuring+(aligned?" (aligned)":" (against)");if(!ddDir[k])ddDir[k]=[];ddDir[k].push(t)});num.push({label:"Div During Trade",bk:Object.keys(ddDir).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(ddDir[k])}})})}
// MAE Timing
var mt=cp.filter(function(t){return t.maeTiming});
if(mt.length>=3)num.push({label:"MAE Timing",bk:[{l:"Dip First",s:gs(mt.filter(function(t){return t.maeTiming==="dip1st"}))},{l:"Run First",s:gs(mt.filter(function(t){return t.maeTiming==="run1st"}))}]});
var dt=cp.filter(function(t){return cDur(t)});
if(dt.length>=3)num.push({label:"Duration",bk:[{l:"< 10m",s:gs(dt.filter(function(t){return cDur(t).m<10}))},{l:"10-30m",s:gs(dt.filter(function(t){var m=cDur(t).m;return m>=10&&m<30}))},{l:"30m+",s:gs(dt.filter(function(t){return cDur(t).m>=30}))}]});
// Timeframe buckets
var tf=cp.filter(function(t){return t.timeframe});
if(tf.length>=3){var tfBk={};tf.forEach(function(t){if(!tfBk[t.timeframe])tfBk[t.timeframe]=[];tfBk[t.timeframe].push(t)});var bks=Object.keys(tfBk).map(function(k){return{l:k,s:gs(tfBk[k])}});if(bks.length>=2)num.push({label:"Timeframe",bk:bks})}
// Trade # of day
var tn=cp.filter(function(t){return t.tradeNumOfDay});
if(tn.length>=3)num.push({label:"Trade # of Day",bk:[{l:"#1-2",s:gs(tn.filter(function(t){return+t.tradeNumOfDay<=2}))},{l:"#3-4",s:gs(tn.filter(function(t){var v=+t.tradeNumOfDay;return v>=3&&v<=4}))},{l:"#5+",s:gs(tn.filter(function(t){return+t.tradeNumOfDay>=5}))}]});
// Confidence
var cf=cp.filter(function(t){return t.confidence});
if(cf.length>=3)num.push({label:"Confidence",bk:[{l:"1-2 (Low)",s:gs(cf.filter(function(t){return+t.confidence<=2}))},{l:"3 (Med)",s:gs(cf.filter(function(t){return+t.confidence===3}))},{l:"4-5 (High)",s:gs(cf.filter(function(t){return+t.confidence>=4}))}]});
// Emotion
var em=cp.filter(function(t){return t.emotion&&t.emotion!=="calm"});
if(em.length>=2){var emBk={};cp.filter(function(t){return t.emotion}).forEach(function(t){var e=t.emotion;if(!emBk[e])emBk[e]=[];emBk[e].push(t)});var eBks=Object.keys(emBk).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(emBk[k])}});num.push({label:"Emotional State",bk:eBks})}
// Session read
var sr=cp.filter(function(t){return t.sessionRead});
if(sr.length>=3){var srBk={};sr.forEach(function(t){var s=t.sessionRead;if(!srBk[s])srBk[s]=[];srBk[s].push(t)});num.push({label:"Session Read (Yours)",bk:Object.keys(srBk).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(srBk[k])}})})}
// System session vs your read
var dayMap={};cp.forEach(function(t){if(!dayMap[t.date])dayMap[t.date]=[];dayMap[t.date].push(t)});
var matchTrades=[],mismatchTrades=[];
cp.filter(function(t){return t.sessionRead}).forEach(function(t){var sys=sysSession(dayMap[t.date]||[]);if(sys==="unknown")return;if(t.sessionRead===sys)matchTrades.push(t);else mismatchTrades.push(t)});
if(matchTrades.length+mismatchTrades.length>=3)num.push({label:"Your Read vs System",bk:[{l:"Match",s:gs(matchTrades)},{l:"Mismatch",s:gs(mismatchTrades)}]});

// === COMBO ANALYSIS (top 2, 3, 4, 5 rule combos) ===
var combos=[];
if(cp.length>=5){
var activeRules=RK.filter(function(k){return cp.filter(function(t){return t.rules[k]==="Y"}).length>=2});
// 2-rule combos
for(var i=0;i<activeRules.length;i++){for(var j=i+1;j<activeRules.length;j++){
var both=cp.filter(function(t){return t.rules[activeRules[i]]==="Y"&&t.rules[activeRules[j]]==="Y"});
if(both.length>=3){var s=gs(both);combos.push({rules:[RL[activeRules[i]],RL[activeRules[j]]],stats:s,count:2})}}}
// 3-rule combos (only from top 6 rules by edge)
var topRules=activeRules.slice().sort(function(a,b){var ae=Math.abs(yn.find(function(r){return r.key===a})||{edge:0}).edge||0;var be=Math.abs(yn.find(function(r){return r.key===b})||{edge:0}).edge||0;return be-ae}).slice(0,6);
for(var i=0;i<topRules.length;i++){for(var j=i+1;j<topRules.length;j++){for(var k=j+1;k<topRules.length;k++){
var tri=cp.filter(function(t){return t.rules[topRules[i]]==="Y"&&t.rules[topRules[j]]==="Y"&&t.rules[topRules[k]]==="Y"});
if(tri.length>=2){var s=gs(tri);combos.push({rules:[RL[topRules[i]],RL[topRules[j]],RL[topRules[k]]],stats:s,count:3})}}}}
// 4-rule combos (only from top 5 rules, min 4 trades)
var top5=topRules.slice(0,5);
if(cp.length>=10){for(var i=0;i<top5.length;i++){for(var j=i+1;j<top5.length;j++){for(var k=j+1;k<top5.length;k++){for(var l=k+1;l<top5.length;l++){
var quad=cp.filter(function(t){return t.rules[top5[i]]==="Y"&&t.rules[top5[j]]==="Y"&&t.rules[top5[k]]==="Y"&&t.rules[top5[l]]==="Y"});
if(quad.length>=4){var s=gs(quad);combos.push({rules:[RL[top5[i]],RL[top5[j]],RL[top5[k]],RL[top5[l]]],stats:s,count:4})}}}}}}
// 5-rule combos (only from top 5 rules, min 5 trades)
if(cp.length>=15&&top5.length>=5){
var quint=cp.filter(function(t){return top5.every(function(r){return t.rules[r]==="Y"})});
if(quint.length>=5){var s=gs(quint);combos.push({rules:top5.map(function(r){return RL[r]}),stats:s,count:5})}}
combos.sort(function(a,b){if(b.stats.wr!==a.stats.wr)return b.stats.wr-a.stats.wr;return b.stats.ar-a.stats.ar});
combos=combos.slice(0,20)}

// === MIN RULE COUNT CURVE ===
var minRule=[];
for(var n=0;n<=8;n++){var tr=cp.filter(function(t){return ruleCount(t)>=n});if(tr.length>=2)minRule.push({min:n,stats:gs(tr)})}

// === CORRELATION MATRIX ===
var corr=[];
if(cp.length>=5){
var ar2=activeRules||RK.filter(function(k){return cp.filter(function(t){return t.rules[k]==="Y"}).length>=2});
for(var i=0;i<ar2.length;i++){for(var j=i+1;j<ar2.length;j++){
var bothY=cp.filter(function(t){return t.rules[ar2[i]]==="Y"&&t.rules[ar2[j]]==="Y"}).length;
var eitherY=cp.filter(function(t){return t.rules[ar2[i]]==="Y"||t.rules[ar2[j]]==="Y"}).length;
if(eitherY>0){corr.push({a:RL[ar2[i]],b:RL[ar2[j]],overlap:bothY/eitherY,bothN:bothY})}}}
corr.sort(function(a,b){return b.overlap-a.overlap})}

// === ENTRY QUALITY SCORE ===
var scores=[];
if(cp.length>=5&&yn.length>=3){
// Weight = normalized edge for each rule
var maxEdge=Math.max.apply(null,yn.filter(function(r){return RK.indexOf(r.key)>=0}).map(function(r){return Math.abs(r.edge)}));
if(maxEdge>0){
var weights={};yn.forEach(function(r){if(RK.indexOf(r.key)>=0)weights[r.key]=r.edge/maxEdge});
scores=cp.map(function(t){var score=0,maxScore=0;
RK.forEach(function(k){if(weights[k]!==undefined){var w=Math.abs(weights[k]);maxScore+=w;if(t.rules[k]==="Y"&&weights[k]>0)score+=w;else if(t.rules[k]==="Y"&&weights[k]<0)score-=w*0.5}});
var pct=maxScore>0?Math.round(score/maxScore*100):0;
return{id:t.id,score:pct,pl:cPL(t).pl,rm:cPL(t).rm,date:t.date,ticker:t.ticker}}).sort(function(a,b){return b.score-a.score})}}

// === CONDITIONAL EDGE ===
var cond=[];
if(cp.length>=8){
var topYN=yn.filter(function(r){return RK.indexOf(r.key)>=0}).slice(0,6);
for(var i=0;i<topYN.length;i++){for(var j=0;j<topYN.length;j++){if(i===j)continue;
var base=cp.filter(function(t){return t.rules[topYN[i].key]==="Y"});
var added=base.filter(function(t){return t.rules[topYN[j].key]==="Y"});
var without=base.filter(function(t){return t.rules[topYN[j].key]==="N"});
if(added.length>=2&&without.length>=2){var inc=gs(added).wr-gs(without).wr;
cond.push({base:topYN[i].label,add:topYN[j].label,incr:inc,addStats:gs(added),woStats:gs(without)})}}}}
cond.sort(function(a,b){return Math.abs(b.incr)-Math.abs(a.incr)});
cond=cond.slice(0,12);

// === EDGE DECAY ===
var decay=[];
if(cp.length>=10){
var sorted_cp=cp.slice().sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)});
var last20=sorted_cp.slice(-20);var last10=sorted_cp.slice(-10);
RK.forEach(function(k){
var all_y=cp.filter(function(t){return t.rules[k]==="Y"});if(all_y.length<3)return;
var l20_y=last20.filter(function(t){return t.rules[k]==="Y"});
var l10_y=last10.filter(function(t){return t.rules[k]==="Y"});
var all_s=gs(all_y),l20_s=l20_y.length>=2?gs(l20_y):null,l10_s=l10_y.length>=2?gs(l10_y):null;
var decaying=(l10_s&&l10_s.wr<all_s.wr-0.15)||(l20_s&&l20_s.wr<all_s.wr-0.10);
decay.push({key:k,label:RL[k],allTime:all_s,last20:l20_s,last10:l10_s,decaying:decaying,allN:all_y.length})});
// Also check top combos for decay
if(combos.length>=3){combos.slice(0,5).forEach(function(c){
var all_y=cp.filter(function(t){return c.rules.every(function(rl){var k=Object.keys(RL).find(function(x){return RL[x]===rl});return k&&t.rules[k]==="Y"})});
if(all_y.length<5)return;
var sorted_y=all_y.slice().sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)});
var l10_y=sorted_y.slice(-10);var l20_y=sorted_y.slice(-20);
var all_s=gs(all_y),l20_s=l20_y.length>=3?gs(l20_y):null,l10_s=l10_y.length>=3?gs(l10_y):null;
var decaying=(l10_s&&l10_s.wr<all_s.wr-0.15)||(l20_s&&l20_s.wr<all_s.wr-0.10);
decay.push({key:"combo_"+c.rules.join("_"),label:c.rules.join(" + "),allTime:all_s,last20:l20_s,last10:l10_s,decaying:decaying,allN:all_y.length,isCombo:true})})}
decay.sort(function(a,b){return b.decaying-a.decaying||b.allN-a.allN})}

// === EXIT PLANNING ANALYSIS ===
var exitAnalysis={targetTypes:[],captureAnalysis:null,partialAnalysis:null,multiTargetAnalysis:null};
var tradesWithTargets=cp.filter(function(t){return t.targets&&t.targets.length>0&&t.entry&&t.exit});
if(tradesWithTargets.length>=3){
// Target type hit rate
var typeMap={};
tradesWithTargets.forEach(function(t){(t.targets||[]).forEach(function(tgt){if(!tgt.type)return;if(!typeMap[tgt.type])typeMap[tgt.type]={hits:0,total:0,rWhenHit:[],rWhenMiss:[]};typeMap[tgt.type].total++;if(tgt.isHit==="Y"){typeMap[tgt.type].hits++;var r=cPL(t).rm;typeMap[tgt.type].rWhenHit.push(r)}else if(tgt.isHit==="N"){var r=cPL(t).rm;typeMap[tgt.type].rWhenMiss.push(r)}})});
exitAnalysis.targetTypes=Object.keys(typeMap).map(function(k){var d=typeMap[k];var ttLabel=(TARGET_TYPES.find(function(x){return x.v===k})||{l:k}).l;return{type:k,label:ttLabel,total:d.total,hitRate:d.hits/d.total,avgRHit:d.rWhenHit.length?d.rWhenHit.reduce(function(s,v){return s+v},0)/d.rWhenHit.length:null,avgRMiss:d.rWhenMiss.length?d.rWhenMiss.reduce(function(s,v){return s+v},0)/d.rWhenMiss.length:null}}).filter(function(x){return x.total>=2}).sort(function(a,b){return b.hitRate-a.hitRate});
// MFE vs actual capture
var mfeTrades=cp.filter(function(t){return t.mfePrice&&t.entry&&t.exit});
if(mfeTrades.length>=3){var capData=mfeTrades.map(function(t){var mfe=cMFE(t);return mfe&&mfe.cp!==null?mfe.cp:null}).filter(function(v){return v!==null});exitAnalysis.captureAnalysis={count:capData.length,avg:capData.reduce(function(s,v){return s+v},0)/capData.length,pct70plus:capData.filter(function(v){return v>=0.7}).length/capData.length,pct50minus:capData.filter(function(v){return v<0.5}).length/capData.length}}
// Trend end (left on table)
var trendEndTrades=cp.filter(function(t){return t.trendEndPrice&&t.entry&&t.exit&&t.mfePrice});
if(trendEndTrades.length>=3){var leftOnTable=trendEndTrades.map(function(t){var e=+t.entry,mfe=+t.mfePrice,te=+t.trendEndPrice,rk=Math.abs(e-(+t.stop||0));if(rk<=0)return null;var mfeDist=t.direction==="L"?mfe-e:e-mfe;var teDist=t.direction==="L"?te-e:e-te;return teDist>0&&mfeDist>0?{leftR:(teDist-mfeDist)/rk,leftPct:(teDist-mfeDist)/teDist}:null}).filter(Boolean);if(leftOnTable.length>=2){exitAnalysis.leftOnTable={count:leftOnTable.length,avgLeftR:leftOnTable.reduce(function(s,v){return s+v.leftR},0)/leftOnTable.length,avgLeftPct:leftOnTable.reduce(function(s,v){return s+v.leftPct},0)/leftOnTable.length}}}
// Partial vs Full analysis
var partialTrades=cp.filter(function(t){return t.hasPartial==="Y"&&t.partialExitPrice&&t.partialPct&&t.entry&&t.exit});
var fullTrades=cp.filter(function(t){return t.hasPartial==="N"});
if(partialTrades.length>=3||fullTrades.length>=3){exitAnalysis.partialAnalysis={partialStats:partialTrades.length>=2?gs(partialTrades):null,fullStats:fullTrades.length>=2?gs(fullTrades):null,partialCount:partialTrades.length,fullCount:fullTrades.length}}}

return{yn:yn,num:num,combos:combos,minRule:minRule,corr:corr,scores:scores,cond:cond,decay:decay,exitAnalysis:exitAnalysis}},[cp]);
// === TIME AUTO-FORMAT ===
function fmtTime(v){var d=v.replace(/\D/g,"");if(d.length>=4){return d.slice(0,2)+":"+d.slice(2,4)}return v}
// === FORM ===
function rF(){if(!et)return null;var t=et;
function u(k,v){setEt(function(p){var c=dc(p);c[k]=v;return c})}
function uR(k,v){setEt(function(p){var c=dc(p);c.rules[k]=v;return c})}
function uS(k,v){setEt(function(p){var c=dc(p);c.stopMgmt[k]=v;return c})}
function onTimeBlur(field,v){if(/^\d{3,4}$/.test(v.replace(/\D/g,""))){u(field,fmtTime(v))}}
var img=t.screenshotData||t.screenshotUrl;
var pp=(t.entry&&t.exit&&t.shares)?cPL(t):null;
var mf=(t.entry&&t.mfePrice)?cMFE(t):null;
var ma=(t.entry&&t.maePrice)?cMAE(t):null;
var du=cDur(t);
var pv=[];
if(pp){pv.push(h("div",{key:"pl",style:{flex:1,textAlign:"center",minWidth:55}},h("div",{style:{fontSize:8,color:K.dm}},"P/L"),h("div",{style:{fontSize:13,fontWeight:700,color:pp.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},"$"+pp.pl.toFixed(2))));pv.push(h("div",{key:"r",style:{flex:1,textAlign:"center",minWidth:45}},h("div",{style:{fontSize:8,color:K.dm}},"R"),h("div",{style:{fontSize:13,fontWeight:700,color:pp.rm>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},pp.rm.toFixed(2)+"R")))}
if(du)pv.push(h("div",{key:"d",style:{flex:1,textAlign:"center",minWidth:50}},h("div",{style:{fontSize:8,color:K.dm}},"Dur"),h("div",{style:{fontSize:13,fontWeight:700,color:K.go,fontFamily:"JetBrains Mono,monospace"}},du.l)));
if(mf&&mf.cp!==null)pv.push(h("div",{key:"c",style:{flex:1,textAlign:"center",minWidth:50}},h("div",{style:{fontSize:8,color:K.dm}},"Cap"),h("div",{style:{fontSize:13,fontWeight:700,color:mf.cp>=.7?K.g:mf.cp>=.5?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},(mf.cp*100).toFixed(0)+"%")));
if(ma)pv.push(h("div",{key:"m",style:{flex:1,textAlign:"center",minWidth:50}},h("div",{style:{fontSize:8,color:K.dm}},"MAE"),h("div",{style:{fontSize:13,fontWeight:700,color:K.r,fontFamily:"JetBrains Mono,monospace"}},"-$"+ma.md.toFixed(2))));
var re=RK.map(function(k){return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"3px 7px",background:K.bg,borderRadius:6}},h("span",{style:{fontSize:10,color:K.dm}},RL[k]),h(YN,{v:t.rules[k],onChange:function(v){uR(k,v)}}))});
var se=Object.keys(SL).map(function(k){return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"3px 7px",background:K.bg,borderRadius:6}},h("span",{style:{fontSize:10,color:K.dm}},SL[k]),h(YN,{v:t.stopMgmt[k],onChange:function(v){uS(k,v)}}))});
var qe=["macdCross","rsiExtreme","cloudAlign","chanRetest","cloud15m"].map(function(k){return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"3px 7px",background:K.bg,borderRadius:6}},h("span",{style:{fontSize:10,color:K.dm}},RL[k]),h(YN,{v:t.rules[k],onChange:function(v){uR(k,v)}}))});
var g4="1fr 1fr 1fr 1fr",g3="1fr 1fr 1fr";
// Section label helper
function SL2(label,color,tip){return h("div",{style:{fontSize:10,fontWeight:700,color:color||K.go,marginBottom:5,marginTop:4,display:"flex",alignItems:"center",borderBottom:"1px solid "+K.bd,paddingBottom:4}},label,tip?h(Tip,{t:tip}):null)}
return h("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.85)",zIndex:1000,overflow:"auto",padding:"16px 8px"}},
h("div",{style:{maxWidth:qm?580:880,margin:"0 auto",background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:20}},
// Header
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14,flexWrap:"wrap",gap:6}},
h("div",{style:{display:"flex",alignItems:"center",gap:8}},h("h2",{style:{color:K.go,fontSize:15,margin:0,fontFamily:"JetBrains Mono,monospace"}},qm?"QUICK ENTRY":"TRADE ENTRY"),h("span",{style:{fontSize:9,padding:"2px 8px",borderRadius:4,background:t.mode==="backtest"?K.pu:K.cy,color:"#fff",fontWeight:600}},t.mode==="backtest"?"BT":"LIVE")),
h("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},h(Pl,{v:t.mode,onChange:function(v){u("mode",v)},options:[{v:"live",l:"Live",c:K.cy},{v:"backtest",l:"BT",c:K.pu}]}),h("button",{onClick:function(){sQm(!qm)},style:{padding:"4px 8px",background:qm?K.cy:K.pu,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer"}},qm?"Full":"Quick"),h("button",{onClick:function(){setSf(false);setEt(null)},style:{padding:"4px 8px",background:K.r,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer"}},"Cancel"))),

// === BLOCK 1: IDENTITY — Direction + Type + Strategy ===
SL2("TRADE IDENTITY",K.go),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Direction",h(Tip,{t:"Long = betting price goes up. Short = betting price goes down."})),h(Pl,{v:t.direction,onChange:function(v){u("direction",v)},options:[{v:"L",l:"LONG",c:K.g},{v:"S",l:"SHORT",c:K.r}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Type",h(Tip,{t:"Reversal = entering against the prior trend. Continuation = entering in the direction of the trend."})),h(Pl,{v:t.type,onChange:function(v){u("type",v)},options:[{v:"Rev",l:"Reversal",c:K.cy},{v:"Cont",l:"Continuation",c:K.go}]}))),
userStrats.length?h("div",{style:{marginBottom:12}},
h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Strategy",h(Tip,{t:"Which strategy are you using for this trade? Rules below will update based on your selection."})),
h("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},
h("button",{onClick:function(){u("strategyId","")},style:{padding:"5px 10px",borderRadius:5,border:"1px solid "+K.bd,fontSize:11,fontWeight:600,cursor:"pointer",background:!t.strategyId?K.dm:"transparent",color:!t.strategyId?"#fff":K.dm}},"None"),
userStrats.map(function(s){return h("button",{key:s.id,onClick:function(){u("strategyId",s.id)},style:{padding:"5px 12px",borderRadius:5,border:"1px solid "+(t.strategyId===s.id?K.go:K.bd),fontSize:11,fontWeight:600,cursor:"pointer",background:t.strategyId===s.id?K.go:"transparent",color:t.strategyId===s.id?"#000":K.dm}},s.name)}))):null,

// === BLOCK 2: CAN'T RECOVER LATER ===
SL2("NOW — CAN'T RECOVER LATER",K.r,"Fill these in real-time. Emotion, confidence, and session read cannot be reconstructed from broker records or screenshots."),
h("div",{style:{display:"grid",gridTemplateColumns:"60px 1fr 1fr 1fr 80px",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trade#",h(Tip,{t:"Which trade is this in your session today? Auto-generated but you can correct it."})),h(Ip,{value:t.tradeNumOfDay,onChange:function(v){u("tradeNumOfDay",v)},type:"number",placeholder:"1"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Session",h(Tip,{t:"Your read of the overall market session. Trending = clear direction. Ranging = bouncing. Choppy = no clean moves. Breakout = breaking key level. Reversal = changing direction."})),h(Sel,{value:t.sessionRead,onChange:function(v){u("sessionRead",v)},options:[{v:"",l:"--"}].concat(SESSIONS.map(function(s){return{v:s,l:s.charAt(0).toUpperCase()+s.slice(1)}}))})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Confidence",h(Tip,{t:"How confident were you in this setup at entry? 1 = very unsure, 5 = high conviction."})),h(Pl,{v:t.confidence,onChange:function(v){u("confidence",v)},options:[{v:"1",l:"1"},{v:"2",l:"2"},{v:"3",l:"3"},{v:"4",l:"4"},{v:"5",l:"5"}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Emotion",h(Tip,{t:"Your emotional state at entry. Calm = ideal. FOMO = fear of missing out. Revenge = trading to recover losses."})),h(Sel,{value:t.emotion,onChange:function(v){u("emotion",v)},options:EMOTIONS.map(function(e){return{v:e,l:e.charAt(0).toUpperCase()+e.slice(1)}})})),
h("div",null,h("div",{style:{fontSize:10,color:K.go,marginBottom:3}},"Followed?",h(Tip,{t:"Did this trade meet your minimum entry criteria? The most powerful metric in the journal — measures the real cost of breaking discipline."})),h(YN,{v:t.followedRules,onChange:function(v){u("followedRules",v)}}))),

// === BLOCK 3: MARKET CONTEXT ===
SL2("MARKET CONTEXT",K.pu,"Technical conditions at entry. Can be filled from screenshots after the session."),
h("div",{style:{display:"grid",gridTemplateColumns:"80px 1fr 1fr 1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"TF",h(Tip,{t:"Timeframe you used for entry."})),h(Sel,{value:t.timeframe,onChange:function(v){u("timeframe",v)},options:TFS.map(function(tf){return{v:tf,l:tf}})})),
h("div",null,h("div",{style:{fontSize:10,color:K.pu,marginBottom:3}},"Cloud Dir",h(Tip,{t:"EMA cloud direction at entry. Bullish = cloud sloping up. Bearish = cloud sloping down."})),h(Pl,{v:t.cloudDirection,onChange:function(v){u("cloudDirection",v)},options:[{v:"",l:"--"},{v:"bull",l:"Bull",c:K.g},{v:"bear",l:"Bear",c:K.r}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.pu,marginBottom:3}},"Cloud W%",h(Tip,{t:"Width of the EMA cloud as a percentage of price. Wider cloud = stronger trend. Example: 0.25 = 0.25% wide."})),h(Ip,{value:t.cloudThickness,onChange:function(v){u("cloudThickness",v)},type:"number",step:"0.01",placeholder:"0.25"})),
h("div",null,h("div",{style:{fontSize:10,color:K.go,marginBottom:3}},"ADX",h(Tip,{t:"Average Directional Index at entry. Measures trend strength. Under 20 = weak/choppy. 20-25 = developing. 25+ = strong trend."})),h(Ip,{value:t.adxAtEntry,onChange:function(v){u("adxAtEntry",v)},type:"number",step:"0.1",placeholder:"25"})),
h("div",null,h("div",{style:{fontSize:10,color:K.go,marginBottom:3}},"RSI Entry",h(Tip,{t:"RSI value at your entry. Under 30 = oversold. 30-50 = bearish zone. 50-70 = bullish zone. 70+ = overbought."})),h(Ip,{value:t.rsiAtEntry,onChange:function(v){u("rsiAtEntry",v)},type:"number",step:"0.1",placeholder:"45"}))),

// === BLOCK 4: REAL TRADE DATA ===
SL2("TRADE DATA","#e0e6ed","Prices, times, and execution data. Recoverable from broker records after the session."),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Date"),h(Ip,{value:t.date,onChange:function(v){u("date",v)},type:"date"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Entry Time",h(Tip,{t:"Time you entered the trade. Type 1032 and it auto-formats to 10:32."})),h(Ip,{value:t.time,onChange:function(v){u("time",v)},onBlur:function(e){onTimeBlur("time",e.target.value)},placeholder:"10:32"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Exit Time"),h(Ip,{value:t.exitTime,onChange:function(v){u("exitTime",v)},onBlur:function(e){onTimeBlur("exitTime",e.target.value)},placeholder:"10:47"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Ticker"),h(Ip,{value:t.ticker,onChange:function(v){u("ticker",v.toUpperCase())},placeholder:"TSLA"}))),
h("div",{style:{display:"grid",gridTemplateColumns:g4,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Entry $",h(Tip,{t:"Your fill price when entering the trade."})),h(Ip,{value:t.entry,onChange:function(v){u("entry",v)},type:"number",step:"0.01",placeholder:"452.30"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Stop $",h(Tip,{t:"Your initial stop loss price. Used to calculate R-multiple (risk unit)."})),h(Ip,{value:t.stop,onChange:function(v){u("stop",v)},type:"number",step:"0.01",placeholder:"451.10"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Exit $",h(Tip,{t:"Your fill price when exiting the trade."})),h(Ip,{value:t.exit,onChange:function(v){u("exit",v)},type:"number",step:"0.01",placeholder:"454.80"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Shares",h(Tip,{t:"Number of shares or contracts traded."})),h(Ip,{value:t.shares,onChange:function(v){u("shares",v)},type:"number",placeholder:"400"}))),
h("div",{style:{display:"grid",gridTemplateColumns:g4,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.cy,marginBottom:3}},t.direction==="L"?"MFE — High $":"MFE — Low $",h(Tip,{t:"Maximum Favorable Excursion — the best price the trade reached while you were in it. For longs: highest price. For shorts: lowest price."})),h(Ip,{value:t.mfePrice,onChange:function(v){u("mfePrice",v)},type:"number",step:"0.01"})),
h("div",null,h("div",{style:{fontSize:10,color:K.r,marginBottom:3}},t.direction==="L"?"MAE — Low $":"MAE — High $",h(Tip,{t:"Maximum Adverse Excursion — the worst drawdown price while you were in the trade. For longs: lowest price hit. For shorts: highest price hit."})),h(Ip,{value:t.maePrice,onChange:function(v){u("maePrice",v)},type:"number",step:"0.01"})),
h("div",null,h("div",{style:{fontSize:10,color:K.cy,marginBottom:3}},"RSI at Peak",h(Tip,{t:"RSI value at the MFE — the best price. Helps identify when RSI signals a reversal from the peak."})),h(Ip,{value:t.rsiAtPeak,onChange:function(v){u("rsiAtPeak",v)},type:"number",step:"0.1",placeholder:"78"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"RSI at Exit",h(Tip,{t:"RSI value at your exit price."})),h(Ip,{value:t.rsiAtExit,onChange:function(v){u("rsiAtExit",v)},type:"number",step:"0.1",placeholder:"72"}))),
// MAE Timing + Div Before + Div During
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{display:"flex",alignItems:"center",fontSize:10,color:K.dm,marginBottom:3}},"MAE Timing",h(Tip,{t:"Did the worst drawdown happen before or after the best price? Dip First = hit stop area then ran. Run First = ran to MFE then pulled back. Measures momentum quality."})),h(Pl,{v:t.maeTiming,onChange:function(v){u("maeTiming",v)},options:[{v:"",l:"--"},{v:"dip1st",l:"Dip First",c:K.go},{v:"run1st",l:"Run First",c:K.cy}]})),
h("div",null,h("div",{style:{display:"flex",alignItems:"center",fontSize:10,color:K.go,marginBottom:3}},"Div Before Entry",h(Tip,{t:"Was divergence building before your entry? Bullish div = price making lower lows but RSI making higher lows. Bearish = opposite."})),h(Pl,{v:t.divBefore,onChange:function(v){u("divBefore",v)},options:DIVS})),
h("div",null,h("div",{style:{display:"flex",alignItems:"center",fontSize:10,color:K.cy,marginBottom:3}},"Div During Trade",h(Tip,{t:"Did divergence form while in the trade? Signals potential exit point."})),h(Pl,{v:t.divDuring,onChange:function(v){u("divDuring",v)},options:DIVS}))),
// Exit details row
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Exit Type",h(Tip,{t:"How did you exit? Trail = trailing stop hit. Limit = hit your target. Stopped = initial stop hit."})),h(Pl,{v:t.exitType,onChange:function(v){u("exitType",v)},options:[{v:"Trail",l:"Trail",c:K.g},{v:"Limit",l:"Limit",c:K.go},{v:"Stop",l:"Stopped",c:K.r}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Vol at Exit",h(Tip,{t:"Volume at time of exit relative to average. High volume exits on wins = strong momentum. Low volume = potential for more."})),h(Pl,{v:t.volAtExit,onChange:function(v){u("volAtExit",v)},options:[{v:"B",l:"Below",c:K.r},{v:"A",l:"At Avg",c:K.go},{v:"H",l:"Above",c:K.g}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trend End $",h(Tip,{t:"Where did the move ultimately top or bottom AFTER you exited? Shows how much you left on the table post-exit."})),h(Ip,{value:t.trendEndPrice,onChange:function(v){u("trendEndPrice",v)},type:"number",step:"0.01",placeholder:"456.20"}))),
// Trail details (only if exit type is Trail)
t.exitType==="Trail"?h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trail TF",h(Tip,{t:"Which timeframe chart did you use to trail your stop?"})),h(Pl,{v:t.trailTimeframe,onChange:function(v){u("trailTimeframe",v)},options:[{v:"",l:"--"},{v:"1m",l:"1m",c:K.g},{v:"3m",l:"3m",c:K.go},{v:"5m",l:"5m",c:K.cy},{v:"same",l:"Same",c:K.pu}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trail Stop $",h(Tip,{t:"The actual trailing stop price when it was hit. Combined with MFE shows exactly how much you gave back from peak."})),h(Ip,{value:t.trailStopPrice,onChange:function(v){u("trailStopPrice",v)},type:"number",step:"0.01"}))):null,
// Partial exit
h("div",{style:{marginBottom:8}},
h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
h("div",{style:{fontSize:10,color:K.dm,fontWeight:700}},"Partial Exit?",h(Tip,{t:"Did you take a partial exit on this trade? Analysis will compare blended R of partial strategy vs full exit."})),
h(Pl,{v:t.hasPartial,onChange:function(v){u("hasPartial",v)},options:[{v:"",l:"--"},{v:"Y",l:"Yes",c:K.g},{v:"N",l:"No",c:K.dm}]})),
t.hasPartial==="Y"?h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Partial Exit $",h(Tip,{t:"Price at which you took your partial exit."})),h(Ip,{value:t.partialExitPrice,onChange:function(v){u("partialExitPrice",v)},type:"number",step:"0.01"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"% Exited",h(Tip,{t:"What percentage of your position did you exit partially?"})),h(Pl,{v:t.partialPct,onChange:function(v){u("partialPct",v)},options:[{v:"",l:"--"},{v:"25",l:"25%",c:K.go},{v:"33",l:"33%",c:K.go},{v:"50",l:"50%",c:K.cy},{v:"75",l:"75%",c:K.pu}]}))):null),

// === EXIT PLANNING — TARGET BUILDER ===
!qm?h("div",{style:{marginBottom:8}},
SL2("EXIT PLANNING — TARGETS",K.cy,"Plan your exits before entering the trade. Define where you planned to take profits — analysis will show which target types you actually hit vs miss."),
function(){
var targets=t.targets||[];
function uTarget(idx,field,val){setEt(function(p){var c=dc(p);if(!c.targets)c.targets=[];var arr=c.targets.slice();if(!arr[idx])arr[idx]=mkTarget();arr[idx]=Object.assign({},arr[idx]);arr[idx][field]=val;c.targets=arr;return c})}
function addTarget(){setEt(function(p){var c=dc(p);c.targets=(c.targets||[]).concat([mkTarget()]);return c})}
function removeTarget(idx){setEt(function(p){var c=dc(p);c.targets=(c.targets||[]).filter(function(_,i){return i!==idx});return c})}
function calcTargetR(tgt){if(!t.entry||!t.stop||!tgt.price)return null;var e=+t.entry,s=+t.stop,tp=+tgt.price;var rk=Math.abs(e-s);if(rk<=0)return null;var rv=t.direction==="L"?(tp-e)/rk:(e-tp)/rk;return rv.toFixed(2)}
return h("div",null,
targets.length===0?h("div",{style:{fontSize:10,color:K.dm,marginBottom:8,padding:"8px 10px",background:K.bg,borderRadius:6,borderLeft:"2px solid "+K.cy}},"Add targets before entering. Multi-slot targets (T1, T2, T3) appear when Partial Exit is set to Yes — match each target to a partial exit."):null,
targets.map(function(tgt,idx){
var autoR=calcTargetR(tgt);
return h("div",{key:tgt.id||idx,style:{background:K.bg,borderRadius:8,border:"1px solid "+K.bd,padding:"8px 10px",marginBottom:6}},
h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}},
h("div",{style:{display:"flex",alignItems:"center",gap:6}},
h("span",{style:{fontSize:11,fontWeight:700,color:K.cy,fontFamily:"JetBrains Mono,monospace"}},"T"+(idx+1)),
autoR?h("span",{style:{fontSize:10,color:+autoR>=1?K.g:+autoR>=0?K.go:K.r,fontFamily:"JetBrains Mono,monospace",fontWeight:700}},autoR+"R"):null),
h("div",{style:{display:"flex",alignItems:"center",gap:4}},
h("span",{style:{fontSize:9,color:K.dm,marginRight:2}},"Hit?"),
h(Pl,{v:tgt.isHit,onChange:function(v){uTarget(idx,"isHit",v)},options:[{v:"",l:"--"},{v:"Y",l:"Y",c:K.g},{v:"N",l:"N",c:K.r}]}),
h("button",{onClick:function(){removeTarget(idx)},style:{padding:"2px 7px",background:"transparent",border:"1px solid "+K.r+"44",borderRadius:4,color:K.r,fontSize:9,cursor:"pointer",marginLeft:4}},"\u00d7"))),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:6}},
h("div",null,h("div",{style:{fontSize:9,color:K.dm,marginBottom:3}},"Target Type"),
h("select",{value:tgt.type||"",onChange:function(e){uTarget(idx,"type",e.target.value)},style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"5px 8px",color:tgt.type?K.tx:K.dm,fontSize:11,width:"100%",outline:"none"}},TARGET_TYPES.map(function(tt){return h("option",{key:tt.v,value:tt.v},tt.l)}))),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,marginBottom:3}},"Timeframe"),
h("select",{value:tgt.tf||"",onChange:function(e){uTarget(idx,"tf",e.target.value)},style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"5px 8px",color:tgt.tf?K.tx:K.dm,fontSize:11,width:"100%",outline:"none"}},TARGET_TF_LABELS.options.map(function(o){return h("option",{key:o.v,value:o.v},o.l)}))),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,marginBottom:3}},"Target $"),
h(Ip,{value:tgt.price,onChange:function(v){uTarget(idx,"price",v)},type:"number",step:"0.01",placeholder:"Target price"}))
))
}),
h("button",{onClick:addTarget,style:{width:"100%",padding:"6px",background:"transparent",border:"1px dashed "+K.cy+"44",borderRadius:6,color:K.cy,fontSize:10,cursor:"pointer",marginTop:2}},"\u2295 Add Target "+({0:"",1:"(T2 — Multi-target)",2:"(T3)"}[targets.length]||"(T"+(targets.length+1)+")")))
}()):null,

// Emotion During + After
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Emotion During",h(Tip,{t:"How did you feel while in the trade? Anxious/Impatient often leads to early exits. Greedy can lead to late exits."})),h(Sel,{value:t.emotionDuring,onChange:function(v){u("emotionDuring",v)},options:[{v:"",l:"--"}].concat(EMOTIONS_DURING.map(function(e){return{v:e,l:e.charAt(0).toUpperCase()+e.slice(1)}}))})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Emotion After",h(Tip,{t:"How did you feel after the trade closed? Regret and revenge are the two most expensive emotions in trading."})),h(Sel,{value:t.emotionAfter,onChange:function(v){u("emotionAfter",v)},options:[{v:"",l:"--"}].concat(EMOTIONS_AFTER.map(function(e){return{v:e,l:e.charAt(0).toUpperCase()+e.slice(1)}}))})),
),

// P/L preview
pv.length?h("div",{style:{display:"flex",gap:4,marginBottom:10,padding:6,background:K.bg,borderRadius:8,flexWrap:"wrap"}},pv):null,

// === BLOCK 5: SCREENSHOTS ===
SL2("SCREENSHOTS",K.cy,"Capture both entry and exit charts. Entry screenshot = your setup at the moment you entered. Exit screenshot = chart at close."),
function(){
var img=t.screenshotData||t.screenshotUrl;
var img2=t.exitScreenshotData||t.exitScreenshotUrl;
return h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:12}},
// Entry screenshot
h("div",null,
h("div",{style:{fontSize:10,color:K.dm,marginBottom:3,fontWeight:600}},"Entry Chart",h(Tip,{t:"Screenshot of the chart at your entry point. Capture your setup as it looked when you pulled the trigger."})),
h("div",{style:{display:"flex",gap:4,marginBottom:3}},
h(Ip,{value:t.screenshotUrl,onChange:function(v){u("screenshotUrl",v)},placeholder:"Paste URL...",style:{flex:1,fontSize:11}}),
h("button",{onClick:function(){fr.current&&fr.current.click()},style:{padding:"4px 8px",background:K.cy,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer",flexShrink:0}},"Upload"),
h("input",{ref:fr,type:"file",accept:"image/*",onChange:hF,style:{display:"none"}})),
h("div",{onDrop:hD,onDragOver:function(e){e.preventDefault()},style:{border:"2px dashed "+K.bd,borderRadius:8,padding:img?4:12,textAlign:"center",color:K.dm,fontSize:10,cursor:"pointer",minHeight:img?36:60,display:"flex",alignItems:"center",justifyContent:"center",background:K.bg,position:"relative"}},
img?h("div",{style:{position:"relative",width:"100%"}},
h("img",{src:img,alt:"",onClick:function(){setLb(img)},style:{maxWidth:"100%",maxHeight:120,borderRadius:6,cursor:"zoom-in",display:"block",margin:"0 auto"}}),
h("button",{onClick:function(e){e.stopPropagation();u("screenshotUrl","");u("screenshotData","")},style:{position:"absolute",top:2,right:2,padding:"1px 5px",background:"rgba(0,0,0,.7)",border:"none",borderRadius:3,color:K.r,fontSize:9,cursor:"pointer"}},"×"))
:"Drag & drop")),
// Exit screenshot
h("div",null,
h("div",{style:{fontSize:10,color:K.dm,marginBottom:3,fontWeight:600}},"Exit Chart",h(Tip,{t:"Screenshot of the chart at your exit point. Capture what the setup looked like when you closed the trade — useful for reviewing exit quality."})),
h("div",{style:{display:"flex",gap:4,marginBottom:3}},
h(Ip,{value:t.exitScreenshotUrl,onChange:function(v){u("exitScreenshotUrl",v)},placeholder:"Paste URL...",style:{flex:1,fontSize:11}}),
h("button",{onClick:function(){fr2.current&&fr2.current.click()},style:{padding:"4px 8px",background:K.cy,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer",flexShrink:0}},"Upload"),
h("input",{ref:fr2,type:"file",accept:"image/*",onChange:hF2,style:{display:"none"}})),
h("div",{onDrop:hD2,onDragOver:function(e){e.preventDefault()},style:{border:"2px dashed "+K.bd,borderRadius:8,padding:img2?4:12,textAlign:"center",color:K.dm,fontSize:10,cursor:"pointer",minHeight:img2?36:60,display:"flex",alignItems:"center",justifyContent:"center",background:K.bg,position:"relative"}},
img2?h("div",{style:{position:"relative",width:"100%"}},
h("img",{src:img2,alt:"",onClick:function(){setLb(img2)},style:{maxWidth:"100%",maxHeight:120,borderRadius:6,cursor:"zoom-in",display:"block",margin:"0 auto"}}),
h("button",{onClick:function(e){e.stopPropagation();u("exitScreenshotUrl","");u("exitScreenshotData","")},style:{position:"absolute",top:2,right:2,padding:"1px 5px",background:"rgba(0,0,0,.7)",border:"none",borderRadius:3,color:K.r,fontSize:9,cursor:"pointer"}},"×"))
:"Drag & drop")))
}(),

// === BLOCK 6: RULES (Full mode only) ===
!qm?h("div",null,
function(){
var activeStrat=userStrats.find(function(s){return s.id===t.strategyId});
if(activeStrat){
var coreKeys=Object.keys(activeStrat.coreRules||{});
var addonKeys=activeStrat.addons||[];
var coreRows=coreKeys.map(function(k){var lbl=activeStrat.coreRules[k]||getIndLabel(k);var tip=getIndTip(k);return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 8px",background:K.bg,borderRadius:6,borderLeft:"2px solid "+K.go}},h("span",{style:{fontSize:11,color:K.tx}},lbl,tip?h(Tip,{t:tip}):null),h(YN,{v:t.rules[k]||"",onChange:function(v){uR(k,v)}}))});
var addonRows=addonKeys.map(function(k){var lbl=getIndLabel(k);var tip=getIndTip(k);return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 8px",background:K.bg,borderRadius:6,borderLeft:"2px solid "+K.pu}},h("span",{style:{fontSize:11,color:K.tx}},lbl,tip?h(Tip,{t:tip}):null),h(YN,{v:t.rules[k]||"",onChange:function(v){uR(k,v)}}))});
return h("div",null,
h("div",{style:{fontSize:10,fontWeight:700,color:K.go,marginBottom:4,marginTop:4,display:"flex",alignItems:"center",borderBottom:"1px solid "+K.bd,paddingBottom:4}},activeStrat.name+" — Core Rules",h(Tip,{t:"Core rules for your "+activeStrat.name+" strategy. These define the setup."})),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4,marginBottom:10}},coreRows),
addonKeys.length?h("div",null,
h("div",{style:{fontSize:10,fontWeight:700,color:K.pu,marginBottom:4,display:"flex",alignItems:"center",borderBottom:"1px solid "+K.bd,paddingBottom:4}},"Add-on Indicators",h(TierBadge,{tier:"t1"})),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4,marginBottom:10}},addonRows)):null)
}
// Default: original rules
return h("div",null,
SL2("SETUP RULES",K.go,"Mark Y/N for each rule present in your setup. This data feeds the Rule Edge Analysis to show which rules matter most."),
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:4,marginBottom:10}},re))
}(),
SL2("STOP MANAGEMENT",K.r,"Track how you managed your stop on this trade. The analysis will show which stop strategies protect profits best."),
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:4,marginBottom:10}},se),
h("div",{style:{marginBottom:10}},h("div",{style:{fontSize:10,color:K.dm,marginBottom:2}},"Notes"),h(Ip,{value:t.notes,onChange:function(v){u("notes",v)},placeholder:"Trade notes..."}))):null,
qm?h("div",{style:{marginBottom:10}},
SL2("QUICK RULES",K.go),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4}},qe)):null,
h("button",{onClick:sv,style:{width:"100%",padding:"10px",background:K.g,border:"none",borderRadius:8,color:"#000",fontSize:13,fontWeight:700,cursor:"pointer"}},"SAVE TRADE")))}
// === LOG VIEW ===
function rL(){
var rows=fl.map(function(t){var p=cPL(t),mfe=cMFE(t),dur=cDur(t),img=t.screenshotData||t.screenshotUrl,img2=t.exitScreenshotData||t.exitScreenshotUrl,w=p.pl>0;
var mi=[h("span",{key:"e"},"E:"+t.entry),h("span",{key:"x"},"X:"+t.exit),h("span",{key:"s"},"\u00d7"+t.shares)];
if(dur)mi.push(h("span",{key:"d",style:{color:K.go}},dur.l));
if(mfe&&mfe.cp!==null)mi.push(h("span",{key:"c",style:{color:mfe.cp>=.7?K.g:K.go}},(mfe.cp*100).toFixed(0)+"%"));
if(t.adxAtEntry)mi.push(h("span",{key:"a",style:{color:+t.adxAtEntry>=25?K.g:K.go}},"ADX"+t.adxAtEntry));
if(t.rsiAtEntry)mi.push(h("span",{key:"ri"},"RSI"+t.rsiAtEntry));
if(t.timeframe&&t.timeframe!=="3m")mi.push(h("span",{key:"tf",style:{color:K.pu}},t.timeframe));
if(t.followedRules==="N")mi.push(h("span",{key:"fr",style:{color:K.r,fontWeight:700}},"\u2717rules"));
return h("div",{key:t.id,onClick:function(){oE(t)},style:{display:"flex",alignItems:"center",gap:8,padding:"10px 12px",background:K.cd,borderRadius:8,border:"1px solid "+K.bd,borderLeft:"3px solid "+(w?K.g:p.pl<0?K.r:K.bd),cursor:"pointer",marginBottom:2}},
h("div",{style:{width:22,textAlign:"center",flexShrink:0}},h("span",{style:{fontSize:11,fontWeight:700,color:K.dm,fontFamily:"JetBrains Mono,monospace"}},t.tradeNumOfDay||"")),
h("div",{style:{display:"flex",gap:2,flexShrink:0}},
h("div",{style:{width:img2?38:48,height:36,borderRadius:4,overflow:"hidden",flexShrink:0,background:K.bg,display:"flex",alignItems:"center",justifyContent:"center"}},img?h("img",{src:img,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"},onClick:function(e){e.stopPropagation();setLb(img)}}):h("span",{style:{fontSize:7,color:K.dm}},"\u2014")),
img2?h("div",{style:{width:38,height:36,borderRadius:4,overflow:"hidden",flexShrink:0,background:K.bg,display:"flex",alignItems:"center",justifyContent:"center",borderLeft:"1px solid "+K.bd}},h("img",{src:img2,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"},onClick:function(e){e.stopPropagation();setLb(img2)}})):null),
h("div",{style:{minWidth:38,textAlign:"center"}},h("span",{style:{fontSize:14,fontWeight:700,color:t.direction==="L"?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},t.direction==="L"?"L":"S"),h("div",{style:{fontSize:9,color:K.dm}},t.type),(t.mode||"live")==="backtest"?h("div",{style:{fontSize:7,color:K.pu,fontWeight:600}},"BT"):null),
h("div",{style:{minWidth:50}},
h("div",{style:{fontSize:13,fontWeight:700,color:K.tx}},t.ticker),
h("div",{style:{fontSize:9,color:K.dm}},t.date),
function(){var s=userStrats.find(function(x){return x.id===t.strategyId});return s?h("div",{style:{fontSize:8,color:K.go,marginTop:1,maxWidth:70,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},s.name):null}()),
h("div",{style:{flex:1,display:"flex",gap:12,alignItems:"center",fontSize:12,fontFamily:"JetBrains Mono,monospace",color:K.dm,flexWrap:"wrap"}},mi),
h("div",{style:{textAlign:"right",minWidth:80}},h("div",{style:{fontSize:16,fontWeight:700,color:w?K.g:p.pl<0?K.r:K.dm,fontFamily:"JetBrains Mono,monospace"}},"$"+p.pl.toFixed(2)),h("div",{style:{fontSize:10,color:w?K.g:p.pl<0?K.r:K.dm}},p.rm.toFixed(2)+"R")),
h("button",{onClick:function(e){e.stopPropagation();dl(t.id)},style:{padding:"3px 6px",background:"transparent",border:"1px solid "+K.bd,borderRadius:4,color:K.r,fontSize:9,cursor:"pointer"}},"\u00d7"))});
var sc=[];
if(st){sc.push(h(SC,{key:"wr",label:"Win Rate",value:(st.wr*100).toFixed(1)+"%",color:st.wr>=.5?K.g:K.r,sub:st.w+"W/"+st.l+"L"}));sc.push(h(SC,{key:"tp",label:"Total P/L",value:"$"+st.tp.toFixed(0),color:st.tp>=0?K.g:K.r}));sc.push(h(SC,{key:"ar",label:"Avg R",value:st.ar.toFixed(2)+"R",color:st.ar>=0?K.g:K.r}));sc.push(h(SC,{key:"pf",label:"PF",value:st.pf>=999?"\u221e":st.pf.toFixed(2),color:st.pf>=1.5?K.g:st.pf>=1?K.go:K.r}));sc.push(h(SC,{key:"aw",label:"Avg W/L",value:"$"+st.aw.toFixed(0),color:K.g,sub:"L: $"+st.al.toFixed(0)}));if(st.ad!==null)sc.push(h(SC,{key:"ad",label:"Avg Dur",value:st.ad.toFixed(0)+"m",color:K.go}));if(st.ac!==null)sc.push(h(SC,{key:"ac",label:"Capture",value:(st.ac*100).toFixed(0)+"%",color:st.ac>=.7?K.g:st.ac>=.5?K.go:K.r}))}
return h("div",null,
h("div",{style:{display:"flex",gap:6,marginBottom:10,flexWrap:"wrap",alignItems:"center"}},h(Pl,{v:fd,onChange:sFd,options:[{v:"ALL",l:"All"},{v:"L",l:"Longs",c:K.g},{v:"S",l:"Shorts",c:K.r}]}),h(Pl,{v:ft,onChange:sFt,options:[{v:"ALL",l:"All"},{v:"Rev",l:"Rev",c:K.cy},{v:"Cont",l:"Cont",c:K.go}]}),tks.length>1?h("select",{value:fk,onChange:function(e){sFk(e.target.value)},style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"4px 8px",color:K.tx,fontSize:10}},[h("option",{key:"ALL",value:"ALL"},"All")].concat(tks.map(function(t){return h("option",{key:t,value:t},t)}))):null,
h("select",{value:sortBy,onChange:function(e){setSort(e.target.value)},style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"4px 8px",color:K.tx,fontSize:10}},
h("option",{value:"date_desc"},"Newest First"),h("option",{value:"date_asc"},"Oldest First"),h("option",{value:"trade_num_asc"},"Trade # (1 first)"),h("option",{value:"trade_num_desc"},"Trade # (Last first)"),h("option",{value:"pl_best"},"Best P/L"),h("option",{value:"pl_worst"},"Worst P/L"),h("option",{value:"r_best"},"Best R"),h("option",{value:"r_worst"},"Worst R"),h("option",{value:"wins"},"Wins First"),h("option",{value:"losses"},"Losses First")),
h("div",{style:{flex:1}}),h("span",{style:{fontSize:10,color:K.dm}},fl.length+" trades")),
sc.length?h("div",{style:{display:"flex",gap:5,marginBottom:10,flexWrap:"wrap"}},sc):null,
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},rows),
!fl.length?h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"No trades yet."):null)}
// === RULES VIEW ===
function rR(){
var d=ra;if(!d.yn.length&&!d.num.length)return h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"Log trades with rules to see analysis.");
function bkRow(b,i){return h("div",{key:i,style:{flex:1,minWidth:100,padding:6,background:K.bg,borderRadius:6}},h("div",{style:{fontSize:9,fontWeight:600,color:K.tx,marginBottom:3}},b.l),h("div",{style:{fontSize:10,color:K.dm}},b.s.n+"tr ",h("span",{style:{color:b.s.wr>=.5?K.g:K.r,fontWeight:600}},(b.s.wr*100).toFixed(0)+"%")," ",h("span",{style:{color:b.s.ar>=0?K.g:K.r}},b.s.ar.toFixed(2)+"R")," ",h("span",{style:{color:b.s.ap>=0?K.g:K.r}},"$"+b.s.ap.toFixed(0))),h(Bar,{pct:b.s.wr*100,color:b.s.wr>=.5?K.g:K.r}))}
var sections=[];
// Y/N Rules
sections.push(h("div",{key:"yn",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:8}},"RULE EDGE ANALYSIS",h(Tip,{t:"Compares win rate when each rule is marked Y vs N. Edge % shows the difference. Higher = that rule matters more for your setups."})),d.yn.map(function(r){var ep=(r.edge*100).toFixed(1);
return h("div",{key:r.key,style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"8px 12px",marginBottom:4}},h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}},h("span",{style:{fontSize:11,fontWeight:600,color:K.tx}},r.label),h("span",{style:{fontSize:14,fontWeight:700,color:r.edge>.05?K.g:r.edge<-.05?K.r:K.dm,fontFamily:"JetBrains Mono,monospace"}},(r.edge>0?"+":"")+ep+"%")),h("div",{style:{display:"flex",gap:12,fontSize:9}},h("div",{style:{flex:1}},h("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:2}},h("span",{style:{color:K.g}},"Y:"+r.w.n),h("span",{style:{color:K.g,fontFamily:"JetBrains Mono,monospace"}},(r.w.wr*100).toFixed(0)+"% "+r.w.ar.toFixed(2)+"R $"+r.w.ap.toFixed(0))),h(Bar,{pct:r.w.wr*100,color:K.g})),h("div",{style:{flex:1}},h("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:2}},h("span",{style:{color:K.r}},"N:"+r.wo.n),h("span",{style:{color:K.r,fontFamily:"JetBrains Mono,monospace"}},(r.wo.wr*100).toFixed(0)+"% "+r.wo.ar.toFixed(2)+"R $"+r.wo.ap.toFixed(0))),h(Bar,{pct:r.wo.wr*100,color:K.r}))))})));
// Numeric buckets
if(d.num.length)sections.push(h("div",{key:"num",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.pu,fontWeight:700,marginBottom:8}},"BUCKET ANALYSIS",h(Tip,{t:"Groups trades by numeric ranges (ADX, RSI, duration, etc) and shows performance for each bucket. Helps identify optimal conditions for your trades."})),d.num.map(function(n,ni){return h("div",{key:ni,style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"10px 12px",marginBottom:4}},h("div",{style:{fontSize:11,fontWeight:600,color:K.tx,marginBottom:6}},n.label),h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},n.bk.map(bkRow)))})));
// Combo Analysis
if(d.combos.length)sections.push(h("div",{key:"combo",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.cy,fontWeight:700,marginBottom:8}},"TOP SETUP COMBOS",h(TierBadge,{tier:"t1"}),h(Tip,{t:"Ranks 2, 3, 4, and 5 rule combinations by win rate and R. These are your best setups \u2014 the specific combos that produce the highest edge when present together. Higher rule counts require more trades to activate."})),d.combos.slice(0,15).map(function(c,i){return h("div",{key:i,style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 10px",background:K.cd,borderRadius:6,border:"1px solid "+K.bd,marginBottom:3}},h("div",{style:{flex:1}},h("span",{style:{fontSize:9,padding:"1px 5px",borderRadius:3,background:c.count===2?K.bd:c.count===3?K.pu:c.count===4?K.go:K.cy,color:"#fff",fontWeight:700,marginRight:6}},c.count+"R"),h("span",{style:{fontSize:10,color:K.tx}},c.rules.join(" + ")),h("span",{style:{fontSize:10,color:K.dm,marginLeft:6}},c.stats.n+" trades")),h("div",{style:{display:"flex",gap:10,fontFamily:"JetBrains Mono,monospace",fontSize:11}},h("span",{style:{color:c.stats.wr>=.6?K.g:c.stats.wr>=.45?K.go:K.r,fontWeight:700}},(c.stats.wr*100).toFixed(0)+"%"),h("span",{style:{color:c.stats.ar>=0?K.g:K.r}},c.stats.ar.toFixed(2)+"R"),h("span",{style:{color:c.stats.ap>=0?K.g:K.r}},"$"+c.stats.ap.toFixed(0))))})));
// Min Rule Count
if(d.minRule.length>1)sections.push(h("div",{key:"minr",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:8}},"MIN RULE COUNT THRESHOLD",h(Tip,{t:"Shows performance at each minimum rule count. Use this to set your 'don\u2019t trade' threshold \u2014 e.g. if 4+ rules = 70% WR but 2 rules = 35%, stop taking trades under 4 rules."})),h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},d.minRule.map(function(m){return h("div",{key:m.min,style:{flex:1,minWidth:80,padding:8,background:K.cd,borderRadius:8,border:"1px solid "+K.bd,textAlign:"center"}},h("div",{style:{fontSize:10,color:K.dm}},m.min+"+ rules"),h("div",{style:{fontSize:14,fontWeight:700,color:m.stats.wr>=.6?K.g:m.stats.wr>=.45?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},(m.stats.wr*100).toFixed(0)+"%"),h("div",{style:{fontSize:10,color:K.dm}},m.stats.n+"tr "+m.stats.ar.toFixed(2)+"R"),h(Bar,{pct:m.stats.wr*100,color:m.stats.wr>=.5?K.g:K.r}))}))));
// Correlation
if(d.corr.length)sections.push(h("div",{key:"corr",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.dm,fontWeight:700,marginBottom:8}},"RULE CORRELATION",h(TierBadge,{tier:"t1"}),h(Tip,{t:"Shows which rules fire together most often. High overlap (red) = redundant signals, essentially the same edge. Low overlap (green) = independent edges that stack."})),d.corr.slice(0,8).map(function(c,i){return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:8,padding:"4px 10px",background:K.cd,borderRadius:6,marginBottom:2,fontSize:10}},h("span",{style:{flex:1,color:K.tx}},c.a+" \u2194 "+c.b),h("span",{style:{color:c.overlap>.7?K.r:c.overlap>.4?K.go:K.g,fontFamily:"JetBrains Mono,monospace",fontWeight:600}},(c.overlap*100).toFixed(0)+"% overlap"),h("span",{style:{color:K.dm}},c.bothN+" both Y"))})));
// Conditional Edge
if(d.cond.length)sections.push(h("div",{key:"cond",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.cy,fontWeight:700,marginBottom:8}},"CONDITIONAL EDGE",h(TierBadge,{tier:"t1"}),h(Tip,{t:"Shows the incremental value of adding one rule when another is already present. Answers: 'Given I have Rule A, does adding Rule B actually improve my results?'"})),d.cond.slice(0,8).map(function(c,i){return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:6,padding:"4px 10px",background:K.cd,borderRadius:6,marginBottom:2,fontSize:10}},h("span",{style:{flex:1,color:K.tx}},"When ",h("span",{style:{color:K.go}},c.base)," \u2192 adding ",h("span",{style:{color:K.cy}},c.add)),h("span",{style:{color:c.incr>.05?K.g:c.incr<-.05?K.r:K.dm,fontFamily:"JetBrains Mono,monospace",fontWeight:700}},(c.incr>0?"+":"")+(c.incr*100).toFixed(0)+"% WR"))})));
// Entry Quality Scores
if(d.scores.length)sections.push(h("div",{key:"score",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:4}},"ENTRY QUALITY SCORES",h(TierBadge,{tier:"t2"}),h(Tip,{t:"Each trade scored 0-100 based on which rules were present, weighted by each rule\u2019s independent edge. Compare scores to outcomes \u2014 high scores should produce better results over time."})),h("div",{style:{fontSize:10,color:K.dm,marginBottom:8}},"Score vs actual P/L and R-multiple."),h("div",{style:{display:"flex",flexDirection:"column",gap:2}},d.scores.slice(0,15).map(function(s){return h("div",{key:s.id,style:{display:"flex",alignItems:"center",gap:8,padding:"3px 8px",background:K.cd,borderRadius:4,fontSize:10}},h("div",{style:{width:40,fontWeight:700,color:s.score>=70?K.g:s.score>=45?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},s.score),h("div",{style:{flex:1,height:6,background:K.bg,borderRadius:3,overflow:"hidden"}},h("div",{style:{width:s.score+"%",height:"100%",background:s.score>=70?K.g:s.score>=45?K.go:K.r,borderRadius:3}})),h("span",{style:{color:K.dm,width:50}},s.date.slice(5)),h("span",{style:{color:s.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace",width:60,textAlign:"right"}},"$"+s.pl.toFixed(0)+" "+s.rm.toFixed(1)+"R"))}))));

// === EDGE DECAY ===
if(d.decay&&d.decay.length)sections.push(h("div",{key:"decay",style:{marginBottom:14}},
h("div",{style:{fontSize:12,color:K.r,fontWeight:700,marginBottom:4,display:"flex",alignItems:"center"}},"EDGE DECAY MONITOR",h(TierBadge,{tier:"t1"}),h(Tip,{t:"Shows all-time vs last 20 vs last 10 trades for each rule and top combo. When recent performance drops significantly below all-time, your edge is degrading. Act before you give back profits."})),
d.decay.some(function(x){return x.decaying})?h("div",{style:{padding:"8px 12px",background:K.r+"18",border:"1px solid "+K.r+"44",borderRadius:8,marginBottom:10,fontSize:11,color:K.r,fontWeight:600}},"\u26a0 Edge decay detected — review flagged rules below"):null,
h("div",{style:{display:"flex",flexDirection:"column",gap:4}},
d.decay.map(function(r,i){
var hasRecent=r.last10||r.last20;
var flag=r.decaying;
return h("div",{key:i,style:{background:K.cd,borderRadius:8,border:"1px solid "+(flag?K.r+"66":K.bd),padding:"8px 12px"}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}},
h("div",{style:{display:"flex",alignItems:"center",gap:6}},
flag?h("span",{style:{fontSize:9,padding:"1px 5px",borderRadius:3,background:K.r+"33",color:K.r,fontWeight:700}},"\u25bc DECAY"):h("span",{style:{fontSize:9,padding:"1px 5px",borderRadius:3,background:K.g+"22",color:K.g,fontWeight:700}},"\u2713 STABLE"),
h("span",{style:{fontSize:11,fontWeight:600,color:K.tx,marginLeft:4}},r.label),
r.isCombo?h("span",{style:{fontSize:8,color:K.pu,marginLeft:4}},"COMBO"):null),
h("span",{style:{fontSize:10,color:K.dm}},r.allN+" total trades")),
h("div",{style:{display:"flex",gap:8}},
h("div",{style:{flex:1,textAlign:"center",padding:"4px 6px",background:K.bg,borderRadius:6}},
h("div",{style:{fontSize:9,color:K.dm,marginBottom:2}},"All-Time"),
h("div",{style:{fontSize:14,fontWeight:700,color:r.allTime.wr>=.5?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(r.allTime.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:9,color:K.dm}},r.allTime.ar.toFixed(2)+"R"),
h(Bar,{pct:r.allTime.wr*100,color:r.allTime.wr>=.5?K.g:K.r})),
r.last20?h("div",{style:{flex:1,textAlign:"center",padding:"4px 6px",background:K.bg,borderRadius:6}},
h("div",{style:{fontSize:9,color:K.dm,marginBottom:2}},"Last 20"),
h("div",{style:{fontSize:14,fontWeight:700,color:r.last20.wr<r.allTime.wr-0.10?K.r:r.last20.wr>=.5?K.g:K.go,fontFamily:"JetBrains Mono,monospace"}},(r.last20.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:9,color:K.dm}},r.last20.ar.toFixed(2)+"R"),
h(Bar,{pct:r.last20.wr*100,color:r.last20.wr>=.5?K.g:K.go})):null,
r.last10?h("div",{style:{flex:1,textAlign:"center",padding:"4px 6px",background:K.bg,borderRadius:6}},
h("div",{style:{fontSize:9,color:K.dm,marginBottom:2}},"Last 10"),
h("div",{style:{fontSize:14,fontWeight:700,color:r.last10.wr<r.allTime.wr-0.15?K.r:r.last10.wr>=.5?K.g:K.go,fontFamily:"JetBrains Mono,monospace"}},(r.last10.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:9,color:K.dm}},r.last10.ar.toFixed(2)+"R"),
h(Bar,{pct:r.last10.wr*100,color:r.last10.wr>=.5?K.g:K.r})):h("div",{style:{flex:1,textAlign:"center",padding:"4px 6px",background:K.bg,borderRadius:6,opacity:.4}},
h("div",{style:{fontSize:9,color:K.dm}}),"Last 10",h("div",{style:{fontSize:10,color:K.dm,marginTop:4}},"Need 2+ trades"))
))}))));

// === EXIT PLANNING ANALYSIS ===
if(d.exitAnalysis&&(d.exitAnalysis.targetTypes.length||d.exitAnalysis.captureAnalysis)){
var ea=d.exitAnalysis;
sections.push(h("div",{key:"exit",style:{marginBottom:14}},
h("div",{style:{fontSize:12,color:K.cy,fontWeight:700,marginBottom:4,display:"flex",alignItems:"center"}},"EXIT PLANNING ANALYSIS",h(Tip,{t:"Analyzes your planned targets vs actual outcomes. Shows which target types you hit most reliably, your average capture rate, and how much you typically leave on the table post-exit."})),
// Capture stats
ea.captureAnalysis?h("div",{style:{display:"flex",gap:6,marginBottom:10,flexWrap:"wrap"}},
h(SC,{label:"Avg Capture",value:(ea.captureAnalysis.avg*100).toFixed(0)+"%",color:ea.captureAnalysis.avg>=.7?K.g:ea.captureAnalysis.avg>=.5?K.go:K.r,sub:ea.captureAnalysis.count+" trades"}),
h(SC,{label:"70%+ Cap",value:(ea.captureAnalysis.pct70plus*100).toFixed(0)+"%",color:ea.captureAnalysis.pct70plus>=.5?K.g:K.go,sub:"hit 70%+ MFE"}),
h(SC,{label:"Sub-50% Cap",value:(ea.captureAnalysis.pct50minus*100).toFixed(0)+"%",color:ea.captureAnalysis.pct50minus>=.4?K.r:K.go,sub:"exited early"}),
ea.leftOnTable?h(SC,{label:"Left On Table",value:ea.leftOnTable.avgLeftR.toFixed(2)+"R avg",color:K.r,sub:(ea.leftOnTable.avgLeftPct*100).toFixed(0)+"% of move"}):null):null,
// Target type hit rates
ea.targetTypes.length?h("div",{style:{marginBottom:10}},
h("div",{style:{fontSize:11,color:K.dm,fontWeight:600,marginBottom:6}},"TARGET TYPE HIT RATE",h(Tip,{t:"Which target types you actually hit vs miss. High hit rate = this level is a reliable exit point for your setups."})),
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},ea.targetTypes.map(function(tt,i){
return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:8,padding:"5px 10px",background:K.cd,borderRadius:6,border:"1px solid "+K.bd}},
h("div",{style:{flex:1,fontSize:11,color:K.tx}},tt.label),
h("div",{style:{display:"flex",gap:10,alignItems:"center",fontFamily:"JetBrains Mono,monospace",fontSize:10}},
h("span",{style:{color:K.dm}},tt.total+"×"),
h("span",{style:{fontWeight:700,color:tt.hitRate>=.65?K.g:tt.hitRate>=.45?K.go:K.r}},(tt.hitRate*100).toFixed(0)+"% hit"),
tt.avgRHit!==null?h("span",{style:{color:K.g}},tt.avgRHit.toFixed(2)+"R (hit)"):null,
tt.avgRMiss!==null?h("span",{style:{color:K.r}},tt.avgRMiss.toFixed(2)+"R (miss)"):null),
h("div",{style:{width:80,height:5,background:K.bg,borderRadius:3,overflow:"hidden"}},
h("div",{style:{width:(tt.hitRate*100)+"%",height:"100%",background:tt.hitRate>=.65?K.g:tt.hitRate>=.45?K.go:K.r}})))}))
):null,
// Partial vs full
ea.partialAnalysis?h("div",{},
h("div",{style:{fontSize:11,color:K.dm,fontWeight:600,marginBottom:6}},"PARTIAL vs FULL EXIT"),
h("div",{style:{display:"flex",gap:6}},
ea.partialAnalysis.partialStats?h("div",{style:{flex:1,padding:"8px 12px",background:K.cd,borderRadius:8,border:"1px solid "+K.bd}},
h("div",{style:{fontSize:10,color:K.cy,fontWeight:700,marginBottom:4}},"PARTIAL ("+(ea.partialAnalysis.partialCount)+" trades)"),
h("div",{style:{fontSize:13,fontWeight:700,color:ea.partialAnalysis.partialStats.wr>=.5?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(ea.partialAnalysis.partialStats.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:10,color:K.dm}},ea.partialAnalysis.partialStats.ar.toFixed(2)+"R avg \u2022 $"+ea.partialAnalysis.partialStats.ap.toFixed(0)+" avg")):null,
ea.partialAnalysis.fullStats?h("div",{style:{flex:1,padding:"8px 12px",background:K.cd,borderRadius:8,border:"1px solid "+K.bd}},
h("div",{style:{fontSize:10,color:K.go,fontWeight:700,marginBottom:4}},"FULL ("+(ea.partialAnalysis.fullCount)+" trades)"),
h("div",{style:{fontSize:13,fontWeight:700,color:ea.partialAnalysis.fullStats.wr>=.5?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(ea.partialAnalysis.fullStats.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:10,color:K.dm}},ea.partialAnalysis.fullStats.ar.toFixed(2)+"R avg \u2022 $"+ea.partialAnalysis.fullStats.ap.toFixed(0)+" avg")):null))
:null))};

return h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:10}},"Viewing "+(md==="all"?"ALL":md.toUpperCase())+" \u2022 "+cp.length+" completed trades"),sections)}
// === EQUITY VIEW ===
function rEq(){
if(!cp.length)return h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"Log completed trades to see equity.");
var sorted=cp.slice().sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)});
// Cumulative
var cum=0,maxC=0,minC=0;
var pts=sorted.map(function(t,i){var p=cPL(t);cum+=p.pl;if(cum>maxC)maxC=cum;if(cum<minC)minC=cum;return{i:i+1,pl:p.pl,cum:cum,d:t.date}});
var range=Math.max(maxC-minC,1);
// Period grouping
function getKey(d){
if(plP==="daily")return d;
if(plP==="weekly"){var dt=new Date(d);var day=dt.getDay();var diff=dt.getDate()-day+(day===0?-6:1);dt.setDate(diff);return dt.toISOString().slice(0,10)}
if(plP==="monthly")return d.slice(0,7);
if(plP==="quarterly"){var m=parseInt(d.slice(5,7));var q=Math.ceil(m/3);return d.slice(0,4)+"-Q"+q}
return d}
var periods={};sorted.forEach(function(t){var k=getKey(t.date);if(!periods[k])periods[k]={key:k,pl:0,n:0,w:0};var p=cPL(t);periods[k].pl+=p.pl;periods[k].n++;if(p.pl>0)periods[k].w++});
// Apply manual adjustments
var pArr=Object.keys(periods).sort().map(function(k){var adj=plAdj[k]||{amount:0,notes:""};return Object.assign({},periods[k],{adjAmount:adj.amount||0,adjNotes:adj.notes||"",displayPl:(periods[k].pl+(parseFloat(adj.amount)||0))})});
var maxPPL=Math.max.apply(null,pArr.map(function(p){return Math.abs(p.displayPl)}).concat([1]));
return h("div",null,
// Cumulative chart
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:14,marginBottom:12}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}},h("div",{style:{fontSize:11,color:K.dm,display:"flex",alignItems:"center"}},"CUMULATIVE P/L",h(Tip,{t:"Running total of your P/L across all completed trades, in chronological order. Shows your equity curve \u2014 consistent upward = edge is working."})),h("div",{style:{fontSize:18,fontWeight:700,color:cum>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},"$"+cum.toFixed(2))),
function(){if(pts.length<2)return h("div",{style:{textAlign:"center",padding:20,color:K.dm}},"2+ trades to see line chart");
var svgW=600,svgH=160,pd=30,W=pts.length-1;
var xS=function(i){return pd+(i/W)*(svgW-pd*2)};
var yS=function(v){return pd+(maxC-v)/range*(svgH-pd*2)};
var ln=pts.map(function(p,i){return(i===0?"M":"L")+xS(i).toFixed(1)+","+yS(p.cum).toFixed(1)}).join(" ");
var ar=ln+" L"+xS(W).toFixed(1)+","+(svgH-pd)+" L"+xS(0).toFixed(1)+","+(svgH-pd)+" Z";
var zY=Math.min(Math.max(yS(0),pd),svgH-pd);
return h("div",{style:{background:K.bg,borderRadius:6,padding:4}},h("svg",{viewBox:"0 0 "+svgW+" "+svgH,style:{width:"100%",height:160}},
h("line",{x1:pd,y1:zY,x2:svgW-pd,y2:zY,stroke:K.dm,strokeWidth:.5,strokeDasharray:"4 3"}),
h("path",{d:ar,fill:cum>=0?"rgba(46,213,115,.1)":"rgba(255,71,87,.1)"}),
h("path",{d:ln,fill:"none",stroke:cum>=0?K.g:K.r,strokeWidth:2,strokeLinejoin:"round",strokeLinecap:"round"}),
pts.map(function(p,i){return h("circle",{key:i,cx:xS(i),cy:yS(p.cum),r:pts.length>30?2:3,fill:p.cum>=0?K.g:K.r},h("title",null,"#"+p.i+" "+p.d+": $"+p.cum.toFixed(2)))})))}()),
// Period selector + summary
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:14}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}},h("div",{style:{fontSize:11,color:K.dm,display:"flex",alignItems:"center"}},"P/L BREAKDOWN",h(Tip,{t:"Your profit/loss grouped by time period. Switch between daily, weekly, monthly, and quarterly views to spot patterns in your performance over time."})),h(Pl,{v:plP,onChange:sPlP,options:[{v:"daily",l:"Day"},{v:"weekly",l:"Week"},{v:"monthly",l:"Month"},{v:"quarterly",l:"Qtr"}]})),
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},pArr.map(function(p){
var lbl=plP==="daily"?p.key.slice(5):plP==="weekly"?"Wk "+p.key.slice(5):plP==="monthly"?p.key:p.key;
return h("div",{key:p.key,style:{display:"flex",alignItems:"center",gap:6,padding:"4px 8px",background:K.bg,borderRadius:6}},
h("div",{style:{width:65,fontSize:10,color:K.dm,fontFamily:"JetBrains Mono,monospace",flexShrink:0}},lbl),
h("div",{style:{flex:1,height:14,background:K.cd,borderRadius:3,overflow:"hidden"}},h("div",{style:{width:Math.max(Math.abs(p.displayPl)/maxPPL*100,3)+"%",height:"100%",background:p.displayPl>=0?K.g:K.r,borderRadius:3,opacity:.7}})),
h("div",{style:{width:70,textAlign:"right",fontSize:11,fontWeight:700,color:p.displayPl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},"$"+p.displayPl.toFixed(0)),
h("div",{style:{width:55,fontSize:10,color:K.dm,textAlign:"right"}},p.n+"tr "+p.w+"W"),
h("input",{type:"number",value:p.adjAmount||"",onChange:function(e){var v=e.target.value;sPlAdj(function(prev){var n=Object.assign({},prev);n[p.key]=Object.assign({},n[p.key]||{},{amount:v});return n})},placeholder:"+/-",step:"0.01",title:"Manual P/L adjustment for this period (display only, does not affect analysis)",style:{width:52,background:K.inp,border:"1px solid "+K.bd,borderRadius:4,padding:"2px 5px",color:p.adjAmount&&parseFloat(p.adjAmount)!==0?(parseFloat(p.adjAmount)>0?K.g:K.r):K.dm,fontSize:9,fontFamily:"JetBrains Mono,monospace",outline:"none",textAlign:"right"}}))}))),
// Period stats summary
pArr.length>=2?h("div",{style:{display:"flex",gap:6,marginTop:10,flexWrap:"wrap"}},
h(SC,{label:"Best "+plP,value:"$"+Math.max.apply(null,pArr.map(function(p){return p.displayPl})).toFixed(0),color:K.g}),
h(SC,{label:"Worst "+plP,value:"$"+Math.min.apply(null,pArr.map(function(p){return p.displayPl})).toFixed(0),color:K.r}),
h(SC,{label:"Win "+plP+"s",value:pArr.filter(function(p){return p.displayPl>0}).length+"/"+pArr.length,color:pArr.filter(function(p){return p.displayPl>0}).length/pArr.length>=.5?K.g:K.r}),
h(SC,{label:"Avg "+plP,value:"$"+(pArr.reduce(function(s,p){return s+p.displayPl},0)/pArr.length).toFixed(0),color:pArr.reduce(function(s,p){return s+p.displayPl},0)>=0?K.g:K.r})):null)}
// === STRATEGIES VIEW ===
function rStrats(){
var maxS=userStrats.length>=1?"Free limit: 1 strategy (upgrade for more)":"";
// Strategy editor modal
if(editStrat!==null){
var es=editStrat;
var isNew=!es.id;
var tmpl=STRATEGY_TEMPLATES.find(function(t){return t.id===es.templateId});
return h("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.88)",zIndex:1000,overflow:"auto",padding:"16px 8px"}},
h("div",{style:{maxWidth:760,margin:"0 auto",background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:20}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}},
h("h2",{style:{color:K.go,fontSize:15,margin:0,fontFamily:"JetBrains Mono,monospace"}},isNew?"NEW STRATEGY":"EDIT STRATEGY"),
h("button",{onClick:function(){setEditStrat(null)},style:{padding:"4px 10px",background:K.r,border:"none",borderRadius:6,color:"#fff",fontSize:11,cursor:"pointer"}},"Cancel")),
// Name
h("div",{style:{marginBottom:10}},
h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Strategy Name"),
h("input",{type:"text",value:es.name||"",onChange:function(e){setEditStrat(function(p){return Object.assign({},p,{name:e.target.value})})},placeholder:"My Channel Reversal...",style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"7px 10px",color:K.tx,fontSize:13,width:"100%",outline:"none"}})),
// Template selector
h("div",{style:{marginBottom:12}},
h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Base on Template (optional)"),
h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
h("button",{onClick:function(){setEditStrat(function(p){return Object.assign({},p,{templateId:"",coreRules:{},addons:[]})})},style:{padding:"4px 10px",borderRadius:6,border:"1px solid "+K.bd,fontSize:10,cursor:"pointer",background:!es.templateId?K.cy:"transparent",color:!es.templateId?"#fff":K.dm}},"Custom"),
STRATEGY_TEMPLATES.map(function(t){return h("button",{key:t.id,onClick:function(){setEditStrat(function(p){return Object.assign({},p,{templateId:t.id,coreRules:Object.assign({},t.coreRules),addons:p.addons||[]})})},style:{padding:"4px 10px",borderRadius:6,border:"1px solid "+K.bd,fontSize:10,cursor:"pointer",background:es.templateId===t.id?K.go:"transparent",color:es.templateId===t.id?"#000":K.dm}},t.name)}))),
// Template info
tmpl?h("div",{style:{background:K.bg,borderRadius:8,padding:"10px 14px",marginBottom:12,border:"1px solid "+K.bd}},
h("div",{style:{fontSize:11,color:K.tx,marginBottom:6}},tmpl.desc),
h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
Object.keys(CONDITIONS).map(function(c){
var isBest=tmpl.conditions.best.indexOf(c)>=0;
var isAvoid=tmpl.conditions.avoid&&tmpl.conditions.avoid.indexOf(c)>=0;
if(!isBest&&!isAvoid)return null;
return h("span",{key:c,style:{fontSize:9,padding:"2px 7px",borderRadius:10,background:isBest?K.g+"22":K.r+"22",color:isBest?K.g:K.r,border:"1px solid "+(isBest?K.g:K.r)+"44",fontWeight:600}},isBest?"\u2713 ":"\u2715 ",CONDITIONS[c].l)}))):null,
// Core rules section
h("div",{style:{marginBottom:12}},
h("div",{style:{fontSize:11,color:K.go,fontWeight:700,marginBottom:6,borderBottom:"1px solid "+K.bd,paddingBottom:4}},"CORE RULES — Layer 1",h("span",{style:{fontSize:9,color:K.dm,fontWeight:400,marginLeft:6}},"Always present for this strategy")),
es.templateId&&tmpl?
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:4}},Object.keys(tmpl.coreRules).map(function(k){return h("div",{key:k,style:{padding:"5px 8px",background:K.bg,borderRadius:6,fontSize:10,color:K.tx,display:"flex",alignItems:"center",gap:4}},h("span",{style:{color:K.g,fontWeight:700}},"●"),tmpl.coreRules[k])})):
h("div",null,
h("div",{style:{fontSize:10,color:K.dm,marginBottom:6}},"Add your core rules for this strategy:"),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:4,marginBottom:6}},
(es.coreRules?Object.keys(es.coreRules):[]).map(function(k){return h("div",{key:k,style:{padding:"4px 8px",background:K.bg,borderRadius:6,fontSize:10,color:K.tx,display:"flex",justifyContent:"space-between",alignItems:"center"}},h("span",{},(es.coreRules[k]||k)),h("button",{onClick:function(){setEditStrat(function(p){var nr=Object.assign({},p.coreRules);delete nr[k];return Object.assign({},p,{coreRules:nr})})},style:{background:"transparent",border:"none",color:K.r,cursor:"pointer",fontSize:10}},"×"))})),
h("div",{style:{display:"flex",gap:4}},
h("input",{id:"newRuleInput",type:"text",placeholder:"Rule name...",style:{flex:1,background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"5px 8px",color:K.tx,fontSize:11,outline:"none"}}),
h("button",{onClick:function(){var inp=document.getElementById("newRuleInput");if(!inp||!inp.value.trim())return;var k="custom_"+Date.now();setEditStrat(function(p){var nr=Object.assign({},p.coreRules||{});nr[k]=inp.value.trim();return Object.assign({},p,{coreRules:nr})});inp.value=""},style:{padding:"5px 10px",background:K.g,border:"none",borderRadius:6,color:"#000",fontSize:10,cursor:"pointer",fontWeight:700}},"Add")))),
// Add-on indicators
h("div",{style:{marginBottom:14}},
h("div",{style:{fontSize:11,color:K.pu,fontWeight:700,marginBottom:6,borderBottom:"1px solid "+K.bd,paddingBottom:4}},"ADD-ON INDICATORS — Layer 2",h(TierBadge,{tier:"t1"}),h("span",{style:{fontSize:9,color:K.dm,fontWeight:400,marginLeft:6}},"Optional indicators from the library")),
Object.keys(IND_CAT_LABELS).map(function(cat){
return h("div",{key:cat,style:{marginBottom:8}},
h("div",{style:{fontSize:9,color:K.go,fontWeight:700,marginBottom:4,textTransform:"uppercase",letterSpacing:1}},IND_CAT_LABELS[cat]),
h("div",{style:{display:"flex",flexWrap:"wrap",gap:4}},
IND_LIBRARY[cat].map(function(ind){
var active=(es.addons||[]).indexOf(ind.k)>=0;
return h("button",{key:ind.k,title:ind.tip,onClick:function(){setEditStrat(function(p){var a=p.addons||[];var idx=a.indexOf(ind.k);return Object.assign({},p,{addons:idx>=0?a.filter(function(x){return x!==ind.k}):a.concat([ind.k])})})},style:{padding:"3px 8px",borderRadius:4,border:"1px solid "+(active?K.pu:K.bd),fontSize:9,cursor:"pointer",background:active?K.pu+"22":"transparent",color:active?K.pu:K.dm,fontWeight:active?700:400}},ind.l)})))})),
// Save button
h("button",{onClick:function(){if(!es.name||!es.name.trim()){alert("Please name your strategy");return}var s=Object.assign({},es,{id:es.id||gid()});setStrats(function(p){var idx=p.findIndex(function(x){return x.id===s.id});if(idx>=0){var n=p.slice();n[idx]=s;return n}return p.concat([s])});setEditStrat(null)},style:{width:"100%",padding:"10px",background:K.g,border:"none",borderRadius:8,color:"#000",fontSize:13,fontWeight:700,cursor:"pointer"}},"SAVE STRATEGY")))}

// Main strategies list
return h("div",null,
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}},
h("div",null,
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,marginBottom:2}},"My Strategies"),
h("div",{style:{fontSize:10,color:K.dm}},"Define your trading strategies. Each strategy gets its own rule set and analysis.")),
h("div",{style:{display:"flex",gap:6,alignItems:"center"}},
userStrats.length>=1?h("span",{style:{fontSize:9,color:K.go,padding:"2px 7px",borderRadius:4,background:K.go+"22",border:"1px solid "+K.go+"44"}},"Free: 1/1 ",h(TierBadge,{tier:"t1"})):null,
h("button",{onClick:function(){if(userStrats.length>=1){alert("Free plan allows 1 strategy. Upgrade to Tier 1 for up to 3 strategies.");return}setEditStrat({id:"",name:"",templateId:"",coreRules:{},addons:[]})},style:{padding:"6px 14px",background:K.g,border:"none",borderRadius:8,color:"#000",fontSize:11,fontWeight:700,cursor:"pointer"}},"+ New Strategy"))),
// User strategies
userStrats.length?h("div",{style:{display:"flex",flexDirection:"column",gap:8,marginBottom:20}},userStrats.map(function(s){
var tmpl=STRATEGY_TEMPLATES.find(function(t){return t.id===s.templateId});
var tradeCt=trades.filter(function(t){return t.strategyId===s.id}).length;
var allRules=Object.keys(s.coreRules||{}).concat(s.addons||[]);
return h("div",{key:s.id,style:{background:K.cd,borderRadius:10,border:"1px solid "+K.bd,padding:"12px 16px"}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}},
h("div",null,
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,marginBottom:2}},s.name),
tmpl?h("div",{style:{fontSize:10,color:K.dm,marginBottom:4}},"Based on: ",h("span",{style:{color:K.go}},tmpl.name)):null,
h("div",{style:{fontSize:10,color:K.dm}},tradeCt+" trades logged")),
h("div",{style:{display:"flex",gap:6}},
h("button",{onClick:function(){setEditStrat(dc(s))},style:{padding:"4px 10px",background:"transparent",border:"1px solid "+K.bd,borderRadius:6,color:K.dm,fontSize:10,cursor:"pointer"}},"Edit"),
h("button",{onClick:function(){if(confirm("Delete "+s.name+"?"))setStrats(function(p){return p.filter(function(x){return x.id!==s.id})})},style:{padding:"4px 10px",background:"transparent",border:"1px solid "+K.r+"44",borderRadius:6,color:K.r,fontSize:10,cursor:"pointer"}},"Delete"))),
// Condition tags
tmpl?h("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:8}},
Object.keys(CONDITIONS).map(function(c){
var isBest=tmpl.conditions.best.indexOf(c)>=0;
var isAvoid=tmpl.conditions.avoid&&tmpl.conditions.avoid.indexOf(c)>=0;
if(!isBest&&!isAvoid)return null;
return h("span",{key:c,style:{fontSize:9,padding:"2px 7px",borderRadius:10,background:isBest?K.g+"22":K.r+"22",color:isBest?K.g:K.r,border:"1px solid "+(isBest?K.g:K.r)+"44",fontWeight:600}},isBest?"\u2713 ":"\u2715 ",CONDITIONS[c].l)})):null,
// Rules summary
h("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},
Object.keys(s.coreRules||{}).map(function(k){return h("span",{key:k,style:{fontSize:9,padding:"2px 6px",borderRadius:4,background:K.g+"18",color:K.g,border:"1px solid "+K.g+"33"}},s.coreRules[k]||k)}),
(s.addons||[]).map(function(k){return h("span",{key:k,style:{fontSize:9,padding:"2px 6px",borderRadius:4,background:K.pu+"18",color:K.pu,border:"1px solid "+K.pu+"33"}},getIndLabel(k))})))})):
h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"No strategies yet. Add your first strategy to get started."),

// Template library
h("div",{style:{marginTop:20}},
h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:10,display:"flex",alignItems:"center"}},"STRATEGY LIBRARY",h(Tip,{t:"Pre-built strategy templates. Select one as a starting point for your own strategy."})),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}},
STRATEGY_TEMPLATES.map(function(t){
return h("div",{key:t.id,style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"10px 14px"}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx,marginBottom:4}},t.name),
h("div",{style:{fontSize:10,color:K.dm,marginBottom:8,lineHeight:1.5}},t.desc),
h("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:8}},
Object.keys(CONDITIONS).map(function(c){
var isBest=t.conditions.best.indexOf(c)>=0;
var isAvoid=t.conditions.avoid&&t.conditions.avoid.indexOf(c)>=0;
if(!isBest&&!isAvoid)return null;
return h("span",{key:c,style:{fontSize:9,padding:"2px 6px",borderRadius:10,background:isBest?K.g+"22":K.r+"22",color:isBest?K.g:K.r,border:"1px solid "+(isBest?K.g:K.r)+"44",fontWeight:600}},isBest?"\u2713 ":"\u2715 ",CONDITIONS[c].l)})),
h("button",{onClick:function(){if(userStrats.length>=1){alert("Free plan allows 1 strategy. Upgrade for more.");return}setEditStrat({id:"",name:t.name,templateId:t.id,coreRules:Object.assign({},t.coreRules),addons:[]})},style:{padding:"4px 10px",background:K.go,border:"none",borderRadius:6,color:"#000",fontSize:10,fontWeight:700,cursor:"pointer"}},"Use Template"))}))))}

// === HEAT MAP + HOUR GRID DATA ===
// === CSV TEMPLATE EXPORT/IMPORT ===
function dlCSVTemplate(trades){
var RULE_KEYS=["ultimateHL","lhhl","chanBreak","chanRetest","firstCandle10ema","secondCandleEntry","macdCross","cloudAlign","rsiExtreme","cloud15m"];
var STOP_KEYS=["initStopHL","stopToChan","trailHL","trailFailedHL","stopMoved","reentry"];
var headers=["date","time","exitTime","ticker","timeframe","direction","type","mode","entryPrice","stopPrice","exitPrice","shares","mfe","mae","adxAtEntry","cloudWidthPct","cloudDirection","rsiAtEntry","rsiAtPeak","rsiAtExit","divBefore","divDuring","maeTiming","volumeAtExit","exitType","session","confidence","emotion","emotionDuring","emotionAfter","followedRules","hasPartial","partialExitPrice","partialPct","trailTimeframe","trailStopPrice","trendEndPrice","screenshotUrl","exitScreenshotUrl"].concat(RULE_KEYS.map(function(k){return"rule_"+k})).concat(STOP_KEYS.map(function(k){return"stop_"+k}));
var sample=["2024-01-15","09:32","09:45","TSLA","3m","Long","Continuation","live","245.50","244.00","248.20","100","249.00","244.50","28","0.25","Bullish","52","71","68","None","None","Run First","Above Avg","Trail","Trending","4","Calm","Calm","Satisfied","Y","N","","","1m","","","",""].concat(RULE_KEYS.map(function(){return"Y"})).concat(STOP_KEYS.map(function(){return"N"}));
var notes=["# VALID VALUES PER COLUMN","# date: YYYY-MM-DD","# timeframe: 1m 3m 5m 15m 1h 2h 4h 1D 1W","# direction: Long Short","# type: Reversal Continuation","# mode: live backtest","# cloudDirection: Bullish Bearish None","# divBefore divDuring: Bullish Bearish None","# maeTiming: Dip First Run First","# volumeAtExit: Below Avg At Avg Above Avg","# exitType: Trail Limit Stopped","# session: Trending Ranging Choppy Breakout Reversal","# confidence: 1 2 3 4 5","# emotion emotionDuring: Calm Eager FOMO Frustrated Revenge Bored","# emotionDuring: Calm Confident Anxious Impatient Greedy Panicked","# emotionAfter: Satisfied Relieved Frustrated Regret Revenge Neutral","# followedRules hasPartial: Y N","# partialPct: 25 33 50 75","# trailTimeframe: 1m 3m 5m Same","# all rule_ and stop_ columns: Y N"];
var rows=[notes.join("\n"),headers.join(","),sample.join(",")];
// add existing trades if any
if(trades&&trades.length){trades.forEach(function(t){var row=headers.slice(0,39).map(function(col){
if(col.startsWith("rule_")){var k=col.replace("rule_","");return(t.rules&&t.rules[k])||""}
else if(col.startsWith("stop_")){var k=col.replace("stop_","");return(t.stopRules&&t.stopRules[k])||""}
else{var v=t[col]||"";return String(v).indexOf(",")>=0?'"'+v+'"':v}
});var ruleVals=RULE_KEYS.map(function(k){return(t.rules&&t.rules[k])||""});
var stopVals=STOP_KEYS.map(function(k){return(t.stopRules&&t.stopRules[k])||""});
rows.push(row.concat(ruleVals).concat(stopVals).join(","))})}
var blob=new Blob([rows.join("\n")],{type:"text/csv"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="trade_journal_template.csv";a.click();URL.revokeObjectURL(url)}

function parseCSV(text,cb){
var lines=text.split("\n").filter(function(l){return l.trim()&&!l.trim().startsWith("#")});
if(lines.length<2){cb(null,"No data rows found");return}
var headers=lines[0].split(",").map(function(h){return h.trim()});
var RULE_KEYS=["ultimateHL","lhhl","chanBreak","chanRetest","firstCandle10ema","secondCandleEntry","macdCross","cloudAlign","rsiExtreme","cloud15m"];
var STOP_KEYS=["initStopHL","stopToChan","trailHL","trailFailedHL","stopMoved","reentry"];
var imported=[];
for(var i=1;i<lines.length;i++){
var vals=lines[i].match(/(".*?"|[^,]+|(?<=,)(?=,)|^(?=,)|(?<=,)$)/g)||[];
// simple split fallback
vals=lines[i].split(",").map(function(v){return v.trim().replace(/^"|"$/g,"")});
if(vals.length<3)continue;
var row={};headers.forEach(function(h,idx){row[h]=vals[idx]||""});
var t={id:Date.now()+"_"+i,date:row.date||"",time:row.time||"",exitTime:row.exitTime||"",ticker:(row.ticker||"TSLA").toUpperCase(),timeframe:row.timeframe||"3m",direction:row.direction||"Long",type:row.type||"Continuation",mode:row.mode||"live",entryPrice:parseFloat(row.entryPrice)||0,stopPrice:parseFloat(row.stopPrice)||0,exitPrice:parseFloat(row.exitPrice)||0,shares:parseFloat(row.shares)||0,mfe:parseFloat(row.mfe)||0,mae:parseFloat(row.mae)||0,adxAtEntry:row.adxAtEntry||"",cloudWidthPct:row.cloudWidthPct||"",cloudDirection:row.cloudDirection||"None",rsiAtEntry:row.rsiAtEntry||"",rsiAtPeak:row.rsiAtPeak||"",rsiAtExit:row.rsiAtExit||"",divBefore:row.divBefore||"None",divDuring:row.divDuring||"None",maeTiming:row.maeTiming||"",volumeAtExit:row.volumeAtExit||"",exitType:row.exitType||"",sessionRead:row.session||"",confidence:row.confidence||"",emotion:row.emotion||"Calm",emotionDuring:row.emotionDuring||"",emotionAfter:row.emotionAfter||"",followedRules:row.followedRules||"",hasPartial:row.hasPartial||"N",partialExitPrice:parseFloat(row.partialExitPrice)||0,partialPct:row.partialPct||"",trailTimeframe:row.trailTimeframe||"",trailStopPrice:parseFloat(row.trailStopPrice)||0,trendEndPrice:parseFloat(row.trendEndPrice)||0,screenshotUrl:row.screenshotUrl||"",screenshotData:"",exitScreenshotUrl:row.exitScreenshotUrl||"",exitScreenshotData:"",targets:[],strategyId:"",rules:{},stopRules:{}};
RULE_KEYS.forEach(function(k){t.rules[k]=row["rule_"+k]||""});
STOP_KEYS.forEach(function(k){t.stopRules[k]=row["stop_"+k]||""});
imported.push(t)}
cb(imported,null)}

// === HEATMAP + WEEKLY CALENDAR ===
var HeatmapTab=function(){
var _wk=React.useState(null),selWeek=_wk[0],setSelWeek=_wk[1];
var _vw=React.useState("calendar"),hmView=_vw[0],setHmView=_vw[1];
var ALL_DAYS=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
var TRADE_DAYS=["Sun","Mon","Tue","Wed","Thu","Fri"];
var HOURS=["6","7","8","9","10","11","12","13","14","15","16","17"];

function weekKey(dateStr){var d=new Date(dateStr+"T12:00:00");var day=d.getDay();var tmp=new Date(d);tmp.setDate(d.getDate()-day);return tmp.toISOString().slice(0,10)}
function isOpex(dateStr){var d=new Date(dateStr+"T12:00:00");if(d.getDay()!==5)return false;var cnt=0;var t=new Date(d.getFullYear(),d.getMonth(),1);while(t<=d){if(t.getDay()===5)cnt++;t.setDate(t.getDate()+1)}return cnt===3}
function cellBg(pl,n){if(!n)return{bg:K.bg,tc:K.dm,bd:"1px solid "+K.bd};var intensity=Math.min(Math.abs(pl)/80,1);if(pl>0)return{bg:"rgba(46,213,115,"+(0.1+intensity*0.55)+")",tc:K.g,bd:"1px solid rgba(46,213,115,.3)"};return{bg:"rgba(255,71,87,"+(0.1+intensity*0.55)+")",tc:K.r,bd:"1px solid rgba(255,71,87,.3)"}}

var weekMap={};
cp.forEach(function(t){if(!t.date)return;var wk=weekKey(t.date);if(!weekMap[wk])weekMap[wk]={key:wk,trades:[],pl:0,w:0,r:0,n:0,days:{}};var p=cPL(t);weekMap[wk].trades.push(t);weekMap[wk].pl+=p.pl;weekMap[wk].n++;if(p.pl>0)weekMap[wk].w++;weekMap[wk].r+=(p.r||0);var dn=ALL_DAYS[new Date(t.date+"T12:00:00").getDay()];if(!weekMap[wk].days[dn])weekMap[wk].days[dn]={pl:0,n:0,w:0,trades:[]};weekMap[wk].days[dn].pl+=p.pl;weekMap[wk].days[dn].n++;if(p.pl>0)weekMap[wk].days[dn].w++;weekMap[wk].days[dn].trades.push(t)});
var weeks=Object.keys(weekMap).sort().reverse().map(function(k){return weekMap[k]});
var selWeekData=selWeek?weekMap[selWeek]:null;

var dayMap2={};ALL_DAYS.forEach(function(d){dayMap2[d]={pl:0,n:0,w:0}});
cp.forEach(function(t){if(!t.date)return;var dn=ALL_DAYS[new Date(t.date+"T12:00:00").getDay()];var p=cPL(t);dayMap2[dn].pl+=p.pl;dayMap2[dn].n++;if(p.pl>0)dayMap2[dn].w++});
var dayArr=TRADE_DAYS.map(function(d){return Object.assign({day:d},dayMap2[d])});
var maxDayPL=Math.max.apply(null,dayArr.map(function(d){return Math.abs(d.pl)}).concat([1]));

var hourMap={};
cp.forEach(function(t){if(!t.time)return;var hr=parseInt(t.time.split(":")[0]);if(isNaN(hr))return;var p=cPL(t);if(!hourMap[hr])hourMap[hr]={pl:0,n:0,w:0};hourMap[hr].pl+=p.pl;hourMap[hr].n++;if(p.pl>0)hourMap[hr].w++});
var gridMap={};
cp.forEach(function(t){if(!t.date||!t.time)return;var dn=ALL_DAYS[new Date(t.date+"T12:00:00").getDay()];var hr=parseInt(t.time.split(":")[0]);if(isNaN(hr))return;var key=dn+"_"+hr;if(!gridMap[key])gridMap[key]={pl:0,n:0,w:0};var p=cPL(t);gridMap[key].pl+=p.pl;gridMap[key].n++;if(p.pl>0)gridMap[key].w++});
var COL=56;

if(!cp.length)return h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"Log completed trades to see performance patterns.");

return h("div",null,
h("div",{style:{display:"flex",gap:4,marginBottom:12}},
[["calendar","Weekly Calendar"],["grid","Hour x Day Grid"]].map(function(x){
return h("button",{key:x[0],onClick:function(){setHmView(x[0])},style:{padding:"5px 14px",borderRadius:6,border:"1px solid "+(hmView===x[0]?K.cy:K.bd),fontSize:11,fontWeight:600,cursor:"pointer",background:hmView===x[0]?K.cy+"22":"transparent",color:hmView===x[0]?K.cy:K.dm}},x[1])})),
hmView==="calendar"?h("div",{style:{display:"grid",gridTemplateColumns:selWeekData?"1fr 300px":"1fr",gap:12}},
h("div",null,
h("div",{style:{display:"grid",gridTemplateColumns:"80px repeat(6,1fr)",gap:3,marginBottom:4}},
h("div",{style:{fontSize:9,color:K.dm}},""),
TRADE_DAYS.map(function(d){return h("div",{key:d,style:{textAlign:"center",fontSize:10,fontWeight:700,color:K.dm}},d)})),
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},
weeks.map(function(wk){
var wkStart=new Date(wk.key+"T12:00:00");
var wkLabel=wkStart.toLocaleDateString("en-US",{month:"short",day:"numeric"});
var isOpexWk=TRADE_DAYS.some(function(day){var idx=ALL_DAYS.indexOf(day);var cd=new Date(wkStart);cd.setDate(cd.getDate()+idx);return isOpex(cd.toISOString().slice(0,10))});
var isSelected=selWeek===wk.key;
return h("div",{key:wk.key,style:{display:"grid",gridTemplateColumns:"80px repeat(6,1fr)",gap:3,cursor:"pointer"},onClick:function(){setSelWeek(isSelected?null:wk.key)}},
h("div",{style:{display:"flex",flexDirection:"column",justifyContent:"center",padding:"4px 6px",borderRadius:6,background:isSelected?K.cy+"22":K.cd,border:"1px solid "+(isSelected?K.cy:K.bd)}},
h("div",{style:{fontSize:10,fontWeight:700,color:isSelected?K.cy:K.tx}},wkLabel),
h("div",{style:{fontSize:9,color:wk.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(wk.pl>=0?"+":"-")+"$"+Math.abs(wk.pl).toFixed(0)),
h("div",{style:{fontSize:8,color:K.dm}},wk.n+"tr "+(wk.w/wk.n*100).toFixed(0)+"%WR"),
isOpexWk?h("div",{style:{fontSize:7,color:K.go,fontWeight:700,marginTop:1}},"OPEX"):null),
TRADE_DAYS.map(function(day){
var dc=wk.days[day];
var cb=cellBg(dc?dc.pl:0,dc?dc.n:0);
var dayIdx=ALL_DAYS.indexOf(day);
var cellDate=new Date(wkStart);cellDate.setDate(cellDate.getDate()+dayIdx);
var opex=isOpex(cellDate.toISOString().slice(0,10));
return h("div",{key:day,
title:dc?day+" wk "+wkLabel+": "+dc.n+" trades, "+(dc.pl>=0?"+":"")+dc.pl.toFixed(2)+" P/L, "+(dc.w/dc.n*100).toFixed(0)+"% WR":day+" no trades",
style:{borderRadius:6,background:cb.bg,border:cb.bd,padding:"4px 4px",minHeight:48,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",position:"relative"}},
opex?h("span",{style:{position:"absolute",top:2,right:3,fontSize:6,color:K.go,fontWeight:700}},"OPEX"):null,
dc&&dc.n>0?h("div",{style:{textAlign:"center"}},
h("div",{style:{fontSize:9,fontWeight:700,color:cb.tc,fontFamily:"JetBrains Mono,monospace"}},(dc.pl>=0?"+":"-")+"$"+Math.abs(dc.pl).toFixed(0)),
h("div",{style:{fontSize:8,color:cb.tc,opacity:.85}},(dc.w/dc.n*100).toFixed(0)+"% WR"),
h("div",{style:{fontSize:7,color:K.dm}},dc.n+"tr")):
h("div",{style:{fontSize:8,color:K.bd}},"-"))
}))
}))
),
selWeekData?h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.cy,padding:12,position:"sticky",top:12,alignSelf:"start"}},
h("div",{style:{fontSize:11,fontWeight:700,color:K.cy,marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center"}},
"Week of "+new Date(selWeekData.key+"T12:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),
h("span",{style:{fontSize:10,color:K.dm,cursor:"pointer"},onClick:function(){setSelWeek(null)}},"x close")),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:10}},
[["P/L",(selWeekData.pl>=0?"+$":"-$")+Math.abs(selWeekData.pl).toFixed(2),selWeekData.pl>=0?K.g:K.r],
["Trades",""+selWeekData.n,K.tx],
["Win Rate",(selWeekData.w/selWeekData.n*100).toFixed(0)+"%",selWeekData.w/selWeekData.n>=.5?K.g:K.r],
["Avg R",(selWeekData.r/selWeekData.n).toFixed(2)+"R",selWeekData.r/selWeekData.n>=0?K.g:K.r]
].map(function(x){return h("div",{key:x[0],style:{background:K.bg,borderRadius:6,padding:"6px 8px",textAlign:"center"}},
h("div",{style:{fontSize:9,color:K.dm,marginBottom:2}},x[0]),
h("div",{style:{fontSize:13,fontWeight:700,color:x[2],fontFamily:"JetBrains Mono,monospace"}},x[1]))})),
h("div",{style:{fontSize:10,fontWeight:700,color:K.dm,marginBottom:6}},"Trades this week"),
h("div",{style:{display:"flex",flexDirection:"column",gap:3,maxHeight:320,overflowY:"auto"}},
selWeekData.trades.sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)}).map(function(t){
var p=cPL(t);
return h("div",{key:t.id,style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 6px",background:K.bg,borderRadius:4,fontSize:10}},
h("div",null,
h("div",{style:{color:K.tx,fontWeight:600}},t.ticker+" "+t.direction),
h("div",{style:{color:K.dm,fontSize:9}},t.date+" "+(t.time||""))),
h("div",{style:{textAlign:"right"}},
h("div",{style:{color:p.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace",fontWeight:700}},(p.pl>=0?"+$":"-$")+Math.abs(p.pl).toFixed(2)),
h("div",{style:{color:K.dm,fontSize:9}},p.r.toFixed(2)+"R")))}))
):null):null,
hmView==="grid"?h("div",null,
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:14,marginBottom:12}},
h("div",{style:{fontSize:11,color:K.dm,fontWeight:700,marginBottom:10,display:"flex",alignItems:"center"}},"DAY OF WEEK PERFORMANCE",h(Tip,{t:"P/L and win rate by day. Futures trade Sun-Fri."})),
h("div",{style:{display:"flex",gap:6}},dayArr.map(function(d){
return h("div",{key:d.day,style:{flex:1,padding:"10px 6px",background:K.bg,borderRadius:8,textAlign:"center",border:"1px solid "+(d.n>0&&d.pl>0?K.g+"44":d.n>0&&d.pl<0?K.r+"44":K.bd)}},
h("div",{style:{fontSize:11,fontWeight:700,color:K.tx,marginBottom:4}},d.day),
d.n>0?h("div",null,
h("div",{style:{fontSize:13,fontWeight:700,color:d.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(d.pl>=0?"+":"-")+"$"+Math.abs(d.pl).toFixed(0)),
h("div",{style:{fontSize:10,color:d.w/d.n>=.5?K.g:K.r,marginTop:2}},(d.w/d.n*100).toFixed(0)+"% WR"),
h("div",{style:{fontSize:9,color:K.dm}},d.n+" trades"),
h("div",{style:{height:3,background:K.bd,borderRadius:2,marginTop:6,overflow:"hidden"}},
h("div",{style:{height:"100%",width:(Math.abs(d.pl)/maxDayPL*100)+"%",background:d.pl>=0?K.g:K.r,borderRadius:2}})))
:h("div",{style:{fontSize:9,color:K.dm,marginTop:4}},"no data"))}))
),
cp.filter(function(t){return t.date&&t.time}).length>=3?
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:14}},
h("div",{style:{fontSize:11,color:K.dm,fontWeight:700,marginBottom:12,display:"flex",alignItems:"center"}},"HOUR x DAY GRID  (Sun-Fri Futures)",h(Tip,{t:"Hours down left, days across top. Hover each cell for trade detail."})),
h("div",{style:{overflowX:"auto"}},
h("div",{style:{display:"inline-block"}},
h("div",{style:{display:"flex",marginBottom:4,paddingLeft:52}},
TRADE_DAYS.map(function(day){var ds=dayMap2[day];return h("div",{key:day,style:{width:COL,textAlign:"center",fontSize:10,fontWeight:700,color:ds&&ds.n>0&&ds.pl>0?K.g:ds&&ds.n>0&&ds.pl<0?K.r:K.dm,marginRight:3}},day)})),
HOURS.map(function(hr){
return h("div",{key:hr,style:{display:"flex",alignItems:"center",marginBottom:3}},
h("div",{style:{width:52,fontSize:10,color:hourMap[+hr]?K.tx:K.dm,fontWeight:hourMap[+hr]?600:400,flexShrink:0}},hr+":00"),
TRADE_DAYS.map(function(day){
var key=day+"_"+hr;var cell=gridMap[key];
var cb=cellBg(cell?cell.pl:0,cell?cell.n:0);
var txt=cell&&cell.n>0?(cell.pl>=0?"+":"-")+"$"+Math.abs(cell.pl).toFixed(0):"";
var subTxt=cell&&cell.n>0?(cell.w/cell.n*100).toFixed(0)+"%":"";
return h("div",{key:day,
title:cell?day+" "+hr+":00 - "+cell.n+" trade"+(cell.n>1?"s":"")+", "+(cell.pl>=0?"+":"")+cell.pl.toFixed(2)+" P/L, "+(cell.w/cell.n*100).toFixed(0)+"% WR":"No trades",
style:{width:COL,height:34,marginRight:3,background:cb.bg,border:cb.bd,borderRadius:5,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",fontSize:8,fontFamily:"JetBrains Mono,monospace",color:cb.tc}},
cell&&cell.n>0?h("div",{style:{textAlign:"center"}},
h("div",{style:{fontSize:8,lineHeight:1.2}},txt),
h("div",{style:{fontSize:7,opacity:.85}},subTxt)):null)}))
}))))
:h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:20,textAlign:"center",color:K.dm,fontSize:11}},"Log 3+ trades with entry times to see the hour grid.")):null)};



// === EDUCATION TAB (proper React component - no useState outside App) ===
var EduTab=function(){
var _ec=React.useState("Strategies"),eduCat=_ec[0],setEduCat=_ec[1];
var _sel=React.useState(null),selId=_sel[0],setSelId=_sel[1];
var STRATS=[
{id:"ema_cloud",name:"EMA Cloud System",icon:"☁",cat:"Strategies",
desc:"An EMA cloud is built from two EMAs plotted with the area between them shaded — typically the 9 and 21 EMA, or 8 and 21. When price is above the cloud, bias is long. Below = short. Inside the cloud = no trade. The cloud gives a visual trend filter that avoids the noise of a single line.",
detail:"The cloud becomes most powerful when combined with a momentum indicator like MACD or RSI. The sequence is: (1) price must be on the correct side of the cloud, (2) cloud must be sloping in your direction, (3) momentum must confirm. A wide cloud means strong trend. A narrow or flat cloud means the trend is weakening — this is when you reduce size or sit out.",
tip:"Cloud width is a built-in volatility and trend strength gauge. Wide = trade with the trend. Narrow = be cautious. This journal tracks cloud width % — use the bucket analysis to find your optimal width range."},
{id:"macd",name:"MACD",icon:"📊",cat:"Strategies",
desc:"Moving Average Convergence Divergence measures momentum by comparing two EMAs (typically 12 and 26 period) and plotting their difference as the MACD line, along with a 9-period signal line. The histogram shows the gap between them — expanding histogram = accelerating momentum, shrinking = fading.",
detail:"For momentum scalping, the two most useful MACD signals are: (1) the histogram flipping from negative to positive (or vice versa) near a key level — this is the earliest entry signal, and (2) the MACD line crossing the signal line for confirmation. Divergence is the elite signal — price makes a new high but MACD histogram makes a lower high. This means momentum is dying before price reverses.",
tip:"MACD cross after a prolonged trend gives false signals in choppy markets. The histogram direction change is more reliable than the cross for early entries on short timeframes."},
{id:"rsi",name:"RSI",icon:"📈",cat:"Strategies",
desc:"Relative Strength Index measures the speed and magnitude of recent price moves on a 0-100 scale. Above 70 = overbought territory. Below 30 = oversold. But for momentum trading, overbought does not mean sell — in a strong trend, RSI can stay above 70 for extended periods.",
detail:"RSI has three uses in this system: (1) At entry — RSI at 50-65 on a long setup means momentum has room to run. RSI at 80+ on entry means you may be chasing. (2) At peak — RSI at peak MFE tells you how far momentum extended. If you consistently exit when RSI hits 75, compare to what RSI peaked at — are you leaving too early? (3) Divergence — the most powerful RSI signal. Price makes new high, RSI makes lower high = momentum is failing. This journal tracks RSI at entry, at peak, and at exit separately to analyze all three uses.",
tip:"RSI divergence before entry is one of the sharpest reversal signals. Price making a new low while RSI makes a higher low = bullish divergence. Always log it in the divergence field — the analysis will show whether divergence-confirmed entries outperform."},
{id:"adx",name:"ADX (Average Directional Index)",icon:"📉",cat:"Strategies",
desc:"ADX measures trend strength on a 0-100 scale, but it does NOT indicate direction — only strength. Below 20 = weak or no trend (range/chop). 20-25 = emerging trend. 25+ = confirmed trend. 40+ = very strong trend. Many momentum systems require ADX 25+ before taking a trade.",
detail:"ADX is the quality filter for your setups. A technically perfect entry pattern in a low-ADX environment has a much lower win rate than the same pattern with ADX 30+. This journal has an ADX bucket analysis that will show you exactly what your win rate is at each ADX range. Check it after 20+ trades — most traders find a clear threshold where their edge materializes.",
tip:"ADX lags price by definition — it tells you the trend that existed, not what is coming. Use it as a filter (only trade when ADX is above your threshold) rather than as an entry trigger. The entry trigger should come from price action and momentum."},
{id:"swing",name:"Swing Points (HH/HL/LH/LL)",icon:"🔁",cat:"Strategies",
desc:"Swing points are the foundational language of price structure. A Higher High (HH) and Higher Low (HL) sequence defines an uptrend. Lower High (LH) and Lower Low (LL) defines a downtrend. A break in structure — a new LH after an uptrend — is the earliest sign of a potential reversal.",
detail:"For continuation trades, you want to see HH/HL intact and enter on the pullback to the HL. The stop goes below the most recent HL. For reversal trades, you wait for a confirmed structural shift — price makes a LH, then breaks below the prior HL. That break of structure is your reversal entry signal. The 'LH/HL' rule in this journal tracks whether the structure was intact at your entry.",
tip:"The quality of a swing point matters. A swing high formed on high volume with a long upper wick is more significant than one formed on thin volume. Strong swing points hold under retest pressure. Weak ones get violated."},
{id:"channel",name:"Channel Analysis",icon:"📐",cat:"Strategies",
desc:"Price channels are formed by drawing parallel lines connecting swing highs and swing lows. An upward channel has higher highs and higher lows on parallel lines. The channel top is resistance, the bottom is support. Channels can be ascending, descending, or horizontal (range).",
detail:"Channel trading has two modes: (1) Range play — buy the bottom, sell the top, stop outside the channel. Works best when ADX is below 20 and price has touched each boundary at least twice. (2) Breakout play — price consolidates in a tight channel then breaks with volume. The measured move target is the channel width added to the breakout point. This journal tracks Chan Break and Chan Retest separately to show whether entering on the break or waiting for the retest works better for you.",
tip:"The more touches a channel boundary has, the more reliable it becomes — but also the more compressed the eventual breakout. Channels with 4+ touches on each side tend to produce explosive breakouts when they finally fail."},
{id:"divergence",name:"Divergence",icon:"⚡",cat:"Signals",
desc:"Divergence occurs when price and a momentum indicator disagree. Bullish divergence: price makes a lower low, but RSI or MACD makes a higher low. This means selling pressure is weakening despite price falling — a reversal signal. Bearish divergence is the mirror: price makes a higher high, but momentum makes a lower high.",
detail:"This journal tracks divergence in two places: before entry (should I take this trade?) and during the trade (should I exit?). Divergence before entry on a reversal setup is a high-confidence confluence. Divergence during a trade — particularly bearish divergence while you are long — is a warning that momentum is fading and you should consider tightening your stop or taking partial profits. The analysis engine will show whether your divergence-confirmed entries have a higher win rate than non-divergence entries.",
tip:"Hidden divergence is different from regular divergence. Hidden bullish divergence: price makes a higher low, RSI makes a lower low — this confirms the trend and suggests continuation, not reversal. It is an entry signal, not an exit warning. Regular divergence at market extremes (RSI 75+) carries more weight than divergence in the mid-range."},
{id:"volume",name:"Volume Analysis",icon:"🔊",cat:"Signals",
desc:"Volume is the fuel behind price moves. A breakout on high volume means institutional participation — the move is likely to continue. A breakout on low volume means retail-only participation — the move is likely to fail. Volume at exit tells you whether the move exhausted itself or still has buyers/sellers.",
detail:"This journal tracks volume at exit as Below Avg, At Avg, or Above Avg. The analysis will show whether your winning trades tend to exit into above-average volume (exhaustion top/bottom) or below-average volume (move faded quietly). For continuation trades, you want to see volume expanding in the direction of the trend and contracting on pullbacks — this confirms the trend is healthy and the pullback is just resting.",
tip:"Volume spikes on reversal candles carry the most information. A bearish engulfing candle on 3x average volume is a high-confidence reversal signal. The same candle on 0.5x volume is noise. Always note whether an important candle had volume confirmation."},
{id:"wyckoff",name:"Wyckoff Method",icon:"🏛",cat:"Advanced",
desc:"Wyckoff analysis focuses on the relationship between price, volume, and the behavior of large institutional operators (the Composite Man). Markets move through four phases: Accumulation (large operators buying quietly), Markup (uptrend as public joins), Distribution (large operators selling into strength), and Markdown (downtrend).",
detail:"Key Wyckoff events: Spring — a false break below support in accumulation that shakes out weak holders before the markup. Upthrust — false break above resistance in distribution. Sign of Strength (SOS) — a strong advance on increasing volume after a spring, confirming accumulation is complete. Last Point of Support (LPS) — the pullback after a SOS, the ideal entry point. Wyckoff analysis is most powerful on daily/weekly charts but principles apply intraday on liquid names like TSLA.",
tip:"The Spring is the most powerful Wyckoff entry. Price quickly violates support, finds no sellers, and snaps back above — the failure itself is the signal. Volume on the spring should be lower than prior down bars, and volume on the recovery should surge. A high-volume spring that fails to recover is a genuine breakdown, not a spring."},
{id:"ict",name:"ICT Concepts",icon:"🏦",cat:"Advanced",
desc:"ICT (Inner Circle Trader) concepts focus on institutional order flow, liquidity, and market maker behavior. The core idea is that markets move to seek liquidity — pools of stop orders and resting orders — before reversing. Retail traders place stops in predictable places (below swing lows, above swing highs), and institutional algorithms engineer moves to grab that liquidity before the real move.",
detail:"Key ICT concepts: Order Blocks — the last bearish candle before a strong bullish move (or last bullish before a strong bearish move). Price often returns to these levels for a reaction. Fair Value Gaps (FVG) — a 3-candle pattern where the wicks of the first and third candles do not overlap, leaving an imbalance that price tends to fill. Liquidity Sweeps — price quickly takes out a prior high/low and reverses, stopping out traders who had breakout entries. Killzones — specific high-probability time windows (NY Open 9:30-11am, London Open, etc.) when institutional flow is highest.",
tip:"ICT concepts work best when the direction of the higher timeframe narrative is clear. Identify whether the market is in a bullish or bearish expansion phase on the daily/4h, then look for order blocks and FVGs on the 1-5 minute chart that align with that bias. Trading ICT setups against the higher timeframe trend produces the worst results."}
];
var cats=["Strategies","Signals","Advanced"];
var filtered=STRATS.filter(function(s){return s.cat===eduCat});
return h("div",null,
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"12px 16px",marginBottom:12}},
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,marginBottom:4}},"Trading Education"),
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.5}},"Reference guides for the strategies and indicators built into this journal. Each entry covers the core concept, how to apply it in practice, and a pro tip from experience. Click any card to expand.")),
h("div",{style:{display:"flex",gap:4,marginBottom:12,flexWrap:"wrap"}},
cats.map(function(cat){return h("button",{key:cat,onClick:function(){setEduCat(cat);setSelId(null)},style:{padding:"5px 14px",borderRadius:6,border:"1px solid "+(eduCat===cat?K.cy:K.bd),fontSize:11,fontWeight:600,cursor:"pointer",background:eduCat===cat?K.cy+"22":"transparent",color:eduCat===cat?K.cy:K.dm}},cat)})),
h("div",{style:{display:"flex",flexDirection:"column",gap:8}},
filtered.map(function(s){
var isOpen=selId===s.id;
return h("div",{key:s.id,style:{background:K.cd,borderRadius:8,border:"1px solid "+(isOpen?K.cy:K.bd),padding:"12px 14px",cursor:"pointer"},
onClick:function(){setSelId(isOpen?null:s.id)}},
h("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:isOpen?8:0}},
h("span",{style:{fontSize:20,flexShrink:0}},s.icon),
h("div",{style:{flex:1}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx}},s.name),
h("div",{style:{fontSize:10,color:K.dm,marginTop:2,lineHeight:1.4,display:isOpen?"none":"block"}},s.desc.substring(0,120)+"...")),
h("div",{style:{fontSize:10,color:K.cy,flexShrink:0}},isOpen?"▲ collapse":"▼ expand")),
isOpen?h("div",null,
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.6,marginBottom:10}},s.desc),
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.6,marginBottom:10,borderLeft:"3px solid "+K.bd,paddingLeft:10}},s.detail),
h("div",{style:{background:K.bg,borderRadius:6,padding:"8px 12px",borderLeft:"3px solid "+K.cy}},
h("div",{style:{fontSize:9,color:K.cy,fontWeight:700,marginBottom:3}},"PRO TIP"),
h("div",{style:{fontSize:10,color:K.dm,lineHeight:1.5}},s.tip))):null)
})))};

// === NEWS TAB (proper React component) ===
var NewsTab=function(){
var _nc=React.useState("General"),newsCat=_nc[0],setNewsCat=_nc[1];
var FEEDS=[
{n:"Bloomberg Markets",u:"https://www.bloomberg.com/markets",d:"Institutional-grade financial news. Best for macro, Fed coverage, and pre-market context.",icon:"📰",cat:"General"},
{n:"Reuters Markets",u:"https://www.reuters.com/markets",d:"Fast, reliable breaking news. Strong on earnings reactions and global macro events.",icon:"🌐",cat:"General"},
{n:"MarketWatch",u:"https://www.marketwatch.com",d:"Broad market coverage with live quotes, earnings calendar, and economic data.",icon:"📊",cat:"General"},
{n:"Investor's Business Daily",u:"https://www.investors.com/market-trend/stock-market-today",d:"Daily market analysis focused on growth stocks and momentum setups.",icon:"📈",cat:"General"},
{n:"Finviz News",u:"https://finviz.com/news.ashx",d:"Real-time aggregated headlines from all major sources. Fast scanning for catalysts.",icon:"⚡",cat:"General"},
{n:"Benzinga",u:"https://www.benzinga.com/news",d:"Pre-market catalyst research. Known for fast options flow and earnings news.",icon:"🔔",cat:"General"},
{n:"Fed Economic Calendar (FRED)",u:"https://fred.stlouisfed.org/releases",d:"Official Federal Reserve economic data releases. CPI, PPI, unemployment, GDP — all in one place with historical context.",icon:"🏛",cat:"Government"},
{n:"US Economic Calendar (BEA)",u:"https://www.bea.gov/news/schedule",d:"Bureau of Economic Analysis official release schedule. GDP, personal income, trade data.",icon:"🏦",cat:"Government"},
{n:"BLS Release Calendar",u:"https://www.bls.gov/schedule/news_release/",d:"Bureau of Labor Statistics. CPI, PPI, jobs report (NFP), unemployment — all official release dates.",icon:"📋",cat:"Government"},
{n:"US Treasury Announcements",u:"https://home.treasury.gov/news/press-releases",d:"Treasury auction schedules, bond issuance, and fiscal policy announcements that move rates and equities.",icon:"🏛",cat:"Government"},
{n:"CME FedWatch Tool",u:"https://www.cmegroup.com/markets/interest-rates/cme-fedwatch-tool.html",d:"Real-time market-implied probability of Fed rate changes at each meeting. Essential before trading rate-sensitive days.",icon:"🎯",cat:"Government"},
{n:"SEC EDGAR Filings",u:"https://efts.sec.gov/LATEST/search-index?q=%22TSLA%22&dateRange=custom&startdt=2024-01-01&forms=8-K",d:"Official SEC filings for TSLA. 8-K filings are market-moving disclosures — earnings, guidance changes, CEO announcements.",icon:"📋",cat:"Government"},
{n:"Earnings Whispers",u:"https://www.earningswhispers.com",d:"Earnings calendar with whisper numbers (the real expected number vs the official estimate). Know the bar before you trade earnings.",icon:"📅",cat:"Calendar"},
{n:"Forex Factory Calendar",u:"https://www.forexfactory.com/calendar",d:"The most comprehensive economic event calendar. Color-coded by market impact. Essential for pre-session awareness.",icon:"🗓",cat:"Calendar"},
{n:"Investing.com Calendar",u:"https://www.investing.com/economic-calendar",d:"Economic calendar with actual vs forecast vs prior data. Filter by country and impact level.",icon:"📅",cat:"Calendar"},
{n:"Market Chameleon Earnings",u:"https://marketchameleon.com/CalendarDay",d:"Options-implied earnings moves, historical earnings reactions, and IV rank — critical for sizing around events.",icon:"📊",cat:"Calendar"},
{n:"CBOE VIX",u:"https://www.cboe.com/tradable_products/vix",d:"Volatility index. High VIX means larger expected moves and wider stops needed. Low VIX means compressed ranges — reduce targets.",icon:"📉",cat:"Market"},
{n:"TSLA on Finviz",u:"https://finviz.com/quote.ashx?t=TSLA",d:"TSLA snapshot: news, chart, short float, institutional ownership, and options data.",icon:"🚗",cat:"Market"},
{n:"TradingView Screener",u:"https://www.tradingview.com/screener",d:"Real-time stock screener. Filter by gap %, relative volume, RSI, ADX, and 50+ other criteria.",icon:"🔍",cat:"Market"},
{n:"Unusual Whales",u:"https://unusualwhales.com",d:"Options flow tracking. Large unusual options activity often precedes big moves. Good for pre-market thesis building.",icon:"🐳",cat:"Market"}
];
var cats=["General","Government","Calendar","Market"];
var filtered=FEEDS.filter(function(f){return f.cat===newsCat});
return h("div",null,
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"12px 16px",marginBottom:12}},
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,marginBottom:4}},"Market Resources"),
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.5}},"Quick access to the sources that matter before and during the trading day. Government tab has all official data release schedules. All links open in a new tab."),
h("div",{style:{fontSize:10,color:K.go,marginTop:8,padding:"5px 10px",background:K.go+"11",borderRadius:5,border:"1px solid "+K.go+"33"}},"Paid v1: Live news feed filtered by your ticker with pre-session AI briefings auto-generated each morning.")),
h("div",{style:{display:"flex",gap:4,marginBottom:12,flexWrap:"wrap"}},
cats.map(function(cat){return h("button",{key:cat,onClick:function(){setNewsCat(cat)},style:{padding:"5px 14px",borderRadius:6,border:"1px solid "+(newsCat===cat?K.cy:K.bd),fontSize:11,fontWeight:600,cursor:"pointer",background:newsCat===cat?K.cy+"22":"transparent",color:newsCat===cat?K.cy:K.dm}},cat)})),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}},
filtered.map(function(f){
return h("a",{key:f.n,href:f.u,target:"_blank",rel:"noopener noreferrer",style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"12px 14px",textDecoration:"none",display:"block"}},
h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
h("span",{style:{fontSize:18}},f.icon),
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx}},f.n)),
h("div",{style:{fontSize:10,color:K.dm,lineHeight:1.5}},f.d),
h("div",{style:{fontSize:9,color:K.cy,marginTop:6}},"Open in new tab ↗"))
})))};


// === EXPORT/IMPORT ===
function expJ(){var b=new Blob([JSON.stringify(trades,null,2)],{type:"application/json"});var u=URL.createObjectURL(b);var a=document.createElement("a");a.href=u;a.download="trade_journal_"+new Date().toISOString().slice(0,10)+".json";a.click();URL.revokeObjectURL(u)}
function impJ(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){try{var d=JSON.parse(ev.target.result);if(Array.isArray(d))setTr(d)}catch(err){alert("Bad JSON")}};r.readAsText(f)}
function impCSV(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){parseCSV(ev.target.result,function(imported,err){if(err){alert("CSV error: "+err);return}if(window.confirm("Import "+imported.length+" trades from CSV? This will ADD to existing trades.")){setTr(function(prev){return prev.concat(imported)})}})};r.readAsText(f)}
// Lightbox
if(lb)return h("div",null,h("div",{onClick:function(){setLb(null)},style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.92)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",cursor:"zoom-out"}},h("img",{src:lb,alt:"",style:{maxWidth:"94vw",maxHeight:"94vh",borderRadius:8}}),h("div",{style:{position:"absolute",top:16,right:24,color:"#fff",fontSize:28,cursor:"pointer",fontWeight:700}},"\u00d7")));
var lc=trades.filter(function(t){return(t.mode||"live")==="live"}).length;
var bc=trades.filter(function(t){return(t.mode||"live")==="backtest"}).length;
return h("div",{style:{background:K.bg,minHeight:"100vh",color:K.tx,fontFamily:"'IBM Plex Sans',-apple-system,sans-serif"}},
sf?rF():null,
h("div",{style:{padding:"8px 12px",borderBottom:"1px solid "+K.bd,display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}},
h("h1",{style:{margin:0,fontSize:14,fontFamily:"JetBrains Mono,monospace",color:K.go}},"TRADE JOURNAL v7"),
h("div",{style:{display:"flex",gap:2,background:K.cd,borderRadius:8,padding:2}},
h("button",{onClick:function(){sMd("live")},style:{padding:"3px 8px",borderRadius:6,border:"none",fontSize:11,fontWeight:600,cursor:"pointer",background:md==="live"?K.cy:"transparent",color:md==="live"?"#fff":K.dm}},"Live("+lc+")"),
h("button",{onClick:function(){sMd("backtest")},style:{padding:"3px 8px",borderRadius:6,border:"none",fontSize:11,fontWeight:600,cursor:"pointer",background:md==="backtest"?K.pu:"transparent",color:md==="backtest"?"#fff":K.dm}},"BT("+bc+")"),
h("button",{onClick:function(){sMd("all")},style:{padding:"3px 8px",borderRadius:6,border:"none",fontSize:11,fontWeight:600,cursor:"pointer",background:md==="all"?K.go:"transparent",color:md==="all"?"#fff":K.dm}},"All")),
h("div",{style:{display:"flex",gap:2,background:K.cd,borderRadius:8,padding:2,flexWrap:"wrap"}},[["log","Log"],["rules","Analysis"],["equity","Equity"],["heatmap","Heatmap"],["strategies","Strategies"],["education","Education"],["news","News"]].map(function(x){return h("button",{key:x[0],onClick:function(){setVw(x[0])},style:{padding:"4px 10px",borderRadius:6,border:"none",fontSize:11,fontWeight:600,cursor:"pointer",background:vw===x[0]?K.cy:"transparent",color:vw===x[0]?"#fff":K.dm}},x[1])})),
h("div",{style:{flex:1}}),
h("button",{onClick:oQ,style:{padding:"5px 10px",background:K.pu,border:"none",borderRadius:8,color:"#fff",fontSize:11,fontWeight:600,cursor:"pointer"}},"Quick"),
h("button",{onClick:oN,style:{padding:"5px 10px",background:K.g,border:"none",borderRadius:8,color:"#000",fontSize:11,fontWeight:600,cursor:"pointer"}},"+ Trade"),
h("div",{style:{display:"flex",gap:3}},h("button",{onClick:expJ,style:{padding:"3px 7px",background:"transparent",border:"1px solid "+K.bd,borderRadius:6,color:K.dm,fontSize:9,cursor:"pointer"}},"Export JSON"),h("button",{onClick:function(){ir.current&&ir.current.click()},style:{padding:"3px 7px",background:"transparent",border:"1px solid "+K.bd,borderRadius:6,color:K.dm,fontSize:9,cursor:"pointer"}},"Import JSON"),h("button",{onClick:function(){dlCSVTemplate(trades)},style:{padding:"3px 7px",background:"transparent",border:"1px solid "+K.go,borderRadius:6,color:K.go,fontSize:9,cursor:"pointer"}},"CSV Template"),h("button",{onClick:function(){cr.current&&cr.current.click()},style:{padding:"3px 7px",background:"transparent",border:"1px solid "+K.go,borderRadius:6,color:K.go,fontSize:9,cursor:"pointer"}},"Import CSV"),h("input",{ref:ir,type:"file",accept:".json",onChange:impJ,style:{display:"none"}}),h("input",{ref:cr,type:"file",accept:".csv",onChange:impCSV,style:{display:"none"}}))),
h("div",{style:{padding:12,maxWidth:1200,margin:"0 auto"}},vw==="log"?rL():null,vw==="rules"?rR():null,vw==="equity"?rEq():null,vw==="heatmap"?h(HeatmapTab,null):null,vw==="strategies"?rStrats():null,vw==="education"?h(EduTab,null):null,vw==="news"?h(NewsTab,null):null))}
ReactDOM.createRoot(document.getElementById("root")).render(h(App));
}catch(err){document.getElementById("root").innerHTML='<div style="color:#ff4757;padding:20px;font-family:monospace">Error: '+err.message+'<br><pre>'+err.stack+'</pre></div>'}
</script>
</body></html>
