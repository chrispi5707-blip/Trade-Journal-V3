<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade Journal v14 — Beta</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=JetBrains+Mono:wght@600;700&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<style>
:root{--sb-w:220px;--sb-mini:54px}
*{margin:0;padding:0;box-sizing:border-box}
body{background:#080b12;color:#e8edf5;font-family:'IBM Plex Sans',-apple-system,sans-serif;font-size:13px;min-height:100vh;transition:background .2s,color .2s}
[data-theme="light"] body{background:#f0f2f7;color:#0f1923}
[data-theme="light"]::-webkit-scrollbar-track{background:#f0f2f7}
[data-theme="light"]::-webkit-scrollbar-thumb{background:#c8d0de}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none}
input[type=number]{-moz-appearance:textfield}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#080b12}::-webkit-scrollbar-thumb{background:#1e2840;border-radius:3px}
select{background:#1a2435;border:1px solid #1e2840;border-radius:6px;padding:6px 10px;color:#e8edf5;font-size:12px;outline:none;transition:background .2s,border-color .2s,color .2s}
[data-theme="light"] select{background:#f7f9fc;border-color:#e2e6ee;color:#0f1923}
.tip{position:relative;display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:#1e2840;color:#4a586e;font-size:8px;cursor:help;margin-left:4px;flex-shrink:0}
.tip:hover::after{content:attr(data-t);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#1a2435;border:1px solid #1e2840;color:#e8edf5;padding:6px 10px;border-radius:6px;font-size:10px;white-space:normal;width:220px;z-index:9000;line-height:1.4;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,.5)}
.tip:hover::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:#1e2840;z-index:9001}
/* Light mode sidebar */
[data-theme="light"] .tj-sidebar{background:#ffffff;border-right-color:#e2e6ee;box-shadow:2px 0 12px rgba(0,0,0,0.06)}
[data-theme="light"] .sb-brand{border-bottom-color:#e2e6ee}
[data-theme="light"] .sb-cta-wrap{border-bottom-color:#e2e6ee}
[data-theme="light"] .sb-mode-row{background:#f0f2f7;border-color:#e2e6ee}
[data-theme="light"] .sb-mode-btn{color:#6b7a8d}
[data-theme="light"] .sb-sec-label{color:#9aa5b4}
[data-theme="light"] .sb-link{color:#4a586e}
[data-theme="light"] .sb-link:hover{background:#f0f2f7;color:#0f1923}
[data-theme="light"] .sb-link.sb-active{background:#e8f5f0;color:#0f1923}
[data-theme="light"] .sb-app-name{color:#0f1923}
[data-theme="light"] .sb-toggle{background:#f0f2f7;border-color:#e2e6ee;color:#6b7a8d}
[data-theme="light"] .sb-quick-btn{color:#4a586e;border-color:#e2e6ee}
[data-theme="light"] .sb-quick-btn:hover{background:#f0f2f7}
[data-theme="light"] .wm-footer{background:rgba(240,242,247,0.95);border-top-color:#e2e6ee}
[data-theme="light"] .wm-footer span,[data-theme="light"] .wm-footer a{color:#9aa5b4}

/* ── SIDEBAR ──────────────────────────────────────────── */
.tj-sidebar{
  width:var(--sb-w);min-height:100vh;
  background:#0c1018;border-right:1px solid #1e2840;
  display:flex;flex-direction:column;
  position:fixed;top:0;left:0;bottom:0;z-index:8000;
  overflow:hidden;
  transition:width 0.22s cubic-bezier(0.4,0,0.2,1);
}
.tj-sidebar.sb-mini{width:var(--sb-mini)}

/* Brand */
.sb-brand{padding:14px 12px 12px;border-bottom:1px solid #1e2840;display:flex;align-items:center;gap:9px;min-height:58px}
.sb-logo{width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,#00d68f,#5b8dee);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;box-shadow:0 2px 10px rgba(0,214,143,0.25)}
.sb-brand-text{flex:1;min-width:0;overflow:hidden;white-space:nowrap}
.sb-app-name{font-size:13px;font-weight:700;color:#e8edf5;letter-spacing:-0.2px}
.sb-app-badge{display:inline-block;font-size:8px;font-weight:700;color:#00d68f;background:rgba(0,214,143,0.1);border:1px solid rgba(0,214,143,0.22);border-radius:4px;padding:1px 5px;letter-spacing:0.5px;text-transform:uppercase;margin-top:2px}

/* New Trade CTA */
.sb-cta-wrap{padding:8px 10px 6px;border-bottom:1px solid #1e2840;overflow:hidden;display:flex;flex-direction:column;gap:5px}
.sb-cta{width:100%;padding:9px 12px;background:#00d68f;border:none;border-radius:8px;color:#000;font-family:'IBM Plex Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;box-shadow:0 2px 14px rgba(0,214,143,0.35);transition:all .15s;white-space:nowrap;overflow:hidden}
.sb-cta:hover{background:#00eaa0;box-shadow:0 3px 20px rgba(0,214,143,0.5);transform:translateY(-1px)}
.sb-cta-icon{font-size:16px;font-weight:300;flex-shrink:0;line-height:1}
.sb-cta-text{overflow:hidden;transition:opacity .15s,max-width .22s;max-width:120px}
.sb-mini .sb-cta-text{opacity:0;max-width:0}
.sb-mini .sb-cta{gap:0}
.sb-mini .sb-cta-wrap{padding:8px 6px}

/* Mode switcher - now inside cta-wrap */
.sb-mode-row{display:flex;flex-wrap:wrap;background:#111520;border:1px solid #1e2840;border-radius:7px;padding:3px;gap:2px}
.sb-mode-btn{flex:1;padding:4px 4px;border:none;border-radius:4px;font-family:'IBM Plex Sans',sans-serif;font-size:10px;font-weight:600;cursor:pointer;background:transparent;color:#4a586e;transition:all .15s;white-space:nowrap;text-align:center}
.sb-mode-btn.m-live{background:#00d68f;color:#000;box-shadow:0 1px 6px rgba(0,214,143,0.3)}
.sb-mode-btn.m-bt{background:#8b6cf6;color:#fff}
.sb-mode-btn.m-all{background:#f5a623;color:#000}
.sb-mini .sb-mode-row{display:none}

/* Section labels */
.sb-sec-label{font-size:9px;font-weight:700;color:#4a586e;text-transform:uppercase;letter-spacing:0.8px;padding:12px 14px 4px;white-space:nowrap;overflow:hidden;transition:opacity .15s}
.sb-mini .sb-sec-label{opacity:0;height:0;padding:0;overflow:hidden}

/* Nav links */
.sb-link{display:flex;align-items:center;gap:9px;padding:7px 10px;margin:1px 6px;border-radius:7px;cursor:pointer;border:none;background:transparent;color:#8d9bb5;font-size:12px;font-weight:500;font-family:'IBM Plex Sans',sans-serif;width:calc(100% - 12px);text-align:left;transition:all .12s;white-space:nowrap;overflow:hidden}
.sb-link:hover{background:#161b28;color:#e8edf5}
.sb-link.sb-active{background:#1c2336;color:#e8edf5;font-weight:600}
.sb-link.sb-active .sb-link-icon{color:#00d68f}
.sb-link-icon{font-size:14px;width:18px;text-align:center;flex-shrink:0}
.sb-link-label{flex:1;overflow:hidden;transition:opacity .15s,max-width .22s;max-width:140px}
.sb-link-dot{width:5px;height:5px;border-radius:50%;background:#00d68f;flex-shrink:0}
.sb-mini .sb-link{justify-content:center;padding:8px 0;margin:1px auto;width:38px}
.sb-mini .sb-link-label,.sb-mini .sb-link-dot{opacity:0;max-width:0;overflow:hidden}

/* Toggle button */
.sb-toggle{position:absolute;top:18px;right:-10px;width:20px;height:20px;border-radius:50%;background:#1c2336;border:1px solid #273351;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:8100;color:#8d9bb5;font-size:10px;font-weight:700;line-height:1;box-shadow:0 1px 6px rgba(0,0,0,0.5);transition:all .15s}
.sb-toggle:hover{background:#5b8dee;border-color:#5b8dee;color:#fff;box-shadow:0 0 10px rgba(91,141,238,0.4)}

/* Quick entry button in sidebar */
.sb-quick-btn{display:flex;align-items:center;gap:9px;padding:7px 10px;margin:1px 6px;border-radius:7px;cursor:pointer;border:1px solid #273351;background:transparent;color:#8d9bb5;font-size:12px;font-weight:500;font-family:'IBM Plex Sans',sans-serif;width:calc(100% - 12px);text-align:left;transition:all .12s;white-space:nowrap;overflow:hidden}
.sb-quick-btn:hover{background:#161b28;color:#e8edf5;border-color:#3a4a5c}
.sb-mini .sb-quick-btn{justify-content:center;padding:8px 0;margin:1px auto;width:38px}
.sb-mini .sb-quick-btn .sb-link-label{opacity:0;max-width:0;overflow:hidden}

/* ── MAIN CONTENT ─────────────────────────────────────── */
.tj-main{margin-left:var(--sb-w);min-height:100vh;transition:margin-left .22s cubic-bezier(0.4,0,0.2,1)}
.tj-main.main-mini{margin-left:var(--sb-mini)}
.tj-page{padding:12px 16px 60px;max-width:1200px;overflow-x:hidden}

/* Footer stays full width */
.wm-footer{position:fixed;bottom:0;left:0;right:0;background:rgba(8,11,18,0.92);border-top:1px solid #1e2840;padding:4px 16px;display:flex;align-items:center;justify-content:space-between;z-index:7999;backdrop-filter:blur(4px)}
.wm-footer span{font-size:9px;color:#4a586e;font-family:'JetBrains Mono',monospace}
.wm-footer a{color:var(--accent);text-decoration:none;font-size:9px}

/* Sidebar tooltip for collapsed icon mode */
.sb-tip{position:fixed;background:#1c2336;border:1px solid #273351;color:#e8edf5;font-family:'IBM Plex Sans',sans-serif;font-size:11px;font-weight:600;padding:4px 10px;border-radius:6px;pointer-events:none;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,0.5);white-space:nowrap}
</style>
</head><body>
<div id="root" style="display:none"></div>
<div class="wm-footer">
  <span>⚠️ BETA — Trade Journal © 2025 Chris Pi. All rights reserved. <a href="#" onclick="document.getElementById('tos-modal').style.display='flex';return false;" style="color:#1e90ff">Terms of Use</a></span>
  <span>Unauthorized scraping, reverse engineering, or reproduction strictly prohibited.</span>
</div>
<div id="tos-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:9999;align-items:center;justify-content:center;padding:20px">
<div style="background:#0f1923;border:1px solid #1e2d3d;border-radius:12px;max-width:680px;width:100%;max-height:85vh;overflow-y:auto;padding:32px">
<div style="font-size:18px;font-weight:700;color:#e0e6ed;margin-bottom:4px">Trade Journal v14 — Beta Terms of Use</div>
<div style="font-size:10px;color:#6b7a8d;margin-bottom:20px;font-family:'JetBrains Mono',monospace">Version 1.0 — Effective upon first use</div>
<div style="font-size:12px;color:#e0e6ed;line-height:1.8">
<p style="margin-bottom:12px">These Terms of Use ("Terms") govern your access to and use of Trade Journal (the "Software"), a proprietary trading performance system developed and owned by Chris Pi ("Creator"). By accessing or using the Software, you agree to be bound by these Terms.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">1. BETA ACCESS</div>
<p style="margin-bottom:12px">This Software is provided in beta form for evaluation and feedback purposes only. Features may change, data may be reset, and availability is not guaranteed. Beta access is granted at the Creator's sole discretion and may be revoked at any time.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">2. INTELLECTUAL PROPERTY</div>
<p style="margin-bottom:12px">All source code, algorithms, analysis methodologies, user interface designs, feature concepts, and associated intellectual property embodied in this Software are the exclusive property of the Creator. No license, right, or interest in any intellectual property is granted except as expressly stated in these Terms.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">3. PROHIBITED ACTIVITIES</div>
<p style="margin-bottom:12px">You expressly agree that you will NOT: (a) reverse engineer, decompile, disassemble, or otherwise attempt to derive the source code, algorithms, or underlying logic of the Software; (b) scrape, crawl, or systematically extract any data, content, or features from the Software; (c) copy, reproduce, distribute, or create derivative works based on the Software or any portion thereof; (d) use the Software to build, develop, or assist in developing any competing product or service; (e) share, sublicense, sell, or transfer access to the Software to any third party without express written consent.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">4. NON-COMPETE</div>
<p style="margin-bottom:12px">During your use of the Software and for a period of twenty-four (24) months following termination of access, you agree not to directly or indirectly develop, co-develop, invest in, advise, or otherwise materially assist any product or service that substantially replicates the core functionality of this Software, including but not limited to: rule-based edge analysis, combo performance ranking, conditional edge calculations, entry quality scoring, edge decay monitoring, trade DNA fingerprinting, or behavioral tilt detection systems for traders.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">5. CONFIDENTIALITY</div>
<p style="margin-bottom:12px">You acknowledge that the Software contains proprietary and confidential information. You agree to maintain the confidentiality of all non-public aspects of the Software and not to disclose any proprietary methodologies, feature designs, or implementation details to any third party.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">6. DATA & PRIVACY</div>
<p style="margin-bottom:12px">In this beta version, all trade data is stored locally in your browser. The Creator does not collect, transmit, or store your trading data. You are solely responsible for backing up your data. Future paid versions may involve cloud storage subject to a separate privacy policy.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">7. NO FINANCIAL ADVICE</div>
<p style="margin-bottom:12px">The Software is a performance tracking and analytics tool only. Nothing in this Software constitutes financial advice, investment advice, or a recommendation to buy or sell any security. Trading involves substantial risk of loss. Past performance data in this journal does not guarantee future results.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">8. DISCLAIMER OF WARRANTIES</div>
<p style="margin-bottom:12px">The Software is provided "AS IS" without warranty of any kind. The Creator makes no warranties, express or implied, including but not limited to merchantability, fitness for a particular purpose, or non-infringement.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">9. LIMITATION OF LIABILITY</div>
<p style="margin-bottom:12px">To the maximum extent permitted by law, the Creator shall not be liable for any indirect, incidental, special, consequential, or punitive damages arising from your use of the Software, including any trading losses incurred.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">10. GOVERNING LAW</div>
<p style="margin-bottom:12px">These Terms shall be governed by and construed in accordance with the laws of the State of Illinois, without regard to conflict of law principles.</p>
<div style="font-size:11px;font-weight:700;color:#1e90ff;margin:16px 0 6px;letter-spacing:0.5px">11. MODIFICATIONS</div>
<p style="margin-bottom:12px">The Creator reserves the right to modify these Terms at any time. Continued use of the Software following notification of changes constitutes acceptance of the revised Terms.</p>
<p style="margin-bottom:0;color:#6b7a8d;font-size:11px">By clicking "I Agree" below, you acknowledge that you have read, understood, and agree to be bound by these Terms of Use.</p>
</div>
<div style="margin-top:24px;display:flex;justify-content:flex-end;gap:10px;align-items:center">
<span id="tos-decline-note" style="font-size:10px;color:#6b7a8d;display:none;margin-right:auto">You must accept the Terms to use this software.</span>
<button id="tos-decline-btn" onclick="tosDecline()" style="background:transparent;border:1px solid #1e2d3d;color:#6b7a8d;padding:10px 20px;border-radius:8px;font-size:12px;cursor:pointer">Decline</button>
<button id="tos-agree-btn" onclick="tosAgree()" style="background:#1e90ff;border:none;color:#fff;padding:10px 28px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">I Agree</button>
</div>
</div>
</div>
<script>
// TOS gate — runs before React loads
var TOS_KEY = 'tj5_tos_v1';
function tosAgree() {
  try { localStorage.setItem(TOS_KEY, Date.now().toString()); } catch(e) {}
  document.getElementById('tos-modal').style.display = 'none';
  document.getElementById('root').style.display = 'block';
}
function tosClose() {
  document.getElementById('tos-modal').style.display = 'none';
}
function tosDecline() {
  document.getElementById('tos-decline-note').style.display = 'inline';
  document.getElementById('tos-agree-btn').style.boxShadow = '0 0 0 2px #ff4757';
}
(function() {
  // Always show app — TOS already accepted
  document.getElementById('root').style.display = 'block';
  try {
    var accepted = localStorage.getItem(TOS_KEY);
    if (!accepted) {
      document.getElementById('tos-modal').style.display = 'flex';
    } else {
      document.getElementById('tos-agree-btn').textContent = 'Close';
      document.getElementById('tos-agree-btn').onclick = tosClose;
      document.getElementById('tos-decline-btn').style.display = 'none';
    }
  } catch(e) {}
})();
</script>
<script>
try{
var h=React.createElement,us=React.useState,ue=React.useEffect,uc=React.useCallback,ur=React.useRef,um=React.useMemo;

// === TIER CONSTANTS ===
var TIERS={FREE:{id:"free",label:"Free",color:"#6b7a8d",maxStrategies:1},T1:{id:"t1",label:"Tier 1",color:"#1e90ff",maxStrategies:3},T2:{id:"t2",label:"Tier 2",color:"#a855f7",maxStrategies:999},T3:{id:"t3",label:"Tier 3",color:"#ffa502",maxStrategies:999}};
// BETA: all users get full T3 access — remove this line when billing goes live
var BETA_TIER=TIERS.T3;
function TierBadge(p){var colors={t1:"#1e90ff",t2:"#a855f7",t3:"#ffa502"};var c=colors[p.tier]||"#6b7a8d";return h("span",{title:"Available on "+p.tier.toUpperCase(),style:{fontSize:8,padding:"1px 5px",borderRadius:3,background:c+"22",color:c,border:"1px solid "+c+"44",fontWeight:700,marginLeft:5,verticalAlign:"middle",cursor:"default"}},"\uD83D\uDD12 "+p.tier.toUpperCase())}

// === MARKET CONDITIONS ===
var CONDITIONS={trending:{l:"Trending",c:"#2ed573"},ranging:{l:"Range Bound",c:"#1e90ff"},breakout:{l:"Breakout",c:"#ffa502"},choppy:{l:"Choppy",c:"#ff4757"},flat:{l:"Flat/Low Vol",c:"#6b7a8d"}};

// === INDICATOR LIBRARY (Add-on Cloud) ===
var IND_LIBRARY={
trend:[
{k:"ema_align_multi",l:"EMA Multi-TF Aligned",tip:"Multiple timeframe EMAs all pointing same direction"},
{k:"ema_slope",l:"EMA Slope Direction",tip:"EMA is sloping in direction of trade"},
{k:"price_above_ema",l:"Price Above/Below EMA",tip:"Price is on correct side of key EMA"},
{k:"htf_trend",l:"Higher TF Trend Aligned",tip:"Higher timeframe trend matches your entry direction"},
{k:"adx_threshold",l:"ADX Threshold Met",tip:"ADX above your minimum threshold for trend strength"},
{k:"trendline_intact",l:"Trend Line Intact",tip:"Key trend line has not been broken"},
{k:"hh_hl",l:"HH/HL Structure (Longs)",tip:"Price making higher highs and higher lows"}],
momentum:[
{k:"macd_cross",l:"MACD Cross",tip:"MACD line crossed signal line in trade direction"},
{k:"macd_hist",l:"MACD Histogram Direction",tip:"Histogram bars expanding in trade direction"},
{k:"rsi_level",l:"RSI Threshold",tip:"RSI is at a meaningful level for your setup"},
{k:"rsi_div",l:"RSI Divergence",tip:"RSI diverging from price action"},
{k:"stoch_cross",l:"Stochastic Cross",tip:"Stochastic crossed in trade direction"},
{k:"momentum_inc",l:"Momentum Increasing",tip:"Price momentum accelerating in trade direction"}],
volume:[
{k:"vol_above_avg",l:"Volume Above Average",tip:"Current volume exceeds average"},
{k:"vol_spike",l:"Volume Spike on Move",tip:"Significant volume spike confirming the move"},
{k:"vol_dry",l:"Volume Drying on Pullback",tip:"Volume decreasing on the pullback — weak counter move"},
{k:"vwap_pos",l:"VWAP Position",tip:"Price is on correct side of VWAP"},
{k:"vwap_retest",l:"VWAP Retest",tip:"Price retested VWAP before continuing"},
{k:"vol_at_level",l:"Volume at Key Level",tip:"Volume confirming reaction at support/resistance"}],
structure:[
{k:"sr_level",l:"S/R Level Hit",tip:"Price reached a key support or resistance level"},
{k:"level_retest",l:"Prior Level Retested",tip:"Price retesting a previously broken level"},
{k:"swing_break",l:"Swing High/Low Broken",tip:"Prior swing point has been taken out"},
{k:"inside_bar",l:"Inside Bar Present",tip:"Current bar is inside prior bar — compression before move"},
{k:"fvg",l:"Fair Value Gap Present",tip:"Imbalance gap in price that price may return to fill"},
{k:"order_block",l:"Order Block Identified",tip:"Institutional order block identified at entry area"},
{k:"liq_sweep",l:"Liquidity Sweep Confirmed",tip:"Stop hunt / liquidity grab confirmed before entry"}],
candle:[
{k:"engulfing",l:"Engulfing Candle",tip:"Candle engulfs prior candle body"},
{k:"pin_bar",l:"Pin Bar / Hammer",tip:"Long wick rejection candle at key level"},
{k:"doji_level",l:"Doji at Level",tip:"Indecision candle at key support/resistance"},
{k:"candle_close",l:"Candle Close Confirmation",tip:"Candle closed above/below key level"},
{k:"first_candle",l:"First Candle Off Level",tip:"First candle reaction at key level"},
{k:"second_candle",l:"Second Candle Entry",tip:"Entry on second candle confirmation"}],
timeframe:[
{k:"htf_aligned",l:"Higher TF Aligned",tip:"Higher timeframe chart supports your direction"},
{k:"mid_tf_aligned",l:"Mid TF Aligned",tip:"Intermediate timeframe confirms setup"},
{k:"entry_tf_confirmed",l:"Entry TF Confirmed",tip:"Entry timeframe shows clean setup"},
{k:"tf_confluence",l:"TF Confluence Present",tip:"Multiple timeframes all aligned at same level"}],
pattern:[
{k:"fib_level",l:"Fibonacci Level Hit",tip:"Price at key Fibonacci retracement level"},
{k:"fib_confluence",l:"Fibonacci Confluence",tip:"Multiple Fibonacci levels converging"},
{k:"harmonic_complete",l:"Harmonic Pattern Complete",tip:"Harmonic pattern (Gartley/Bat/Crab) at completion point"},
{k:"elliott_count",l:"Elliott Wave Count Valid",tip:"Wave count supports entry"},
{k:"wyckoff_phase",l:"Wyckoff Phase ID'd",tip:"Wyckoff phase clearly identified"},
{k:"bb_extreme",l:"Bollinger Band Extreme",tip:"Price at outer Bollinger Band"},
{k:"bb_squeeze",l:"Bollinger Squeeze Present",tip:"Bands are contracted — compression before expansion"}],
risk:[
{k:"clean_stop",l:"Clean Stop Location",tip:"Stop has a logical price structure behind it"},
{k:"min_r_clear",l:"Min R Target Clear",tip:"Minimum R multiple target is identifiable"},
{k:"risk_within_limit",l:"Risk Within Daily Limit",tip:"This trade keeps you within your daily risk rules"},
{k:"size_within_rules",l:"Position Size Within Rules",tip:"Share size follows your sizing rules"}]};

var IND_CAT_LABELS={trend:"Trend",momentum:"Momentum",volume:"Volume",structure:"Price Structure",candle:"Candle Patterns",timeframe:"Multi-Timeframe",pattern:"Pattern Specific",risk:"Risk & Setup"};

// === BUILT-IN STRATEGY TEMPLATES ===
var STRATEGY_TEMPLATES=[
{id:"admin_rev",name:"Admin Reversal",desc:"Chris's personal reversal system. EMA cloud with MACD, RSI, ADX, swing points and channel analysis. Fade extended moves at key levels with full rule confluence.",conditions:{best:["reversal","ranging"],avoid:["trending","breakout"]},coreRules:{ultHL:"Ultimate H/L — Short from key High / Long from key Low",lhHL:"LH/HL Sequence — Lower High confirmed (short) / Higher Low confirmed (long)",chanBreak:"Channel Break — Price broke channel in your direction",chanRetest:"Channel Retest — Price retested broken level",candleOff10:"1st Candle off 10 EMA — First reactive candle off 10 EMA",secondCandle:"2nd Candle Entry — Entered on 2nd candle confirmation",macdCross:"MACD Cross — MACD crossed in direction of trade",cloudAlign:"Cloud Aligned — EMA cloud aligned with direction",rsiExtreme:"RSI Extreme — RSI at overbought/oversold extreme",cloud15m:"15m Cloud — 15 minute cloud aligned"},stopMgmt:true},
{id:"admin_cont",name:"Admin Continuation",desc:"Chris's personal continuation system. Trade in the direction of the dominant trend on pullbacks with EMA cloud, MACD and momentum confirmation.",conditions:{best:["trending","breakout"],avoid:["choppy","ranging"]},coreRules:{ultHL:"Ultimate H/L — Buying key Low (long) / Selling key High (short)",lhHL:"LH/HL Sequence — Higher Low forming (long) / Lower High forming (short)",chanBreak:"Channel Break — Break in direction of trend",chanRetest:"Channel Retest — Retest of broken level holding",candleOff10:"1st Candle off 10 EMA — First candle bouncing off 10 EMA",secondCandle:"2nd Candle Entry — Entry on 2nd candle in direction",macdCross:"MACD Cross — MACD confirming trend direction",cloudAlign:"Cloud Aligned — EMA cloud supporting trend",rsiExtreme:"RSI Extreme — RSI confirming momentum",cloud15m:"15m Cloud — 15 minute trend cloud aligned"},stopMgmt:true},
{id:"chan_rev",name:"Channel Reversal",desc:"Fade moves at the boundaries of an established price channel. Enter when price hits channel resistance/support with confirmation of rejection.",conditions:{best:["ranging","choppy"],avoid:["trending","breakout"]},coreRules:{ultHL:"Ultimate H/L",lhHL:"LH / HL",chanBreak:"Chan Break",chanRetest:"Chan Retest",candleOff10:"1st Candle 10EMA",secondCandle:"2nd Candle Entry",macdCross:"MACD Cross",cloudAlign:"Cloud Align",rsiExtreme:"RSI Extreme",cloud15m:"15m Cloud"},stopMgmt:true},
{id:"chan_cont",name:"Channel Continuation",desc:"Trade in the direction of the dominant trend within a channel structure. Enter on pullbacks to channel midline or support.",conditions:{best:["trending","breakout"],avoid:["ranging","flat"]},coreRules:{ultHL:"Ultimate H/L",lhHL:"LH / HL",chanBreak:"Chan Break",chanRetest:"Chan Retest",candleOff10:"1st Candle 10EMA",secondCandle:"2nd Candle Entry",macdCross:"MACD Cross",cloudAlign:"Cloud Align",rsiExtreme:"RSI Extreme",cloud15m:"15m Cloud"},stopMgmt:true},
{id:"ema_system",name:"EMA / Moving Average",desc:"Trade price reactions to key EMAs. Enter when price pulls back to EMA in a trending market with momentum confirmation.",conditions:{best:["trending"],avoid:["choppy","flat","ranging"]},coreRules:{ema_slope:"EMA Slope Direction",price_above_ema:"Price Above/Below EMA",htf_trend:"Higher TF Trend Aligned",candle_close:"Candle Close Confirmation",vol_above_avg:"Volume Above Average"},stopMgmt:true},
{id:"wyckoff",name:"Wyckoff Method",desc:"Trade the phases of market cycles — accumulation, markup, distribution, markdown. Enter on Springs (longs) or Upthrusts (shorts) with volume confirmation.",conditions:{best:["ranging","trending"],avoid:["choppy"]},coreRules:{wyckoff_phase:"Wyckoff Phase ID'd",liq_sweep:"Liquidity Sweep Confirmed",vol_at_level:"Volume at Key Level",sr_level:"S/R Level Hit",vol_spike:"Volume Spike on Move"},stopMgmt:true},
{id:"fibonacci",name:"Fibonacci Retracement",desc:"Enter at key Fibonacci retracement levels within a trend. Look for confluence with S/R and candle confirmation at the level.",conditions:{best:["trending","ranging"],avoid:["choppy","flat"]},coreRules:{fib_level:"Fibonacci Level Hit",fib_confluence:"Fibonacci Confluence",htf_aligned:"Higher TF Aligned",candle_close:"Candle Close Confirmation",sr_level:"S/R Level Hit"},stopMgmt:false},
{id:"bollinger",name:"Bollinger Band System",desc:"Trade mean reversion from band extremes or breakouts from band squeezes. Enter at outer bands with reversal confirmation or on squeeze expansion.",conditions:{best:["ranging","breakout"],avoid:["strong trend"]},coreRules:{bb_extreme:"Bollinger Band Extreme",bb_squeeze:"Bollinger Squeeze Present",rsi_div:"RSI Divergence",vol_spike:"Volume Spike on Move",candle_close:"Candle Close Confirmation"},stopMgmt:false},
{id:"elliott",name:"Elliott Wave",desc:"Trade high-probability wave structures. Primary entries on Wave 3 (strongest wave) or at completion of corrective ABC patterns.",conditions:{best:["trending"],avoid:["choppy","ranging"]},coreRules:{elliott_count:"Elliott Wave Count Valid",fib_confluence:"Fibonacci Confluence",htf_aligned:"Higher TF Aligned",momentum_inc:"Momentum Increasing",vol_above_avg:"Volume Above Average"},stopMgmt:false},
{id:"ict_smc",name:"ICT / Smart Money",desc:"Trade with institutional order flow. Look for liquidity sweeps, order blocks, and fair value gaps within kill zone timing windows.",conditions:{best:["trending","breakout"],avoid:["choppy"]},coreRules:{liq_sweep:"Liquidity Sweep Confirmed",order_block:"Order Block Identified",fvg:"Fair Value Gap Present",htf_aligned:"Higher TF Aligned",vwap_pos:"VWAP Position"},stopMgmt:false},
{id:"vwap",name:"VWAP / Volume",desc:"Use VWAP as dynamic support/resistance. Trade rejections from VWAP or breakouts through VWAP with volume confirmation.",conditions:{best:["trending","ranging"],avoid:["flat"]},coreRules:{vwap_pos:"VWAP Position",vwap_retest:"VWAP Retest",vol_spike:"Volume Spike on Move",vol_above_avg:"Volume Above Average",htf_trend:"Higher TF Trend Aligned"},stopMgmt:false},
{id:"harmonic",name:"Harmonic Patterns",desc:"Trade precise geometric price patterns (Gartley, Bat, Crab, Butterfly) at completion zones. High accuracy when pattern ratios are valid.",conditions:{best:["ranging","trending"],avoid:["choppy","flat"]},coreRules:{harmonic_complete:"Harmonic Pattern Complete",fib_confluence:"Fibonacci Confluence",rsi_div:"RSI Divergence",sr_level:"S/R Level Hit",candle_close:"Candle Close Confirmation"},stopMgmt:false}
];

// === DATA MODEL ===
var TARGET_TYPES=[
{v:"",l:"Select type..."},
{v:"ma_10",l:"10 EMA"},{v:"ma_20",l:"20 EMA"},{v:"ma_50",l:"50 EMA"},{v:"ma_200",l:"200 EMA"},{v:"ma_vwap",l:"VWAP"},
{v:"fib_236",l:"Fib 23.6%"},{v:"fib_382",l:"Fib 38.2%"},{v:"fib_50",l:"Fib 50%"},{v:"fib_618",l:"Fib 61.8%"},{v:"fib_786",l:"Fib 78.6%"},{v:"fib_100",l:"Fib 100%"},{v:"fib_127",l:"Fib 127%"},{v:"fib_162",l:"Fib 161.8%"},
{v:"prior_high",l:"Prior High"},{v:"prior_low",l:"Prior Low"},{v:"daily_high",l:"Daily High"},{v:"daily_low",l:"Daily Low"},{v:"weekly_high",l:"Weekly High"},{v:"weekly_low",l:"Weekly Low"},{v:"swing_high",l:"Swing High"},{v:"swing_low",l:"Swing Low"},
{v:"chan_top",l:"Channel Top"},{v:"chan_bottom",l:"Channel Bottom"},{v:"chan_mid",l:"Channel Mid"},
{v:"round_num",l:"Round Number"},{v:"custom",l:"Custom Level"}];
var TARGET_TF_LABELS={v:"--",options:[{v:"",l:"--"},{v:"1m",l:"1m"},{v:"3m",l:"3m"},{v:"5m",l:"5m"},{v:"15m",l:"15m"},{v:"1h",l:"1h"},{v:"4h",l:"4h"},{v:"1D",l:"Daily"},{v:"1W",l:"Weekly"}]};
var TARGET_CAT_LABELS={"ma":"Moving Averages","fib":"Fibonacci","price_level":"Price Levels","channel":"Channel","other":"Other"};
function mkTarget(){return{id:gid(),type:"",tf:"",price:"",notes:"",isHit:""}};

var E={id:"",date:"",time:"",exitTime:"",direction:"L",type:"Rev",ticker:"TSLA",mode:"live",timeframe:"3m",
strategyId:"",
entry:"",stop:"",exit:"",shares:"",mfePrice:"",maePrice:"",maeTiming:"",
adxAtEntry:"",cloudThickness:"",cloudDirection:"",rsiAtEntry:"",rsiAtPeak:"",
divBefore:"",divDuring:"",
tradeNumOfDay:"",sessionRead:"",confidence:"",emotion:"calm",emotionDuring:"",emotionAfter:"",followedRules:"",
screenshotUrl:"",screenshotData:"",exitScreenshotUrl:"",exitScreenshotData:"",
hasPartial:"",partialExitPrice:"",partialPct:"",
targets:[],
trailTimeframe:"",trailStopPrice:"",trendEndPrice:"",
rules:{},
stopMgmt:{initStop:"",stopChan:"",trailHL:"",trailFailHL:"",stopMoved:"",reentry:""},
exitType:"",rsiAtExit:"",volAtExit:"",notes:"",excluded:false};
var RL={ultHL:"Ultimate H/L",lhHL:"LH / HL",chanBreak:"Chan Break",chanRetest:"Chan Retest",candleOff10:"1st Candle 10EMA",secondCandle:"2nd Candle Entry",macdCross:"MACD Cross",cloudAlign:"Cloud Align",rsiExtreme:"RSI Extreme",cloud15m:"15m Cloud"};
var DIVS=[{v:"",l:"None"},{v:"bull",l:"Bullish",c:"#2ed573"},{v:"bear",l:"Bearish",c:"#ff4757"}];
// Stop management rules — user customizable (stored in localStorage)
var DEFAULT_STOP_RULES=[
{k:"initStop",l:"Init Stop HL"},
{k:"stopChan",l:"Stop\u2192Chan"},
{k:"trailHL",l:"Trail H/L"},
{k:"trailFailHL",l:"Trail Failed H/L"},
{k:"stopMoved",l:"Stop Moved"},
{k:"reentry",l:"Re-entry"}
];
function loadStopRules(){try{var s=localStorage.getItem("tj5_stop_rules");if(s)return JSON.parse(s);return DEFAULT_STOP_RULES;}catch(e){return DEFAULT_STOP_RULES;}}
function saveStopRules(r){try{localStorage.setItem("tj5_stop_rules",JSON.stringify(r));}catch(e){}}
// SL object for backwards compat with analysis engine — rebuilt dynamically
function buildSL(rules){var o={};rules.forEach(function(r){o[r.k]=r.l;});return o;}
var SL=buildSL(loadStopRules());
var RK=Object.keys(RL);
var TFS=["1m","3m","5m","15m","1h","2h","4h","1D","1W"];
var EMOTIONS=["calm","eager","fomo","frustrated","angry","revenge","bored"];
var EMOTIONS_DURING=["calm","confident","anxious","impatient","greedy","panicked"];
var EMOTIONS_AFTER=["satisfied","relieved","frustrated","disappointed","regret","angry","revenge","neutral"];
var TRAIL_TFS=["1m","3m","5m","same"];
var PARTIAL_PCTS=["25","33","50","75"];
var SESSIONS=["trending","ranging","choppy","breakout","reversal"];
var THEMES={
dark:{bg:"#080b12",cd:"#0f1923",bd:"#1e2840",g:"#00d68f",r:"#ff4757",go:"#ffa502",cy:"#1e90ff",pu:"#a855f7",tx:"#e8edf5",dm:"#6b7a8d",inp:"#1a2535",
sdw:"0 2px 12px rgba(0,0,0,0.4),0 1px 3px rgba(0,0,0,0.3)",sdwHover:"0 4px 20px rgba(0,0,0,0.5)",sbBg:"#0c1018",sbBd:"#1e2840"},
light:{bg:"#f0f2f7",cd:"#ffffff",bd:"#e2e6ee",g:"#00b87a",r:"#e8364a",go:"#e07b00",cy:"#1a7fd4",pu:"#7c3aed",tx:"#0f1923",dm:"#6b7a8d",inp:"#f7f9fc",
sdw:"0 2px 12px rgba(0,0,0,0.08),0 1px 4px rgba(0,0,0,0.05)",sdwHover:"0 6px 24px rgba(0,0,0,0.12)",sbBg:"#ffffff",sbBd:"#e2e6ee"}};
var _themeMode=(function(){try{return localStorage.getItem("tj5_theme")||"dark"}catch(e){return"dark"}})();
var K=Object.assign({},THEMES[_themeMode]);
function applyTheme(mode){
  var t=THEMES[mode]||THEMES.dark;
  Object.keys(t).forEach(function(k){K[k]=t[k]});
  document.documentElement.setAttribute("data-theme",mode);
  try{localStorage.setItem("tj5_theme",mode)}catch(e){}
}
applyTheme(_themeMode);

// === STRATEGY HELPERS ===
function getStrategyRules(strat){
if(!strat)return{core:{},addons:{}};
var core=Object.assign({},strat.coreRules||{});
var addons=strat.addons||{};
return{core:core,addons:addons}}
function getAllStratRuleKeys(strat){
if(!strat)return[];
var keys=Object.keys(strat.coreRules||{});
(strat.addons||[]).forEach(function(k){keys.push(k)});
return keys}
function getIndLabel(k){
var found=null;
Object.keys(IND_LIBRARY).forEach(function(cat){IND_LIBRARY[cat].forEach(function(ind){if(ind.k===k)found=ind})});
return found?found.l:(RL[k]||k)}
function getIndTip(k){
var found=null;
Object.keys(IND_LIBRARY).forEach(function(cat){IND_LIBRARY[cat].forEach(function(ind){if(ind.k===k)found=ind})});
return found?found.tip:""}

// === UTILS ===
function gid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}
function dc(o){return JSON.parse(JSON.stringify(o))}
function cPL(t){if(!t.entry||!t.exit||!t.shares)return{pl:0,pp:0,rm:0};var e=+t.entry,x=+t.exit,s=+t.stop,sh=+t.shares;var pl=t.direction==="L"?(x-e)*sh:(e-x)*sh;var rk=Math.abs(e-s);return{pl:pl,pp:t.direction==="L"?(x-e)/e:(e-x)/e,rm:rk>0?(t.direction==="L"?(x-e)/rk:(e-x)/rk):0}}
function cMFE(t){if(!t.entry||!t.mfePrice)return null;var e=+t.entry,m=+t.mfePrice,x=t.exit?+t.exit:null;var md=t.direction==="L"?m-e:e-m;var ed=x?(t.direction==="L"?x-e:e-x):null;return{md:md,cp:ed!==null&&md>0?ed/md:null}}
function cMAE(t){if(!t.entry||!t.maePrice)return null;return{md:t.direction==="L"?+t.entry-+t.maePrice:+t.maePrice-+t.entry}}
function cDur(t){if(!t.time||!t.exitTime)return null;function tm(s){var p=s.split(":");return parseInt(p[0])*60+parseInt(p[1]||0)}var d=tm(t.exitTime)-tm(t.time);if(d<=0)return null;return{m:d,l:Math.floor(d/60)>0?Math.floor(d/60)+"h "+d%60+"m":d%60+"m"}}
function gs(a){if(!a.length)return{n:0,wr:0,ar:0,ap:0,tp:0};var r=a.map(cPL),w=r.filter(function(x){return x.pl>0});return{n:a.length,wr:w.length/a.length,ar:r.reduce(function(s,x){return s+x.rm},0)/a.length,ap:r.reduce(function(s,x){return s+x.pl},0)/a.length,tp:r.reduce(function(s,x){return s+x.pl},0)}}
function ruleCount(t){var c=0;RK.forEach(function(k){if(t.rules&&t.rules[k]==="Y")c++});return c}
// System session read from avg ADX + cloud width for a day
function sysSession(dayTrades){
var adxs=dayTrades.filter(function(t){return t.adxAtEntry}).map(function(t){return+t.adxAtEntry});
var cws=dayTrades.filter(function(t){return t.cloudThickness}).map(function(t){return+t.cloudThickness});
if(!adxs.length&&!cws.length)return"unknown";
var avgAdx=adxs.length?adxs.reduce(function(a,b){return a+b},0)/adxs.length:null;
var avgCw=cws.length?cws.reduce(function(a,b){return a+b},0)/cws.length:null;
if(avgAdx!==null&&avgAdx<18&&avgCw!==null&&avgCw<0.15)return"ranging";
if(avgAdx!==null&&avgAdx<20)return"choppy";
if(avgAdx!==null&&avgAdx>=25)return"trending";
return"choppy"}
// === COMPONENTS ===
function Pl(p){return h("div",{style:{display:"flex",gap:2,background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:2,flexWrap:"wrap"}},p.options.map(function(o){return h("button",{key:o.v,onClick:function(){p.onChange(o.v)},style:{padding:"5px 10px",borderRadius:5,border:"none",fontSize:12,fontWeight:600,cursor:"pointer",background:p.v===o.v?(o.c||K.cy):"transparent",color:p.v===o.v?"#fff":K.tx,transition:"all .15s"}},o.l)}))}
function YN(p){return h(Pl,{v:p.v,onChange:p.onChange,options:[{v:"Y",l:"Y",c:K.g},{v:"N",l:"N",c:K.r},{v:"",l:"-",c:K.dm}]})}
function Ip(p){return h("input",{type:p.type||"text",value:p.value||"",onChange:function(e){p.onChange(e.target.value)},placeholder:p.placeholder,step:p.step,style:Object.assign({background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"7px 10px",color:K.tx,fontSize:13,width:"100%",outline:"none",boxShadow:"inset 0 1px 3px rgba(0,0,0,0.15)"},p.style||{})})}
function SC(p){return h("div",{style:{background:K.cd,border:"1px solid "+K.bd,borderRadius:8,padding:"10px 14px",flex:1,minWidth:100,boxShadow:K.sdw}},h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},p.label),h("div",{style:{fontSize:18,fontWeight:700,color:p.color||K.tx,fontFamily:"JetBrains Mono,monospace"}},p.value),p.sub?h("div",{style:{fontSize:10,color:K.dm,marginTop:2}},p.sub):null)}
function Sel(p){return h("select",{value:p.value||"",onChange:function(e){p.onChange(e.target.value)},style:Object.assign({background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"6px 10px",color:K.tx,fontSize:12,width:"100%",outline:"none"},p.style||{})},p.options.map(function(o){return h("option",{key:o.v,value:o.v},o.l)}))}
// Mini bar for bucket display
function Bar(p){return h("div",{style:{height:4,background:K.bd,borderRadius:2,marginTop:4,overflow:"hidden"}},h("div",{style:{height:"100%",width:Math.max(p.pct,1)+"%",background:p.color||K.g,borderRadius:2}}))}
function Tip(p){return h("span",{className:"tip","data-t":p.t},"\u24d8")}
// === APP STATE ===
function App(){
var _t=us(function(){try{return JSON.parse(localStorage.getItem("tj5")||"[]")}catch(e){return[]}});
var trades=_t[0],setTr=_t[1];
var _strats=us(function(){try{return JSON.parse(localStorage.getItem("tj5_strats")||"[]")}catch(e){return[]}});
var userStrats=_strats[0],setStrats=_strats[1];
var _v=us("log"),vw=_v[0],setVw=_v[1];
var _openMenu=us(null),openMenu=_openMenu[0],setOpenMenu=_openMenu[1];
var _logFlat=us(false),logFlat=_logFlat[0],setLogFlat=_logFlat[1];
var _stopRules=us(loadStopRules),stopRules=_stopRules[0],setStopRules=_stopRules[1];
ue(function(){saveStopRules(stopRules);SL=buildSL(stopRules);},[stopRules]);
var _rmode=us(function(){try{return localStorage.getItem("tj5_rmode")||"dollar"}catch(e){return"dollar"}});
var rMode=_rmode[0],setRMode=_rmode[1];
ue(function(){try{localStorage.setItem("tj5_rmode",rMode)}catch(e){}},[rMode]);
// fmtPL: format a P/L value based on display mode. always shows both, primary is big
function fmtMain(pl,rm){return rMode==="R"?(rm!=null?((rm>=0?"+":"")+rm.toFixed(2)+"R"):"—"):(pl>=0?"+$":"-$")+Math.abs(pl).toFixed(2);}
function fmtSub(pl,rm){return rMode==="R"?((pl>=0?"+$":"-$")+Math.abs(pl).toFixed(2)):((rm!=null?(rm>=0?"+":"")+rm.toFixed(2)+"R":"—"));}
function fmtColor(pl){return pl>0?K.g:pl<0?K.r:K.dm;}
var _stratV=us(false),stratV=_stratV[0],setStratV=_stratV[1];
var _editStrat=us(null),editStrat=_editStrat[0],setEditStrat=_editStrat[1];
var _e=us(null),et=_e[0],setEt=_e[1];
var _sf=us(false),sf=_sf[0],setSf=_sf[1];
var _theme=us(function(){try{return localStorage.getItem("tj5_theme")||"dark"}catch(e){return"dark"}});
var themeMode=_theme[0],setThemeMode=_theme[1];
// Mutate global K and trigger single re-render via themeMode state
ue(function(){
  var t=THEMES[themeMode]||THEMES.dark;
  Object.keys(t).forEach(function(k){K[k]=t[k]});
  document.documentElement.setAttribute("data-theme",themeMode);
  try{localStorage.setItem("tj5_theme",themeMode)}catch(e){}
},[themeMode]);
function toggleTheme(){setThemeMode(function(p){return p==="dark"?"light":"dark"});}
var _lb=us(null),lb=_lb[0],setLb=_lb[1];
var _fd=us("ALL"),fd=_fd[0],sFd=_fd[1];
var _ft=us("ALL"),ft=_ft[0],sFt=_ft[1];
var _fk=us("ALL"),fk=_fk[0],sFk=_fk[1];
var _qm=us(false),qm=_qm[0],sQm=_qm[1];
var _sort=us("date_desc"),sortBy=_sort[0],setSort=_sort[1];
var _md=us("live"),md=_md[0],sMd=_md[1];
// Analysis group — scopes what cp feeds into the analysis engine
// null = all trades; {ids:Set, label:string, type:string} = filtered subset
var _ag=us(null),analysisGroup=_ag[0],setAnalysisGroup=_ag[1];
var _dayTags=us(function(){try{return JSON.parse(localStorage.getItem("tj5_day_tags")||"{}")}catch(e){return{}}});
var dayTags=_dayTags[0],setDayTags=_dayTags[1];
ue(function(){try{localStorage.setItem("tj5_day_tags",JSON.stringify(dayTags))}catch(e){}},[dayTags]);
function setDayTag(date,tag){setDayTags(function(p){var n=Object.assign({},p);if(tag===null||tag===p[date]){delete n[date]}else{n[date]=tag}return n})}
var _dayCharts=us(function(){try{return JSON.parse(localStorage.getItem("tj5_day_charts")||"{}")}catch(e){return{}}});
var dayCharts=_dayCharts[0],setDayCharts=_dayCharts[1];
ue(function(){try{localStorage.setItem("tj5_day_charts",JSON.stringify(dayCharts))}catch(e){}},[dayCharts]);
function setDayChart(date,data){setDayCharts(function(p){var n=Object.assign({},p);if(data===null){delete n[date]}else{n[date]=data}return n})}
var dcRef=ur(null);
var dcDateRef=ur(null);
var _chartUrlModal=us(null),chartUrlModal=_chartUrlModal[0],setChartUrlModal=_chartUrlModal[1];
var _chartUrlInput=us(""),chartUrlInput=_chartUrlInput[0],setChartUrlInput=_chartUrlInput[1];
var _djModal=us(null),djModal=_djModal[0],setDjModal=_djModal[1];
var _djText=us(""),djText=_djText[0],setDjText=_djText[1];
var _showTour=us(false),showTour=_showTour[0],setShowTour=_showTour[1];
var _tourSection=us(0),tourSection=_tourSection[0],setTourSection=_tourSection[1];
var _msel=us(false),multiSelMode=_msel[0],setMultiSelMode=_msel[1];
var _mids=us(new Set()),multiSelIds=_mids[0],setMultiSelIds=_mids[1];
function toggleMultiSel(id){setMultiSelIds(function(p){var n=new Set(p);n.has(id)?n.delete(id):n.add(id);return n})}
function selectDay(date,trades){setMultiSelIds(function(p){var n=new Set(p);trades.filter(function(t){return t.date===date}).forEach(function(t){n.add(t.id)});return n})}
function clearMultiSel(){setMultiSelIds(new Set());setMultiSelMode(false)}
function bulkDelete(){if(!multiSelIds.size)return;if(!confirm("Delete "+multiSelIds.size+" trades?"))return;setTr(function(p){return p.filter(function(t){return !multiSelIds.has(t.id)})});clearMultiSel()}
function bulkExclude(){if(!multiSelIds.size)return;setTr(function(p){return p.map(function(t){return multiSelIds.has(t.id)?Object.assign({},t,{excluded:true}):t})});clearMultiSel()}
var _plPeriod=us("daily"),plP=_plPeriod[0],sPlP=_plPeriod[1];
var _plAdj=us(function(){try{return JSON.parse(localStorage.getItem("tj5_adj")||"{}")}catch(e){return{}}});
var plAdj=_plAdj[0],sPlAdj=_plAdj[1];
var _dj=us(function(){try{return JSON.parse(localStorage.getItem("tj5_dj")||"{}")}catch(e){return{}}});
var dayJournal=_dj[0],setDj=_dj[1];
var _logView=us("daily"),logView=_logView[0],setLogView=_logView[1];
var _les=us({}),logExpandState=_les[0],setLogExpandState=_les[1];
var _sbCollapsed=us(function(){try{return localStorage.getItem("tj5_sb_collapsed")==="1"}catch(e){return false}});
var sbCollapsed=_sbCollapsed[0],setSbCollapsed=_sbCollapsed[1];
ue(function(){try{localStorage.setItem("tj5_sb_collapsed",sbCollapsed?"1":"0")}catch(e){}},[sbCollapsed]);
var fr=ur(null),fr2=ur(null),ir=ur(null),cr=ur(null);
ue(function(){try{localStorage.setItem("tj5",JSON.stringify(trades))}catch(e){}},[trades]);
ue(function(){try{localStorage.setItem("tj5_strats",JSON.stringify(userStrats))}catch(e){}},[userStrats]);
ue(function(){try{localStorage.setItem("tj5_adj",JSON.stringify(plAdj))}catch(e){}},[plAdj]);
ue(function(){try{localStorage.setItem("tj5_dj",JSON.stringify(dayJournal))}catch(e){}},[dayJournal]);

function mkN(){var t=dc(E);t.id=gid();var today=new Date().toISOString().slice(0,10);t.date=today;t.mode=md==="all"?"live":md;var todayCount=trades.filter(function(tr){return tr.date===today&&(tr.mode||"live")===(md==="all"?"live":md)}).length;t.tradeNumOfDay=String(todayCount+1);return t}
function oN(){setEt(mkN());setSf(true);sQm(false)}
function oQ(){setEt(mkN());setSf(true);sQm(true)}
function oE(t){var c=dc(t);c.rules=Object.assign(dc(E.rules),c.rules||{});c.stopMgmt=Object.assign(dc(E.stopMgmt),c.stopMgmt||{});
if(!c.targets)c.targets=[];
["rsiAtEntry","rsiAtPeak","tradeNumOfDay","sessionRead","confidence","emotion","emotionDuring","emotionAfter","followedRules","timeframe","maeTiming","divBefore","divDuring","cloudDirection","hasPartial","partialExitPrice","partialPct","trailTimeframe","trailStopPrice","trendEndPrice","exitScreenshotUrl","exitScreenshotData"].forEach(function(k){if(c[k]===undefined)c[k]=E[k]});
if(!c.stopMgmt.trailFailHL)c.stopMgmt.trailFailHL="";setEt(c);setSf(true);sQm(false)}
function sv(){if(!et)return;setTr(function(p){var i=-1;for(var j=0;j<p.length;j++)if(p[j].id===et.id){i=j;break}if(i>=0){var n=p.slice();n[i]=et;return n}return p.concat([et])});setSf(false);setEt(null)}
function dl(id){if(confirm("Delete?")){setTr(function(p){return p.filter(function(t){return t.id!==id})})}}
function toggleExclude(id){setTr(function(p){return p.map(function(t){return t.id===id?Object.assign({},t,{excluded:!t.excluded}):t})})}
function toggleSelectForGroup(id){setAnalysisGroup(function(prev){
  var ids=prev&&prev.ids?new Set(prev.ids):new Set();
  if(ids.has(id)){ids.delete(id);}else{ids.add(id);}
  if(ids.size===0)return null;
  return{ids:ids,label:"Custom ("+ids.size+" trades)",type:"custom"};
})}
function selectDay(date){
  var dayIds=new Set(mf.filter(function(t){return t.date===date&&t.entry&&t.exit&&t.shares&&!t.excluded}).map(function(t){return t.id}));
  if(dayIds.size===0)return;
  setAnalysisGroup(function(prev){
    // If this exact day is already the whole group, clear it
    if(prev&&prev.type==="day"&&prev.date===date)return null;
    return{ids:dayIds,label:date+" ("+dayIds.size+" trades)",type:"day",date:date};
  });
}
function hF(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){setEt(function(p){var c=dc(p);c.screenshotData=ev.target.result;return c})};r.readAsDataURL(f)}
function hF2(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){setEt(function(p){var c=dc(p);c.exitScreenshotData=ev.target.result;return c})};r.readAsDataURL(f)}
var hD=uc(function(e){e.preventDefault();var f=e.dataTransfer.files[0];if(!f||!f.type.startsWith("image/"))return;var r=new FileReader();r.onload=function(ev){setEt(function(p){var c=dc(p);c.screenshotData=ev.target.result;return c})};r.readAsDataURL(f)},[]);
var hD2=uc(function(e){e.preventDefault();var f=e.dataTransfer.files[0];if(!f||!f.type.startsWith("image/"))return;var r=new FileReader();r.onload=function(ev){setEt(function(p){var c=dc(p);c.exitScreenshotData=ev.target.result;return c})};r.readAsDataURL(f)},[]);

// FILTERED DATA
var mf=um(function(){if(md==="all")return trades;return trades.filter(function(t){return(t.mode||"live")===md})},[trades,md]);
var fl=um(function(){return mf.filter(function(t){if(fd!=="ALL"&&t.direction!==fd)return false;if(ft!=="ALL"&&t.type!==ft)return false;if(fk!=="ALL"&&t.ticker!==fk)return false;return true}).sort(function(a,b){
var pa=cPL(a),pb=cPL(b);
if(sortBy==="date_desc")return(b.date+(b.time||"")).localeCompare(a.date+(a.time||""));
if(sortBy==="date_asc")return(a.date+(a.time||"")).localeCompare(b.date+(b.time||""));
if(sortBy==="pl_best")return pb.pl-pa.pl;
if(sortBy==="pl_worst")return pa.pl-pb.pl;
if(sortBy==="r_best")return pb.rm-pa.rm;
if(sortBy==="r_worst")return pa.rm-pb.rm;
if(sortBy==="trade_num_asc")return(+a.tradeNumOfDay||0)-(+b.tradeNumOfDay||0);
if(sortBy==="trade_num_desc")return(+b.tradeNumOfDay||0)-(+a.tradeNumOfDay||0);
if(sortBy==="time_asc")return(a.time||"").localeCompare(b.time||"");
if(sortBy==="wins")return(pb.pl>0?1:0)-(pa.pl>0?1:0);
if(sortBy==="losses")return(pa.pl<0?1:0)-(pb.pl<0?1:0);
if(sortBy==="longs")return(a.direction==="L"?0:1)-(b.direction==="L"?0:1);
if(sortBy==="shorts")return(a.direction==="S"?0:1)-(b.direction==="S"?0:1);
return(b.date+(b.time||"")).localeCompare(a.date+(a.time||""))})},[mf,fd,ft,fk,sortBy]);
var tks=um(function(){var s={};mf.forEach(function(t){if(t.ticker)s[t.ticker]=1});return Object.keys(s)},[mf]);
var cp=um(function(){
// Base: complete trades only, not excluded from analysis
var base=mf.filter(function(t){return t.entry&&t.exit&&t.shares&&!t.excluded});
// If an analysis group is active, scope to those IDs
if(analysisGroup&&analysisGroup.ids){return base.filter(function(t){return analysisGroup.ids.has(t.id)});}
return base;
},[mf,analysisGroup]);
// === STATS ENGINE ===
var st=um(function(){
var t=fl.filter(function(x){return x.entry&&x.exit&&x.shares});if(!t.length)return null;
var rs=t.map(function(x){var p=cPL(x);return{pl:p.pl,rm:p.rm,mfe:cMFE(x),dur:cDur(x)}});
var w=rs.filter(function(r){return r.pl>0}),l=rs.filter(function(r){return r.pl<0});
var ds=rs.map(function(r){return r.dur}).filter(Boolean);
var cs=rs.map(function(r){return r.mfe&&r.mfe.cp}).filter(function(c){return c!=null});
return{n:rs.length,w:w.length,l:l.length,wr:w.length/rs.length,
tp:rs.reduce(function(s,r){return s+r.pl},0),
aw:w.length?w.reduce(function(s,r){return s+r.pl},0)/w.length:0,
al:l.length?l.reduce(function(s,r){return s+r.pl},0)/l.length:0,
ar:rs.reduce(function(s,r){return s+r.rm},0)/rs.length,
pf:l.length?Math.abs(w.reduce(function(s,r){return s+r.pl},0)/l.reduce(function(s,r){return s+r.pl},0)):w.length?999:0,
ad:ds.length?ds.reduce(function(s,d){return s+d.m},0)/ds.length:null,
ac:cs.length?cs.reduce(function(s,c){return s+c},0)/cs.length:null}},[fl]);
// === RULE ANALYSIS ENGINE ===
var ra=um(function(){if(!cp.length)return{yn:[],num:[],combos:[],minRule:[],corr:[],scores:[],cond:[]};
// Y/N edge for setup rules
var yn=RK.map(function(k){var wi=cp.filter(function(t){return t.rules[k]==="Y"}),wo=cp.filter(function(t){return t.rules[k]==="N"});return{key:k,label:RL[k],w:gs(wi),wo:gs(wo),edge:gs(wi).wr-gs(wo).wr}});
// Stop mgmt rules
Object.keys(SL).forEach(function(k){var wi=cp.filter(function(t){return t.stopMgmt&&t.stopMgmt[k]==="Y"}),wo=cp.filter(function(t){return t.stopMgmt&&t.stopMgmt[k]==="N"});if(wi.length+wo.length>=2)yn.push({key:"sm_"+k,label:"Stop: "+SL[k],w:gs(wi),wo:gs(wo),edge:gs(wi).wr-gs(wo).wr})});
// Followed rules
var fr=cp.filter(function(t){return t.followedRules==="Y"}),fn=cp.filter(function(t){return t.followedRules==="N"});
if(fr.length+fn.length>=2)yn.push({key:"followedRules",label:"\u2605 Followed Rules",w:gs(fr),wo:gs(fn),edge:gs(fr).wr-gs(fn).wr});
yn.sort(function(a,b){return Math.abs(b.edge)-Math.abs(a.edge)});

// Numeric buckets
var num=[];
var at=cp.filter(function(t){return t.adxAtEntry});
if(at.length>=3)num.push({label:"ADX at Entry",bk:[{l:"< 20",s:gs(at.filter(function(t){return+t.adxAtEntry<20}))},{l:"20-25",s:gs(at.filter(function(t){var v=+t.adxAtEntry;return v>=20&&v<25}))},{l:"25+",s:gs(at.filter(function(t){return+t.adxAtEntry>=25}))}]});
var ct=cp.filter(function(t){return t.cloudThickness});
if(ct.length>=3)num.push({label:"Cloud Width %",bk:[{l:"< 0.15%",s:gs(ct.filter(function(t){return+t.cloudThickness<0.15}))},{l:"0.15-0.35%",s:gs(ct.filter(function(t){var v=+t.cloudThickness;return v>=0.15&&v<0.35}))},{l:"0.35%+",s:gs(ct.filter(function(t){return+t.cloudThickness>=0.35}))}]});
var re=cp.filter(function(t){return t.rsiAtEntry});
if(re.length>=3){num.push({label:"RSI at Entry",bk:[{l:"< 30",s:gs(re.filter(function(t){return+t.rsiAtEntry<30}))},{l:"30-50",s:gs(re.filter(function(t){var v=+t.rsiAtEntry;return v>=30&&v<50}))},{l:"50-70",s:gs(re.filter(function(t){var v=+t.rsiAtEntry;return v>=50&&v<70}))},{l:"70+",s:gs(re.filter(function(t){return+t.rsiAtEntry>=70}))}]});
var lo=re.filter(function(t){return t.direction==="L"}),sh=re.filter(function(t){return t.direction==="S"});
if(lo.length>=3)num.push({label:"RSI Entry (Longs)",bk:[{l:"< 30",s:gs(lo.filter(function(t){return+t.rsiAtEntry<30}))},{l:"30-50",s:gs(lo.filter(function(t){var v=+t.rsiAtEntry;return v>=30&&v<50}))},{l:"50+",s:gs(lo.filter(function(t){return+t.rsiAtEntry>=50}))}]});
if(sh.length>=3)num.push({label:"RSI Entry (Shorts)",bk:[{l:"< 50",s:gs(sh.filter(function(t){return+t.rsiAtEntry<50}))},{l:"50-70",s:gs(sh.filter(function(t){var v=+t.rsiAtEntry;return v>=50&&v<70}))},{l:"70+",s:gs(sh.filter(function(t){return+t.rsiAtEntry>=70}))}]})}
var rp=cp.filter(function(t){return t.rsiAtPeak});
if(rp.length>=3)num.push({label:"RSI at Peak (MFE)",bk:[{l:"< 65",s:gs(rp.filter(function(t){return+t.rsiAtPeak<65}))},{l:"65-75",s:gs(rp.filter(function(t){var v=+t.rsiAtPeak;return v>=65&&v<75}))},{l:"75-85",s:gs(rp.filter(function(t){var v=+t.rsiAtPeak;return v>=75&&v<85}))},{l:"85+",s:gs(rp.filter(function(t){return+t.rsiAtPeak>=85}))}]});
var ve=cp.filter(function(t){return t.volAtExit});
if(ve.length>=3)num.push({label:"Volume at Exit",bk:[{l:"Below",s:gs(ve.filter(function(t){return t.volAtExit==="B"}))},{l:"At Avg",s:gs(ve.filter(function(t){return t.volAtExit==="A"}))},{l:"Above",s:gs(ve.filter(function(t){return t.volAtExit==="H"}))}]});
// Divergence Before Entry
var db=cp.filter(function(t){return t.divBefore});
if(db.length>=3){var dbDir={};db.forEach(function(t){var k=t.divBefore+(t.direction==="L"?" (Long)":" (Short)");if(!dbDir[k])dbDir[k]=[];dbDir[k].push(t)});num.push({label:"Div Before Entry",bk:Object.keys(dbDir).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(dbDir[k])}})})}
// Divergence During Trade
var dd=cp.filter(function(t){return t.divDuring});
if(dd.length>=3){var ddDir={};dd.forEach(function(t){var aligned=(t.direction==="L"&&t.divDuring==="bull")||(t.direction==="S"&&t.divDuring==="bear");var k=t.divDuring+(aligned?" (aligned)":" (against)");if(!ddDir[k])ddDir[k]=[];ddDir[k].push(t)});num.push({label:"Div During Trade",bk:Object.keys(ddDir).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(ddDir[k])}})})}
// MAE Timing
var mt=cp.filter(function(t){return t.maeTiming});
if(mt.length>=3)num.push({label:"MAE Timing",bk:[{l:"Dip First",s:gs(mt.filter(function(t){return t.maeTiming==="dip1st"}))},{l:"Run First",s:gs(mt.filter(function(t){return t.maeTiming==="run1st"}))}]});
var dt=cp.filter(function(t){return cDur(t)});
if(dt.length>=3)num.push({label:"Duration",bk:[{l:"< 10m",s:gs(dt.filter(function(t){return cDur(t).m<10}))},{l:"10-30m",s:gs(dt.filter(function(t){var m=cDur(t).m;return m>=10&&m<30}))},{l:"30m+",s:gs(dt.filter(function(t){return cDur(t).m>=30}))}]});
// Timeframe buckets
var tf=cp.filter(function(t){return t.timeframe});
if(tf.length>=3){var tfBk={};tf.forEach(function(t){if(!tfBk[t.timeframe])tfBk[t.timeframe]=[];tfBk[t.timeframe].push(t)});var bks=Object.keys(tfBk).map(function(k){return{l:k,s:gs(tfBk[k])}});if(bks.length>=2)num.push({label:"Timeframe",bk:bks})}
// Trade # of day
var tn=cp.filter(function(t){return t.tradeNumOfDay});
if(tn.length>=3)num.push({label:"Trade # of Day",bk:[{l:"#1-2",s:gs(tn.filter(function(t){return+t.tradeNumOfDay<=2}))},{l:"#3-4",s:gs(tn.filter(function(t){var v=+t.tradeNumOfDay;return v>=3&&v<=4}))},{l:"#5+",s:gs(tn.filter(function(t){return+t.tradeNumOfDay>=5}))}]});
// Confidence
var cf=cp.filter(function(t){return t.confidence});
if(cf.length>=3)num.push({label:"Confidence",bk:[{l:"1-2 (Low)",s:gs(cf.filter(function(t){return+t.confidence<=2}))},{l:"3 (Med)",s:gs(cf.filter(function(t){return+t.confidence===3}))},{l:"4-5 (High)",s:gs(cf.filter(function(t){return+t.confidence>=4}))}]});
// Emotion
var em=cp.filter(function(t){return t.emotion&&t.emotion!=="calm"});
if(em.length>=2){var emBk={};cp.filter(function(t){return t.emotion}).forEach(function(t){var e=t.emotion;if(!emBk[e])emBk[e]=[];emBk[e].push(t)});var eBks=Object.keys(emBk).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(emBk[k])}});num.push({label:"Emotional State",bk:eBks})}
// Session read
var sr=cp.filter(function(t){return t.sessionRead});
if(sr.length>=3){var srBk={};sr.forEach(function(t){var s=t.sessionRead;if(!srBk[s])srBk[s]=[];srBk[s].push(t)});num.push({label:"Session Read (Yours)",bk:Object.keys(srBk).map(function(k){return{l:k.charAt(0).toUpperCase()+k.slice(1),s:gs(srBk[k])}})})}
// System session vs your read
var dayMap={};cp.forEach(function(t){if(!dayMap[t.date])dayMap[t.date]=[];dayMap[t.date].push(t)});
var matchTrades=[],mismatchTrades=[];
cp.filter(function(t){return t.sessionRead}).forEach(function(t){var sys=sysSession(dayMap[t.date]||[]);if(sys==="unknown")return;if(t.sessionRead===sys)matchTrades.push(t);else mismatchTrades.push(t)});
if(matchTrades.length+mismatchTrades.length>=3)num.push({label:"Your Read vs System",bk:[{l:"Match",s:gs(matchTrades)},{l:"Mismatch",s:gs(mismatchTrades)}]});

// === COMBO ANALYSIS (top 2, 3, 4, 5 rule combos) ===
var combos=[];
if(cp.length>=5){
var activeRules=RK.filter(function(k){return cp.filter(function(t){return t.rules[k]==="Y"}).length>=2});
// 2-rule combos
for(var i=0;i<activeRules.length;i++){for(var j=i+1;j<activeRules.length;j++){
var both=cp.filter(function(t){return t.rules[activeRules[i]]==="Y"&&t.rules[activeRules[j]]==="Y"});
if(both.length>=3){var s=gs(both);combos.push({rules:[RL[activeRules[i]],RL[activeRules[j]]],stats:s,count:2})}}}
// 3-rule combos (only from top 6 rules by edge)
var topRules=activeRules.slice().sort(function(a,b){var ae=Math.abs(yn.find(function(r){return r.key===a})||{edge:0}).edge||0;var be=Math.abs(yn.find(function(r){return r.key===b})||{edge:0}).edge||0;return be-ae}).slice(0,6);
for(var i=0;i<topRules.length;i++){for(var j=i+1;j<topRules.length;j++){for(var k=j+1;k<topRules.length;k++){
var tri=cp.filter(function(t){return t.rules[topRules[i]]==="Y"&&t.rules[topRules[j]]==="Y"&&t.rules[topRules[k]]==="Y"});
if(tri.length>=2){var s=gs(tri);combos.push({rules:[RL[topRules[i]],RL[topRules[j]],RL[topRules[k]]],stats:s,count:3})}}}}
// 4-rule combos (only from top 5 rules, min 4 trades)
var top5=topRules.slice(0,5);
if(cp.length>=10){for(var i=0;i<top5.length;i++){for(var j=i+1;j<top5.length;j++){for(var k=j+1;k<top5.length;k++){for(var l=k+1;l<top5.length;l++){
var quad=cp.filter(function(t){return t.rules[top5[i]]==="Y"&&t.rules[top5[j]]==="Y"&&t.rules[top5[k]]==="Y"&&t.rules[top5[l]]==="Y"});
if(quad.length>=4){var s=gs(quad);combos.push({rules:[RL[top5[i]],RL[top5[j]],RL[top5[k]],RL[top5[l]]],stats:s,count:4})}}}}}}
// 5-rule combos (only from top 5 rules, min 5 trades)
if(cp.length>=15&&top5.length>=5){
var quint=cp.filter(function(t){return top5.every(function(r){return t.rules[r]==="Y"})});
if(quint.length>=5){var s=gs(quint);combos.push({rules:top5.map(function(r){return RL[r]}),stats:s,count:5})}}
combos.sort(function(a,b){if(b.stats.wr!==a.stats.wr)return b.stats.wr-a.stats.wr;return b.stats.ar-a.stats.ar});
combos=combos.slice(0,20)}

// === MIN RULE COUNT CURVE ===
var minRule=[];
for(var n=0;n<=8;n++){var tr=cp.filter(function(t){return ruleCount(t)>=n});if(tr.length>=2)minRule.push({min:n,stats:gs(tr)})}

// === CORRELATION MATRIX ===
var corr=[];
if(cp.length>=5){
var ar2=activeRules||RK.filter(function(k){return cp.filter(function(t){return t.rules[k]==="Y"}).length>=2});
for(var i=0;i<ar2.length;i++){for(var j=i+1;j<ar2.length;j++){
var bothY=cp.filter(function(t){return t.rules[ar2[i]]==="Y"&&t.rules[ar2[j]]==="Y"}).length;
var eitherY=cp.filter(function(t){return t.rules[ar2[i]]==="Y"||t.rules[ar2[j]]==="Y"}).length;
if(eitherY>0){corr.push({a:RL[ar2[i]],b:RL[ar2[j]],overlap:bothY/eitherY,bothN:bothY})}}}
corr.sort(function(a,b){return b.overlap-a.overlap})}

// === ENTRY QUALITY SCORE ===
var scores=[];
if(cp.length>=5&&yn.length>=3){
// Weight = normalized edge for each rule
var maxEdge=Math.max.apply(null,yn.filter(function(r){return RK.indexOf(r.key)>=0}).map(function(r){return Math.abs(r.edge)}));
if(maxEdge>0){
var weights={};yn.forEach(function(r){if(RK.indexOf(r.key)>=0)weights[r.key]=r.edge/maxEdge});
scores=cp.map(function(t){var score=0,maxScore=0;
RK.forEach(function(k){if(weights[k]!==undefined){var w=Math.abs(weights[k]);maxScore+=w;if(t.rules[k]==="Y"&&weights[k]>0)score+=w;else if(t.rules[k]==="Y"&&weights[k]<0)score-=w*0.5}});
var pct=maxScore>0?Math.round(score/maxScore*100):0;
return{id:t.id,score:pct,pl:cPL(t).pl,rm:cPL(t).rm,date:t.date,ticker:t.ticker}}).sort(function(a,b){return b.score-a.score})}}

// === CONDITIONAL EDGE ===
var cond=[];
if(cp.length>=8){
var topYN=yn.filter(function(r){return RK.indexOf(r.key)>=0}).slice(0,6);
for(var i=0;i<topYN.length;i++){for(var j=0;j<topYN.length;j++){if(i===j)continue;
var base=cp.filter(function(t){return t.rules[topYN[i].key]==="Y"});
var added=base.filter(function(t){return t.rules[topYN[j].key]==="Y"});
var without=base.filter(function(t){return t.rules[topYN[j].key]==="N"});
if(added.length>=2&&without.length>=2){var inc=gs(added).wr-gs(without).wr;
cond.push({base:topYN[i].label,add:topYN[j].label,incr:inc,addStats:gs(added),woStats:gs(without)})}}}}
cond.sort(function(a,b){return Math.abs(b.incr)-Math.abs(a.incr)});
cond=cond.slice(0,12);

// === EDGE DECAY ===
var decay=[];
if(cp.length>=10){
var sorted_cp=cp.slice().sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)});
var last20=sorted_cp.slice(-20);var last10=sorted_cp.slice(-10);
RK.forEach(function(k){
var all_y=cp.filter(function(t){return t.rules[k]==="Y"});if(all_y.length<3)return;
var l20_y=last20.filter(function(t){return t.rules[k]==="Y"});
var l10_y=last10.filter(function(t){return t.rules[k]==="Y"});
var all_s=gs(all_y),l20_s=l20_y.length>=2?gs(l20_y):null,l10_s=l10_y.length>=2?gs(l10_y):null;
var decaying=(l10_s&&l10_s.wr<all_s.wr-0.15)||(l20_s&&l20_s.wr<all_s.wr-0.10);
decay.push({key:k,label:RL[k],allTime:all_s,last20:l20_s,last10:l10_s,decaying:decaying,allN:all_y.length})});
// Also check top combos for decay
if(combos.length>=3){combos.slice(0,5).forEach(function(c){
var all_y=cp.filter(function(t){return c.rules.every(function(rl){var k=Object.keys(RL).find(function(x){return RL[x]===rl});return k&&t.rules[k]==="Y"})});
if(all_y.length<5)return;
var sorted_y=all_y.slice().sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)});
var l10_y=sorted_y.slice(-10);var l20_y=sorted_y.slice(-20);
var all_s=gs(all_y),l20_s=l20_y.length>=3?gs(l20_y):null,l10_s=l10_y.length>=3?gs(l10_y):null;
var decaying=(l10_s&&l10_s.wr<all_s.wr-0.15)||(l20_s&&l20_s.wr<all_s.wr-0.10);
decay.push({key:"combo_"+c.rules.join("_"),label:c.rules.join(" + "),allTime:all_s,last20:l20_s,last10:l10_s,decaying:decaying,allN:all_y.length,isCombo:true})})}
decay.sort(function(a,b){return b.decaying-a.decaying||b.allN-a.allN})}

// === EXIT PLANNING ANALYSIS ===
var exitAnalysis={targetTypes:[],captureAnalysis:null,partialAnalysis:null,multiTargetAnalysis:null};
var tradesWithTargets=cp.filter(function(t){return t.targets&&t.targets.length>0&&t.entry&&t.exit});
if(tradesWithTargets.length>=3){
// Target type hit rate
var typeMap={};
tradesWithTargets.forEach(function(t){(t.targets||[]).forEach(function(tgt){if(!tgt.type)return;if(!typeMap[tgt.type])typeMap[tgt.type]={hits:0,total:0,rWhenHit:[],rWhenMiss:[]};typeMap[tgt.type].total++;if(tgt.isHit==="Y"){typeMap[tgt.type].hits++;var r=cPL(t).rm;typeMap[tgt.type].rWhenHit.push(r)}else if(tgt.isHit==="N"){var r=cPL(t).rm;typeMap[tgt.type].rWhenMiss.push(r)}})});
exitAnalysis.targetTypes=Object.keys(typeMap).map(function(k){var d=typeMap[k];var ttLabel=(TARGET_TYPES.find(function(x){return x.v===k})||{l:k}).l;return{type:k,label:ttLabel,total:d.total,hitRate:d.hits/d.total,avgRHit:d.rWhenHit.length?d.rWhenHit.reduce(function(s,v){return s+v},0)/d.rWhenHit.length:null,avgRMiss:d.rWhenMiss.length?d.rWhenMiss.reduce(function(s,v){return s+v},0)/d.rWhenMiss.length:null}}).filter(function(x){return x.total>=2}).sort(function(a,b){return b.hitRate-a.hitRate});
// MFE vs actual capture
var mfeTrades=cp.filter(function(t){return t.mfePrice&&t.entry&&t.exit});
if(mfeTrades.length>=3){var capData=mfeTrades.map(function(t){var mfe=cMFE(t);return mfe&&mfe.cp!==null?mfe.cp:null}).filter(function(v){return v!==null});exitAnalysis.captureAnalysis={count:capData.length,avg:capData.reduce(function(s,v){return s+v},0)/capData.length,pct70plus:capData.filter(function(v){return v>=0.7}).length/capData.length,pct50minus:capData.filter(function(v){return v<0.5}).length/capData.length}}
// Trend end (left on table)
var trendEndTrades=cp.filter(function(t){return t.trendEndPrice&&t.entry&&t.exit&&t.mfePrice});
if(trendEndTrades.length>=3){var leftOnTable=trendEndTrades.map(function(t){var e=+t.entry,mfe=+t.mfePrice,te=+t.trendEndPrice,rk=Math.abs(e-(+t.stop||0));if(rk<=0)return null;var mfeDist=t.direction==="L"?mfe-e:e-mfe;var teDist=t.direction==="L"?te-e:e-te;return teDist>0&&mfeDist>0?{leftR:(teDist-mfeDist)/rk,leftPct:(teDist-mfeDist)/teDist}:null}).filter(Boolean);if(leftOnTable.length>=2){exitAnalysis.leftOnTable={count:leftOnTable.length,avgLeftR:leftOnTable.reduce(function(s,v){return s+v.leftR},0)/leftOnTable.length,avgLeftPct:leftOnTable.reduce(function(s,v){return s+v.leftPct},0)/leftOnTable.length}}}
// Partial vs Full analysis
var partialTrades=cp.filter(function(t){return t.hasPartial==="Y"&&t.partialExitPrice&&t.partialPct&&t.entry&&t.exit});
var fullTrades=cp.filter(function(t){return t.hasPartial==="N"});
if(partialTrades.length>=3||fullTrades.length>=3){exitAnalysis.partialAnalysis={partialStats:partialTrades.length>=2?gs(partialTrades):null,fullStats:fullTrades.length>=2?gs(fullTrades):null,partialCount:partialTrades.length,fullCount:fullTrades.length}}
// BE stop cost
var beMoveTrades=cp.filter(function(t){return t.stopMgmt&&t.stopMgmt.stopMoved==="Y"&&t.entry&&t.exit&&t.stop});
var noBeMoveTrades=cp.filter(function(t){return t.stopMgmt&&t.stopMgmt.stopMoved==="N"&&t.entry&&t.exit&&t.stop});
if(beMoveTrades.length>=3){
var beLosses=beMoveTrades.filter(function(t){return cPL(t).pl<=0});
var beWins=beMoveTrades.filter(function(t){return cPL(t).pl>0});
var beLMFE=beLosses.map(function(t){var m=cMFE(t);return m&&m.cp!=null?m.cp:null}).filter(function(v){return v!==null});
var avgBeLMFE=beLMFE.length?beLMFE.reduce(function(s,v){return s+v},0)/beLMFE.length:null;
var teCostT=beLosses.filter(function(t){return t.trendEndPrice&&+t.trendEndPrice>0&&t.mfePrice&&+t.mfePrice>0});
var avgCostR=null;
if(teCostT.length>=2){var costs=teCostT.map(function(t){var e=+t.entry,ex=+t.exit,te=+t.trendEndPrice,rk=Math.abs(e-(+t.stop||0));if(rk<=0)return null;var teDist=t.direction==="L"?te-e:e-te;var exDist=t.direction==="L"?ex-e:e-ex;return teDist>exDist?{costR:(teDist-exDist)/rk}:null}).filter(Boolean);if(costs.length>=2)avgCostR=costs.reduce(function(s,v){return s+v.costR},0)/costs.length}
exitAnalysis.beStopAnalysis={moveCount:beMoveTrades.length,noMoveCount:noBeMoveTrades.length,moveStats:gs(beMoveTrades),noMoveStats:noBeMoveTrades.length>=3?gs(noBeMoveTrades):null,beLossCount:beLosses.length,beWinCount:beWins.length,avgMFEAtBELoss:avgBeLMFE,avgCostR:avgCostR,teSampleSize:teCostT.length}}
// Duration vs capture
var dcTrades=cp.filter(function(t){return t.mfePrice&&t.entry&&t.exit&&t.time&&t.exitTime});
if(dcTrades.length>=5){
var dBkts=[{l:"<10 min",min:0,max:10,t:[]},{l:"10-30 min",min:10,max:30,t:[]},{l:"30-60 min",min:30,max:60,t:[]},{l:">60 min",min:60,max:9999,t:[]}];
dcTrades.forEach(function(t){var dur=cDur(t);if(!dur)return;var bkt=dBkts.find(function(b){return dur.m>=b.min&&dur.m<b.max});if(bkt)bkt.t.push(t)});
exitAnalysis.durCap=dBkts.map(function(b){if(b.t.length<2)return null;var caps=b.t.map(function(t){var m=cMFE(t);return m&&m.cp!=null?m.cp:null}).filter(function(v){return v!==null});return{l:b.l,n:b.t.length,avgCap:caps.length?caps.reduce(function(s,v){return s+v},0)/caps.length:null,st:gs(b.t)}}).filter(Boolean)}
// Exit type breakdown
var etT=cp.filter(function(t){return t.exitType&&t.entry&&t.exit&&t.shares});
if(etT.length>=5){var etMap={};etT.forEach(function(t){if(!etMap[t.exitType])etMap[t.exitType]=[];etMap[t.exitType].push(t)});
exitAnalysis.exitTypes=Object.keys(etMap).map(function(k){if(etMap[k].length<2)return null;return{label:k.charAt(0).toUpperCase()+k.slice(1),n:etMap[k].length,st:gs(etMap[k])}}).filter(Boolean).sort(function(a,b){return b.st.ar-a.st.ar})}
}

return{yn:yn,num:num,combos:combos,minRule:minRule,corr:corr,scores:scores,cond:cond,decay:decay,exitAnalysis:exitAnalysis}},[cp]);
// === TIME AUTO-FORMAT ===
function fmtTime(v){var d=v.replace(/\D/g,"");if(d.length>=4){return d.slice(0,2)+":"+d.slice(2,4)}return v}
// === FORM ===
function rF(){if(!et)return null;var t=et;
function u(k,v){setEt(function(p){var c=dc(p);c[k]=v;return c})}
function uR(k,v){setEt(function(p){var c=dc(p);c.rules[k]=v;return c})}
function uS(k,v){setEt(function(p){var c=dc(p);c.stopMgmt[k]=v;return c})}
function onTimeBlur(field,v){if(/^\d{3,4}$/.test(v.replace(/\D/g,""))){u(field,fmtTime(v))}}
function onTimeChange(field,v){
var digits=v.replace(/\D/g,"");
if(digits.length===4){u(field,digits.slice(0,2)+":"+digits.slice(2,4));return}
if(v.length===2&&!v.includes(":")&&v===digits){u(field,v+":");return}
u(field,v)}
var img=t.screenshotData||t.screenshotUrl;
var pp=(t.entry&&t.exit&&t.shares)?cPL(t):null;
var mf=(t.entry&&t.mfePrice)?cMFE(t):null;
var ma=(t.entry&&t.maePrice)?cMAE(t):null;
var du=cDur(t);
var pv=[];
if(pp){pv.push(h("div",{key:"pl",style:{flex:1,textAlign:"center",minWidth:55}},h("div",{style:{fontSize:8,color:K.dm}},"P/L"),h("div",{style:{fontSize:13,fontWeight:700,color:pp.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},"$"+pp.pl.toFixed(2))));pv.push(h("div",{key:"r",style:{flex:1,textAlign:"center",minWidth:45}},h("div",{style:{fontSize:8,color:K.dm}},"R"),h("div",{style:{fontSize:13,fontWeight:700,color:pp.rm>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},pp.rm.toFixed(2)+"R")))}
if(du)pv.push(h("div",{key:"d",style:{flex:1,textAlign:"center",minWidth:50}},h("div",{style:{fontSize:8,color:K.dm}},"Dur"),h("div",{style:{fontSize:13,fontWeight:700,color:K.go,fontFamily:"JetBrains Mono,monospace"}},du.l)));
if(mf&&mf.cp!==null)pv.push(h("div",{key:"c",style:{flex:1,textAlign:"center",minWidth:50}},h("div",{style:{fontSize:8,color:K.dm}},"Cap"),h("div",{style:{fontSize:13,fontWeight:700,color:mf.cp>=.7?K.g:mf.cp>=.5?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},(mf.cp*100).toFixed(0)+"%")));
if(ma)pv.push(h("div",{key:"m",style:{flex:1,textAlign:"center",minWidth:50}},h("div",{style:{fontSize:8,color:K.dm}},"MAE"),h("div",{style:{fontSize:13,fontWeight:700,color:K.r,fontFamily:"JetBrains Mono,monospace"}},"-$"+ma.md.toFixed(2))));
var re=RK.map(function(k){return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"3px 7px",background:K.bg,borderRadius:6}},h("span",{style:{fontSize:10,color:K.dm}},RL[k]),h(YN,{v:t.rules[k],onChange:function(v){uR(k,v)}}))});
var se=stopRules.map(function(r){return h("div",{key:r.k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"3px 7px",background:K.bg,borderRadius:6}},h("span",{style:{fontSize:10,color:K.dm}},r.l),h(YN,{v:t.stopMgmt[r.k],onChange:function(v){uS(r.k,v)}}))});
var qe=["macdCross","rsiExtreme","cloudAlign","chanRetest","cloud15m"].map(function(k){return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"3px 7px",background:K.bg,borderRadius:6}},h("span",{style:{fontSize:10,color:K.dm}},RL[k]),h(YN,{v:t.rules[k],onChange:function(v){uR(k,v)}}))});
var g4="1fr 1fr 1fr 1fr",g3="1fr 1fr 1fr";
// Section label helper
function SL2(label,color,tip){return h("div",{style:{fontSize:10,fontWeight:700,color:color||K.go,marginBottom:5,marginTop:4,display:"flex",alignItems:"center",borderBottom:"1px solid "+K.bd,paddingBottom:4}},label,tip?h(Tip,{t:tip}):null)}
return h("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.85)",zIndex:9500,overflow:"auto",padding:"16px 8px"}},
h("div",{style:{maxWidth:qm?580:880,margin:"0 auto",background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:20}},
// Header
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14,flexWrap:"wrap",gap:6}},
h("div",{style:{display:"flex",alignItems:"center",gap:8}},h("h2",{style:{color:K.go,fontSize:15,margin:0,fontFamily:"JetBrains Mono,monospace"}},qm?"QUICK ENTRY":"TRADE ENTRY"),h("span",{style:{fontSize:9,padding:"2px 8px",borderRadius:4,background:t.mode==="backtest"?K.pu:K.cy,color:"#fff",fontWeight:600}},t.mode==="backtest"?"BT":"LIVE")),
h("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},h(Pl,{v:t.mode,onChange:function(v){u("mode",v)},options:[{v:"live",l:"Live",c:K.cy},{v:"backtest",l:"BT",c:K.pu}]}),h("button",{onClick:function(){sQm(!qm)},style:{padding:"4px 8px",background:qm?K.cy:K.pu,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer"}},qm?"Full":"Quick"),h("button",{onClick:function(){setSf(false);setEt(null)},style:{padding:"4px 8px",background:K.r,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer"}},"Cancel"))),

// === BLOCK 1: IDENTITY — Direction + Type + Strategy ===
SL2("TRADE IDENTITY",K.go),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Direction",h(Tip,{t:"Long = betting price goes up. Short = betting price goes down."})),h(Pl,{v:t.direction,onChange:function(v){u("direction",v)},options:[{v:"L",l:"LONG",c:K.g},{v:"S",l:"SHORT",c:K.r}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Type",h(Tip,{t:"Reversal = entering against the prior trend. Continuation = entering in the direction of the trend."})),h(Pl,{v:t.type,onChange:function(v){u("type",v)},options:[{v:"Rev",l:"Reversal",c:K.cy},{v:"Cont",l:"Continuation",c:K.go}]}))),
userStrats.length?h("div",{style:{marginBottom:12}},
h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Strategy",h(Tip,{t:"Which strategy are you using for this trade? Rules below will update based on your selection."})),
h("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},
h("button",{onClick:function(){u("strategyId","")},style:{padding:"5px 10px",borderRadius:5,border:"1px solid "+K.bd,fontSize:11,fontWeight:600,cursor:"pointer",background:!t.strategyId?K.dm:"transparent",color:!t.strategyId?"#fff":K.dm}},"None"),
userStrats.map(function(s){return h("button",{key:s.id,onClick:function(){u("strategyId",s.id)},style:{padding:"5px 12px",borderRadius:5,border:"1px solid "+(t.strategyId===s.id?K.go:K.bd),fontSize:11,fontWeight:600,cursor:"pointer",background:t.strategyId===s.id?K.go:"transparent",color:t.strategyId===s.id?"#000":K.dm}},s.name)}))):null,

// === BLOCK 2: CAN'T RECOVER LATER ===
SL2("NOW — CAN'T RECOVER LATER",K.r,"Fill these in real-time. Emotion, confidence, and session read cannot be reconstructed from broker records or screenshots."),
h("div",{style:{display:"grid",gridTemplateColumns:"60px 1fr 1fr 1fr 80px",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trade#",h(Tip,{t:"Which trade is this in your session today? Auto-generated but you can correct it."})),h(Ip,{value:t.tradeNumOfDay,onChange:function(v){u("tradeNumOfDay",v)},type:"number",placeholder:"1"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Session",h(Tip,{t:"Your read of the overall market session. Trending = clear direction. Ranging = bouncing. Choppy = no clean moves. Breakout = breaking key level. Reversal = changing direction."})),h(Sel,{value:t.sessionRead,onChange:function(v){u("sessionRead",v)},options:[{v:"",l:"--"}].concat(SESSIONS.map(function(s){return{v:s,l:s.charAt(0).toUpperCase()+s.slice(1)}}))})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Confidence",h(Tip,{t:"How confident were you in this setup at entry? 1 = very unsure, 5 = high conviction."})),h(Pl,{v:t.confidence,onChange:function(v){u("confidence",v)},options:[{v:"1",l:"1"},{v:"2",l:"2"},{v:"3",l:"3"},{v:"4",l:"4"},{v:"5",l:"5"}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Emotion",h(Tip,{t:"Your emotional state at entry. Calm = ideal. FOMO = fear of missing out. Revenge = trading to recover losses."})),h(Sel,{value:t.emotion,onChange:function(v){u("emotion",v)},options:EMOTIONS.map(function(e){return{v:e,l:e.charAt(0).toUpperCase()+e.slice(1)}})})),
h("div",null,h("div",{style:{fontSize:10,color:K.go,marginBottom:3}},"Followed?",h(Tip,{t:"Did this trade meet your minimum entry criteria? The most powerful metric in the journal — measures the real cost of breaking discipline."})),h(YN,{v:t.followedRules,onChange:function(v){u("followedRules",v)}}))),

// === BLOCK 3: MARKET CONTEXT ===
SL2("MARKET CONTEXT",K.pu,"Technical conditions at entry. Can be filled from screenshots after the session."),
h("div",{style:{display:"grid",gridTemplateColumns:"80px 1fr 1fr 1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"TF",h(Tip,{t:"Timeframe you used for entry."})),h(Sel,{value:t.timeframe,onChange:function(v){u("timeframe",v)},options:TFS.map(function(tf){return{v:tf,l:tf}})})),
h("div",null,h("div",{style:{fontSize:10,color:K.pu,marginBottom:3}},"Cloud Dir",h(Tip,{t:"EMA cloud direction at entry. Bullish = cloud sloping up. Bearish = cloud sloping down."})),h(Pl,{v:t.cloudDirection,onChange:function(v){u("cloudDirection",v)},options:[{v:"",l:"--"},{v:"bull",l:"Bull",c:K.g},{v:"bear",l:"Bear",c:K.r}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.pu,marginBottom:3}},"Cloud W%",h(Tip,{t:"Width of the EMA cloud as a percentage of price. Wider cloud = stronger trend. Example: 0.25 = 0.25% wide."})),h(Ip,{value:t.cloudThickness,onChange:function(v){u("cloudThickness",v)},type:"number",step:"0.01",placeholder:"0.25"})),
h("div",null,h("div",{style:{fontSize:10,color:K.go,marginBottom:3}},"ADX",h(Tip,{t:"Average Directional Index at entry. Measures trend strength. Under 20 = weak/choppy. 20-25 = developing. 25+ = strong trend."})),h(Ip,{value:t.adxAtEntry,onChange:function(v){u("adxAtEntry",v)},type:"number",step:"0.1",placeholder:"25"})),
h("div",null,h("div",{style:{fontSize:10,color:K.go,marginBottom:3}},"RSI Entry",h(Tip,{t:"RSI value at your entry. Under 30 = oversold. 30-50 = bearish zone. 50-70 = bullish zone. 70+ = overbought."})),h(Ip,{value:t.rsiAtEntry,onChange:function(v){u("rsiAtEntry",v)},type:"number",step:"0.1",placeholder:"45"}))),

// === BLOCK 4: REAL TRADE DATA ===
SL2("TRADE DATA","#e0e6ed","Prices, times, and execution data. Recoverable from broker records after the session."),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Date"),h(Ip,{value:t.date,onChange:function(v){u("date",v)},type:"date"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Entry Time",h(Tip,{t:"Type 1032 and it auto-formats to 10:32."})),h(Ip,{value:t.time,onChange:function(v){onTimeChange("time",v)},onBlur:function(e){onTimeBlur("time",e.target.value)},placeholder:"10:32"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Exit Time"),h(Ip,{value:t.exitTime,onChange:function(v){onTimeChange("exitTime",v)},onBlur:function(e){onTimeBlur("exitTime",e.target.value)},placeholder:"10:47"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Ticker"),h(Ip,{value:t.ticker,onChange:function(v){u("ticker",v.toUpperCase())},placeholder:"TSLA"}))),
h("div",{style:{display:"grid",gridTemplateColumns:g4,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Entry $",h(Tip,{t:"Your fill price when entering the trade."})),h(Ip,{value:t.entry,onChange:function(v){u("entry",v)},type:"number",step:"0.01",placeholder:"452.30"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Stop $",h(Tip,{t:"Your initial stop loss price. Used to calculate R-multiple (risk unit)."})),h(Ip,{value:t.stop,onChange:function(v){u("stop",v)},type:"number",step:"0.01",placeholder:"451.10"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Exit $",h(Tip,{t:"Your fill price when exiting the trade."})),h(Ip,{value:t.exit,onChange:function(v){u("exit",v)},type:"number",step:"0.01",placeholder:"454.80"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Shares",h(Tip,{t:"Number of shares or contracts traded."})),h(Ip,{value:t.shares,onChange:function(v){u("shares",v)},type:"number",placeholder:"400"}))),
h("div",{style:{display:"grid",gridTemplateColumns:g4,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.cy,marginBottom:3}},t.direction==="L"?"MFE — High $":"MFE — Low $",h(Tip,{t:"Maximum Favorable Excursion — the best price the trade reached while you were in it. For longs: highest price. For shorts: lowest price."})),h(Ip,{value:t.mfePrice,onChange:function(v){u("mfePrice",v)},type:"number",step:"0.01"})),
h("div",null,h("div",{style:{fontSize:10,color:K.r,marginBottom:3}},t.direction==="L"?"MAE — Low $":"MAE — High $",h(Tip,{t:"Maximum Adverse Excursion — the worst drawdown price while you were in the trade. For longs: lowest price hit. For shorts: highest price hit."})),h(Ip,{value:t.maePrice,onChange:function(v){u("maePrice",v)},type:"number",step:"0.01"})),
h("div",null,h("div",{style:{fontSize:10,color:K.cy,marginBottom:3}},"RSI at Peak",h(Tip,{t:"RSI value at the MFE — the best price. Helps identify when RSI signals a reversal from the peak."})),h(Ip,{value:t.rsiAtPeak,onChange:function(v){u("rsiAtPeak",v)},type:"number",step:"0.1",placeholder:"78"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"RSI at Exit",h(Tip,{t:"RSI value at your exit price."})),h(Ip,{value:t.rsiAtExit,onChange:function(v){u("rsiAtExit",v)},type:"number",step:"0.1",placeholder:"72"}))),
// MAE Timing + Div Before + Div During
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{display:"flex",alignItems:"center",fontSize:10,color:K.dm,marginBottom:3}},"MAE Timing",h(Tip,{t:"Did the worst drawdown happen before or after the best price? Dip First = hit stop area then ran. Run First = ran to MFE then pulled back. Measures momentum quality."})),h(Pl,{v:t.maeTiming,onChange:function(v){u("maeTiming",v)},options:[{v:"",l:"--"},{v:"dip1st",l:"Dip First",c:K.go},{v:"run1st",l:"Run First",c:K.cy}]})),
h("div",null,h("div",{style:{display:"flex",alignItems:"center",fontSize:10,color:K.go,marginBottom:3}},"Div Before Entry",h(Tip,{t:"Was divergence building before your entry? Bullish div = price making lower lows but RSI making higher lows. Bearish = opposite."})),h(Pl,{v:t.divBefore,onChange:function(v){u("divBefore",v)},options:DIVS})),
h("div",null,h("div",{style:{display:"flex",alignItems:"center",fontSize:10,color:K.cy,marginBottom:3}},"Div During Trade",h(Tip,{t:"Did divergence form while in the trade? Signals potential exit point."})),h(Pl,{v:t.divDuring,onChange:function(v){u("divDuring",v)},options:DIVS}))),
// Exit details row
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Exit Type",h(Tip,{t:"How did you exit? Trail = trailing stop hit. Limit = hit your target. Stopped = initial stop hit."})),h(Pl,{v:t.exitType,onChange:function(v){u("exitType",v)},options:[{v:"Trail",l:"Trail",c:K.g},{v:"Limit",l:"Limit",c:K.go},{v:"Stop",l:"Stopped",c:K.r}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Vol at Exit",h(Tip,{t:"Volume at time of exit relative to average. High volume exits on wins = strong momentum. Low volume = potential for more."})),h(Pl,{v:t.volAtExit,onChange:function(v){u("volAtExit",v)},options:[{v:"B",l:"Below",c:K.r},{v:"A",l:"At Avg",c:K.go},{v:"H",l:"Above",c:K.g}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trend End $",h(Tip,{t:"Where did the move ultimately top or bottom AFTER you exited? Shows how much you left on the table post-exit."})),h(Ip,{value:t.trendEndPrice,onChange:function(v){u("trendEndPrice",v)},type:"number",step:"0.01",placeholder:"456.20"}))),
// Trail details (only if exit type is Trail)
t.exitType==="Trail"?h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trail TF",h(Tip,{t:"Which timeframe chart did you use to trail your stop?"})),h(Pl,{v:t.trailTimeframe,onChange:function(v){u("trailTimeframe",v)},options:[{v:"",l:"--"},{v:"1m",l:"1m",c:K.g},{v:"3m",l:"3m",c:K.go},{v:"5m",l:"5m",c:K.cy},{v:"same",l:"Same",c:K.pu}]})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Trail Stop $",h(Tip,{t:"The actual trailing stop price when it was hit. Combined with MFE shows exactly how much you gave back from peak."})),h(Ip,{value:t.trailStopPrice,onChange:function(v){u("trailStopPrice",v)},type:"number",step:"0.01"}))):null,
// Partial exit
h("div",{style:{marginBottom:8}},
h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
h("div",{style:{fontSize:10,color:K.dm,fontWeight:700}},"Partial Exit?",h(Tip,{t:"Did you take a partial exit on this trade? Analysis will compare blended R of partial strategy vs full exit."})),
h(Pl,{v:t.hasPartial,onChange:function(v){u("hasPartial",v)},options:[{v:"",l:"--"},{v:"Y",l:"Yes",c:K.g},{v:"N",l:"No",c:K.dm}]})),
t.hasPartial==="Y"?h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Partial Exit $",h(Tip,{t:"Price at which you took your partial exit."})),h(Ip,{value:t.partialExitPrice,onChange:function(v){u("partialExitPrice",v)},type:"number",step:"0.01"})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"% Exited",h(Tip,{t:"What percentage of your position did you exit partially?"})),h(Pl,{v:t.partialPct,onChange:function(v){u("partialPct",v)},options:[{v:"",l:"--"},{v:"25",l:"25%",c:K.go},{v:"33",l:"33%",c:K.go},{v:"50",l:"50%",c:K.cy},{v:"75",l:"75%",c:K.pu}]}))):null),

// === EXIT PLANNING — TARGET BUILDER ===
!qm?h("div",{style:{marginBottom:8}},
SL2("EXIT PLANNING — TARGETS",K.cy,"Plan your exits before entering the trade. Define where you planned to take profits — analysis will show which target types you actually hit vs miss."),
function(){
var targets=t.targets||[];
function uTarget(idx,field,val){setEt(function(p){var c=dc(p);if(!c.targets)c.targets=[];var arr=c.targets.slice();if(!arr[idx])arr[idx]=mkTarget();arr[idx]=Object.assign({},arr[idx]);arr[idx][field]=val;c.targets=arr;return c})}
function addTarget(){setEt(function(p){var c=dc(p);c.targets=(c.targets||[]).concat([mkTarget()]);return c})}
function removeTarget(idx){setEt(function(p){var c=dc(p);c.targets=(c.targets||[]).filter(function(_,i){return i!==idx});return c})}
function calcTargetR(tgt){if(!t.entry||!t.stop||!tgt.price)return null;var e=+t.entry,s=+t.stop,tp=+tgt.price;var rk=Math.abs(e-s);if(rk<=0)return null;var rv=t.direction==="L"?(tp-e)/rk:(e-tp)/rk;return rv.toFixed(2)}
return h("div",null,
targets.length===0?h("div",{style:{fontSize:10,color:K.dm,marginBottom:8,padding:"8px 10px",background:K.bg,borderRadius:6,borderLeft:"2px solid "+K.cy}},"Add targets before entering. Multi-slot targets (T1, T2, T3) appear when Partial Exit is set to Yes — match each target to a partial exit."):null,
targets.map(function(tgt,idx){
var autoR=calcTargetR(tgt);
return h("div",{key:tgt.id||idx,style:{background:K.bg,borderRadius:8,border:"1px solid "+K.bd,padding:"8px 10px",marginBottom:6}},
h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}},
h("div",{style:{display:"flex",alignItems:"center",gap:6}},
h("span",{style:{fontSize:11,fontWeight:700,color:K.cy,fontFamily:"JetBrains Mono,monospace"}},"T"+(idx+1)),
autoR?h("span",{style:{fontSize:10,color:+autoR>=1?K.g:+autoR>=0?K.go:K.r,fontFamily:"JetBrains Mono,monospace",fontWeight:700}},autoR+"R"):null),
h("div",{style:{display:"flex",alignItems:"center",gap:4}},
h("span",{style:{fontSize:9,color:K.dm,marginRight:2}},"Hit?"),
h(Pl,{v:tgt.isHit,onChange:function(v){uTarget(idx,"isHit",v)},options:[{v:"",l:"--"},{v:"Y",l:"Y",c:K.g},{v:"N",l:"N",c:K.r}]}),
h("button",{onClick:function(){removeTarget(idx)},style:{padding:"2px 7px",background:"transparent",border:"1px solid "+K.r+"44",borderRadius:4,color:K.r,fontSize:9,cursor:"pointer",marginLeft:4}},"\u00d7"))),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:6}},
h("div",null,h("div",{style:{fontSize:9,color:K.dm,marginBottom:3}},"Target Type"),
h("select",{value:tgt.type||"",onChange:function(e){uTarget(idx,"type",e.target.value)},style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"5px 8px",color:tgt.type?K.tx:K.dm,fontSize:11,width:"100%",outline:"none"}},TARGET_TYPES.map(function(tt){return h("option",{key:tt.v,value:tt.v},tt.l)}))),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,marginBottom:3}},"Timeframe"),
h("select",{value:tgt.tf||"",onChange:function(e){uTarget(idx,"tf",e.target.value)},style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"5px 8px",color:tgt.tf?K.tx:K.dm,fontSize:11,width:"100%",outline:"none"}},TARGET_TF_LABELS.options.map(function(o){return h("option",{key:o.v,value:o.v},o.l)}))),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,marginBottom:3}},"Target $"),
h(Ip,{value:tgt.price,onChange:function(v){uTarget(idx,"price",v)},type:"number",step:"0.01",placeholder:"Target price"}))
))
}),
h("button",{onClick:addTarget,style:{width:"100%",padding:"6px",background:"transparent",border:"1px dashed "+K.cy+"44",borderRadius:6,color:K.cy,fontSize:10,cursor:"pointer",marginTop:2}},"\u2295 Add Target "+({0:"",1:"(T2 — Multi-target)",2:"(T3)"}[targets.length]||"(T"+(targets.length+1)+")")))
}()):null,

// Emotion During + After
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:8}},
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Emotion During",h(Tip,{t:"How did you feel while in the trade? Anxious/Impatient often leads to early exits. Greedy can lead to late exits."})),h(Sel,{value:t.emotionDuring,onChange:function(v){u("emotionDuring",v)},options:[{v:"",l:"--"}].concat(EMOTIONS_DURING.map(function(e){return{v:e,l:e.charAt(0).toUpperCase()+e.slice(1)}}))})),
h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Emotion After",h(Tip,{t:"How did you feel after the trade closed? Regret and revenge are the two most expensive emotions in trading."})),h(Sel,{value:t.emotionAfter,onChange:function(v){u("emotionAfter",v)},options:[{v:"",l:"--"}].concat(EMOTIONS_AFTER.map(function(e){return{v:e,l:e.charAt(0).toUpperCase()+e.slice(1)}}))})),
),

// P/L preview
pv.length?h("div",{style:{display:"flex",gap:4,marginBottom:10,padding:6,background:K.bg,borderRadius:8,flexWrap:"wrap"}},pv):null,

// === BLOCK 5: SCREENSHOTS ===
SL2("SCREENSHOTS",K.cy,"Capture both entry and exit charts. Entry screenshot = your setup at the moment you entered. Exit screenshot = chart at close."),
function(){
var img=t.screenshotData||t.screenshotUrl;
var img2=t.exitScreenshotData||t.exitScreenshotUrl;
return h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:12}},
// Entry screenshot
h("div",null,
h("div",{style:{fontSize:10,color:K.dm,marginBottom:3,fontWeight:600}},"Entry Chart",h(Tip,{t:"Screenshot of the chart at your entry point. Capture your setup as it looked when you pulled the trigger."})),
h("div",{style:{display:"flex",gap:4,marginBottom:3}},
h(Ip,{value:t.screenshotUrl,onChange:function(v){u("screenshotUrl",v)},placeholder:"Paste URL...",style:{flex:1,fontSize:11}}),
h("button",{onClick:function(){fr.current&&fr.current.click()},style:{padding:"4px 8px",background:K.cy,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer",flexShrink:0}},"Upload"),
h("input",{ref:fr,type:"file",accept:"image/*",onChange:hF,style:{display:"none"}})),
h("div",{onDrop:hD,onDragOver:function(e){e.preventDefault()},style:{border:"2px dashed "+K.bd,borderRadius:8,padding:img?4:12,textAlign:"center",color:K.dm,fontSize:10,cursor:"pointer",minHeight:img?36:60,display:"flex",alignItems:"center",justifyContent:"center",background:K.bg,position:"relative"}},
img?h("div",{style:{position:"relative",width:"100%"}},
h("img",{src:img,alt:"",onClick:function(){setLb(img)},style:{maxWidth:"100%",maxHeight:120,borderRadius:6,cursor:"zoom-in",display:"block",margin:"0 auto"}}),
h("button",{onClick:function(e){e.stopPropagation();u("screenshotUrl","");u("screenshotData","")},style:{position:"absolute",top:2,right:2,padding:"1px 5px",background:"rgba(0,0,0,.7)",border:"none",borderRadius:3,color:K.r,fontSize:9,cursor:"pointer"}},"×"))
:"Drag & drop")),
// Exit screenshot
h("div",null,
h("div",{style:{fontSize:10,color:K.dm,marginBottom:3,fontWeight:600}},"Exit Chart",h(Tip,{t:"Screenshot of the chart at your exit point. Capture what the setup looked like when you closed the trade — useful for reviewing exit quality."})),
h("div",{style:{display:"flex",gap:4,marginBottom:3}},
h(Ip,{value:t.exitScreenshotUrl,onChange:function(v){u("exitScreenshotUrl",v)},placeholder:"Paste URL...",style:{flex:1,fontSize:11}}),
h("button",{onClick:function(){fr2.current&&fr2.current.click()},style:{padding:"4px 8px",background:K.cy,border:"none",borderRadius:6,color:"#fff",fontSize:10,cursor:"pointer",flexShrink:0}},"Upload"),
h("input",{ref:fr2,type:"file",accept:"image/*",onChange:hF2,style:{display:"none"}})),
h("div",{onDrop:hD2,onDragOver:function(e){e.preventDefault()},style:{border:"2px dashed "+K.bd,borderRadius:8,padding:img2?4:12,textAlign:"center",color:K.dm,fontSize:10,cursor:"pointer",minHeight:img2?36:60,display:"flex",alignItems:"center",justifyContent:"center",background:K.bg,position:"relative"}},
img2?h("div",{style:{position:"relative",width:"100%"}},
h("img",{src:img2,alt:"",onClick:function(){setLb(img2)},style:{maxWidth:"100%",maxHeight:120,borderRadius:6,cursor:"zoom-in",display:"block",margin:"0 auto"}}),
h("button",{onClick:function(e){e.stopPropagation();u("exitScreenshotUrl","");u("exitScreenshotData","")},style:{position:"absolute",top:2,right:2,padding:"1px 5px",background:"rgba(0,0,0,.7)",border:"none",borderRadius:3,color:K.r,fontSize:9,cursor:"pointer"}},"×"))
:"Drag & drop")))
}(),

// === BLOCK 6: RULES (Full mode only) ===
!qm?h("div",null,
// UNIVERSAL: Followed Rules always visible
h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"6px 10px",background:K.bg,borderRadius:6,marginBottom:8,border:"1px solid "+K.bd}},
h("div",null,
h("span",{style:{fontSize:11,color:K.tx,fontWeight:700}},"★ Followed Rules",h(Tip,{t:"Did this trade meet your minimum entry criteria? This is the single most important metric — the cost of breaking your own rules in real dollars."})),
h("div",{style:{fontSize:9,color:K.dm,marginTop:1}},"Did this trade meet your entry rules?")),
h(YN,{v:t.followedRules,onChange:function(v){u("followedRules",v)}})),
// STRATEGY SELECTOR
h("div",{style:{marginBottom:8}},
h("div",{style:{fontSize:10,color:K.dm,fontWeight:700,marginBottom:6,display:"flex",alignItems:"center"}},"STRATEGY / SETUP RULES",
h("span",{style:{fontSize:8,color:K.dm,fontWeight:400,background:K.bg,padding:"1px 6px",borderRadius:10,border:"1px solid "+K.bd,marginLeft:6}},"optional"),
h(Tip,{t:"Optional. Select a strategy to score your setup rules. Skip entirely if you only want to log price, emotion, or notes."})),
function(){
// If a strategy is selected, show its rules
var activeBuiltin=STRATEGY_TEMPLATES.find(function(s){return s.id===t.strategyId});
var activeStrat=activeBuiltin||userStrats.find(function(s){return s.id===t.strategyId});
var allStrats=[].concat(STRATEGY_TEMPLATES.filter(function(st){return st.id==="admin_rev"||st.id==="admin_cont"})).concat(userStrats);
if(activeStrat){
var coreKeys=Object.keys(activeStrat.coreRules||{});
var addonKeys=activeStrat.addons||[];
var isDir=t.direction;
var coreRows=coreKeys.map(function(k){
var lbl=activeStrat.coreRules[k]||getIndLabel(k);
var tip=getIndTip(k);
return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 8px",background:K.bg,borderRadius:6,borderLeft:"2px solid "+K.go}},
h("span",{style:{fontSize:10,color:K.tx,lineHeight:1.3}},lbl,tip?h(Tip,{t:tip}):null),
h(YN,{v:t.rules[k]||"",onChange:function(v){uR(k,v)}}))});
var addonRows=addonKeys.map(function(k){var lbl=getIndLabel(k);var tip=getIndTip(k);return h("div",{key:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 8px",background:K.bg,borderRadius:6,borderLeft:"2px solid "+K.pu}},h("span",{style:{fontSize:10,color:K.tx}},lbl,tip?h(Tip,{t:tip}):null),h(YN,{v:t.rules[k]||"",onChange:function(v){uR(k,v)}}))});
return h("div",null,
h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6,borderBottom:"1px solid "+K.bd,paddingBottom:4}},
h("span",{style:{fontSize:10,fontWeight:700,color:K.go}},activeStrat.name+(isDir?" — "+(isDir==="L"?"Long":"Short")+" Rules":"")),
h("button",{onClick:function(){u("strategyId","")},style:{fontSize:9,color:K.dm,background:"transparent",border:"1px solid "+K.bd,borderRadius:4,padding:"2px 6px",cursor:"pointer"}},"✕ Clear")),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:3,marginBottom:8}},coreRows),
addonKeys.length?h("div",null,
h("div",{style:{fontSize:10,fontWeight:700,color:K.pu,marginBottom:4}},"Add-on Indicators"),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:3,marginBottom:8}},addonRows)):null)
}
// No strategy selected — show message + picker if strategies exist
return h("div",{style:{padding:"12px 14px",background:K.bg,borderRadius:8,border:"1px dashed "+K.bd}},
allStrats.length===0?h("div",null,
h("div",{style:{fontSize:11,fontWeight:600,color:K.tx,marginBottom:6}},"No strategies set up yet"),
h("div",{style:{fontSize:10,color:K.dm,lineHeight:1.7}},"Go to the ",h("span",{style:{color:K.cy,fontWeight:600,cursor:"pointer"},onClick:function(){setVw("strategies")}},"Strategies tab")," to choose your approach. If you haven't found your strategy yet, that's fine — use backtesting to discover what fits your personality. Every method in the library has proven successful for different types of traders."),
h("div",{style:{fontSize:10,color:K.go,marginTop:8,fontStyle:"italic"}},"You can skip this entirely and just log price, emotion, or notes.")):
h("div",null,
h("div",{style:{fontSize:10,color:K.dm,marginBottom:8,lineHeight:1.6}},"No strategy selected. Pick one to score your rules, or skip — journaling works without it."),
h("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},
allStrats.map(function(s){
var isAdmin=s.id==="admin_rev"||s.id==="admin_cont";
return h("button",{key:s.id,onClick:function(){u("strategyId",s.id)},
style:{padding:"5px 12px",borderRadius:6,border:"1px solid "+(isAdmin?K.go+"66":K.bd),fontSize:10,cursor:"pointer",
background:"transparent",color:isAdmin?K.go:K.dm,fontWeight:isAdmin?700:400}},s.name)}))));
}()),
// STOP MANAGEMENT — standalone, optional, customizable
h("div",{style:{marginBottom:8}},
h("div",{style:{fontSize:10,color:K.dm,fontWeight:700,marginBottom:4,display:"flex",alignItems:"center",gap:4}},
"STOP MANAGEMENT",
h("span",{style:{fontSize:8,color:K.dm,fontWeight:400,background:K.bg,padding:"1px 6px",borderRadius:10,border:"1px solid "+K.bd}},"optional"),
h(Tip,{t:"Track how you managed your stop. Independent of strategy. Customize these rules in ⚙ Settings."})),
stopRules.length>0?
h("div",{style:{display:"grid",gridTemplateColumns:g3,gap:4}},se):
h("div",{style:{padding:"8px 12px",background:K.bg,borderRadius:6,fontSize:10,color:K.dm,border:"1px dashed "+K.bd,display:"flex",alignItems:"center",justifyContent:"space-between"}},
"No stop rules yet.",
h("span",{style:{color:K.cy,cursor:"pointer",fontWeight:600},onClick:function(){setOpenMenu("settings")}},"Add in Settings ⚙"))),
h("div",{style:{marginBottom:10}},h("div",{style:{fontSize:10,color:K.dm,marginBottom:2}},"Notes"),h(Ip,{value:t.notes,onChange:function(v){u("notes",v)},placeholder:"Trade notes..."}))):null,
qm?h("div",{style:{marginBottom:10}},
SL2("QUICK RULES",K.go),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4}},qe)):null,
h("button",{onClick:sv,style:{width:"100%",padding:"10px",background:K.g,border:"none",borderRadius:8,color:"#000",fontSize:13,fontWeight:700,cursor:"pointer"}},"SAVE TRADE")))}
// === LOG VIEW ===
function rL(){
var rows=fl.map(function(t){var p=cPL(t),mfe=cMFE(t),dur=cDur(t),img=t.screenshotData||t.screenshotUrl,img2=t.exitScreenshotData||t.exitScreenshotUrl,w=p.pl>0;
var mi=[h("span",{key:"e"},"E:"+t.entry),h("span",{key:"x"},"X:"+t.exit),h("span",{key:"s"},"\u00d7"+t.shares)];
if(dur)mi.push(h("span",{key:"d",style:{color:K.go}},dur.l));
if(mfe&&mfe.cp!==null)mi.push(h("span",{key:"c",style:{color:mfe.cp>=.7?K.g:K.go}},(mfe.cp*100).toFixed(0)+"%"));
if(t.adxAtEntry)mi.push(h("span",{key:"a",style:{color:+t.adxAtEntry>=25?K.g:K.go}},"ADX"+t.adxAtEntry));
if(t.rsiAtEntry)mi.push(h("span",{key:"ri"},"RSI"+t.rsiAtEntry));
if(t.timeframe&&t.timeframe!=="3m")mi.push(h("span",{key:"tf",style:{color:K.pu}},t.timeframe));
if(t.followedRules==="N")mi.push(h("span",{key:"fr",style:{color:K.r,fontWeight:700}},"\u2717rules"));
if(t.excluded)mi.push(h("span",{key:"exc",style:{color:K.r,fontWeight:700,fontSize:8,padding:"1px 4px",border:"1px solid "+K.r+"55",borderRadius:3,letterSpacing:"0.5px"}},"EXCL"));
return h("div",{key:t.id,onClick:function(){oE(t)},style:{display:"flex",alignItems:"center",gap:8,padding:"10px 12px",background:t.excluded?K.r+"0a":K.cd,borderRadius:8,border:"1px solid "+K.bd,borderLeft:"3px solid "+(t.excluded?K.r+"55":w?K.g:p.pl<0?K.r:K.bd),cursor:"pointer",marginBottom:2,opacity:t.excluded?0.65:1,outline:(analysisGroup&&analysisGroup.ids&&analysisGroup.ids.has(t.id))?"2px solid "+K.cy+"88":"none",outlineOffset:"1px"}},
h("div",{style:{width:22,textAlign:"center",flexShrink:0}},h("span",{style:{fontSize:11,fontWeight:700,color:K.dm,fontFamily:"JetBrains Mono,monospace"}},t.tradeNumOfDay||"")),
h("div",{style:{display:"flex",gap:2,flexShrink:0}},
h("div",{style:{width:img2?38:48,height:36,borderRadius:4,overflow:"hidden",flexShrink:0,background:K.bg,display:"flex",alignItems:"center",justifyContent:"center"}},img?h("img",{src:img,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"},onClick:function(e){e.stopPropagation();setLb(img)}}):h("span",{style:{fontSize:7,color:K.dm}},"\u2014")),
img2?h("div",{style:{width:38,height:36,borderRadius:4,overflow:"hidden",flexShrink:0,background:K.bg,display:"flex",alignItems:"center",justifyContent:"center",borderLeft:"1px solid "+K.bd}},h("img",{src:img2,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"},onClick:function(e){e.stopPropagation();setLb(img2)}})):null),
h("div",{style:{minWidth:38,textAlign:"center"}},h("span",{style:{fontSize:14,fontWeight:700,color:t.direction==="L"?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},t.direction==="L"?"L":"S"),h("div",{style:{fontSize:9,color:K.dm}},t.type),(t.mode||"live")==="backtest"?h("div",{style:{fontSize:7,color:K.pu,fontWeight:600}},"BT"):null),
h("div",{style:{minWidth:50}},
h("div",{style:{fontSize:13,fontWeight:700,color:K.tx}},t.ticker),
h("div",{style:{fontSize:9,color:K.dm}},t.date),
function(){var s=userStrats.find(function(x){return x.id===t.strategyId});return s?h("div",{style:{fontSize:8,color:K.go,marginTop:1,maxWidth:70,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},s.name):null}()),
h("div",{style:{flex:1,display:"flex",gap:12,alignItems:"center",fontSize:12,fontFamily:"JetBrains Mono,monospace",color:K.dm,flexWrap:"wrap"}},mi),
h("div",{style:{textAlign:"right",minWidth:80}},h("div",{style:{fontSize:16,fontWeight:700,color:w?K.g:p.pl<0?K.r:K.dm,fontFamily:"JetBrains Mono,monospace"}},"$"+p.pl.toFixed(2)),h("div",{style:{fontSize:10,color:w?K.g:p.pl<0?K.r:K.dm}},p.rm.toFixed(2)+"R")),
h("div",{style:{display:"flex",flexDirection:"column",gap:2,flexShrink:0},onClick:function(e){e.stopPropagation()}},
h("button",{onClick:function(e){e.stopPropagation();dl(t.id)},style:{padding:"2px 5px",background:"transparent",border:"1px solid "+K.bd,borderRadius:3,color:K.r,fontSize:8,cursor:"pointer",lineHeight:1.2}},"✕"),
h("button",{title:t.excluded?"Re-include in analysis":"Exclude from analysis (keeps P&L)",onClick:function(e){e.stopPropagation();toggleExclude(t.id)},style:{padding:"2px 5px",background:t.excluded?K.r+"33":"transparent",border:"1px solid "+(t.excluded?K.r:K.bd),borderRadius:3,color:t.excluded?K.r:K.dm,fontSize:8,cursor:"pointer",lineHeight:1.2,fontWeight:t.excluded?700:400}},t.excluded?"EXC":"EX"),
h("button",{title:"Add/remove from analysis group",onClick:function(e){e.stopPropagation();toggleSelectForGroup(t.id)},style:{padding:"2px 5px",background:(analysisGroup&&analysisGroup.ids&&analysisGroup.ids.has(t.id))?K.cy+"33":"transparent",border:"1px solid "+((analysisGroup&&analysisGroup.ids&&analysisGroup.ids.has(t.id))?K.cy:K.bd),borderRadius:3,color:(analysisGroup&&analysisGroup.ids&&analysisGroup.ids.has(t.id))?K.cy:K.dm,fontSize:8,cursor:"pointer",lineHeight:1.2}},"SEL"))
)});
var sc=[];
if(st){sc.push(h(SC,{key:"wr",label:"Win Rate",value:(st.wr*100).toFixed(1)+"%",color:st.wr>=.5?K.g:K.r,sub:st.w+"W/"+st.l+"L"}));var totalAdj=Object.values(plAdj).reduce(function(s,a){return s+(parseFloat(a&&a.amount||0))},0);
var adjTp=st.tp+totalAdj;
sc.push(h(SC,{key:"tp",label:"Total P/L",value:"$"+adjTp.toFixed(0),color:adjTp>=0?K.g:K.r,sub:totalAdj!==0?"adj: "+(totalAdj>=0?"+":"")+totalAdj.toFixed(0):null}));sc.push(h(SC,{key:"ar",label:"Avg R",value:st.ar.toFixed(2)+"R",color:st.ar>=0?K.g:K.r}));sc.push(h(SC,{key:"pf",label:"PF",value:st.pf>=999?"\u221e":st.pf.toFixed(2),color:st.pf>=1.5?K.g:st.pf>=1?K.go:K.r}));sc.push(h(SC,{key:"aw",label:"Avg W/L",value:"$"+st.aw.toFixed(0),color:K.g,sub:"L: $"+st.al.toFixed(0)}));if(st.ad!==null)sc.push(h(SC,{key:"ad",label:"Avg Dur",value:st.ad.toFixed(0)+"m",color:K.go}));if(st.ac!==null)sc.push(h(SC,{key:"ac",label:"Capture",value:(st.ac*100).toFixed(0)+"%",color:st.ac>=.7?K.g:st.ac>=.5?K.go:K.r}))}
// Group by date
var byDate={};
fl.forEach(function(t){var d=t.date||"Unknown";if(!byDate[d])byDate[d]=[];byDate[d].push(t)});
var dateOrder=(sortBy==="date_asc")
  ?Object.keys(byDate).sort()
  :Object.keys(byDate).sort().reverse();
// Sorts that don't make sense grouped by date — render flat
var flatSorts=["trade_num_asc","trade_num_desc","pl_best","pl_worst","r_best","r_worst","wins","losses"];
var isFlat=flatSorts.indexOf(sortBy)>=0;

return h("div",null,
h("div",{style:{display:"flex",gap:6,marginBottom:8,flexWrap:"wrap",alignItems:"center"}},
h(Pl,{v:fd,onChange:sFd,options:[{v:"ALL",l:"All"},{v:"L",l:"Longs",c:K.g},{v:"S",l:"Shorts",c:K.r}]}),
h(Pl,{v:ft,onChange:sFt,options:[{v:"ALL",l:"All"},{v:"Rev",l:"Rev",c:K.cy},{v:"Cont",l:"Cont",c:K.go}]}),
tks.length>1?h("select",{value:fk,onChange:function(e){sFk(e.target.value)},style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"4px 8px",color:K.tx,fontSize:10}},[h("option",{key:"ALL",value:"ALL"},"All")].concat(tks.map(function(t){return h("option",{key:t,value:t},t)}))):null,
h("select",{value:sortBy,onChange:function(e){setSort(e.target.value)},style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"4px 8px",color:K.tx,fontSize:10}},
h("option",{value:"date_desc"},"Newest First"),
h("option",{value:"date_asc"},"Oldest First"),
h("option",{value:"trade_num_asc"},"Trade # ↑"),
h("option",{value:"trade_num_desc"},"Trade # ↓"),
h("option",{value:"time_asc"},"Time ↑"),
h("option",{value:"pl_best"},"Best P/L"),
h("option",{value:"pl_worst"},"Worst P/L"),
h("option",{value:"r_best"},"Best R"),
h("option",{value:"wins"},"Wins First"),
h("option",{value:"losses"},"Losses First"),
h("option",{value:"longs"},"Longs First"),
h("option",{value:"shorts"},"Shorts First")),
// Grouped / Flat toggle
h("div",{style:{display:"flex",gap:2,background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:2}},
h("button",{onClick:function(){setLogFlat(false)},style:{padding:"3px 8px",borderRadius:4,border:"none",fontSize:10,fontWeight:600,cursor:"pointer",background:!logFlat?K.cy:"transparent",color:!logFlat?"#fff":K.tx}},"📁 Grouped"),
h("button",{onClick:function(){setLogFlat(true)},style:{padding:"3px 8px",borderRadius:4,border:"none",fontSize:10,fontWeight:600,cursor:"pointer",background:logFlat?K.cy:"transparent",color:logFlat?"#fff":K.tx}},"☰ Flat")),
h("div",{style:{flex:1}}),
multiSelMode?h("span",{style:{fontSize:10,color:K.cy,fontWeight:600}},multiSelIds.size+" selected"):h("span",{style:{fontSize:10,color:K.dm}},fl.length+" trades"),
h("button",{onClick:function(){setMultiSelMode(function(p){if(p){clearMultiSel()}else{return true}});},style:{padding:"3px 8px",borderRadius:4,border:"1px solid "+(multiSelMode?K.cy:K.bd),fontSize:10,fontWeight:600,cursor:"pointer",background:multiSelMode?K.cy+"22":"transparent",color:multiSelMode?K.cy:K.dm}},multiSelMode?"✓ Done":"Select")),
sc.length?h("div",{style:{display:"flex",gap:5,marginBottom:10,flexWrap:"wrap"}},sc):null,
!fl.length?h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"No trades yet."):null,
// Trade row renderer — shared between flat and grouped
h("div",{style:{display:"flex",flexDirection:"column",gap:4}},
logFlat?fl.map(function(t){
var p=cPL(t),mfe=cMFE(t),dur=cDur(t),img=t.screenshotData||t.screenshotUrl,img2=t.exitScreenshotData||t.exitScreenshotUrl,w=p.pl>0;
var mi=[h("span",{key:"e"},"E:"+t.entry),h("span",{key:"x"},"X:"+t.exit),h("span",{key:"s"},"×"+t.shares)];
if(dur)mi.push(h("span",{key:"d",style:{color:K.go}},dur.l));
if(mfe&&mfe.cp!==null)mi.push(h("span",{key:"c",style:{color:mfe.cp>=.7?K.g:K.go}},(mfe.cp*100).toFixed(0)+"%"));
if(t.adxAtEntry)mi.push(h("span",{key:"a",style:{color:+t.adxAtEntry>=25?K.g:K.go}},"ADX"+t.adxAtEntry));
if(t.rsiAtEntry)mi.push(h("span",{key:"ri"},"RSI"+t.rsiAtEntry));
if(t.timeframe&&t.timeframe!=="3m")mi.push(h("span",{key:"tf",style:{color:K.pu}},t.timeframe));
if(t.followedRules==="N")mi.push(h("span",{key:"fr",style:{color:K.r,fontWeight:700}},"✗rules"));
return h("div",{key:t.id,onClick:function(){oE(t)},style:{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:K.cd,borderRadius:6,border:"1px solid "+K.bd,borderLeft:"3px solid "+(w?K.g:p.pl<0?K.r:K.bd),cursor:"pointer",boxShadow:K.sdw}},
h("div",{style:{width:22,textAlign:"center",flexShrink:0}},h("span",{style:{fontSize:11,fontWeight:700,color:K.dm,fontFamily:"JetBrains Mono,monospace"}},t.tradeNumOfDay||"")),
h("div",{style:{display:"flex",gap:2,flexShrink:0}},
h("div",{style:{width:img2?34:42,height:32,borderRadius:4,overflow:"hidden",flexShrink:0,background:K.bg,display:"flex",alignItems:"center",justifyContent:"center"}},img?h("img",{src:img,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"},onClick:function(e){e.stopPropagation();setLb(img)}}):h("span",{style:{fontSize:7,color:K.dm}},"—")),
img2?h("div",{style:{width:34,height:32,borderRadius:4,overflow:"hidden",flexShrink:0,background:K.bg,display:"flex",alignItems:"center",justifyContent:"center",borderLeft:"1px solid "+K.bd}},h("img",{src:img2,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"},onClick:function(e){e.stopPropagation();setLb(img2)}})):null),
h("div",{style:{flex:1,minWidth:0}},
h("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:3}},
h("span",{style:{fontSize:11,fontWeight:700,color:t.direction==="L"?K.g:K.r}},t.direction==="L"?"L":"S"),
h("span",{style:{fontSize:11,color:K.dm}},t.ticker),
h("span",{style:{fontSize:10,color:K.dm}},t.date+(t.time?" "+t.time:"")),
t.mode==="backtest"?h("span",{style:{fontSize:8,color:K.pu,fontWeight:700,background:K.pu+"22",padding:"1px 5px",borderRadius:3}},"BT"):null),
h("div",{style:{display:"flex",gap:6,flexWrap:"wrap",fontSize:10,color:K.dm,fontFamily:"JetBrains Mono,monospace"}},mi)),
h("div",{style:{textAlign:"right",flexShrink:0}},
h("div",{style:{fontSize:14,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:w?K.g:p.pl<0?K.r:K.dm}},(p.pl>=0?"+$":"-$")+Math.abs(p.pl).toFixed(2)),
p.rm!=null?h("div",{style:{fontSize:10,color:p.rm>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(p.rm>=0?"+":"")+p.rm.toFixed(2)+"R"):h("span",{style:{fontSize:10,color:K.dm,fontFamily:"JetBrains Mono,monospace"}},"— R",h(Tip,{t:"Enter a Stop price to calculate R-multiple"}))));
}):dateOrder.map(function(date){
var dayTrades=byDate[date];
var cp2=dayTrades.filter(function(t){return t.entry&&t.exit&&t.shares});
var dayPL=cp2.reduce(function(s,t){return s+cPL(t).pl},0);
var adjAmt=parseFloat(plAdj[date]&&plAdj[date].amount||0);
var adjPL=dayPL+adjAmt;
var dayW=cp2.filter(function(t){return cPL(t).pl>0}).length;
var isOpen=!logExpandState||logExpandState[date]!==false;
var weekday=new Date(date+"T12:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});
var sortedDay=dayTrades.slice().sort(function(a,b){
if(sortBy==="pl_best")return cPL(b).pl-cPL(a).pl;
if(sortBy==="pl_worst")return cPL(a).pl-cPL(b).pl;
if(sortBy==="r_best")return cPL(b).rm-cPL(a).rm;
if(sortBy==="wins"){var wa=cPL(a).pl>0?0:1,wb=cPL(b).pl>0?0:1;return wa-wb}
if(sortBy==="losses"){var la=cPL(a).pl<0?0:1,lb=cPL(b).pl<0?0:1;return la-lb}
if(sortBy==="trade_num_asc")return(+a.tradeNumOfDay||0)-(+b.tradeNumOfDay||0);
if(sortBy==="trade_num_desc")return(+b.tradeNumOfDay||0)-(+a.tradeNumOfDay||0);
if(sortBy==="longs")return(a.direction==="L"?0:1)-(b.direction==="L"?0:1);
if(sortBy==="shorts")return(a.direction==="S"?0:1)-(b.direction==="S"?0:1);
return(a.time||"").localeCompare(b.time||"")});
return h("div",{key:date,style:{borderRadius:8,border:"1px solid "+(dayTags[date]==="good"?K.g+"55":dayTags[date]==="bad"?K.r+"55":adjPL>0?K.g+"33":adjPL<0?K.r+"33":K.bd),overflow:"hidden",borderLeft:"3px solid "+(dayTags[date]==="good"?K.g:dayTags[date]==="bad"?K.r:"transparent"),boxShadow:K.sdw}},
h("div",{style:{display:"flex",alignItems:"center",gap:10,padding:"8px 12px",background:K.cd,cursor:"pointer",userSelect:"none"},
onClick:function(){setLogExpandState(function(p){var n=Object.assign({},p);n[date]=!isOpen;return n})}},
h("div",{style:{flex:1,display:"flex",alignItems:"center",gap:10}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx}},weekday),
h("div",{style:{fontSize:10,color:K.dm}},dayTrades.length+"tr"+(cp2.length?" · "+dayW+"/"+cp2.length+" W":"")),
adjAmt!==0?h("div",{style:{fontSize:9,color:K.go,fontStyle:"italic"}},"adj "+(adjAmt>=0?"+":"")+adjAmt.toFixed(0)):null),
cp2.length>0?h("div",{style:{fontSize:13,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:adjPL>=0?K.g:K.r}},(adjPL>=0?"+$":"-$")+Math.abs(adjPL).toFixed(2)):null,
h("div",{style:{display:"flex",gap:2,flexShrink:0},onClick:function(e){e.stopPropagation()}},
multiSelMode?h("button",{title:"Select all trades this day",onClick:function(e){e.stopPropagation();selectDay(date,fl)},style:{padding:"2px 7px",borderRadius:4,fontSize:9,fontWeight:700,cursor:"pointer",background:K.cy+"22",border:"1px solid "+K.cy,color:K.cy}},"All"):null,
multiSelMode?null:h("div",{style:{display:"flex",alignItems:"center",gap:1,marginRight:4}},
  dayCharts[date]
    ?h("button",{title:"View daily chart",onClick:function(e){e.stopPropagation();setLb(dayCharts[date])},style:{padding:"2px 8px",borderRadius:4,fontSize:11,cursor:"pointer",background:K.cy+"22",border:"1px solid "+K.cy,color:K.cy,fontWeight:700}},"📊")
    :h("button",{title:"Add daily chart — click to upload or paste URL",onClick:function(e){e.stopPropagation();setChartUrlModal(date);setChartUrlInput("");},style:{padding:"2px 8px",borderRadius:4,fontSize:11,cursor:"pointer",background:"transparent",border:"1px dashed "+K.bd,color:K.dm,fontWeight:400}},"📊"),
  dayCharts[date]?h("button",{title:"Remove daily chart",onClick:function(e){e.stopPropagation();setDayChart(date,null)},style:{padding:"1px 4px",borderRadius:3,fontSize:9,cursor:"pointer",background:"transparent",border:"none",color:K.dm,lineHeight:1}},"✕"):null),
multiSelMode?null:h("button",{title:"Daily journal / notes",onClick:function(e){e.stopPropagation();setDjModal(date);setDjText(dayJournal[date]&&dayJournal[date].log||"");},style:{padding:"2px 7px",borderRadius:4,fontSize:9,fontWeight:700,cursor:"pointer",background:dayJournal[date]&&dayJournal[date].log?K.go+"33":"transparent",border:"1px solid "+(dayJournal[date]&&dayJournal[date].log?K.go:K.bd),color:dayJournal[date]&&dayJournal[date].log?K.go:K.dm}},"J"),
multiSelMode?null:h("button",{title:"Tag as Good Day",onClick:function(e){e.stopPropagation();setDayTag(date,"good")},style:{padding:"2px 7px",borderRadius:4,fontSize:9,fontWeight:700,cursor:"pointer",background:dayTags[date]==="good"?K.g+"33":"transparent",border:"1px solid "+(dayTags[date]==="good"?K.g:K.bd),color:dayTags[date]==="good"?K.g:K.dm}},"G"),
multiSelMode?null:h("button",{title:"Tag as Bad Day",onClick:function(e){e.stopPropagation();setDayTag(date,"bad")},style:{padding:"2px 7px",borderRadius:4,fontSize:9,fontWeight:700,cursor:"pointer",background:dayTags[date]==="bad"?K.r+"33":"transparent",border:"1px solid "+(dayTags[date]==="bad"?K.r:K.bd),color:dayTags[date]==="bad"?K.r:K.dm}},"B"),
multiSelMode?null:h("button",{title:"Untag this day",onClick:function(e){e.stopPropagation();setDayTag(date,null)},style:{padding:"2px 7px",borderRadius:4,fontSize:9,fontWeight:700,cursor:"pointer",background:!dayTags[date]?K.dm+"22":"transparent",border:"1px solid "+(!dayTags[date]?K.dm:K.bd),color:K.dm}},"—"),
multiSelMode?null:h("button",{title:"Delete entire day",onClick:function(e){e.stopPropagation();if(confirm("Delete all "+dayTrades.length+" trades on "+date+"?")){setTr(function(p){return p.filter(function(t){return t.date!==date})})}},style:{padding:"2px 7px",borderRadius:4,fontSize:9,fontWeight:700,cursor:"pointer",background:"transparent",border:"1px solid "+K.r+"55",color:K.r}},"🗑")),
h("div",{style:{fontSize:10,color:K.dm,marginLeft:4}},isOpen?"▲":"▼")),
isOpen?h("div",{style:{display:"flex",flexDirection:"column",gap:2,padding:"4px 4px"}},
sortedDay.map(function(t){
var p=cPL(t),mfe=cMFE(t),dur=cDur(t),img=t.screenshotData||t.screenshotUrl,img2=t.exitScreenshotData||t.exitScreenshotUrl,w=p.pl>0;
var isSel=multiSelIds.has(t.id);
var mi=[h("span",{key:"e"},"E:"+t.entry),h("span",{key:"x"},"X:"+t.exit),h("span",{key:"s"},"×"+t.shares)];
if(dur)mi.push(h("span",{key:"d",style:{color:K.go}},dur.l));
if(mfe&&mfe.cp!==null)mi.push(h("span",{key:"c",style:{color:mfe.cp>=.7?K.g:K.go}},(mfe.cp*100).toFixed(0)+"%"));
if(t.adxAtEntry)mi.push(h("span",{key:"a",style:{color:+t.adxAtEntry>=25?K.g:K.go}},"ADX"+t.adxAtEntry));
if(t.rsiAtEntry)mi.push(h("span",{key:"ri"},"RSI"+t.rsiAtEntry));
if(t.timeframe&&t.timeframe!=="3m")mi.push(h("span",{key:"tf",style:{color:K.pu}},t.timeframe));
if(t.followedRules==="N")mi.push(h("span",{key:"fr",style:{color:K.r,fontWeight:700}},"✗rules"));
if(t.excluded)mi.push(h("span",{key:"exc",style:{color:K.r,fontWeight:700,fontSize:8,padding:"1px 4px",border:"1px solid "+K.r+"55",borderRadius:3,letterSpacing:"0.5px"}},"EXCL"));
return h("div",{key:t.id,onClick:function(){multiSelMode?toggleMultiSel(t.id):oE(t)},style:{display:"flex",alignItems:"center",gap:8,padding:"8px 10px",background:isSel?K.cy+"15":t.excluded?K.r+"0a":K.cd,borderRadius:6,border:"1px solid "+K.bd,borderLeft:"3px solid "+(isSel?K.cy:t.excluded?K.r+"55":w?K.g:p.pl<0?K.r:K.bd),cursor:"pointer",opacity:t.excluded?0.65:1,outline:(analysisGroup&&analysisGroup.ids&&analysisGroup.ids.has(t.id))?"2px solid "+K.cy+"88":"none",outlineOffset:"1px",boxShadow:K.sdw}},
multiSelMode?h("div",{style:{width:16,height:16,borderRadius:3,border:"2px solid "+(isSel?K.cy:K.bd),background:isSel?K.cy:"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}},isSel?h("span",{style:{fontSize:9,color:"#000",fontWeight:700,lineHeight:1}},"✓"):null):null,
h("div",{style:{width:20,textAlign:"center",flexShrink:0}},h("span",{style:{fontSize:11,fontWeight:700,color:K.dm,fontFamily:"JetBrains Mono,monospace"}},t.tradeNumOfDay||"")),
h("div",{style:{display:"flex",gap:2,flexShrink:0}},
h("div",{style:{width:img2?34:42,height:32,borderRadius:4,overflow:"hidden",flexShrink:0,background:K.cd,display:"flex",alignItems:"center",justifyContent:"center"}},img?h("img",{src:img,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"},onClick:function(e){e.stopPropagation();setLb(img)}}):h("span",{style:{fontSize:7,color:K.dm}},"—")),
img2?h("div",{style:{width:34,height:32,borderRadius:4,overflow:"hidden",flexShrink:0,background:K.cd,display:"flex",alignItems:"center",justifyContent:"center",borderLeft:"1px solid "+K.bd}},h("img",{src:img2,alt:"",style:{width:"100%",height:"100%",objectFit:"cover"},onClick:function(e){e.stopPropagation();setLb(img2)}})):null),
h("div",{style:{minWidth:32,textAlign:"center"}},h("span",{style:{fontSize:13,fontWeight:700,color:t.direction==="L"?K.g:K.r}},(t.direction==="L"?"L":"S")),h("div",{style:{fontSize:9,color:K.dm}},t.type),(t.mode||"live")==="backtest"?h("div",{style:{fontSize:7,color:K.pu,fontWeight:600}},"BT"):null),
h("div",{style:{minWidth:45}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx}},t.ticker),
function(){var s=userStrats.find(function(x){return x.id===t.strategyId})||STRATEGY_TEMPLATES.find(function(x){return x.id===t.strategyId});return s?h("div",{style:{fontSize:8,color:K.go,maxWidth:60,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},s.name):null}()),
h("div",{style:{flex:1,display:"flex",gap:10,alignItems:"center",fontSize:11,fontFamily:"JetBrains Mono,monospace",color:K.dm,flexWrap:"wrap"}},mi),
h("div",{style:{textAlign:"right",minWidth:72}},h("div",{style:{fontSize:14,fontWeight:700,color:w?K.g:p.pl<0?K.r:K.dm,fontFamily:"JetBrains Mono,monospace"}},"$"+p.pl.toFixed(2)),h("div",{style:{fontSize:10,color:w?K.g:p.pl<0?K.r:K.dm}},p.rm.toFixed(2)+"R")),
h("div",{style:{display:"flex",flexDirection:"column",gap:2,flexShrink:0},onClick:function(e){e.stopPropagation()}},
h("button",{onClick:function(e){e.stopPropagation();dl(t.id)},style:{padding:"2px 5px",background:"transparent",border:"1px solid "+K.bd,borderRadius:3,color:K.r,fontSize:8,cursor:"pointer",lineHeight:1.2}},"✕"),
h("button",{title:t.excluded?"Re-include in analysis":"Exclude from analysis (keeps P&L)",onClick:function(e){e.stopPropagation();toggleExclude(t.id)},style:{padding:"2px 5px",background:t.excluded?K.r+"33":"transparent",border:"1px solid "+(t.excluded?K.r:K.bd),borderRadius:3,color:t.excluded?K.r:K.dm,fontSize:8,cursor:"pointer",lineHeight:1.2,fontWeight:t.excluded?700:400}},t.excluded?"EXC":"EX"),
h("button",{title:"Add/remove from analysis group",onClick:function(e){e.stopPropagation();toggleSelectForGroup(t.id)},style:{padding:"2px 5px",background:(analysisGroup&&analysisGroup.ids&&analysisGroup.ids.has(t.id))?K.cy+"33":"transparent",border:"1px solid "+((analysisGroup&&analysisGroup.ids&&analysisGroup.ids.has(t.id))?K.cy:K.bd),borderRadius:3,color:(analysisGroup&&analysisGroup.ids&&analysisGroup.ids.has(t.id))?K.cy:K.dm,fontSize:8,cursor:"pointer",lineHeight:1.2}},"SEL"))
)})):null)
})))}
// === RULES VIEW ===
function rR(){
var d=ra;

// ── Analysis Group Banner ──
var groupBanner=analysisGroup?h("div",{style:{
  display:"flex",alignItems:"center",gap:10,padding:"10px 14px",
  background:K.cy+"11",border:"1px solid "+K.cy+"44",
  borderRadius:8,marginBottom:14
}},
h("div",{style:{flex:1}},
  h("div",{style:{fontSize:11,fontWeight:700,color:K.cy,marginBottom:2}},"📊 Analysis Scope: "+analysisGroup.label),
  h("div",{style:{fontSize:10,color:K.dm}},"Rules, combos, and all insights are calculated using only these trades. P&L and equity are unaffected.")),
h("button",{onClick:function(){setAnalysisGroup(null)},style:{
  padding:"4px 12px",borderRadius:6,border:"1px solid "+K.cy+"66",
  background:"transparent",color:K.cy,fontSize:10,fontWeight:700,cursor:"pointer"
}},"✕ Clear — Analyze All")):null;

if(!d.yn.length&&!d.num.length)return h("div",null,
  groupBanner,
  h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"Log trades with rules to see analysis."));
function bkRow(b,i){return h("div",{key:i,style:{flex:1,minWidth:100,padding:6,background:K.bg,borderRadius:6}},h("div",{style:{fontSize:9,fontWeight:600,color:K.tx,marginBottom:3}},b.l),h("div",{style:{fontSize:10,color:K.dm}},b.s.n+"tr ",h("span",{style:{color:b.s.wr>=.5?K.g:K.r,fontWeight:600}},(b.s.wr*100).toFixed(0)+"%")," ",h("span",{style:{color:b.s.ar>=0?K.g:K.r}},b.s.ar.toFixed(2)+"R")," ",h("span",{style:{color:b.s.ap>=0?K.g:K.r}},"$"+b.s.ap.toFixed(0))),h(Bar,{pct:b.s.wr*100,color:b.s.wr>=.5?K.g:K.r}))}
var sections=[];
// Group banner always first if active
if(groupBanner)sections.push(h("div",{key:"groupbanner"},groupBanner));
// Excluded trade count note
var excCount=mf.filter(function(t){return t.excluded}).length;
if(excCount>0)sections.push(h("div",{key:"excnote",style:{
  display:"flex",alignItems:"center",gap:8,padding:"8px 12px",
  background:K.r+"0d",border:"1px solid "+K.r+"33",borderRadius:6,marginBottom:10,fontSize:10
}},
h("span",{style:{color:K.r,fontWeight:700}},excCount+" trade"+(excCount>1?"s":"")+" excluded from analysis"),
h("span",{style:{color:K.dm}},"(earnings unaffected — go to Log to manage)"))
);
// Rule Donut Grid at top
if(cp.length>=5)sections.push(h(RuleDonutGrid,{key:"donuts",yn:d.yn,cp:cp}));
// Y/N Rules
sections.push(h("div",{key:"yn",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:8}},"RULE EDGE ANALYSIS",h(Tip,{t:"Compares win rate when each rule is marked Y vs N. Edge % shows the difference. Higher = that rule matters more for your setups."})),d.yn.map(function(r){var ep=(r.edge*100).toFixed(1);
return h("div",{key:r.key,style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"8px 12px",marginBottom:4}},h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}},h("span",{style:{fontSize:11,fontWeight:600,color:K.tx}},r.label),h("span",{style:{fontSize:14,fontWeight:700,color:r.edge>.05?K.g:r.edge<-.05?K.r:K.dm,fontFamily:"JetBrains Mono,monospace"}},(r.edge>0?"+":"")+ep+"%")),h("div",{style:{display:"flex",gap:12,fontSize:9}},h("div",{style:{flex:1}},h("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:2}},h("span",{style:{color:K.g}},"Y:"+r.w.n),h("span",{style:{color:K.g,fontFamily:"JetBrains Mono,monospace"}},(r.w.wr*100).toFixed(0)+"% "+r.w.ar.toFixed(2)+"R $"+r.w.ap.toFixed(0))),h(Bar,{pct:r.w.wr*100,color:K.g})),h("div",{style:{flex:1}},h("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:2}},h("span",{style:{color:K.r}},"N:"+r.wo.n),h("span",{style:{color:K.r,fontFamily:"JetBrains Mono,monospace"}},(r.wo.wr*100).toFixed(0)+"% "+r.wo.ar.toFixed(2)+"R $"+r.wo.ap.toFixed(0))),h(Bar,{pct:r.wo.wr*100,color:K.r}))))})));
// Numeric buckets
if(d.num.length)sections.push(h("div",{key:"num",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.pu,fontWeight:700,marginBottom:8}},"BUCKET ANALYSIS",h(Tip,{t:"Groups trades by numeric ranges (ADX, RSI, duration, etc) and shows performance for each bucket. Helps identify optimal conditions for your trades."})),d.num.map(function(n,ni){return h("div",{key:ni,style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"10px 12px",marginBottom:4}},h("div",{style:{fontSize:11,fontWeight:600,color:K.tx,marginBottom:6}},n.label),h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},n.bk.map(bkRow)))})));
// Combo Analysis
if(d.combos.length)sections.push(h("div",{key:"combo",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.cy,fontWeight:700,marginBottom:8}},"TOP SETUP COMBOS",h(TierBadge,{tier:"t1"}),h(Tip,{t:"Ranks 2, 3, 4, and 5 rule combinations by win rate and R. These are your best setups \u2014 the specific combos that produce the highest edge when present together. Higher rule counts require more trades to activate."})),d.combos.slice(0,15).map(function(c,i){return h("div",{key:i,style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 10px",background:K.cd,borderRadius:6,border:"1px solid "+K.bd,marginBottom:3}},h("div",{style:{flex:1}},h("span",{style:{fontSize:9,padding:"1px 5px",borderRadius:3,background:c.count===2?K.bd:c.count===3?K.pu:c.count===4?K.go:K.cy,color:"#fff",fontWeight:700,marginRight:6}},c.count+"R"),h("span",{style:{fontSize:10,color:K.tx}},c.rules.join(" + ")),h("span",{style:{fontSize:10,color:K.dm,marginLeft:6}},c.stats.n+" trades")),h("div",{style:{display:"flex",gap:10,fontFamily:"JetBrains Mono,monospace",fontSize:11}},h("span",{style:{color:c.stats.wr>=.6?K.g:c.stats.wr>=.45?K.go:K.r,fontWeight:700}},(c.stats.wr*100).toFixed(0)+"%"),h("span",{style:{color:c.stats.ar>=0?K.g:K.r}},c.stats.ar.toFixed(2)+"R"),h("span",{style:{color:c.stats.ap>=0?K.g:K.r}},"$"+c.stats.ap.toFixed(0))))})));
// Min Rule Count
if(d.minRule.length>1)sections.push(h("div",{key:"minr",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:8}},"MIN RULE COUNT THRESHOLD",h(Tip,{t:"Shows performance at each minimum rule count. Use this to set your 'don\u2019t trade' threshold \u2014 e.g. if 4+ rules = 70% WR but 2 rules = 35%, stop taking trades under 4 rules."})),h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},d.minRule.map(function(m){return h("div",{key:m.min,style:{flex:1,minWidth:80,padding:8,background:K.cd,borderRadius:8,border:"1px solid "+K.bd,textAlign:"center"}},h("div",{style:{fontSize:10,color:K.dm}},m.min+"+ rules"),h("div",{style:{fontSize:14,fontWeight:700,color:m.stats.wr>=.6?K.g:m.stats.wr>=.45?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},(m.stats.wr*100).toFixed(0)+"%"),h("div",{style:{fontSize:10,color:K.dm}},m.stats.n+"tr "+m.stats.ar.toFixed(2)+"R"),h(Bar,{pct:m.stats.wr*100,color:m.stats.wr>=.5?K.g:K.r}))}))));
// Correlation
if(d.corr.length)sections.push(h("div",{key:"corr",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.dm,fontWeight:700,marginBottom:8}},"RULE CORRELATION",h(TierBadge,{tier:"t1"}),h(Tip,{t:"Shows which rules fire together most often. High overlap (red) = redundant signals, essentially the same edge. Low overlap (green) = independent edges that stack."})),d.corr.slice(0,8).map(function(c,i){return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:8,padding:"4px 10px",background:K.cd,borderRadius:6,marginBottom:2,fontSize:10}},h("span",{style:{flex:1,color:K.tx}},c.a+" \u2194 "+c.b),h("span",{style:{color:c.overlap>.7?K.r:c.overlap>.4?K.go:K.g,fontFamily:"JetBrains Mono,monospace",fontWeight:600}},(c.overlap*100).toFixed(0)+"% overlap"),h("span",{style:{color:K.dm}},c.bothN+" both Y"))})));
// Conditional Edge
if(d.cond.length)sections.push(h("div",{key:"cond",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.cy,fontWeight:700,marginBottom:8}},"CONDITIONAL EDGE",h(TierBadge,{tier:"t1"}),h(Tip,{t:"Shows the incremental value of adding one rule when another is already present. Answers: 'Given I have Rule A, does adding Rule B actually improve my results?'"})),d.cond.slice(0,8).map(function(c,i){return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:6,padding:"4px 10px",background:K.cd,borderRadius:6,marginBottom:2,fontSize:10}},h("span",{style:{flex:1,color:K.tx}},"When ",h("span",{style:{color:K.go}},c.base)," \u2192 adding ",h("span",{style:{color:K.cy}},c.add)),h("span",{style:{color:c.incr>.05?K.g:c.incr<-.05?K.r:K.dm,fontFamily:"JetBrains Mono,monospace",fontWeight:700}},(c.incr>0?"+":"")+(c.incr*100).toFixed(0)+"% WR"))})));
// Entry Quality Scores
if(d.scores.length)sections.push(h("div",{key:"score",style:{marginBottom:14}},h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:4}},"ENTRY QUALITY SCORES",h(TierBadge,{tier:"t2"}),h(Tip,{t:"Each trade scored 0-100 based on which rules were present, weighted by each rule\u2019s independent edge. Compare scores to outcomes \u2014 high scores should produce better results over time."})),h("div",{style:{fontSize:10,color:K.dm,marginBottom:8}},"Score vs actual P/L and R-multiple."),h("div",{style:{display:"flex",flexDirection:"column",gap:2}},d.scores.slice(0,15).map(function(s){return h("div",{key:s.id,style:{display:"flex",alignItems:"center",gap:8,padding:"3px 8px",background:K.cd,borderRadius:4,fontSize:10}},h("div",{style:{width:40,fontWeight:700,color:s.score>=70?K.g:s.score>=45?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},s.score),h("div",{style:{flex:1,height:6,background:K.bg,borderRadius:3,overflow:"hidden"}},h("div",{style:{width:s.score+"%",height:"100%",background:s.score>=70?K.g:s.score>=45?K.go:K.r,borderRadius:3}})),h("span",{style:{color:K.dm,width:50}},s.date.slice(5)),h("span",{style:{color:s.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace",width:60,textAlign:"right"}},"$"+s.pl.toFixed(0)+" "+s.rm.toFixed(1)+"R"))}))));

// === EDGE DECAY ===
if(d.decay&&d.decay.length)sections.push(h("div",{key:"decay",style:{marginBottom:14}},
h("div",{style:{fontSize:12,color:K.r,fontWeight:700,marginBottom:4,display:"flex",alignItems:"center"}},"EDGE DECAY MONITOR",h(TierBadge,{tier:"t1"}),h(Tip,{t:"Shows all-time vs last 20 vs last 10 trades for each rule and top combo. When recent performance drops significantly below all-time, your edge is degrading. Act before you give back profits."})),
d.decay.some(function(x){return x.decaying})?h("div",{style:{padding:"8px 12px",background:K.r+"18",border:"1px solid "+K.r+"44",borderRadius:8,marginBottom:10,fontSize:11,color:K.r,fontWeight:600}},"\u26a0 Edge decay detected — review flagged rules below"):null,
h("div",{style:{display:"flex",flexDirection:"column",gap:4}},
d.decay.map(function(r,i){
var hasRecent=r.last10||r.last20;
var flag=r.decaying;
return h("div",{key:i,style:{background:K.cd,borderRadius:8,border:"1px solid "+(flag?K.r+"66":K.bd),padding:"8px 12px"}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}},
h("div",{style:{display:"flex",alignItems:"center",gap:6}},
flag?h("span",{style:{fontSize:9,padding:"1px 5px",borderRadius:3,background:K.r+"33",color:K.r,fontWeight:700}},"\u25bc DECAY"):h("span",{style:{fontSize:9,padding:"1px 5px",borderRadius:3,background:K.g+"22",color:K.g,fontWeight:700}},"\u2713 STABLE"),
h("span",{style:{fontSize:11,fontWeight:600,color:K.tx,marginLeft:4}},r.label),
r.isCombo?h("span",{style:{fontSize:8,color:K.pu,marginLeft:4}},"COMBO"):null),
h("span",{style:{fontSize:10,color:K.dm}},r.allN+" total trades")),
h("div",{style:{display:"flex",gap:8}},
h("div",{style:{flex:1,textAlign:"center",padding:"4px 6px",background:K.bg,borderRadius:6}},
h("div",{style:{fontSize:9,color:K.dm,marginBottom:2}},"All-Time"),
h("div",{style:{fontSize:14,fontWeight:700,color:r.allTime.wr>=.5?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(r.allTime.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:9,color:K.dm}},r.allTime.ar.toFixed(2)+"R"),
h(Bar,{pct:r.allTime.wr*100,color:r.allTime.wr>=.5?K.g:K.r})),
r.last20?h("div",{style:{flex:1,textAlign:"center",padding:"4px 6px",background:K.bg,borderRadius:6}},
h("div",{style:{fontSize:9,color:K.dm,marginBottom:2}},"Last 20"),
h("div",{style:{fontSize:14,fontWeight:700,color:r.last20.wr<r.allTime.wr-0.10?K.r:r.last20.wr>=.5?K.g:K.go,fontFamily:"JetBrains Mono,monospace"}},(r.last20.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:9,color:K.dm}},r.last20.ar.toFixed(2)+"R"),
h(Bar,{pct:r.last20.wr*100,color:r.last20.wr>=.5?K.g:K.go})):null,
r.last10?h("div",{style:{flex:1,textAlign:"center",padding:"4px 6px",background:K.bg,borderRadius:6}},
h("div",{style:{fontSize:9,color:K.dm,marginBottom:2}},"Last 10"),
h("div",{style:{fontSize:14,fontWeight:700,color:r.last10.wr<r.allTime.wr-0.15?K.r:r.last10.wr>=.5?K.g:K.go,fontFamily:"JetBrains Mono,monospace"}},(r.last10.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:9,color:K.dm}},r.last10.ar.toFixed(2)+"R"),
h(Bar,{pct:r.last10.wr*100,color:r.last10.wr>=.5?K.g:K.r})):h("div",{style:{flex:1,textAlign:"center",padding:"4px 6px",background:K.bg,borderRadius:6,opacity:.4}},
h("div",{style:{fontSize:9,color:K.dm}}),"Last 10",h("div",{style:{fontSize:10,color:K.dm,marginTop:4}},"Need 2+ trades"))
))}))));

// === EXIT PLANNING ANALYSIS ===
if(d.exitAnalysis&&(d.exitAnalysis.targetTypes.length||d.exitAnalysis.captureAnalysis)){
var ea=d.exitAnalysis;
sections.push(h("div",{key:"exit",style:{marginBottom:14}},
h("div",{style:{fontSize:12,color:K.cy,fontWeight:700,marginBottom:4,display:"flex",alignItems:"center"}},"EXIT PLANNING ANALYSIS",h(Tip,{t:"Analyzes your planned targets vs actual outcomes. Shows which target types you hit most reliably, your average capture rate, and how much you typically leave on the table post-exit."})),
// Capture stats
ea.captureAnalysis?h("div",{style:{display:"flex",gap:6,marginBottom:10,flexWrap:"wrap"}},
h(SC,{label:"Avg Capture",value:(ea.captureAnalysis.avg*100).toFixed(0)+"%",color:ea.captureAnalysis.avg>=.7?K.g:ea.captureAnalysis.avg>=.5?K.go:K.r,sub:ea.captureAnalysis.count+" trades"}),
h(SC,{label:"70%+ Cap",value:(ea.captureAnalysis.pct70plus*100).toFixed(0)+"%",color:ea.captureAnalysis.pct70plus>=.5?K.g:K.go,sub:"hit 70%+ MFE"}),
h(SC,{label:"Sub-50% Cap",value:(ea.captureAnalysis.pct50minus*100).toFixed(0)+"%",color:ea.captureAnalysis.pct50minus>=.4?K.r:K.go,sub:"exited early"}),
ea.leftOnTable?h(SC,{label:"Left On Table",value:ea.leftOnTable.avgLeftR.toFixed(2)+"R avg",color:K.r,sub:(ea.leftOnTable.avgLeftPct*100).toFixed(0)+"% of move"}):null):null,
// Target type hit rates
ea.targetTypes.length?h("div",{style:{marginBottom:10}},
h("div",{style:{fontSize:11,color:K.dm,fontWeight:600,marginBottom:6}},"TARGET TYPE HIT RATE",h(Tip,{t:"Which target types you actually hit vs miss. High hit rate = this level is a reliable exit point for your setups."})),
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},ea.targetTypes.map(function(tt,i){
return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:8,padding:"5px 10px",background:K.cd,borderRadius:6,border:"1px solid "+K.bd}},
h("div",{style:{flex:1,fontSize:11,color:K.tx}},tt.label),
h("div",{style:{display:"flex",gap:10,alignItems:"center",fontFamily:"JetBrains Mono,monospace",fontSize:10}},
h("span",{style:{color:K.dm}},tt.total+"×"),
h("span",{style:{fontWeight:700,color:tt.hitRate>=.65?K.g:tt.hitRate>=.45?K.go:K.r}},(tt.hitRate*100).toFixed(0)+"% hit"),
tt.avgRHit!==null?h("span",{style:{color:K.g}},tt.avgRHit.toFixed(2)+"R (hit)"):null,
tt.avgRMiss!==null?h("span",{style:{color:K.r}},tt.avgRMiss.toFixed(2)+"R (miss)"):null),
h("div",{style:{width:80,height:5,background:K.bg,borderRadius:3,overflow:"hidden"}},
h("div",{style:{width:(tt.hitRate*100)+"%",height:"100%",background:tt.hitRate>=.65?K.g:tt.hitRate>=.45?K.go:K.r}})))}))
):null,
// Partial vs full
ea.partialAnalysis?h("div",{},
h("div",{style:{fontSize:11,color:K.dm,fontWeight:600,marginBottom:6}},"PARTIAL vs FULL EXIT"),
h("div",{style:{display:"flex",gap:6}},
ea.partialAnalysis.partialStats?h("div",{style:{flex:1,padding:"8px 12px",background:K.cd,borderRadius:8,border:"1px solid "+K.bd}},
h("div",{style:{fontSize:10,color:K.cy,fontWeight:700,marginBottom:4}},"PARTIAL ("+(ea.partialAnalysis.partialCount)+" trades)"),
h("div",{style:{fontSize:13,fontWeight:700,color:ea.partialAnalysis.partialStats.wr>=.5?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(ea.partialAnalysis.partialStats.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:10,color:K.dm}},ea.partialAnalysis.partialStats.ar.toFixed(2)+"R avg \u2022 $"+ea.partialAnalysis.partialStats.ap.toFixed(0)+" avg")):null,
ea.partialAnalysis.fullStats?h("div",{style:{flex:1,padding:"8px 12px",background:K.cd,borderRadius:8,border:"1px solid "+K.bd}},
h("div",{style:{fontSize:10,color:K.go,fontWeight:700,marginBottom:4}},"FULL ("+(ea.partialAnalysis.fullCount)+" trades)"),
h("div",{style:{fontSize:13,fontWeight:700,color:ea.partialAnalysis.fullStats.wr>=.5?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(ea.partialAnalysis.fullStats.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:10,color:K.dm}},ea.partialAnalysis.fullStats.ar.toFixed(2)+"R avg \u2022 $"+ea.partialAnalysis.fullStats.ap.toFixed(0)+" avg")):null))
:null,
ea.beStopAnalysis?h("div",{style:{marginTop:12}},
h("div",{style:{fontSize:11,color:K.r,fontWeight:700,marginBottom:8,display:"flex",alignItems:"center",gap:6}},
"⚠️ BREAK-EVEN STOP COST",h(Tip,{t:"Compares win rate and R when you moved your stop vs held it. High MFE-at-BE-loss means the trade was working before the stop hit. Cost uses Trend End Price to show R left on the table."})),
h("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginBottom:10}},
h("div",{style:{flex:1,minWidth:110,padding:"10px 12px",background:K.cd,borderRadius:8,border:"1px solid "+K.bd}},
h("div",{style:{fontSize:9,color:K.dm,marginBottom:2}},"STOP MOVED ("+ea.beStopAnalysis.moveCount+")"),
h("div",{style:{fontSize:20,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:ea.beStopAnalysis.moveStats.wr>=.5?K.g:K.r}},(ea.beStopAnalysis.moveStats.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:10,color:K.dm}},ea.beStopAnalysis.moveStats.ar.toFixed(2)+"R avg"),
h("div",{style:{fontSize:10,color:K.dm}},"$"+ea.beStopAnalysis.moveStats.ap.toFixed(0)+" avg")),
ea.beStopAnalysis.noMoveStats?h("div",{style:{flex:1,minWidth:110,padding:"10px 12px",background:K.cd,borderRadius:8,border:"1px solid "+K.bd}},
h("div",{style:{fontSize:9,color:K.dm,marginBottom:2}},"STOP HELD ("+ea.beStopAnalysis.noMoveCount+")"),
h("div",{style:{fontSize:20,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:ea.beStopAnalysis.noMoveStats.wr>=.5?K.g:K.r}},(ea.beStopAnalysis.noMoveStats.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:10,color:K.dm}},ea.beStopAnalysis.noMoveStats.ar.toFixed(2)+"R avg"),
h("div",{style:{fontSize:10,color:K.dm}},"$"+ea.beStopAnalysis.noMoveStats.ap.toFixed(0)+" avg")):null,
ea.beStopAnalysis.avgMFEAtBELoss!==null?h("div",{style:{flex:1,minWidth:130,padding:"10px 12px",background:K.r+"11",borderRadius:8,border:"1px solid "+K.r+"44"}},
h("div",{style:{fontSize:9,color:K.r,marginBottom:2}},"MFE WHEN STOPPED AT BE"),
h("div",{style:{fontSize:20,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:K.r}},(ea.beStopAnalysis.avgMFEAtBELoss*100).toFixed(0)+"%"),
h("div",{style:{fontSize:9,color:K.dm,marginTop:2}},"of move captured before stop"),
h("div",{style:{fontSize:9,color:ea.beStopAnalysis.avgMFEAtBELoss>=0.5?K.r:K.go,fontWeight:700,marginTop:3}},ea.beStopAnalysis.avgMFEAtBELoss>=0.5?"Trade was working — moved too soon":ea.beStopAnalysis.avgMFEAtBELoss>=0.25?"Partial run then stopped":"Stopped early in move")):null),
ea.beStopAnalysis.avgCostR!==null?h("div",{style:{padding:"10px 14px",background:K.r+"0d",borderRadius:8,border:"1px solid "+K.r+"33",marginBottom:8}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.r,marginBottom:3}},"Avg cost of premature BE move: "+ea.beStopAnalysis.avgCostR.toFixed(2)+"R per trade"),
h("div",{style:{fontSize:10,color:K.dm}},"Based on "+ea.beStopAnalysis.teSampleSize+" trades with Trend End Price. R left by exiting before the move completed.")):null,
h("div",{style:{fontSize:10,color:K.dm,marginTop:4}},
"Stop-moved trades: ",h("span",{style:{color:K.g,fontWeight:700}},ea.beStopAnalysis.beWinCount+" won"),
", ",h("span",{style:{color:K.r,fontWeight:700}},ea.beStopAnalysis.beLossCount+" stopped at BE or worse"))
):null,
ea.durCap&&ea.durCap.length>=2?h("div",{style:{marginTop:12}},
h("div",{style:{fontSize:11,color:K.go,fontWeight:700,marginBottom:8}},"HOLD TIME vs CAPTURE %",h(Tip,{t:"How much of MFE you capture at different hold durations. Tells you whether you exit too early on short trades or overstay long ones."})),
h("div",{style:{display:"flex",flexDirection:"column",gap:4}},
ea.durCap.map(function(b,i){
var cc=b.avgCap!==null?(b.avgCap>=0.7?K.g:b.avgCap>=0.5?K.go:K.r):K.dm;
return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:10,padding:"8px 12px",background:K.cd,borderRadius:6,border:"1px solid "+K.bd}},
h("div",{style:{width:70,fontSize:10,color:K.dm}},b.l),
h("div",{style:{width:36,textAlign:"right",fontSize:13,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:cc}},b.avgCap!==null?(b.avgCap*100).toFixed(0)+"%":"--"),
h("div",{style:{flex:1,height:6,background:K.bg,borderRadius:3,overflow:"hidden"}},b.avgCap!==null?h("div",{style:{width:(b.avgCap*100)+"%",height:"100%",background:cc,borderRadius:3}}):null),
h("div",{style:{fontSize:9,color:K.dm,width:90,textAlign:"right"}},b.n+" trades • "+b.st.ar.toFixed(2)+"R"))}))):null,
ea.exitTypes&&ea.exitTypes.length>=2?h("div",{style:{marginTop:12}},
h("div",{style:{fontSize:11,color:K.pu,fontWeight:700,marginBottom:8}},"EXIT TYPE PERFORMANCE",h(Tip,{t:"Which exit method produces the best results. Trail = trailing stop. Limit = planned target. Stopped = initial stop loss."})),
h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
ea.exitTypes.map(function(et,i){
return h("div",{key:i,style:{flex:1,minWidth:100,padding:"8px 12px",background:K.cd,borderRadius:8,border:"1px solid "+K.bd}},
h("div",{style:{fontSize:10,fontWeight:700,color:K.tx,marginBottom:4}},et.label+" ("+et.n+")"),
h("div",{style:{fontSize:18,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:et.st.wr>=.5?K.g:K.r}},(et.st.wr*100).toFixed(0)+"%"),
h("div",{style:{fontSize:10,color:et.st.ar>=0?K.g:K.r}},et.st.ar.toFixed(2)+"R avg"),
h("div",{style:{fontSize:10,color:K.dm}},"$"+et.st.ap.toFixed(0)+" avg"),
h(Bar,{pct:et.st.wr*100,color:et.st.wr>=.5?K.g:K.r}));}))  
):null
))};

return h("div",null,h("div",{style:{fontSize:10,color:K.dm,marginBottom:10}},"Viewing "+(md==="all"?"ALL":md.toUpperCase())+" \u2022 "+cp.length+" completed trades"),sections)}
// === DAILY LOG VIEW ===
var DailyLogTab=function(){
var _exp=React.useState({}),expanded=_exp[0],setExpanded=_exp[1];
var _jf=React.useState({}),jField=_jf[0],setJField=_jf[1];

function toggleDay(date){setExpanded(function(p){var n=Object.assign({},p);n[date]=!n[date];return n})}
function saveJournal(date,section,value){
setDj(function(prev){
var n=Object.assign({},prev);
if(!n[date])n[date]={pre:"",mid:"",post:"",disciplineScore:"",planScore:"",emotionScore:""};
n[date][section]=value;
return n})}

var sorted=fl.slice().sort(function(a,b){return(b.date+b.time).localeCompare(a.date+a.time)});
var byDate={};
sorted.forEach(function(t){
if(!byDate[t.date])byDate[t.date]=[];
byDate[t.date].push(t)});
var dates=Object.keys(byDate).sort().reverse();

if(!dates.length)return h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"No trades yet. Log your first trade to get started.");

return h("div",null,
h("div",{style:{fontSize:10,color:K.dm,marginBottom:12,padding:"6px 10px",background:K.cd,borderRadius:6,border:"1px solid "+K.bd}},
"Daily view — each day shows all trades + pre/mid/post journal. Click any day to expand. Journals auto-save as you type."),
dates.map(function(date){
var dayTrades=byDate[date];
var dayPL=dayTrades.filter(function(t){return t.entry&&t.exit&&t.shares}).reduce(function(s,t){return s+cPL(t).pl},0);
var dayWins=dayTrades.filter(function(t){return t.entry&&t.exit&&t.shares&&cPL(t).pl>0}).length;
var dayCp=dayTrades.filter(function(t){return t.entry&&t.exit&&t.shares}).length;
var dj=dayJournal[date]||{};
var isOpen=expanded[date];
var weekday=new Date(date+"T12:00:00").toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric"});
return h("div",{key:date,style:{background:K.cd,borderRadius:8,border:"1px solid "+(isOpen?K.cy:K.bd),marginBottom:6}},
h("div",{style:{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",cursor:"pointer"},onClick:function(){toggleDay(date)}},
h("div",{style:{flex:1}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx}},weekday),
h("div",{style:{fontSize:10,color:K.dm,marginTop:2}},dayTrades.length+" trade"+(dayTrades.length>1?"s":"")+(dayCp>0?" · "+dayCp+" complete":""))),
dayCp>0?h("div",{style:{display:"flex",gap:12,alignItems:"center"}},
h("div",{style:{fontSize:10,color:K.dm}},dayCp>0?dayWins+"/"+dayCp+" W":""),
h("div",{style:{fontSize:14,fontWeight:700,color:dayPL>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(dayPL>=0?"+$":"-$")+Math.abs(dayPL).toFixed(2))):null,
h("div",{style:{color:K.dm,fontSize:12}},isOpen?"▲":"▼"),
dj.pre||dj.post?h("div",{style:{width:6,height:6,borderRadius:"50%",background:K.cy,flexShrink:0}}):null),
isOpen?h("div",{style:{borderTop:"1px solid "+K.bd,padding:"10px 14px"}},
h("div",{style:{display:"flex",flexDirection:"column",gap:3,marginBottom:12}},
dayTrades.sort(function(a,b){return(a.time||"").localeCompare(b.time||"")}).map(function(t){
var p=t.entry&&t.exit&&t.shares?cPL(t):null;
return h("div",{key:t.id,style:{display:"flex",alignItems:"center",gap:8,padding:"6px 10px",background:K.bg,borderRadius:6,fontSize:10}},
t.screenshotData||t.screenshotUrl?h("img",{src:t.screenshotData||t.screenshotUrl,style:{width:36,height:28,objectFit:"cover",borderRadius:4,cursor:"pointer",flexShrink:0},onClick:function(){setLb(t.screenshotData||t.screenshotUrl)}}):h("div",{style:{width:36,height:28,background:K.cd,borderRadius:4,flexShrink:0}}),
h("div",{style:{flex:1}},
h("div",{style:{color:K.tx,fontWeight:600}},t.direction+" "+t.type+" · "+t.ticker+" · "+(t.time||"?")+" → "+(t.exitTime||"?")),
h("div",{style:{color:K.dm,fontSize:9,marginTop:1}},t.timeframe+" · ADX:"+(t.adxAtEntry||"?")+" · RSI:"+(t.rsiAtEntry||"?")+" · Emotion:"+t.emotion)),
p?h("div",{style:{textAlign:"right",flexShrink:0}},
h("div",{style:{color:p.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace",fontWeight:700}},(p.pl>=0?"+$":"-$")+Math.abs(p.pl).toFixed(2)),
h("div",{style:{color:K.dm,fontSize:9}},p.rm.toFixed(2)+"R")):null,
h("div",{style:{display:"flex",gap:4,flexShrink:0}},
h("button",{onClick:function(){oE(t)},style:{padding:"2px 7px",background:"transparent",border:"1px solid "+K.bd,borderRadius:4,color:K.dm,fontSize:9,cursor:"pointer"}},"Edit"),
h("button",{onClick:function(){dl(t.id)},style:{padding:"2px 6px",background:"transparent",border:"1px solid "+K.r+"44",borderRadius:4,color:K.r,fontSize:9,cursor:"pointer"}},"✕")))})),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}},
[["pre","Pre-Market Plan","What is your plan? What setups are you watching? Key levels today?"],
["mid","Mid-Day Check-In","How is the session going? Any adjustments to your plan?"],
["post","End of Day Review","What worked? What didn't? Key lessons from today's trades?"]].map(function(jd){
var field=jd[0],label=jd[1],placeholder=jd[2];
return h("div",{key:field,style:{background:K.bg,borderRadius:6,padding:"8px 10px"}},
h("div",{style:{fontSize:10,fontWeight:700,color:field==="pre"?K.cy:field==="mid"?K.go:K.g,marginBottom:6}},label),
h("textarea",{value:dj[field]||"",onChange:function(e){saveJournal(date,field,e.target.value)},placeholder:placeholder,style:{width:"100%",minHeight:80,background:"transparent",border:"none",color:K.tx,fontSize:10,lineHeight:1.5,resize:"vertical",outline:"none",fontFamily:"IBM Plex Sans,-apple-system,sans-serif",boxSizing:"border-box"}}))})),
h("div",{style:{display:"flex",gap:8,marginTop:8,alignItems:"center",flexWrap:"wrap"}},
h("div",{style:{fontSize:10,color:K.dm,fontWeight:600}},"Optional Scoring:"),
[["disciplineScore","Discipline","Did you stick to your rules? 1-5"],
["planScore","Plan Quality","How clear was your plan? 1-5"],
["emotionScore","Emotional Control","How well did you manage emotions? 1-5"]].map(function(sd){
var sk=sd[0],sl=sd[1],st=sd[2];
return h("div",{key:sk,style:{display:"flex",alignItems:"center",gap:4}},
h("div",{style:{fontSize:9,color:K.dm}},sl+":"),
[1,2,3,4,5].map(function(n){
return h("button",{key:n,onClick:function(){saveJournal(date,sk,dj[sk]===String(n)?"":String(n))},
title:st,
style:{width:18,height:18,borderRadius:"50%",border:"1px solid "+(dj[sk]===String(n)?K.cy:K.bd),background:dj[sk]===String(n)?K.cy:"transparent",color:dj[sk]===String(n)?"#fff":K.dm,fontSize:8,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}},n)}))}))
):null)
}))};

// === EQUITY VIEW ===
function rEq(){
if(!cp.length)return h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"Log completed trades to see equity.");
var sorted=cp.slice().sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)});
// Cumulative
var cum=0,maxC=0,minC=0;
var dailyAdj={};Object.keys(plAdj).forEach(function(k){var a=parseFloat(plAdj[k]&&plAdj[k].amount||0);if(a&&plP==="daily")dailyAdj[k]=(dailyAdj[k]||0)+a});
var seenDays={};
var pts=sorted.map(function(t,i){var p=cPL(t);cum+=p.pl;
if(!seenDays[t.date]){seenDays[t.date]=true;var da=parseFloat(plAdj[t.date]&&plAdj[t.date].amount||0);if(da)cum+=da}
if(cum>maxC)maxC=cum;if(cum<minC)minC=cum;return{i:i+1,pl:p.pl,cum:cum,d:t.date}});
var range=Math.max(maxC-minC,1);
// Period grouping
function getKey(d){
if(plP==="daily")return d;
if(plP==="weekly"){var dt=new Date(d);var day=dt.getDay();var diff=dt.getDate()-day+(day===0?-6:1);dt.setDate(diff);return dt.toISOString().slice(0,10)}
if(plP==="monthly")return d.slice(0,7);
if(plP==="quarterly"){var m=parseInt(d.slice(5,7));var q=Math.ceil(m/3);return d.slice(0,4)+"-Q"+q}
return d}
var periods={};sorted.forEach(function(t){var k=getKey(t.date);if(!periods[k])periods[k]={key:k,pl:0,n:0,w:0};var p=cPL(t);periods[k].pl+=p.pl;periods[k].n++;if(p.pl>0)periods[k].w++});
// Apply manual adjustments
var pArr=Object.keys(periods).sort().map(function(k){var adj=plAdj[k]||{amount:0,notes:""};return Object.assign({},periods[k],{adjAmount:adj.amount||0,adjNotes:adj.notes||"",displayPl:(periods[k].pl+(parseFloat(adj.amount)||0))})});
var maxPPL=Math.max.apply(null,pArr.map(function(p){return Math.abs(p.displayPl)}).concat([1]));
return h("div",null,
// Cumulative chart
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:14,marginBottom:12}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}},h("div",{style:{fontSize:11,color:K.dm,display:"flex",alignItems:"center"}},"CUMULATIVE P/L",h(Tip,{t:"Running total of your P/L across all completed trades, in chronological order. Shows your equity curve \u2014 consistent upward = edge is working."})),h("div",{style:{fontSize:18,fontWeight:700,color:cum>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},"$"+cum.toFixed(2),h("div",{style:{fontSize:10,color:K.dm,fontWeight:400,marginTop:2,fontFamily:"IBM Plex Sans,-apple-system,sans-serif"}},Object.values(plAdj).reduce(function(s,a){return s+parseFloat(a&&a.amount||0)},0)!==0?"incl. adj":null))),
function(){if(pts.length<2)return h("div",{style:{textAlign:"center",padding:20,color:K.dm}},"2+ trades to see line chart");
var svgW=600,svgH=160,pd=30,W=pts.length-1;
var xS=function(i){return pd+(i/W)*(svgW-pd*2)};
var yS=function(v){return pd+(maxC-v)/range*(svgH-pd*2)};
var ln=pts.map(function(p,i){return(i===0?"M":"L")+xS(i).toFixed(1)+","+yS(p.cum).toFixed(1)}).join(" ");
var ar=ln+" L"+xS(W).toFixed(1)+","+(svgH-pd)+" L"+xS(0).toFixed(1)+","+(svgH-pd)+" Z";
var zY=Math.min(Math.max(yS(0),pd),svgH-pd);
return h("div",{style:{background:K.bg,borderRadius:6,padding:4}},h("svg",{viewBox:"0 0 "+svgW+" "+svgH,style:{width:"100%",height:160}},
h("line",{x1:pd,y1:zY,x2:svgW-pd,y2:zY,stroke:K.dm,strokeWidth:.5,strokeDasharray:"4 3"}),
h("path",{d:ar,fill:cum>=0?"rgba(46,213,115,.1)":"rgba(255,71,87,.1)"}),
h("path",{d:ln,fill:"none",stroke:cum>=0?K.g:K.r,strokeWidth:2,strokeLinejoin:"round",strokeLinecap:"round"}),
pts.map(function(p,i){return h("circle",{key:i,cx:xS(i),cy:yS(p.cum),r:pts.length>30?2:3,fill:p.cum>=0?K.g:K.r},h("title",null,"#"+p.i+" "+p.d+": $"+p.cum.toFixed(2)))})))}()),
// Period selector + summary
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:14}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}},h("div",{style:{fontSize:11,color:K.dm,display:"flex",alignItems:"center"}},"P/L BREAKDOWN",h(Tip,{t:"Your profit/loss grouped by time period. Switch between daily, weekly, monthly, and quarterly views to spot patterns in your performance over time."})),h(Pl,{v:plP,onChange:sPlP,options:[{v:"daily",l:"Day"},{v:"weekly",l:"Week"},{v:"monthly",l:"Month"},{v:"quarterly",l:"Qtr"}]})),
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},pArr.map(function(p){
var lbl=plP==="daily"?p.key.slice(5):plP==="weekly"?"Wk "+p.key.slice(5):plP==="monthly"?p.key:p.key;
return h("div",{key:p.key,style:{display:"flex",alignItems:"center",gap:6,padding:"4px 8px",background:K.bg,borderRadius:6}},
h("div",{style:{width:65,fontSize:10,color:K.dm,fontFamily:"JetBrains Mono,monospace",flexShrink:0}},lbl),
h("div",{style:{flex:1,height:14,background:K.cd,borderRadius:3,overflow:"hidden"}},h("div",{style:{width:Math.max(Math.abs(p.displayPl)/maxPPL*100,3)+"%",height:"100%",background:p.displayPl>=0?K.g:K.r,borderRadius:3,opacity:.7}})),
h("div",{style:{width:70,textAlign:"right",fontSize:11,fontWeight:700,color:p.displayPl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},"$"+p.displayPl.toFixed(0)),
h("div",{style:{width:55,fontSize:10,color:K.dm,textAlign:"right"}},p.n+"tr "+p.w+"W"),
h("input",{type:"number",value:p.adjAmount||"",onChange:function(e){var v=e.target.value;sPlAdj(function(prev){var n=Object.assign({},prev);n[p.key]=Object.assign({},n[p.key]||{},{amount:v});return n})},placeholder:"+/-",step:"0.01",title:"Manual P/L adjustment for this period (display only, does not affect analysis)",style:{width:52,background:K.inp,border:"1px solid "+K.bd,borderRadius:4,padding:"2px 5px",color:p.adjAmount&&parseFloat(p.adjAmount)!==0?(parseFloat(p.adjAmount)>0?K.g:K.r):K.dm,fontSize:9,fontFamily:"JetBrains Mono,monospace",outline:"none",textAlign:"right"}}))}))),
// Period stats summary
pArr.length>=2?h("div",{style:{display:"flex",gap:6,marginTop:10,flexWrap:"wrap"}},
h(SC,{label:"Best "+plP,value:"$"+Math.max.apply(null,pArr.map(function(p){return p.displayPl})).toFixed(0),color:K.g}),
h(SC,{label:"Worst "+plP,value:"$"+Math.min.apply(null,pArr.map(function(p){return p.displayPl})).toFixed(0),color:K.r}),
h(SC,{label:"Win "+plP+"s",value:pArr.filter(function(p){return p.displayPl>0}).length+"/"+pArr.length,color:pArr.filter(function(p){return p.displayPl>0}).length/pArr.length>=.5?K.g:K.r}),
h(SC,{label:"Avg "+plP,value:"$"+(pArr.reduce(function(s,p){return s+p.displayPl},0)/pArr.length).toFixed(0),color:pArr.reduce(function(s,p){return s+p.displayPl},0)>=0?K.g:K.r})):null)}
// === STRATEGIES VIEW ===
function rStrats(){
var maxS=""; // Beta: unlimited strategies
// Strategy editor modal
if(editStrat!==null){
var es=editStrat;
var isNew=!es.id;
var tmpl=STRATEGY_TEMPLATES.find(function(t){return t.id===es.templateId});
return h("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.88)",zIndex:9500,overflow:"auto",padding:"16px 8px"}},
h("div",{style:{maxWidth:760,margin:"0 auto",background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:20}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}},
h("h2",{style:{color:K.go,fontSize:15,margin:0,fontFamily:"JetBrains Mono,monospace"}},isNew?"NEW STRATEGY":"EDIT STRATEGY"),
h("button",{onClick:function(){setEditStrat(null)},style:{padding:"4px 10px",background:K.r,border:"none",borderRadius:6,color:"#fff",fontSize:11,cursor:"pointer"}},"Cancel")),
// Name
h("div",{style:{marginBottom:10}},
h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Strategy Name"),
h("input",{type:"text",value:es.name||"",onChange:function(e){setEditStrat(function(p){return Object.assign({},p,{name:e.target.value})})},placeholder:"My Channel Reversal...",style:{background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"7px 10px",color:K.tx,fontSize:13,width:"100%",outline:"none"}})),
// Template selector
h("div",{style:{marginBottom:12}},
h("div",{style:{fontSize:10,color:K.dm,marginBottom:3}},"Base on Template (optional)"),
h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
h("button",{onClick:function(){setEditStrat(function(p){return Object.assign({},p,{templateId:"",coreRules:{},addons:[]})})},style:{padding:"4px 10px",borderRadius:6,border:"1px solid "+K.bd,fontSize:10,cursor:"pointer",background:!es.templateId?K.cy:"transparent",color:!es.templateId?"#fff":K.dm}},"Custom"),
STRATEGY_TEMPLATES.map(function(t){return h("button",{key:t.id,onClick:function(){setEditStrat(function(p){return Object.assign({},p,{templateId:t.id,coreRules:Object.assign({},t.coreRules),addons:p.addons||[]})})},style:{padding:"4px 10px",borderRadius:6,border:"1px solid "+K.bd,fontSize:10,cursor:"pointer",background:es.templateId===t.id?K.go:"transparent",color:es.templateId===t.id?"#000":K.dm}},t.name)}))),
// Template info
tmpl?h("div",{style:{background:K.bg,borderRadius:8,padding:"10px 14px",marginBottom:12,border:"1px solid "+K.bd}},
h("div",{style:{fontSize:11,color:K.tx,marginBottom:6}},tmpl.desc),
h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},
Object.keys(CONDITIONS).map(function(c){
var isBest=tmpl.conditions.best.indexOf(c)>=0;
var isAvoid=tmpl.conditions.avoid&&tmpl.conditions.avoid.indexOf(c)>=0;
if(!isBest&&!isAvoid)return null;
return h("span",{key:c,style:{fontSize:9,padding:"2px 7px",borderRadius:10,background:isBest?K.g+"22":K.r+"22",color:isBest?K.g:K.r,border:"1px solid "+(isBest?K.g:K.r)+"44",fontWeight:600}},isBest?"\u2713 ":"\u2715 ",CONDITIONS[c].l)}))):null,
// Core rules section
h("div",{style:{marginBottom:12}},
h("div",{style:{fontSize:11,color:K.go,fontWeight:700,marginBottom:6,borderBottom:"1px solid "+K.bd,paddingBottom:4}},"CORE RULES — Layer 1",h("span",{style:{fontSize:9,color:K.dm,fontWeight:400,marginLeft:6}},"Always present for this strategy")),
es.templateId&&tmpl?
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:4}},Object.keys(tmpl.coreRules).map(function(k){return h("div",{key:k,style:{padding:"5px 8px",background:K.bg,borderRadius:6,fontSize:10,color:K.tx,display:"flex",alignItems:"center",gap:4}},h("span",{style:{color:K.g,fontWeight:700}},"●"),tmpl.coreRules[k])})):
h("div",null,
h("div",{style:{fontSize:10,color:K.dm,marginBottom:6}},"Add your core rules for this strategy:"),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:4,marginBottom:6}},
(es.coreRules?Object.keys(es.coreRules):[]).map(function(k){return h("div",{key:k,style:{padding:"4px 8px",background:K.bg,borderRadius:6,fontSize:10,color:K.tx,display:"flex",justifyContent:"space-between",alignItems:"center"}},h("span",{},(es.coreRules[k]||k)),h("button",{onClick:function(){setEditStrat(function(p){var nr=Object.assign({},p.coreRules);delete nr[k];return Object.assign({},p,{coreRules:nr})})},style:{background:"transparent",border:"none",color:K.r,cursor:"pointer",fontSize:10}},"×"))})),
h("div",{style:{display:"flex",gap:4}},
h("input",{id:"newRuleInput",type:"text",placeholder:"Rule name...",style:{flex:1,background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"5px 8px",color:K.tx,fontSize:11,outline:"none"}}),
h("button",{onClick:function(){var inp=document.getElementById("newRuleInput");if(!inp||!inp.value.trim())return;var k="custom_"+Date.now();setEditStrat(function(p){var nr=Object.assign({},p.coreRules||{});nr[k]=inp.value.trim();return Object.assign({},p,{coreRules:nr})});inp.value=""},style:{padding:"5px 10px",background:K.g,border:"none",borderRadius:6,color:"#000",fontSize:10,cursor:"pointer",fontWeight:700}},"Add")))),
// Add-on indicators
h("div",{style:{marginBottom:14}},
h("div",{style:{fontSize:11,color:K.pu,fontWeight:700,marginBottom:6,borderBottom:"1px solid "+K.bd,paddingBottom:4}},"ADD-ON INDICATORS — Layer 2",h(TierBadge,{tier:"t1"}),h("span",{style:{fontSize:9,color:K.dm,fontWeight:400,marginLeft:6}},"Optional indicators from the library")),
Object.keys(IND_CAT_LABELS).map(function(cat){
return h("div",{key:cat,style:{marginBottom:8}},
h("div",{style:{fontSize:9,color:K.go,fontWeight:700,marginBottom:4,textTransform:"uppercase",letterSpacing:1}},IND_CAT_LABELS[cat]),
h("div",{style:{display:"flex",flexWrap:"wrap",gap:4}},
IND_LIBRARY[cat].map(function(ind){
var active=(es.addons||[]).indexOf(ind.k)>=0;
return h("button",{key:ind.k,title:ind.tip,onClick:function(){setEditStrat(function(p){var a=p.addons||[];var idx=a.indexOf(ind.k);return Object.assign({},p,{addons:idx>=0?a.filter(function(x){return x!==ind.k}):a.concat([ind.k])})})},style:{padding:"3px 8px",borderRadius:4,border:"1px solid "+(active?K.pu:K.bd),fontSize:9,cursor:"pointer",background:active?K.pu+"22":"transparent",color:active?K.pu:K.dm,fontWeight:active?700:400}},ind.l)})))})),
// Save button
h("button",{onClick:function(){if(!es.name||!es.name.trim()){alert("Please name your strategy");return}var s=Object.assign({},es,{id:es.id||gid()});setStrats(function(p){var idx=p.findIndex(function(x){return x.id===s.id});if(idx>=0){var n=p.slice();n[idx]=s;return n}return p.concat([s])});setEditStrat(null)},style:{width:"100%",padding:"10px",background:K.g,border:"none",borderRadius:8,color:"#000",fontSize:13,fontWeight:700,cursor:"pointer"}},"SAVE STRATEGY")))}

// Main strategies list
return h("div",null,
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}},
h("div",null,
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,marginBottom:2}},"My Strategies"),
h("div",{style:{fontSize:10,color:K.dm}},"Define your trading strategies. Each strategy gets its own rule set and analysis.")),
h("div",{style:{display:"flex",gap:6,alignItems:"center"}},
h("span",{style:{fontSize:9,color:BETA_TIER.color,padding:"2px 7px",borderRadius:4,background:BETA_TIER.color+"22",border:"1px solid "+BETA_TIER.color+"44"}},"Beta: Full Access"),
h("button",{onClick:function(){setEditStrat({id:"",name:"",templateId:"",coreRules:{},addons:[]})},style:{padding:"6px 14px",background:K.g,border:"none",borderRadius:8,color:"#000",fontSize:11,fontWeight:700,cursor:"pointer"}},"+ New Strategy"))),
// User strategies
userStrats.length?h("div",{style:{display:"flex",flexDirection:"column",gap:8,marginBottom:20}},userStrats.map(function(s){
var tmpl=STRATEGY_TEMPLATES.find(function(t){return t.id===s.templateId});
var tradeCt=trades.filter(function(t){return t.strategyId===s.id}).length;
var allRules=Object.keys(s.coreRules||{}).concat(s.addons||[]);
return h("div",{key:s.id,style:{background:K.cd,borderRadius:10,border:"1px solid "+K.bd,padding:"12px 16px"}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}},
h("div",null,
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,marginBottom:2}},s.name),
tmpl?h("div",{style:{fontSize:10,color:K.dm,marginBottom:4}},"Based on: ",h("span",{style:{color:K.go}},tmpl.name)):null,
h("div",{style:{fontSize:10,color:K.dm}},tradeCt+" trades logged")),
h("div",{style:{display:"flex",gap:6}},
h("button",{onClick:function(){setEditStrat(dc(s))},style:{padding:"4px 10px",background:"transparent",border:"1px solid "+K.bd,borderRadius:6,color:K.dm,fontSize:10,cursor:"pointer"}},"Edit"),
h("button",{onClick:function(){if(confirm("Delete "+s.name+"?"))setStrats(function(p){return p.filter(function(x){return x.id!==s.id})})},style:{padding:"4px 10px",background:"transparent",border:"1px solid "+K.r+"44",borderRadius:6,color:K.r,fontSize:10,cursor:"pointer"}},"Delete"))),
// Condition tags
tmpl?h("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:8}},
Object.keys(CONDITIONS).map(function(c){
var isBest=tmpl.conditions.best.indexOf(c)>=0;
var isAvoid=tmpl.conditions.avoid&&tmpl.conditions.avoid.indexOf(c)>=0;
if(!isBest&&!isAvoid)return null;
return h("span",{key:c,style:{fontSize:9,padding:"2px 7px",borderRadius:10,background:isBest?K.g+"22":K.r+"22",color:isBest?K.g:K.r,border:"1px solid "+(isBest?K.g:K.r)+"44",fontWeight:600}},isBest?"\u2713 ":"\u2715 ",CONDITIONS[c].l)})):null,
// Rules summary
h("div",{style:{display:"flex",gap:4,flexWrap:"wrap"}},
Object.keys(s.coreRules||{}).map(function(k){return h("span",{key:k,style:{fontSize:9,padding:"2px 6px",borderRadius:4,background:K.g+"18",color:K.g,border:"1px solid "+K.g+"33"}},s.coreRules[k]||k)}),
(s.addons||[]).map(function(k){return h("span",{key:k,style:{fontSize:9,padding:"2px 6px",borderRadius:4,background:K.pu+"18",color:K.pu,border:"1px solid "+K.pu+"33"}},getIndLabel(k))})))})):
h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"No strategies yet. Add your first strategy to get started."),

// Template library
h("div",{style:{marginTop:20}},
h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:10,display:"flex",alignItems:"center"}},"STRATEGY LIBRARY",h(Tip,{t:"Pre-built strategy templates. Select one as a starting point for your own strategy."})),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}},
STRATEGY_TEMPLATES.map(function(t){
return h("div",{key:t.id,style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"10px 14px"}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx,marginBottom:4}},t.name),
h("div",{style:{fontSize:10,color:K.dm,marginBottom:8,lineHeight:1.5}},t.desc),
h("div",{style:{display:"flex",gap:4,flexWrap:"wrap",marginBottom:8}},
Object.keys(CONDITIONS).map(function(c){
var isBest=t.conditions.best.indexOf(c)>=0;
var isAvoid=t.conditions.avoid&&t.conditions.avoid.indexOf(c)>=0;
if(!isBest&&!isAvoid)return null;
return h("span",{key:c,style:{fontSize:9,padding:"2px 6px",borderRadius:10,background:isBest?K.g+"22":K.r+"22",color:isBest?K.g:K.r,border:"1px solid "+(isBest?K.g:K.r)+"44",fontWeight:600}},isBest?"\u2713 ":"\u2715 ",CONDITIONS[c].l)})),
h("button",{onClick:function(){setEditStrat({id:"",name:t.name,templateId:t.id,coreRules:Object.assign({},t.coreRules),addons:[]})},style:{padding:"4px 10px",background:K.go,border:"none",borderRadius:6,color:"#000",fontSize:10,fontWeight:700,cursor:"pointer"}},"Use Template"))}))))}

// === HEAT MAP + HOUR GRID DATA ===
// === CSV TEMPLATE EXPORT/IMPORT ===
function dlCSVTemplate(trades){
var RULE_KEYS=["ultimateHL","lhhl","chanBreak","chanRetest","firstCandle10ema","secondCandleEntry","macdCross","cloudAlign","rsiExtreme","cloud15m"];
var STOP_KEYS=["initStopHL","stopToChan","trailHL","trailFailedHL","stopMoved","reentry"];
var headers=["date","time","exitTime","ticker","timeframe","direction","type","mode","entryPrice","stopPrice","exitPrice","shares","mfe","mae","adxAtEntry","cloudWidthPct","cloudDirection","rsiAtEntry","rsiAtPeak","rsiAtExit","divBefore","divDuring","maeTiming","volumeAtExit","exitType","session","confidence","emotion","emotionDuring","emotionAfter","followedRules","hasPartial","partialExitPrice","partialPct","trailTimeframe","trailStopPrice","trendEndPrice","screenshotUrl","exitScreenshotUrl"].concat(RULE_KEYS.map(function(k){return"rule_"+k})).concat(STOP_KEYS.map(function(k){return"stop_"+k}));
var sample=["2024-01-15","09:32","09:45","TSLA","3m","Long","Continuation","live","245.50","244.00","248.20","100","249.00","244.50","28","0.25","Bullish","52","71","68","None","None","Run First","Above Avg","Trail","Trending","4","Calm","Calm","Satisfied","Y","N","","","1m","","","",""].concat(RULE_KEYS.map(function(){return"Y"})).concat(STOP_KEYS.map(function(){return"N"}));
var notes=["# VALID VALUES PER COLUMN","# date: YYYY-MM-DD","# timeframe: 1m 3m 5m 15m 1h 2h 4h 1D 1W","# direction: Long Short","# type: Reversal Continuation","# mode: live backtest","# cloudDirection: Bullish Bearish None","# divBefore divDuring: Bullish Bearish None","# maeTiming: Dip First Run First","# volumeAtExit: Below Avg At Avg Above Avg","# exitType: Trail Limit Stopped","# session: Trending Ranging Choppy Breakout Reversal","# confidence: 1 2 3 4 5","# emotion emotionDuring: Calm Eager FOMO Frustrated Revenge Bored","# emotionDuring: Calm Confident Anxious Impatient Greedy Panicked","# emotionAfter: Satisfied Relieved Frustrated Regret Revenge Neutral","# followedRules hasPartial: Y N","# partialPct: 25 33 50 75","# trailTimeframe: 1m 3m 5m Same","# all rule_ and stop_ columns: Y N"];
var rows=[notes.join("\n"),headers.join(","),sample.join(",")];
// add existing trades if any
if(trades&&trades.length){trades.forEach(function(t){var row=headers.slice(0,39).map(function(col){
if(col.startsWith("rule_")){var k=col.replace("rule_","");return(t.rules&&t.rules[k])||""}
else if(col.startsWith("stop_")){var k=col.replace("stop_","");return(t.stopRules&&t.stopRules[k])||""}
else{var v=t[col]||"";return String(v).indexOf(",")>=0?'"'+v+'"':v}
});var ruleVals=RULE_KEYS.map(function(k){return(t.rules&&t.rules[k])||""});
var stopVals=STOP_KEYS.map(function(k){return(t.stopRules&&t.stopRules[k])||""});
rows.push(row.concat(ruleVals).concat(stopVals).join(","))})}
var blob=new Blob([rows.join("\n")],{type:"text/csv"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="trade_journal_template.csv";a.click();URL.revokeObjectURL(url)}

function parseCSV(text,cb){
var lines=text.split("\n").filter(function(l){return l.trim()&&!l.trim().startsWith("#")});
if(lines.length<2){cb(null,"No data rows found");return}
var headers=lines[0].split(",").map(function(h){return h.trim()});
var RULE_KEYS=["ultimateHL","lhhl","chanBreak","chanRetest","firstCandle10ema","secondCandleEntry","macdCross","cloudAlign","rsiExtreme","cloud15m"];
var STOP_KEYS=["initStopHL","stopToChan","trailHL","trailFailedHL","stopMoved","reentry"];
var imported=[];
for(var i=1;i<lines.length;i++){
var vals=lines[i].match(/(".*?"|[^,]+|(?<=,)(?=,)|^(?=,)|(?<=,)$)/g)||[];
// simple split fallback
vals=lines[i].split(",").map(function(v){return v.trim().replace(/^"|"$/g,"")});
if(vals.length<3)continue;
var row={};headers.forEach(function(h,idx){row[h]=vals[idx]||""});
var t={id:Date.now()+"_"+i,date:row.date||"",time:row.time||"",exitTime:row.exitTime||"",ticker:(row.ticker||"TSLA").toUpperCase(),timeframe:row.timeframe||"3m",direction:row.direction||"Long",type:row.type||"Continuation",mode:row.mode||"live",entryPrice:parseFloat(row.entryPrice)||0,stopPrice:parseFloat(row.stopPrice)||0,exitPrice:parseFloat(row.exitPrice)||0,shares:parseFloat(row.shares)||0,mfe:parseFloat(row.mfe)||0,mae:parseFloat(row.mae)||0,adxAtEntry:row.adxAtEntry||"",cloudWidthPct:row.cloudWidthPct||"",cloudDirection:row.cloudDirection||"None",rsiAtEntry:row.rsiAtEntry||"",rsiAtPeak:row.rsiAtPeak||"",rsiAtExit:row.rsiAtExit||"",divBefore:row.divBefore||"None",divDuring:row.divDuring||"None",maeTiming:row.maeTiming||"",volumeAtExit:row.volumeAtExit||"",exitType:row.exitType||"",sessionRead:row.session||"",confidence:row.confidence||"",emotion:row.emotion||"Calm",emotionDuring:row.emotionDuring||"",emotionAfter:row.emotionAfter||"",followedRules:row.followedRules||"",hasPartial:row.hasPartial||"N",partialExitPrice:parseFloat(row.partialExitPrice)||0,partialPct:row.partialPct||"",trailTimeframe:row.trailTimeframe||"",trailStopPrice:parseFloat(row.trailStopPrice)||0,trendEndPrice:parseFloat(row.trendEndPrice)||0,screenshotUrl:row.screenshotUrl||"",screenshotData:"",exitScreenshotUrl:row.exitScreenshotUrl||"",exitScreenshotData:"",targets:[],strategyId:"",rules:{},stopRules:{}};
RULE_KEYS.forEach(function(k){t.rules[k]=row["rule_"+k]||""});
STOP_KEYS.forEach(function(k){t.stopRules[k]=row["stop_"+k]||""});
imported.push(t)}
cb(imported,null)}

// === HEATMAP + WEEKLY CALENDAR ===
var HeatmapTab=function(){
var _wk=React.useState(null),selWeek=_wk[0],setSelWeek=_wk[1];
var _vw=React.useState("calendar"),hmView=_vw[0],setHmView=_vw[1];
var ALL_DAYS=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
var TRADE_DAYS=["Sun","Mon","Tue","Wed","Thu","Fri"];
var HOURS=["6","7","8","9","10","11","12","13","14","15","16","17"];

function weekKey(dateStr){var d=new Date(dateStr+"T12:00:00");var day=d.getDay();var tmp=new Date(d);tmp.setDate(d.getDate()-day);return tmp.toISOString().slice(0,10)}
function isOpex(dateStr){var d=new Date(dateStr+"T12:00:00");if(d.getDay()!==5)return false;var cnt=0;var t=new Date(d.getFullYear(),d.getMonth(),1);while(t<=d){if(t.getDay()===5)cnt++;t.setDate(t.getDate()+1)}return cnt===3}
function cellBg(pl,n){if(!n)return{bg:K.bg,tc:K.dm,bd:"1px solid "+K.bd};var intensity=Math.min(Math.abs(pl)/80,1);if(pl>0)return{bg:"rgba(46,213,115,"+(0.1+intensity*0.55)+")",tc:K.g,bd:"1px solid rgba(46,213,115,.3)"};return{bg:"rgba(255,71,87,"+(0.1+intensity*0.55)+")",tc:K.r,bd:"1px solid rgba(255,71,87,.3)"}}

var weekMap={};
cp.forEach(function(t){if(!t.date)return;var wk=weekKey(t.date);if(!weekMap[wk])weekMap[wk]={key:wk,trades:[],pl:0,w:0,r:0,n:0,days:{}};var p=cPL(t);weekMap[wk].trades.push(t);weekMap[wk].pl+=p.pl;weekMap[wk].n++;if(p.pl>0)weekMap[wk].w++;weekMap[wk].r+=(p.r||0);var dn=ALL_DAYS[new Date(t.date+"T12:00:00").getDay()];if(!weekMap[wk].days[dn])weekMap[wk].days[dn]={pl:0,n:0,w:0,trades:[]};weekMap[wk].days[dn].pl+=p.pl;weekMap[wk].days[dn].n++;if(p.pl>0)weekMap[wk].days[dn].w++;weekMap[wk].days[dn].trades.push(t)});
var weeks=Object.keys(weekMap).sort().reverse().map(function(k){return weekMap[k]});
var selWeekData=selWeek?weekMap[selWeek]:null;

var dayMap2={};ALL_DAYS.forEach(function(d){dayMap2[d]={pl:0,n:0,w:0}});
cp.forEach(function(t){if(!t.date)return;var dn=ALL_DAYS[new Date(t.date+"T12:00:00").getDay()];var p=cPL(t);dayMap2[dn].pl+=p.pl;dayMap2[dn].n++;if(p.pl>0)dayMap2[dn].w++});
var dayArr=TRADE_DAYS.map(function(d){return Object.assign({day:d},dayMap2[d])});
var maxDayPL=Math.max.apply(null,dayArr.map(function(d){return Math.abs(d.pl)}).concat([1]));

var hourMap={};
cp.forEach(function(t){if(!t.time)return;var hr=parseInt(t.time.split(":")[0]);if(isNaN(hr))return;var p=cPL(t);if(!hourMap[hr])hourMap[hr]={pl:0,n:0,w:0};hourMap[hr].pl+=p.pl;hourMap[hr].n++;if(p.pl>0)hourMap[hr].w++});
var gridMap={};
cp.forEach(function(t){if(!t.date||!t.time)return;var dn=ALL_DAYS[new Date(t.date+"T12:00:00").getDay()];var hr=parseInt(t.time.split(":")[0]);if(isNaN(hr))return;var key=dn+"_"+hr;if(!gridMap[key])gridMap[key]={pl:0,n:0,w:0};var p=cPL(t);gridMap[key].pl+=p.pl;gridMap[key].n++;if(p.pl>0)gridMap[key].w++});
var COL=56;

if(!cp.length)return h("div",{style:{textAlign:"center",padding:40,color:K.dm}},"Log completed trades to see performance patterns.");

return h("div",null,
h("div",{style:{display:"flex",gap:4,marginBottom:12}},
[["calendar","Weekly Calendar"],["grid","Hour x Day Grid"]].map(function(x){
return h("button",{key:x[0],onClick:function(){setHmView(x[0])},style:{padding:"5px 14px",borderRadius:6,border:"1px solid "+(hmView===x[0]?K.cy:K.bd),fontSize:11,fontWeight:600,cursor:"pointer",background:hmView===x[0]?K.cy+"22":"transparent",color:hmView===x[0]?K.cy:K.dm}},x[1])})),
hmView==="calendar"?h("div",{style:{display:"grid",gridTemplateColumns:selWeekData?"1fr 300px":"1fr",gap:12}},
h("div",null,
h("div",{style:{display:"grid",gridTemplateColumns:"80px repeat(6,1fr)",gap:3,marginBottom:4}},
h("div",{style:{fontSize:9,color:K.dm}},""),
TRADE_DAYS.map(function(d){return h("div",{key:d,style:{textAlign:"center",fontSize:10,fontWeight:700,color:K.dm}},d)})),
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},
weeks.map(function(wk){
var wkStart=new Date(wk.key+"T12:00:00");
var wkLabel=wkStart.toLocaleDateString("en-US",{month:"short",day:"numeric"});
var isOpexWk=TRADE_DAYS.some(function(day){var idx=ALL_DAYS.indexOf(day);var cd=new Date(wkStart);cd.setDate(cd.getDate()+idx);return isOpex(cd.toISOString().slice(0,10))});
var isSelected=selWeek===wk.key;
return h("div",{key:wk.key,style:{display:"grid",gridTemplateColumns:"80px repeat(6,1fr)",gap:3,cursor:"pointer"},onClick:function(){setSelWeek(isSelected?null:wk.key)}},
h("div",{style:{display:"flex",flexDirection:"column",justifyContent:"center",padding:"4px 6px",borderRadius:6,background:isSelected?K.cy+"22":K.cd,border:"1px solid "+(isSelected?K.cy:K.bd)}},
h("div",{style:{fontSize:10,fontWeight:700,color:isSelected?K.cy:K.tx}},wkLabel),
h("div",{style:{fontSize:9,color:wk.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(wk.pl>=0?"+":"-")+"$"+Math.abs(wk.pl).toFixed(0)),
h("div",{style:{fontSize:8,color:K.dm}},wk.n+"tr "+(wk.w/wk.n*100).toFixed(0)+"%WR"),
isOpexWk?h("div",{style:{fontSize:7,color:K.go,fontWeight:700,marginTop:1}},"OPEX"):null),
TRADE_DAYS.map(function(day){
var dc=wk.days[day];
var cb=cellBg(dc?dc.pl:0,dc?dc.n:0);
var dayIdx=ALL_DAYS.indexOf(day);
var cellDate=new Date(wkStart);cellDate.setDate(cellDate.getDate()+dayIdx);
var opex=isOpex(cellDate.toISOString().slice(0,10));
return h("div",{key:day,
title:dc?day+" wk "+wkLabel+": "+dc.n+" trades, "+(dc.pl>=0?"+":"")+dc.pl.toFixed(2)+" P/L, "+(dc.w/dc.n*100).toFixed(0)+"% WR":day+" no trades",
style:{borderRadius:6,background:cb.bg,border:cb.bd,padding:"4px 4px",minHeight:48,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",position:"relative"}},
opex?h("span",{style:{position:"absolute",top:2,right:3,fontSize:6,color:K.go,fontWeight:700}},"OPEX"):null,
dc&&dc.n>0?h("div",{style:{textAlign:"center"}},
h("div",{style:{fontSize:9,fontWeight:700,color:cb.tc,fontFamily:"JetBrains Mono,monospace"}},(dc.pl>=0?"+":"-")+"$"+Math.abs(dc.pl).toFixed(0)),
h("div",{style:{fontSize:8,color:cb.tc,opacity:.85}},(dc.w/dc.n*100).toFixed(0)+"% WR"),
h("div",{style:{fontSize:7,color:K.dm}},dc.n+"tr")):
h("div",{style:{fontSize:8,color:K.bd}},"-"))
}))
}))
),
selWeekData?h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.cy,padding:12,position:"sticky",top:12,alignSelf:"start"}},
h("div",{style:{fontSize:11,fontWeight:700,color:K.cy,marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center"}},
"Week of "+new Date(selWeekData.key+"T12:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),
h("span",{style:{fontSize:10,color:K.dm,cursor:"pointer"},onClick:function(){setSelWeek(null)}},"x close")),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:10}},
[["P/L",(selWeekData.pl>=0?"+$":"-$")+Math.abs(selWeekData.pl).toFixed(2),selWeekData.pl>=0?K.g:K.r],
["Trades",""+selWeekData.n,K.tx],
["Win Rate",(selWeekData.w/selWeekData.n*100).toFixed(0)+"%",selWeekData.w/selWeekData.n>=.5?K.g:K.r],
["Avg R",(selWeekData.r/selWeekData.n).toFixed(2)+"R",selWeekData.r/selWeekData.n>=0?K.g:K.r]
].map(function(x){return h("div",{key:x[0],style:{background:K.bg,borderRadius:6,padding:"6px 8px",textAlign:"center"}},
h("div",{style:{fontSize:9,color:K.dm,marginBottom:2}},x[0]),
h("div",{style:{fontSize:13,fontWeight:700,color:x[2],fontFamily:"JetBrains Mono,monospace"}},x[1]))})),
h("div",{style:{fontSize:10,fontWeight:700,color:K.dm,marginBottom:6}},"Trades this week"),
h("div",{style:{display:"flex",flexDirection:"column",gap:3,maxHeight:320,overflowY:"auto"}},
selWeekData.trades.sort(function(a,b){return(a.date+a.time).localeCompare(b.date+b.time)}).map(function(t){
var p=cPL(t);
return h("div",{key:t.id,style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 6px",background:K.bg,borderRadius:4,fontSize:10}},
h("div",null,
h("div",{style:{color:K.tx,fontWeight:600}},t.ticker+" "+t.direction),
h("div",{style:{color:K.dm,fontSize:9}},t.date+" "+(t.time||""))),
h("div",{style:{textAlign:"right"}},
h("div",{style:{color:p.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace",fontWeight:700}},(p.pl>=0?"+$":"-$")+Math.abs(p.pl).toFixed(2)),
h("div",{style:{color:K.dm,fontSize:9}},p.r.toFixed(2)+"R")))}))
):null):null,
hmView==="grid"?h("div",null,
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:14,marginBottom:12}},
h("div",{style:{fontSize:11,color:K.dm,fontWeight:700,marginBottom:10,display:"flex",alignItems:"center"}},"DAY OF WEEK PERFORMANCE",h(Tip,{t:"P/L and win rate by day. Futures trade Sun-Fri."})),
h("div",{style:{display:"flex",gap:6}},dayArr.map(function(d){
return h("div",{key:d.day,style:{flex:1,padding:"10px 6px",background:K.bg,borderRadius:8,textAlign:"center",border:"1px solid "+(d.n>0&&d.pl>0?K.g+"44":d.n>0&&d.pl<0?K.r+"44":K.bd)}},
h("div",{style:{fontSize:11,fontWeight:700,color:K.tx,marginBottom:4}},d.day),
d.n>0?h("div",null,
h("div",{style:{fontSize:13,fontWeight:700,color:d.pl>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(d.pl>=0?"+":"-")+"$"+Math.abs(d.pl).toFixed(0)),
h("div",{style:{fontSize:10,color:d.w/d.n>=.5?K.g:K.r,marginTop:2}},(d.w/d.n*100).toFixed(0)+"% WR"),
h("div",{style:{fontSize:9,color:K.dm}},d.n+" trades"),
h("div",{style:{height:3,background:K.bd,borderRadius:2,marginTop:6,overflow:"hidden"}},
h("div",{style:{height:"100%",width:(Math.abs(d.pl)/maxDayPL*100)+"%",background:d.pl>=0?K.g:K.r,borderRadius:2}})))
:h("div",{style:{fontSize:9,color:K.dm,marginTop:4}},"no data"))}))
),
cp.filter(function(t){return t.date&&t.time}).length>=3?
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:14}},
h("div",{style:{fontSize:11,color:K.dm,fontWeight:700,marginBottom:12,display:"flex",alignItems:"center"}},"HOUR x DAY GRID  (Sun-Fri Futures)",h(Tip,{t:"Hours down left, days across top. Hover each cell for trade detail."})),
h("div",{style:{overflowX:"auto"}},
h("div",{style:{display:"inline-block"}},
h("div",{style:{display:"flex",marginBottom:4,paddingLeft:52}},
TRADE_DAYS.map(function(day){var ds=dayMap2[day];return h("div",{key:day,style:{width:COL,textAlign:"center",fontSize:10,fontWeight:700,color:ds&&ds.n>0&&ds.pl>0?K.g:ds&&ds.n>0&&ds.pl<0?K.r:K.dm,marginRight:3}},day)})),
HOURS.map(function(hr){
return h("div",{key:hr,style:{display:"flex",alignItems:"center",marginBottom:3}},
h("div",{style:{width:52,fontSize:10,color:hourMap[+hr]?K.tx:K.dm,fontWeight:hourMap[+hr]?600:400,flexShrink:0}},hr+":00"),
TRADE_DAYS.map(function(day){
var key=day+"_"+hr;var cell=gridMap[key];
var cb=cellBg(cell?cell.pl:0,cell?cell.n:0);
var txt=cell&&cell.n>0?(cell.pl>=0?"+":"-")+"$"+Math.abs(cell.pl).toFixed(0):"";
var subTxt=cell&&cell.n>0?(cell.w/cell.n*100).toFixed(0)+"%":"";
return h("div",{key:day,
title:cell?day+" "+hr+":00 - "+cell.n+" trade"+(cell.n>1?"s":"")+", "+(cell.pl>=0?"+":"")+cell.pl.toFixed(2)+" P/L, "+(cell.w/cell.n*100).toFixed(0)+"% WR":"No trades",
style:{width:COL,height:34,marginRight:3,background:cb.bg,border:cb.bd,borderRadius:5,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",fontSize:8,fontFamily:"JetBrains Mono,monospace",color:cb.tc}},
cell&&cell.n>0?h("div",{style:{textAlign:"center"}},
h("div",{style:{fontSize:8,lineHeight:1.2}},txt),
h("div",{style:{fontSize:7,opacity:.85}},subTxt)):null)}))
}))))
:h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:20,textAlign:"center",color:K.dm,fontSize:11}},"Log 3+ trades with entry times to see the hour grid.")):null,
(function(){
var ins=[];
var aDays=dayArr.filter(function(d){return d.n>=3});
if(aDays.length>=2){
var best=aDays.slice().sort(function(a,b){return b.pl-a.pl})[0];
var worst=aDays.slice().sort(function(a,b){return a.pl-b.pl})[0];
ins.push({type:"pos",text:"Best day: "+best.day+" (+$"+best.pl.toFixed(0)+", "+(best.w/best.n*100).toFixed(0)+"% WR, "+best.n+" trades)"});
if(worst.pl<0)ins.push({type:"neg",text:"Worst day: "+worst.day+" (-$"+Math.abs(worst.pl).toFixed(0)+", "+(worst.w/worst.n*100).toFixed(0)+"% WR, "+worst.n+" trades) — consider avoiding"});
}
var aHrs=Object.keys(hourMap).filter(function(hr){return hourMap[hr].n>=3}).map(function(hr){return{hr:hr,d:hourMap[hr]}});
if(aHrs.length>=2){
var bh=aHrs.slice().sort(function(a,b){return b.d.pl-a.d.pl})[0];
var wh=aHrs.slice().sort(function(a,b){return a.d.pl-b.d.pl})[0];
ins.push({type:"pos",text:"Best hour: "+bh.hr+":00 (+$"+bh.d.pl.toFixed(0)+", "+(bh.d.w/bh.d.n*100).toFixed(0)+"% WR, "+bh.d.n+" trades)"});
if(wh.d.pl<0)ins.push({type:"neg",text:"Avoid: "+wh.hr+":00 (-$"+Math.abs(wh.d.pl).toFixed(0)+", "+(wh.d.w/wh.d.n*100).toFixed(0)+"% WR, "+wh.d.n+" trades)"});
}
var wcell=null;
TRADE_DAYS.forEach(function(day){HOURS.forEach(function(hr){var k=day+"_"+hr;var c=gridMap[k];if(c&&c.n>=2&&c.pl<0){if(!wcell||c.pl<wcell.pl)wcell={day:day,hr:hr,pl:c.pl,n:c.n,wr:c.w/c.n}}})});
if(wcell)ins.push({type:"neg",text:"Dead zone: "+wcell.day+" "+wcell.hr+":00 (-$"+Math.abs(wcell.pl).toFixed(0)+", "+(wcell.wr*100).toFixed(0)+"% WR, "+wcell.n+" trades)"});
if(!ins.length)return null;
return h("div",{style:{marginTop:12,background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"12px 16px"}},
h("div",{style:{fontSize:11,fontWeight:700,color:K.tx,marginBottom:8}},"PATTERN INSIGHTS"),
ins.map(function(x,i){return h("div",{key:i,style:{display:"flex",gap:8,padding:"6px 0",borderTop:i>0?"1px solid "+K.bd:"none",alignItems:"flex-start"}},
h("span",{style:{color:x.type==="pos"?K.g:K.r,fontWeight:700,fontSize:12,marginTop:1}},x.type==="pos"?"✓":"⚠"),
h("span",{style:{fontSize:11,color:K.dm,lineHeight:1.5}},x.text))}));
})()
)};



// === EDUCATION TAB (proper React component - no useState outside App) ===
var EduTab=function(){
var _ec=React.useState("Strategies"),eduCat=_ec[0],setEduCat=_ec[1];
var _sel=React.useState(null),selId=_sel[0],setSelId=_sel[1];
var STRATS=[
{id:"ema_cloud",name:"EMA Cloud System",icon:"☁",cat:"Strategies",
desc:"An EMA cloud is built from two EMAs plotted with the area between them shaded — typically the 9 and 21 EMA, or 8 and 21. When price is above the cloud, bias is long. Below = short. Inside the cloud = no trade. The cloud gives a visual trend filter that avoids the noise of a single line.",
detail:"The cloud becomes most powerful when combined with a momentum indicator like MACD or RSI. The sequence is: (1) price must be on the correct side of the cloud, (2) cloud must be sloping in your direction, (3) momentum must confirm. A wide cloud means strong trend. A narrow or flat cloud means the trend is weakening — this is when you reduce size or sit out.",
tip:"Cloud width is a built-in volatility and trend strength gauge. Wide = trade with the trend. Narrow = be cautious. This journal tracks cloud width % — use the bucket analysis to find your optimal width range."},
{id:"macd",name:"MACD",icon:"📊",cat:"Strategies",
desc:"Moving Average Convergence Divergence measures momentum by comparing two EMAs (typically 12 and 26 period) and plotting their difference as the MACD line, along with a 9-period signal line. The histogram shows the gap between them — expanding histogram = accelerating momentum, shrinking = fading.",
detail:"For momentum scalping, the two most useful MACD signals are: (1) the histogram flipping from negative to positive (or vice versa) near a key level — this is the earliest entry signal, and (2) the MACD line crossing the signal line for confirmation. Divergence is the elite signal — price makes a new high but MACD histogram makes a lower high. This means momentum is dying before price reverses.",
tip:"MACD cross after a prolonged trend gives false signals in choppy markets. The histogram direction change is more reliable than the cross for early entries on short timeframes."},
{id:"rsi",name:"RSI",icon:"📈",cat:"Strategies",
desc:"Relative Strength Index measures the speed and magnitude of recent price moves on a 0-100 scale. Above 70 = overbought territory. Below 30 = oversold. But for momentum trading, overbought does not mean sell — in a strong trend, RSI can stay above 70 for extended periods.",
detail:"RSI has three uses in this system: (1) At entry — RSI at 50-65 on a long setup means momentum has room to run. RSI at 80+ on entry means you may be chasing. (2) At peak — RSI at peak MFE tells you how far momentum extended. If you consistently exit when RSI hits 75, compare to what RSI peaked at — are you leaving too early? (3) Divergence — the most powerful RSI signal. Price makes new high, RSI makes lower high = momentum is failing. This journal tracks RSI at entry, at peak, and at exit separately to analyze all three uses.",
tip:"RSI divergence before entry is one of the sharpest reversal signals. Price making a new low while RSI makes a higher low = bullish divergence. Always log it in the divergence field — the analysis will show whether divergence-confirmed entries outperform."},
{id:"adx",name:"ADX (Average Directional Index)",icon:"📉",cat:"Strategies",
desc:"ADX measures trend strength on a 0-100 scale, but it does NOT indicate direction — only strength. Below 20 = weak or no trend (range/chop). 20-25 = emerging trend. 25+ = confirmed trend. 40+ = very strong trend. Many momentum systems require ADX 25+ before taking a trade.",
detail:"ADX is the quality filter for your setups. A technically perfect entry pattern in a low-ADX environment has a much lower win rate than the same pattern with ADX 30+. This journal has an ADX bucket analysis that will show you exactly what your win rate is at each ADX range. Check it after 20+ trades — most traders find a clear threshold where their edge materializes.",
tip:"ADX lags price by definition — it tells you the trend that existed, not what is coming. Use it as a filter (only trade when ADX is above your threshold) rather than as an entry trigger. The entry trigger should come from price action and momentum."},
{id:"swing",name:"Swing Points (HH/HL/LH/LL)",icon:"🔁",cat:"Strategies",
desc:"Swing points are the foundational language of price structure. A Higher High (HH) and Higher Low (HL) sequence defines an uptrend. Lower High (LH) and Lower Low (LL) defines a downtrend. A break in structure — a new LH after an uptrend — is the earliest sign of a potential reversal.",
detail:"For continuation trades, you want to see HH/HL intact and enter on the pullback to the HL. The stop goes below the most recent HL. For reversal trades, you wait for a confirmed structural shift — price makes a LH, then breaks below the prior HL. That break of structure is your reversal entry signal. The 'LH/HL' rule in this journal tracks whether the structure was intact at your entry.",
tip:"The quality of a swing point matters. A swing high formed on high volume with a long upper wick is more significant than one formed on thin volume. Strong swing points hold under retest pressure. Weak ones get violated."},
{id:"channel",name:"Channel Analysis",icon:"📐",cat:"Strategies",
desc:"Price channels are formed by drawing parallel lines connecting swing highs and swing lows. An upward channel has higher highs and higher lows on parallel lines. The channel top is resistance, the bottom is support. Channels can be ascending, descending, or horizontal (range).",
detail:"Channel trading has two modes: (1) Range play — buy the bottom, sell the top, stop outside the channel. Works best when ADX is below 20 and price has touched each boundary at least twice. (2) Breakout play — price consolidates in a tight channel then breaks with volume. The measured move target is the channel width added to the breakout point. This journal tracks Chan Break and Chan Retest separately to show whether entering on the break or waiting for the retest works better for you.",
tip:"The more touches a channel boundary has, the more reliable it becomes — but also the more compressed the eventual breakout. Channels with 4+ touches on each side tend to produce explosive breakouts when they finally fail."},
{id:"divergence",name:"Divergence",icon:"⚡",cat:"Signals",
desc:"Divergence occurs when price and a momentum indicator disagree. Bullish divergence: price makes a lower low, but RSI or MACD makes a higher low. This means selling pressure is weakening despite price falling — a reversal signal. Bearish divergence is the mirror: price makes a higher high, but momentum makes a lower high.",
detail:"This journal tracks divergence in two places: before entry (should I take this trade?) and during the trade (should I exit?). Divergence before entry on a reversal setup is a high-confidence confluence. Divergence during a trade — particularly bearish divergence while you are long — is a warning that momentum is fading and you should consider tightening your stop or taking partial profits. The analysis engine will show whether your divergence-confirmed entries have a higher win rate than non-divergence entries.",
tip:"Hidden divergence is different from regular divergence. Hidden bullish divergence: price makes a higher low, RSI makes a lower low — this confirms the trend and suggests continuation, not reversal. It is an entry signal, not an exit warning. Regular divergence at market extremes (RSI 75+) carries more weight than divergence in the mid-range."},
{id:"volume",name:"Volume Analysis",icon:"🔊",cat:"Signals",
desc:"Volume is the fuel behind price moves. A breakout on high volume means institutional participation — the move is likely to continue. A breakout on low volume means retail-only participation — the move is likely to fail. Volume at exit tells you whether the move exhausted itself or still has buyers/sellers.",
detail:"This journal tracks volume at exit as Below Avg, At Avg, or Above Avg. The analysis will show whether your winning trades tend to exit into above-average volume (exhaustion top/bottom) or below-average volume (move faded quietly). For continuation trades, you want to see volume expanding in the direction of the trend and contracting on pullbacks — this confirms the trend is healthy and the pullback is just resting.",
tip:"Volume spikes on reversal candles carry the most information. A bearish engulfing candle on 3x average volume is a high-confidence reversal signal. The same candle on 0.5x volume is noise. Always note whether an important candle had volume confirmation."},
{id:"wyckoff",name:"Wyckoff Method",icon:"🏛",cat:"Advanced",
desc:"Wyckoff analysis focuses on the relationship between price, volume, and the behavior of large institutional operators (the Composite Man). Markets move through four phases: Accumulation (large operators buying quietly), Markup (uptrend as public joins), Distribution (large operators selling into strength), and Markdown (downtrend).",
detail:"Key Wyckoff events: Spring — a false break below support in accumulation that shakes out weak holders before the markup. Upthrust — false break above resistance in distribution. Sign of Strength (SOS) — a strong advance on increasing volume after a spring, confirming accumulation is complete. Last Point of Support (LPS) — the pullback after a SOS, the ideal entry point. Wyckoff analysis is most powerful on daily/weekly charts but principles apply intraday on liquid names like TSLA.",
tip:"The Spring is the most powerful Wyckoff entry. Price quickly violates support, finds no sellers, and snaps back above — the failure itself is the signal. Volume on the spring should be lower than prior down bars, and volume on the recovery should surge. A high-volume spring that fails to recover is a genuine breakdown, not a spring."},
{id:"ict",name:"ICT Concepts",icon:"🏦",cat:"Advanced",
desc:"ICT (Inner Circle Trader) concepts focus on institutional order flow, liquidity, and market maker behavior. The core idea is that markets move to seek liquidity — pools of stop orders and resting orders — before reversing. Retail traders place stops in predictable places (below swing lows, above swing highs), and institutional algorithms engineer moves to grab that liquidity before the real move.",
detail:"Key ICT concepts: Order Blocks — the last bearish candle before a strong bullish move (or last bullish before a strong bearish move). Price often returns to these levels for a reaction. Fair Value Gaps (FVG) — a 3-candle pattern where the wicks of the first and third candles do not overlap, leaving an imbalance that price tends to fill. Liquidity Sweeps — price quickly takes out a prior high/low and reverses, stopping out traders who had breakout entries. Killzones — specific high-probability time windows (NY Open 9:30-11am, London Open, etc.) when institutional flow is highest.",
tip:"ICT concepts work best when the direction of the higher timeframe narrative is clear. Identify whether the market is in a bullish or bearish expansion phase on the daily/4h, then look for order blocks and FVGs on the 1-5 minute chart that align with that bias. Trading ICT setups against the higher timeframe trend produces the worst results."}
];
var cats=["Strategies","Signals","Advanced"];
var filtered=STRATS.filter(function(s){return s.cat===eduCat});
return h("div",null,
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"12px 16px",marginBottom:12}},
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,marginBottom:4}},"Trading Education"),
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.5}},"Reference guides for the strategies and indicators built into this journal. Each entry covers the core concept, how to apply it in practice, and a pro tip from experience. Click any card to expand.")),
h("div",{style:{display:"flex",gap:4,marginBottom:12,flexWrap:"wrap"}},
cats.map(function(cat){return h("button",{key:cat,onClick:function(){setEduCat(cat);setSelId(null)},style:{padding:"5px 14px",borderRadius:6,border:"1px solid "+(eduCat===cat?K.cy:K.bd),fontSize:11,fontWeight:600,cursor:"pointer",background:eduCat===cat?K.cy+"22":"transparent",color:eduCat===cat?K.cy:K.dm}},cat)})),
h("div",{style:{display:"flex",flexDirection:"column",gap:8}},
filtered.map(function(s){
var isOpen=selId===s.id;
return h("div",{key:s.id,style:{background:K.cd,borderRadius:8,border:"1px solid "+(isOpen?K.cy:K.bd),padding:"12px 14px",cursor:"pointer"},
onClick:function(){setSelId(isOpen?null:s.id)}},
h("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:isOpen?8:0}},
h("span",{style:{fontSize:20,flexShrink:0}},s.icon),
h("div",{style:{flex:1}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx}},s.name),
h("div",{style:{fontSize:10,color:K.dm,marginTop:2,lineHeight:1.4,display:isOpen?"none":"block"}},s.desc.substring(0,120)+"...")),
h("div",{style:{fontSize:10,color:K.cy,flexShrink:0}},isOpen?"▲ collapse":"▼ expand")),
isOpen?h("div",null,
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.6,marginBottom:10}},s.desc),
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.6,marginBottom:10,borderLeft:"3px solid "+K.bd,paddingLeft:10}},s.detail),
h("div",{style:{background:K.bg,borderRadius:6,padding:"8px 12px",borderLeft:"3px solid "+K.cy}},
h("div",{style:{fontSize:9,color:K.cy,fontWeight:700,marginBottom:3}},"PRO TIP"),
h("div",{style:{fontSize:10,color:K.dm,lineHeight:1.5}},s.tip))):null)
})))};

// === NEWS TAB (proper React component) ===
var NewsTab=function(){
var _nc=React.useState("General"),newsCat=_nc[0],setNewsCat=_nc[1];
var FEEDS=[
{n:"Bloomberg Markets",u:"https://www.bloomberg.com/markets",d:"Institutional-grade financial news. Best for macro, Fed coverage, and pre-market context.",icon:"📰",cat:"General"},
{n:"Reuters Markets",u:"https://www.reuters.com/markets",d:"Fast, reliable breaking news. Strong on earnings reactions and global macro events.",icon:"🌐",cat:"General"},
{n:"MarketWatch",u:"https://www.marketwatch.com",d:"Broad market coverage with live quotes, earnings calendar, and economic data.",icon:"📊",cat:"General"},
{n:"Investor's Business Daily",u:"https://www.investors.com/market-trend/stock-market-today",d:"Daily market analysis focused on growth stocks and momentum setups.",icon:"📈",cat:"General"},
{n:"Finviz News",u:"https://finviz.com/news.ashx",d:"Real-time aggregated headlines from all major sources. Fast scanning for catalysts.",icon:"⚡",cat:"General"},
{n:"Benzinga",u:"https://www.benzinga.com/news",d:"Pre-market catalyst research. Known for fast options flow and earnings news.",icon:"🔔",cat:"General"},
{n:"MarketWatch Economic Calendar",u:"https://www.marketwatch.com/economy-politics/calendar",d:"MarketWatch's comprehensive economic and political event calendar. All major releases, Fed meetings, and earnings in one view.",icon:"🗓",cat:"Government"},
{n:"Fed Economic Calendar (FRED)",u:"https://fred.stlouisfed.org/releases",d:"Official Federal Reserve economic data releases. CPI, PPI, unemployment, GDP — all in one place with historical context.",icon:"🏛",cat:"Government"},
{n:"US Economic Calendar (BEA)",u:"https://www.bea.gov/news/schedule",d:"Bureau of Economic Analysis official release schedule. GDP, personal income, trade data.",icon:"🏦",cat:"Government"},
{n:"BLS Release Calendar",u:"https://www.bls.gov/schedule/news_release/",d:"Bureau of Labor Statistics. CPI, PPI, jobs report (NFP), unemployment — all official release dates.",icon:"📋",cat:"Government"},
{n:"US Treasury Announcements",u:"https://home.treasury.gov/news/press-releases",d:"Treasury auction schedules, bond issuance, and fiscal policy announcements that move rates and equities.",icon:"🏛",cat:"Government"},
{n:"CME FedWatch Tool",u:"https://www.cmegroup.com/markets/interest-rates/cme-fedwatch-tool.html",d:"Real-time market-implied probability of Fed rate changes at each meeting. Essential before trading rate-sensitive days.",icon:"🎯",cat:"Government"},
{n:"SEC EDGAR Filings",u:"https://efts.sec.gov/LATEST/search-index?q=%22TSLA%22&dateRange=custom&startdt=2024-01-01&forms=8-K",d:"Official SEC filings for TSLA. 8-K filings are market-moving disclosures — earnings, guidance changes, CEO announcements.",icon:"📋",cat:"Government"},
{n:"Earnings Whispers",u:"https://www.earningswhispers.com",d:"Earnings calendar with whisper numbers (the real expected number vs the official estimate). Know the bar before you trade earnings.",icon:"📅",cat:"Calendar"},
{n:"Forex Factory Calendar",u:"https://www.forexfactory.com/calendar",d:"The most comprehensive economic event calendar. Color-coded by market impact. Essential for pre-session awareness.",icon:"🗓",cat:"Calendar"},
{n:"Investing.com Calendar",u:"https://www.investing.com/economic-calendar",d:"Economic calendar with actual vs forecast vs prior data. Filter by country and impact level.",icon:"📅",cat:"Calendar"},
{n:"Market Chameleon Earnings",u:"https://marketchameleon.com/CalendarDay",d:"Options-implied earnings moves, historical earnings reactions, and IV rank — critical for sizing around events.",icon:"📊",cat:"Calendar"},
{n:"CBOE VIX",u:"https://www.cboe.com/tradable_products/vix",d:"Volatility index. High VIX means larger expected moves and wider stops needed. Low VIX means compressed ranges — reduce targets.",icon:"📉",cat:"Market"},
{n:"TSLA on Finviz",u:"https://finviz.com/quote.ashx?t=TSLA",d:"TSLA snapshot: news, chart, short float, institutional ownership, and options data.",icon:"🚗",cat:"Market"},
{n:"TradingView Screener",u:"https://www.tradingview.com/screener",d:"Real-time stock screener. Filter by gap %, relative volume, RSI, ADX, and 50+ other criteria.",icon:"🔍",cat:"Market"},
{n:"Unusual Whales",u:"https://unusualwhales.com",d:"Options flow tracking. Large unusual options activity often precedes big moves. Good for pre-market thesis building.",icon:"🐳",cat:"Market"}
];
var cats=["General","Government","Calendar","Market"];
var filtered=FEEDS.filter(function(f){return f.cat===newsCat});
return h("div",null,
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"12px 16px",marginBottom:12}},
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,marginBottom:4}},"Market Resources"),
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.5}},"Quick access to the sources that matter before and during the trading day. Government tab has all official data release schedules. All links open in a new tab."),
h("div",{style:{fontSize:10,color:K.go,marginTop:8,padding:"5px 10px",background:K.go+"11",borderRadius:5,border:"1px solid "+K.go+"33"}},"Paid v1: Live news feed filtered by your ticker with pre-session AI briefings auto-generated each morning.")),
h("div",{style:{display:"flex",gap:4,marginBottom:12,flexWrap:"wrap"}},
cats.map(function(cat){return h("button",{key:cat,onClick:function(){setNewsCat(cat)},style:{padding:"5px 14px",borderRadius:6,border:"1px solid "+(newsCat===cat?K.cy:K.bd),fontSize:11,fontWeight:600,cursor:"pointer",background:newsCat===cat?K.cy+"22":"transparent",color:newsCat===cat?K.cy:K.dm}},cat)})),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}},
filtered.map(function(f){
return h("a",{key:f.n,href:f.u,target:"_blank",rel:"noopener noreferrer",style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"12px 14px",textDecoration:"none",display:"block"}},
h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:6}},
h("span",{style:{fontSize:18}},f.icon),
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx}},f.n)),
h("div",{style:{fontSize:10,color:K.dm,lineHeight:1.5}},f.d),
h("div",{style:{fontSize:9,color:K.cy,marginTop:6}},"Open in new tab ↗"))
})))};


// === DONUT CHART COMPONENT ===
function Donut(p){
// p: value (0-100), size, color, label, sub, thickness
var sz=p.size||80,thick=p.thick||10,r=(sz-thick)/2,cx=sz/2,cy=sz/2;
var circ=2*Math.PI*r;
var pct=Math.max(0,Math.min(100,p.value||0));
var dash=circ*pct/100;
var gap=circ-dash;
return h("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",gap:4}},
h("div",{style:{position:"relative",width:sz,height:sz}},
h("svg",{width:sz,height:sz,viewBox:"0 0 "+sz+" "+sz},
h("circle",{cx:cx,cy:cy,r:r,fill:"none",stroke:K.bd,strokeWidth:thick}),
pct>0?h("circle",{cx:cx,cy:cy,r:r,fill:"none",stroke:p.color||K.cy,strokeWidth:thick,strokeDasharray:dash+" "+gap,strokeLinecap:"round",transform:"rotate(-90 "+cx+" "+cy+")",style:{transition:"stroke-dasharray 0.5s ease"}}):null),
h("div",{style:{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}},
h("div",{style:{fontSize:p.size>=80?14:11,fontWeight:700,color:p.color||K.tx,fontFamily:"JetBrains Mono,monospace",lineHeight:1}},pct+"%"),
p.sub?h("div",{style:{fontSize:8,color:K.dm,textAlign:"center",lineHeight:1.2,marginTop:2}},p.sub):null)),
p.label?h("div",{style:{fontSize:9,color:K.dm,textAlign:"center",maxWidth:sz,lineHeight:1.3}},p.label):null);}

// === RULE DONUT GRID ===
function RuleDonutGrid(p){
// p.yn = rule edge array, p.cp = complete trades
var yn=p.yn||[],cp=p.cp||[];
if(!yn.length||cp.length<5)return null;
return h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"14px 16px",marginBottom:14}},
h("div",{style:{fontSize:12,color:K.go,fontWeight:700,marginBottom:12}},"RULE WIN RATES — AT A GLANCE"),
h("div",{style:{display:"flex",flexWrap:"wrap",gap:14,justifyContent:"flex-start"}},
yn.filter(function(r){return r.w&&r.w.n>=3;}).slice(0,10).map(function(r,i){
var wr=Math.round(r.w.wr*100);
var color=wr>=65?K.g:wr>=50?K.go:K.r;
return h(Donut,{key:r.key,value:wr,size:78,thick:9,color:color,label:r.label,sub:r.w.n+" trades"});})));}

// === STAT CARD COMPONENT (enhanced) ===
function BigStat(p){
return h("div",{style:{background:K.cd,borderRadius:10,border:"1px solid "+K.bd,padding:"14px 16px",flex:1,minWidth:130}},
h("div",{style:{fontSize:9,color:K.dm,fontWeight:600,letterSpacing:"0.5px",textTransform:"uppercase",marginBottom:6}},p.label),
h("div",{style:{fontSize:24,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:p.color||K.tx,lineHeight:1,marginBottom:4}},p.value),
p.sub?h("div",{style:{fontSize:10,color:K.dm}},p.sub):null,
p.trend?h("div",{style:{fontSize:10,color:p.trend>0?K.g:K.r,marginTop:4}},p.trend>0?"▲":"▼"+" "+Math.abs(p.trend)+"%"):null);}

// === SPARKLINE ===
function Spark(p){
// p.data = array of numbers, p.color, p.width, p.height
var d=p.data||[],w=p.width||120,hh=p.height||32;
if(d.length<2)return null;
var mn=Math.min.apply(null,d),mx=Math.max.apply(null,d);
var rng=mx-mn||1;
var pts=d.map(function(v,i){var x=i/(d.length-1)*w;var y=hh-(v-mn)/rng*hh;return x+","+y;}).join(" ");
var zeroY=hh-(0-mn)/rng*hh;
return h("svg",{width:w,height:hh,style:{display:"block"}},
h("polyline",{points:pts,fill:"none",stroke:p.color||K.cy,strokeWidth:1.5,strokeLinejoin:"round",strokeLinecap:"round"}),
mn<0&&mx>0?h("line",{x1:0,y1:zeroY,x2:w,y2:zeroY,stroke:K.bd,strokeWidth:1,strokeDasharray:"3,3"}):null);}

// === DASHBOARD TAB ===
var DashboardTab=function(){
var _layout=us(function(){try{return JSON.parse(localStorage.getItem("tj5_dash_layout")||"null")||["pnl","winrate","bestsetup","emotion","adx","equity","rules","streaks"]}catch(e){return["pnl","winrate","bestsetup","emotion","adx","equity","rules","streaks"];}});
var layout=_layout[0],setLayout=_layout[1];
var _hidden=us(function(){try{return JSON.parse(localStorage.getItem("tj5_dash_hidden")||"[]")}catch(e){return [];}});
var hidden=_hidden[0],setHidden=_hidden[1];
var _drag=us(null),dragIdx=_drag[0],setDrag=_drag[1];
var _customize=us(false),customizing=_customize[0],setCustomize=_customize[1];

ue(function(){try{localStorage.setItem("tj5_dash_layout",JSON.stringify(layout));}catch(e){}},[layout]);
ue(function(){try{localStorage.setItem("tj5_dash_hidden",JSON.stringify(hidden));}catch(e){}},[hidden]);

var cp=mf.filter(function(t){return t.entry&&t.exit&&t.shares;});
var stats=um(function(){
if(!cp.length)return null;
var rs=cp.map(cPL);
var wins=rs.filter(function(r){return r.pl>0;});
var losses=rs.filter(function(r){return r.pl<=0;});
var totalPL=rs.reduce(function(s,r){return s+r.pl;},0);
var winRate=wins.length/rs.length;
var avgR=rs.reduce(function(s,r){return s+r.rm;},0)/rs.length;
var pf=losses.reduce(function(s,r){return s+Math.abs(r.pl);},0)>0?wins.reduce(function(s,r){return s+r.pl;},0)/Math.abs(losses.reduce(function(s,r){return s+r.pl;},0)):0;
// Equity curve
var cumPL=[];var running=0;cp.forEach(function(t){running+=cPL(t).pl;cumPL.push(running);});
// Win streak
var streak=0,best=0,cur=0;rs.forEach(function(r){if(r.pl>0){cur++;best=Math.max(best,cur);}else cur=0;});
// Losing streak
var lstreak=0,lcur=0;rs.forEach(function(r){if(r.pl<=0){lcur++;lstreak=Math.max(lstreak,lcur);}else lcur=0;});
// Best day
var dayPL={};cp.forEach(function(t){if(!dayPL[t.date])dayPL[t.date]=0;dayPL[t.date]+=cPL(t).pl;});
var days=Object.values(dayPL);var bestDay=Math.max.apply(null,days);var worstDay=Math.min.apply(null,days);
// Emotion best
var emBk={};cp.filter(function(t){return t.emotion;}).forEach(function(t){if(!emBk[t.emotion])emBk[t.emotion]=[];emBk[t.emotion].push(cPL(t).pl);});
var emArr=Object.keys(emBk).map(function(k){var r=emBk[k];return{em:k,n:r.length,wr:r.filter(function(v){return v>0;}).length/r.length};}).filter(function(x){return x.n>=3;}).sort(function(a,b){return b.wr-a.wr;});
// ADX
var adxBks=[
{l:"<20",t:cp.filter(function(t){return t.adxAtEntry&&+t.adxAtEntry<20;})},
{l:"20-25",t:cp.filter(function(t){return t.adxAtEntry&&+t.adxAtEntry>=20&&+t.adxAtEntry<25;})},
{l:"25+",t:cp.filter(function(t){return t.adxAtEntry&&+t.adxAtEntry>=25;})}].filter(function(b){return b.t.length>=2;}).map(function(b){return{l:b.l,wr:gs(b.t).wr,n:b.t.length};});
// Top combo
var ar=RK.filter(function(k){return cp.filter(function(t){return t.rules&&t.rules[k]==="Y";}).length>=2;});
var combos2=[];for(var ci=0;ci<ar.length;ci++){for(var cj=ci+1;cj<ar.length;cj++){var both=cp.filter(function(t){return t.rules&&t.rules[ar[ci]]==="Y"&&t.rules[ar[cj]]==="Y";});if(both.length>=3){combos2.push({rules:[RL[ar[ci]],RL[ar[cj]]],s:gs(both),n:both.length});}}}combos2.sort(function(a,b){return b.s.wr-a.s.wr;});
return{totalPL:totalPL,winRate:winRate,avgR:avgR,pf:pf,n:cp.length,cumPL:cumPL,bestStreak:best,lossStreak:lstreak,bestDay:bestDay,worstDay:worstDay,emArr:emArr,adxBks:adxBks,bestCombo:combos2[0]||null,wins:wins.length,losses:losses.length};
},[cp.length,md]);

var yn=ra.yn||[];

function toggleHide(id){setHidden(function(p){return p.includes(id)?p.filter(function(x){return x!==id;}):p.concat([id]);});}

// Drag reorder
function onDragStart(i){setDrag(i);}
function onDragOver(e,i){e.preventDefault();if(dragIdx===null||dragIdx===i)return;}
function onDrop(e,i){e.preventDefault();if(dragIdx===null||dragIdx===i){setDrag(null);return;}setLayout(function(prev){var nl=prev.slice();var item=nl.splice(dragIdx,1)[0];nl.splice(i,0,item);return nl;});setDrag(null);}

var allWidgets={
pnl:{label:"Total P&L",render:function(){if(!stats)return null;return h(BigStat,{label:"Total P&L",value:(stats.totalPL>=0?"$+":"$-")+Math.abs(stats.totalPL).toFixed(0),color:stats.totalPL>=0?K.g:K.r,sub:stats.n+" trades logged"});}},
winrate:{label:"Win Rate",render:function(){if(!stats)return null;return h("div",{style:{display:"flex",alignItems:"center",gap:16,background:K.cd,borderRadius:10,border:"1px solid "+K.bd,padding:"14px 16px",flex:1,minWidth:130}},h(Donut,{value:Math.round(stats.winRate*100),size:72,thick:9,color:stats.winRate>=0.55?K.g:stats.winRate>=0.4?K.go:K.r}),h("div",null,h("div",{style:{fontSize:9,color:K.dm,fontWeight:600,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:4}},"Win Rate"),h("div",{style:{fontSize:12,color:K.dm}},"Avg R: ",h("span",{style:{color:stats.avgR>=0?K.g:K.r,fontWeight:700,fontFamily:"JetBrains Mono,monospace"}},stats.avgR.toFixed(2)+"R")),h("div",{style:{fontSize:12,color:K.dm}},"PF: ",h("span",{style:{color:stats.pf>=1.5?K.g:stats.pf>=1?K.go:K.r,fontWeight:700,fontFamily:"JetBrains Mono,monospace"}},stats.pf.toFixed(2)))));}},
bestsetup:{label:"Best Setup",render:function(){if(!stats||!stats.bestCombo)return null;var c=stats.bestCombo;return h("div",{style:{background:K.cd,borderRadius:10,border:"1px solid "+K.bd,padding:"14px 16px",flex:1,minWidth:200}},h("div",{style:{fontSize:9,color:K.dm,fontWeight:600,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:6}},"Best Setup Combo"),h("div",{style:{fontSize:13,fontWeight:700,color:K.tx,marginBottom:4}},c.rules.join(" + ")),h("div",{style:{display:"flex",gap:12}},h("div",{style:{fontSize:20,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:K.g}},Math.round(c.s.wr*100)+"%"),h("div",null,h("div",{style:{fontSize:10,color:K.dm}},"win rate"),h("div",{style:{fontSize:10,color:K.dm}},c.n+" trades"))));}},
emotion:{label:"Emotion Edge",render:function(){if(!stats||!stats.emArr||stats.emArr.length<2)return null;var best=stats.emArr[0],worst=stats.emArr[stats.emArr.length-1];return h("div",{style:{background:K.cd,borderRadius:10,border:"1px solid "+K.bd,padding:"14px 16px",flex:1,minWidth:200}},h("div",{style:{fontSize:9,color:K.dm,fontWeight:600,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:8}},"Emotion Edge"),h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},stats.emArr.slice(0,5).map(function(e){var pct=Math.round(e.wr*100);var c2=pct>=60?K.g:pct>=45?K.go:K.r;return h("div",{key:e.em,style:{display:"flex",flexDirection:"column",alignItems:"center",gap:3}},h(Donut,{value:pct,size:56,thick:7,color:c2}),h("div",{style:{fontSize:8,color:K.dm,textTransform:"capitalize",textAlign:"center"}},e.em));})));}},
adx:{label:"ADX Zones",render:function(){if(!stats||!stats.adxBks||stats.adxBks.length<2)return null;return h("div",{style:{background:K.cd,borderRadius:10,border:"1px solid "+K.bd,padding:"14px 16px",flex:1,minWidth:200}},h("div",{style:{fontSize:9,color:K.dm,fontWeight:600,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:8}},"ADX Win Rate by Zone"),h("div",{style:{display:"flex",gap:12,alignItems:"flex-end",flexWrap:"wrap"}},stats.adxBks.map(function(b){var pct=Math.round(b.wr*100);var c2=pct>=60?K.g:pct>=45?K.go:K.r;return h("div",{key:b.l,style:{display:"flex",flexDirection:"column",alignItems:"center",gap:3}},h(Donut,{value:pct,size:64,thick:8,color:c2,sub:b.n+"tr"}),h("div",{style:{fontSize:9,color:K.dm}},b.l));})));}},
equity:{label:"Equity Curve",render:function(){if(!stats||!stats.cumPL||stats.cumPL.length<3)return null;var last=stats.cumPL[stats.cumPL.length-1];return h("div",{style:{background:K.cd,borderRadius:10,border:"1px solid "+K.bd,padding:"14px 16px",flex:1,minWidth:260}},h("div",{style:{fontSize:9,color:K.dm,fontWeight:600,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:8}},"Equity Curve"),h("div",{style:{marginBottom:6}},h(Spark,{data:stats.cumPL,color:last>=0?K.g:K.r,width:300,height:52})),h("div",{style:{display:"flex",justifyContent:"space-between",fontSize:10}},h("span",{style:{color:K.dm}},"Best day: ",h("span",{style:{color:K.g,fontFamily:"JetBrains Mono,monospace"}},"$"+stats.bestDay.toFixed(0))),h("span",{style:{color:K.dm}},"Worst: ",h("span",{style:{color:K.r,fontFamily:"JetBrains Mono,monospace"}},"$"+stats.worstDay.toFixed(0)))));}},
rules:{label:"Rule Win Rates",render:function(){if(!yn.length||cp.length<5)return null;return h(RuleDonutGrid,{yn:yn,cp:cp});}},
streaks:{label:"Streaks & Consistency",render:function(){if(!stats)return null;return h("div",{style:{background:K.cd,borderRadius:10,border:"1px solid "+K.bd,padding:"14px 16px",flex:1,minWidth:200}},h("div",{style:{fontSize:9,color:K.dm,fontWeight:600,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:8}},"Streaks & Days"),h("div",{style:{display:"flex",gap:10,flexWrap:"wrap"}},h(BigStat,{label:"Best Win Streak",value:stats.bestStreak+"W",color:K.g}),h(BigStat,{label:"Worst Lose Streak",value:stats.lossStreak+"L",color:K.r}),h(BigStat,{label:"Best Day",value:"$"+stats.bestDay.toFixed(0),color:K.g}),h(BigStat,{label:"Worst Day",value:"$"+stats.worstDay.toFixed(0),color:K.r})));}}
};

if(!stats||cp.length===0)return h("div",{style:{padding:"40px 20px",textAlign:"center"}},
h("div",{style:{fontSize:40,marginBottom:12}},"📊"),
h("div",{style:{fontSize:16,fontWeight:700,color:K.tx,marginBottom:8}},"Dashboard unlocks after your first logged trade"),
h("div",{style:{fontSize:12,color:K.dm}},"Log a trade with entry, exit, and shares to see your dashboard."));

return h("div",null,
// Header with customize toggle
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}},
h("div",{style:{fontSize:13,fontWeight:700,color:K.tx}},"Dashboard"),
h("button",{onClick:function(){setCustomize(!customizing)},style:{background:customizing?K.cy+"22":"transparent",border:"1px solid "+(customizing?K.cy:K.bd),borderRadius:6,color:customizing?K.cy:K.dm,fontSize:10,padding:"4px 10px",cursor:"pointer",fontWeight:600}},customizing?"✓ Done Customizing":"⚙ Customize")),
// Customize panel
customizing?h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"12px 16px",marginBottom:12}},
h("div",{style:{fontSize:11,color:K.dm,marginBottom:8}},"Show/hide widgets • Drag cards below to reorder"),
h("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},Object.keys(allWidgets).map(function(id){var vis=!hidden.includes(id);return h("button",{key:id,onClick:function(){toggleHide(id);},style:{padding:"4px 10px",borderRadius:20,border:"1px solid "+(vis?K.g:K.bd),background:vis?K.g+"22":"transparent",color:vis?K.g:K.dm,fontSize:10,cursor:"pointer",fontWeight:600}},vis?"✓ ":"",(allWidgets[id]||{label:id}).label);}))):null,
// Widget grid — drag to reorder
h("div",{style:{display:"flex",flexWrap:"wrap",gap:10}},
layout.filter(function(id){return !hidden.includes(id)&&allWidgets[id];}).map(function(id,i){var w=allWidgets[id];var rendered=w.render();if(!rendered)return null;
return h("div",{key:id,draggable:true,onDragStart:function(){onDragStart(i);},onDragOver:function(e){onDragOver(e,i);},onDrop:function(e){onDrop(e,i);},style:{cursor:customizing?"grab":"default",opacity:dragIdx===i?0.5:1,flex:"1 1 250px",transition:"opacity 0.2s"}},rendered);})));};

// === INSIGHTS TAB ===
function IBarRow(p){
var pct=Math.round((p.wr||0)*100);
var bc=pct>=55?K.g:pct>=40?K.go:K.r;
return h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4}},
h("div",{style:{width:p.lw||70,fontSize:11,color:K.tx,flexShrink:0}},p.label),
h("div",{style:{flex:1,height:6,background:K.bd,borderRadius:3}},
h("div",{style:{width:Math.min(pct,100)+"%",height:"100%",background:bc,borderRadius:3}})),
h("div",{style:{width:36,fontSize:11,fontFamily:"JetBrains Mono,monospace",color:bc,textAlign:"right",flexShrink:0}},pct+"%"),
h("div",{style:{width:55,fontSize:10,color:K.dm,textAlign:"right",flexShrink:0}},p.n+" trades"));}

function ITier(n){
if(n>=500)return{label:"⭐ All-Star",color:"#f0b429"};
if(n>=100)return{label:"🔒 Confirmed",color:"#2ed573"};
if(n>=50) return{label:"✅ Solid",color:"#4fc3f7"};
if(n>=25) return{label:"📈 Building",color:"#a78bfa"};
return      {label:"🌱 Emerging",color:"#f0b429"};}

function ICard(p){
var _o=React.useState(false),open=_o[0],setOpen=_o[1];
var t=ITier(p.n||0);
return h("div",{style:{background:K.cd,borderRadius:12,border:"1px solid "+(p.alert?"#ff6b8155":K.bd),padding:"20px 24px",marginBottom:12}},
h("div",{style:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:12}},
h("div",{style:{flex:1}},
h("div",{style:{display:"flex",alignItems:"center",gap:10,marginBottom:10}},
h("span",{style:{fontSize:28}},p.icon||"📊"),
h("div",null,
h("div",{style:{fontSize:10,fontWeight:700,color:t.color,fontFamily:"JetBrains Mono,monospace",letterSpacing:"0.5px"}},t.label),
h("div",{style:{fontSize:9,color:K.dm}},(p.n||0)+" trades")),
h("span",{style:{marginLeft:8,background:p.alert?"#ff6b8133":"#1e2d3d",color:p.alert?K.r:K.dm,fontSize:10,padding:"2px 8px",borderRadius:12,fontWeight:600}},p.tag||"")),
h("div",{style:{fontSize:15,fontWeight:700,color:K.tx,lineHeight:1.4,marginBottom:6}},p.headline),
h("div",{style:{fontSize:12,color:K.dm,lineHeight:1.6,marginBottom:p.action?10:0}},p.body),
p.action?h("div",{style:{display:"inline-flex",alignItems:"center",gap:6,background:p.alert?"#ff6b8122":"#2ed57322",border:"1px solid "+(p.alert?"#ff6b8155":"#2ed57355"),borderRadius:20,padding:"4px 12px"}},
h("span",{style:{fontSize:11}},p.alert?"⚠️":"✅"),
h("span",{style:{fontSize:11,fontWeight:700,color:p.alert?K.r:K.g}},p.action)):null),
h("div",{style:{textAlign:"right",flexShrink:0}},
h("div",{style:{fontSize:24,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:p.mc||K.cy}},p.meta||""),
p.meta2?h("div",{style:{fontSize:11,color:K.dm}},p.meta2):null)),
p.rows?h("div",null,
h("button",{onClick:function(){setOpen(!open)},style:{background:"transparent",border:"none",color:K.cy,fontSize:11,cursor:"pointer",fontWeight:600,padding:"6px 0 0 0"}},open?"▲ Less info":"▾ More info"),
open?h("div",{style:{marginTop:8,padding:"12px",background:K.bg,borderRadius:8,border:"1px solid "+K.bd}},
h("div",{style:{fontSize:10,color:K.dm,marginBottom:8}},p.rowLabel||""),
p.rows.map(function(r,i){return h(IBarRow,{key:i,label:r.l,wr:r.wr,n:r.n,lw:p.lw});})):null):null);}

function PoolCard(p){
var s=p.stats;
return h("div",{style:{flex:1,minWidth:180,background:K.bg,borderRadius:10,border:"2px solid "+(p.color+"44"),padding:"14px 16px"}},
h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
h("div",{style:{fontSize:18}}),
h("div",null,
h("div",{style:{fontSize:12,fontWeight:700,color:p.color}}),
h("div",{style:{fontSize:10,color:K.dm}},(p.days||0)+" days · "+(p.count||0)+" trades"))),
s?h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}},
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase",letterSpacing:"0.5px"}},"Win Rate"),h("div",{style:{fontSize:18,fontWeight:700,color:s.wr>=0.5?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(s.wr*100).toFixed(0)+"%")),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase",letterSpacing:"0.5px"}},"Avg R"),h("div",{style:{fontSize:18,fontWeight:700,color:s.ar>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},s.ar.toFixed(2)+"R")),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase",letterSpacing:"0.5px"}},"Total P/L"),h("div",{style:{fontSize:13,fontWeight:700,color:s.tp>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(s.tp>=0?"+$":"-$")+Math.abs(s.tp).toFixed(0))),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase",letterSpacing:"0.5px"}},"Profit Factor"),h("div",{style:{fontSize:13,fontWeight:700,color:s.pf>=1.5?K.g:s.pf>=1?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},s.pf>=999?"∞":s.pf.toFixed(2)))):
h("div",{style:{fontSize:11,color:K.dm,fontStyle:"italic"}},"Need 3+ trades"));}
function GapRow(p){
var gap=p.live-p.bt;
var gapDir=p.higherIsBetter?(gap>=0?"positive":"negative"):(gap<=0?"positive":"negative");
return h("div",{style:{display:"flex",alignItems:"center",gap:8,padding:"8px 12px",background:K.bg,borderRadius:6}},
h("div",{style:{fontSize:10,color:K.dm,minWidth:110}},p.label),
h("div",{style:{flex:1,display:"flex",gap:16}},
h("div",null,h("div",{style:{fontSize:8,color:K.dm,marginBottom:2}},"LIVE"),h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,fontFamily:"JetBrains Mono,monospace"}},p.liveStr)),
h("div",null,h("div",{style:{fontSize:8,color:K.pu,marginBottom:2}},"BACKTEST"),h("div",{style:{fontSize:14,fontWeight:700,color:K.pu,fontFamily:"JetBrains Mono,monospace"}},p.btStr))),
h("div",{style:{fontSize:11,fontWeight:700,color:gapDir==="positive"?K.g:K.r,fontFamily:"JetBrains Mono,monospace",minWidth:48,textAlign:"right"}},
(gap>=0?"+":"")+p.gapStr));}
var InsightsTab=function(){
// mf is mode-filtered trades, already computed in outer scope
var cp=mf.filter(function(t){return t.entry&&t.exit&&t.shares;});
var insCards=[];

if(cp.length<10){
return h("div",{style:{padding:"48px 20px",textAlign:"center"}},
h("div",{style:{fontSize:48,marginBottom:16}},"📊"),
h("div",{style:{fontSize:18,fontWeight:700,color:K.tx,marginBottom:8}},"Insights unlock at 10 trades"),
h("div",{style:{fontSize:13,color:K.dm,maxWidth:380,margin:"0 auto 20px",lineHeight:1.7}},"Log "+(10-cp.length)+" more trades and your first insights appear here. Every trade makes them sharper."),
h("div",{style:{display:"flex",justifyContent:"center",gap:6,flexWrap:"wrap"}},
[["🌱","10+ Emerging"],["📈","25+ Building"],["✅","50+ Solid"],["🔒","100+ Confirmed"],["⭐","500+ All-Star"]].map(function(x){return h("div",{key:x[1],style:{fontSize:10,color:K.dm,background:K.bg,border:"1px solid "+K.bd,borderRadius:12,padding:"3px 10px"}},x[0]+" "+x[1]);})));}

// 1. Followed Rules
var frT=cp.filter(function(t){return t.followedRules==="Y";});
var fnT=cp.filter(function(t){return t.followedRules==="N";});
if(frT.length>=5&&fnT.length>=3){
var frS=gs(frT),fnS=gs(fnT),edgePct=Math.round((frS.wr-fnS.wr)*100);
if(Math.abs(edgePct)>=10){
insCards.push({section:"Your Discipline",icon:"⭐",tag:"Rule Discipline",n:frT.length+fnT.length,
headline:edgePct>0?"Following your rules wins "+edgePct+"% more often":"You win more when you break your rules — time to review them",
body:edgePct>0?"With rules: "+Math.round(frS.wr*100)+"% win rate ("+frT.length+" trades). Without: "+Math.round(fnS.wr*100)+"% ("+fnT.length+" trades). Rule-break trades are costing you real money.":"Your rules-off win rate ("+Math.round(fnS.wr*100)+"%) beats following them ("+Math.round(frS.wr*100)+"%). Your instincts may be ahead of your written rules.",
action:edgePct>0?"Skip trades that don't meet your rules":"Consider updating your rules to match what's actually working",
alert:edgePct<0,meta:Math.round(frS.wr*100)+"%",meta2:"w/ rules",mc:K.g,
rows:[{l:"With Rules",wr:frS.wr,n:frT.length},{l:"Breaking Rules",wr:fnS.wr,n:fnT.length}],
rowLabel:"Win rate: following rules vs breaking them",lw:100});}}

// 2. Best combo
var ar=RK.filter(function(k){return cp.filter(function(t){return t.rules&&t.rules[k]==="Y";}).length>=2;});
var combos=[];
for(var ci=0;ci<ar.length;ci++){for(var cj=ci+1;cj<ar.length;cj++){
var both=cp.filter(function(t){return t.rules&&t.rules[ar[ci]]==="Y"&&t.rules[ar[cj]]==="Y";});
if(both.length>=5){combos.push({rules:[RL[ar[ci]],RL[ar[cj]]],s:gs(both),n:both.length});}}}
combos.sort(function(a,b){return b.s.wr-a.s.wr;});
if(combos.length>=1){
var best=combos[0];
insCards.push({section:"Your Best Setup",icon:"🎯",tag:"Top Combo",n:best.n,
headline:best.rules.join(" + ")+" is your strongest setup",
body:"Win rate: "+Math.round(best.s.wr*100)+"% across "+best.n+" trades. Avg reward: "+(best.s.ar?best.s.ar.toFixed(1)+"R":"—")+". When both conditions line up this is your A+ entry.",
action:"Prioritize this combination when scanning for entries",
meta:Math.round(best.s.wr*100)+"%",meta2:"win rate",mc:K.g,
rows:combos.slice(0,4).map(function(c){return{l:c.rules.join(" + "),wr:c.s.wr,n:c.n};}),
rowLabel:"Top combos by win rate (5+ trades):",lw:160});}

// 3. Emotion
var emBk={};
cp.filter(function(t){return t.emotion;}).forEach(function(t){if(!emBk[t.emotion])emBk[t.emotion]=[];emBk[t.emotion].push(t);});
var emArr=Object.keys(emBk).map(function(k){return{em:k,n:emBk[k].length,s:gs(emBk[k])};}).filter(function(x){return x.n>=5;}).sort(function(a,b){return a.s.wr-b.s.wr;});
if(emArr.length>=2){
var wEm=emArr[0],bEm=emArr[emArr.length-1];
insCards.push({section:"Your Emotional Edge",icon:"🧠",tag:"Emotion Impact",n:cp.filter(function(t){return t.emotion;}).length,
headline:"You win "+Math.round(bEm.s.wr*100)+"% when "+bEm.em+" — only "+Math.round(wEm.s.wr*100)+"% when "+wEm.em,
body:"Your emotional state measurably changes your outcomes. Best state: "+bEm.em+" ("+Math.round(bEm.s.wr*100)+"% win rate). Worst: "+wEm.em+" ("+Math.round(wEm.s.wr*100)+"%). That gap is real money.",
action:"Consider stopping or sizing down when feeling "+wEm.em,alert:wEm.s.wr<0.38,
meta:Math.round(bEm.s.wr*100)+"%",meta2:"when "+bEm.em,mc:K.g,
rows:emArr.slice().sort(function(a,b){return b.s.wr-a.s.wr;}).map(function(e){return{l:e.em.charAt(0).toUpperCase()+e.em.slice(1),wr:e.s.wr,n:e.n};}),
rowLabel:"Win rate by emotional state at entry:",lw:90});}

// 4. ADX
var adxT=cp.filter(function(t){return t.adxAtEntry;});
if(adxT.length>=10){
var adxBks=[{l:"< 20",t:adxT.filter(function(t){return+t.adxAtEntry<20;})},{l:"20-25",t:adxT.filter(function(t){var v=+t.adxAtEntry;return v>=20&&v<25;})},{l:"25+",t:adxT.filter(function(t){return+t.adxAtEntry>=25;})}].filter(function(b){return b.t.length>=3;}).map(function(b){return{l:b.l,wr:gs(b.t).wr,n:b.t.length};});
if(adxBks.length>=2){
adxBks.sort(function(a,b){return b.wr-a.wr;});
var bADX=adxBks[0],wADX=adxBks[adxBks.length-1];
var adxDiff=Math.round((bADX.wr-wADX.wr)*100);
if(adxDiff>=10)insCards.push({section:"Market Conditions",icon:"📡",tag:"ADX Conditions",n:adxT.length,
headline:"Your edge is "+adxDiff+"% stronger when ADX is "+bADX.l,
body:"ADX "+bADX.l+": "+Math.round(bADX.wr*100)+"% win rate. ADX "+wADX.l+": "+Math.round(wADX.wr*100)+"% win rate. Your strategy needs trending conditions to perform.",
action:"Use ADX "+bADX.l+" as a filter before entering",
meta:Math.round(bADX.wr*100)+"%",meta2:"ADX "+bADX.l,mc:K.cy,
rows:adxBks.map(function(b){return{l:"ADX "+b.l,wr:b.wr,n:b.n};}),
rowLabel:"Win rate by ADX range at entry:",lw:65});}}

// 5. Trade # of day
var tnT=cp.filter(function(t){return t.tradeNumOfDay;});
if(tnT.length>=10){
var tnBks=[{l:"#1-2",t:tnT.filter(function(t){return+t.tradeNumOfDay<=2;})},{l:"#3-4",t:tnT.filter(function(t){var v=+t.tradeNumOfDay;return v>=3&&v<=4;})},{l:"#5+",t:tnT.filter(function(t){return+t.tradeNumOfDay>=5;})}].filter(function(b){return b.t.length>=3;}).map(function(b){return{l:b.l,wr:gs(b.t).wr,n:b.t.length};});
if(tnBks.length>=2){
tnBks.sort(function(a,b){return a.wr-b.wr;});
var wTN=tnBks[0];
if(wTN.wr<0.45)insCards.push({section:"Session Behavior",icon:"🕐",tag:"Trade Timing",n:tnT.length,
headline:"Your "+wTN.l+" trades drag down your performance — "+Math.round(wTN.wr*100)+"% win rate",
body:"Performance drops as the session goes on. Trade "+wTN.l+" win rate: "+Math.round(wTN.wr*100)+"%. Your early trades significantly outperform your later ones — a classic overtrading and fatigue pattern.",
action:"Consider a hard stop after your best-performing trade number",alert:true,
meta:Math.round(wTN.wr*100)+"%",meta2:"at "+wTN.l,mc:K.r,
rows:tnBks.slice().sort(function(a,b){return a.l.localeCompare(b.l);}).map(function(b){return{l:"Trade "+b.l,wr:b.wr,n:b.n};}),
rowLabel:"Win rate by trade number in session:",lw:80});}}

// 6. Top rule by edge
var ynArr=RK.map(function(k){var wi=cp.filter(function(t){return t.rules&&t.rules[k]==="Y";}),wo=cp.filter(function(t){return t.rules&&t.rules[k]==="N";});return{key:k,label:RL[k],wiS:gs(wi),woS:gs(wo),edge:gs(wi).wr-gs(wo).wr,n:wi.length+wo.length};});
var topRule=ynArr.filter(function(r){return r.wiS.cnt>=5&&r.woS.n>=3&&Math.abs(r.edge)>=0.12;}).sort(function(a,b){return Math.abs(b.edge)-Math.abs(a.edge);})[0];
if(topRule){
insCards.push({section:"Your Best Rule",icon:"📏",tag:"Rule Edge",n:topRule.n,
headline:topRule.label+" makes a "+Math.round(Math.abs(topRule.edge)*100)+"% difference",
body:"With "+topRule.label+": "+Math.round(topRule.wiS.wr*100)+"% win rate ("+topRule.wiS.n+" trades). Without: "+Math.round(topRule.woS.wr*100)+"% ("+topRule.woS.n+" trades). This is your most predictive single condition.",
action:topRule.edge>0?"Always confirm "+topRule.label+" before entering":"Be cautious when "+topRule.label+" is your only reason to trade",
meta:Math.round(Math.abs(topRule.edge)*100)+"%",meta2:"edge",mc:K.cy,
rows:ynArr.filter(function(r){return r.wiS.n>=5&&Math.abs(r.edge)>=0.05;}).sort(function(a,b){return Math.abs(b.edge)-Math.abs(a.edge);}).slice(0,5).map(function(r){return{l:r.label,wr:r.wiS.wr,n:r.wiS.n};}),
rowLabel:"Top rules by win rate when present:",lw:130});}

if(insCards.length===0)return h("div",{style:{padding:"40px 20px",textAlign:"center"}},
h("div",{style:{fontSize:40,marginBottom:12}},"📊"),
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,marginBottom:6}},"Keep logging"),
h("div",{style:{fontSize:12,color:K.dm}},"More data needed to surface reliable patterns."));

var secs={};
insCards.forEach(function(c){if(!secs[c.section])secs[c.section]=[];secs[c.section].push(c);});

return h("div",null,
h("div",{style:{background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:"16px 20px",marginBottom:16}},
h("div",{style:{fontSize:15,fontWeight:700,color:K.tx,marginBottom:4}},"Your Trading Insights"),
h("div",{style:{fontSize:12,color:K.dm,lineHeight:1.6}},"The most actionable findings from your data. Cards show what's working and what's costing you money. Tap 'More info' on any card to see the numbers behind the finding."),
h("div",{style:{marginTop:10,display:"flex",gap:6,flexWrap:"wrap"}},
[["🌱","10+"],["📈","25+"],["✅","50+"],["🔒","100+"],["⭐","500+"]].map(function(x){return h("div",{key:x[1],style:{fontSize:10,color:K.dm,background:K.bg,border:"1px solid "+K.bd,borderRadius:12,padding:"2px 10px"}},x[0]+" "+x[1]+" trades");})),
h("div",{style:{marginTop:10,fontSize:11,color:K.dm}},"💡 Tag days as ",h("span",{style:{color:K.g,fontWeight:700}},"G"),"/",h("span",{style:{color:K.r,fontWeight:700}},"B"),"/","— in the Log to build your Good/Bad day pools.")),

// Good / Bad day comparison block
(function(){
var goodDates=Object.keys(dayTags).filter(function(d){return dayTags[d]==="good"});
var badDates=Object.keys(dayTags).filter(function(d){return dayTags[d]==="bad"});
if(!goodDates.length&&!badDates.length)return null;
var goodTrades=cp.filter(function(t){return goodDates.indexOf(t.date)>=0});
var badTrades=cp.filter(function(t){return badDates.indexOf(t.date)>=0});
var untagTrades=cp.filter(function(t){return !dayTags[t.date]});
var goodS=goodTrades.length>=3?gs(goodTrades):null;
var badS=badTrades.length>=3?gs(badTrades):null;
var allS=cp.length>=3?gs(cp):null;


// Rule breakdown for good vs bad
var goodRuleEdges=[];
var badRuleEdges=[];
if(goodTrades.length>=5&&badTrades.length>=5){
RK.forEach(function(k){
var gY=goodTrades.filter(function(t){return t.rules[k]==="Y"});
var gN=goodTrades.filter(function(t){return t.rules[k]==="N"});
var bY=badTrades.filter(function(t){return t.rules[k]==="Y"});
var bN=badTrades.filter(function(t){return t.rules[k]==="N"});
var gRate=gY.length>0?(gY.filter(function(t){return cPL(t).pl>0}).length/gY.length):null;
var bRate=bY.length>0?(bY.filter(function(t){return cPL(t).pl>0}).length/bY.length):null;
if(gRate!==null&&bRate!==null&&Math.abs(gRate-bRate)>=0.1){
goodRuleEdges.push({label:RL[k],goodWR:gRate,badWR:bRate,diff:gRate-bRate,gN:gY.length,bN:bY.length});}});
goodRuleEdges.sort(function(a,b){return Math.abs(b.diff)-Math.abs(a.diff)});
goodRuleEdges=goodRuleEdges.slice(0,5);}

return h("div",{style:{marginBottom:20}},
h("div",{style:{fontSize:11,fontWeight:700,color:K.dm,letterSpacing:"1px",textTransform:"uppercase",marginBottom:10,paddingBottom:4,borderBottom:"1px solid "+K.bd}},"Day Pool Comparison"),
h("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginBottom:16}},
goodDates.length>0?h("div",{style:{flex:1,minWidth:180,background:K.bg,borderRadius:10,border:"2px solid "+K.g+"44",padding:"14px 16px"}},
h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.g}},"✓ Good Days"),
h("div",{style:{fontSize:10,color:K.dm}},"("+goodDates.length+" days · "+goodTrades.length+" trades)")),
goodS?h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}},
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Win Rate"),h("div",{style:{fontSize:18,fontWeight:700,color:goodS.wr>=0.5?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(goodS.wr*100).toFixed(0)+"%")),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Avg R"),h("div",{style:{fontSize:18,fontWeight:700,color:goodS.ar>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},goodS.ar.toFixed(2)+"R")),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Total P/L"),h("div",{style:{fontSize:13,fontWeight:700,color:goodS.tp>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(goodS.tp>=0?"+$":"-$")+Math.abs(goodS.tp).toFixed(0))),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Prof Factor"),h("div",{style:{fontSize:13,fontWeight:700,color:goodS.pf>=1.5?K.g:goodS.pf>=1?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},goodS.pf>=999?"∞":goodS.pf.toFixed(2)))):
h("div",{style:{fontSize:11,color:K.dm,fontStyle:"italic"}},"Need 3+ trades")):null,
badDates.length>0?h("div",{style:{flex:1,minWidth:180,background:K.bg,borderRadius:10,border:"2px solid "+K.r+"44",padding:"14px 16px"}},
h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.r}},"✕ Bad Days"),
h("div",{style:{fontSize:10,color:K.dm}},"("+badDates.length+" days · "+badTrades.length+" trades)")),
badS?h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}},
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Win Rate"),h("div",{style:{fontSize:18,fontWeight:700,color:badS.wr>=0.5?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(badS.wr*100).toFixed(0)+"%")),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Avg R"),h("div",{style:{fontSize:18,fontWeight:700,color:badS.ar>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},badS.ar.toFixed(2)+"R")),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Total P/L"),h("div",{style:{fontSize:13,fontWeight:700,color:badS.tp>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(badS.tp>=0?"+$":"-$")+Math.abs(badS.tp).toFixed(0))),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Prof Factor"),h("div",{style:{fontSize:13,fontWeight:700,color:badS.pf>=1.5?K.g:badS.pf>=1?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},badS.pf>=999?"∞":badS.pf.toFixed(2)))):
h("div",{style:{fontSize:11,color:K.dm,fontStyle:"italic"}},"Need 3+ trades")):null,
allS?h("div",{style:{flex:1,minWidth:180,background:K.bg,borderRadius:10,border:"1px solid "+K.bd,padding:"14px 16px"}},
h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.dm}},"Overall"),
h("div",{style:{fontSize:10,color:K.dm}},"(all "+cp.length+" trades)")),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}},
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Win Rate"),h("div",{style:{fontSize:18,fontWeight:700,color:allS.wr>=0.5?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(allS.wr*100).toFixed(0)+"%")),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Avg R"),h("div",{style:{fontSize:18,fontWeight:700,color:allS.ar>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},allS.ar.toFixed(2)+"R")),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Total P/L"),h("div",{style:{fontSize:13,fontWeight:700,color:allS.tp>=0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(allS.tp>=0?"+$":"-$")+Math.abs(allS.tp).toFixed(0))),
h("div",null,h("div",{style:{fontSize:9,color:K.dm,textTransform:"uppercase"}},"Prof Factor"),h("div",{style:{fontSize:13,fontWeight:700,color:allS.pf>=1.5?K.g:allS.pf>=1?K.go:K.r,fontFamily:"JetBrains Mono,monospace"}},allS.pf>=999?"∞":allS.pf.toFixed(2))))):null),
goodRuleEdges.length>0?h("div",null,
h("div",{style:{fontSize:11,fontWeight:700,color:K.dm,marginBottom:8}},"Rules that behave differently on Good vs Bad days"),
h("div",{style:{display:"flex",flexDirection:"column",gap:4}},goodRuleEdges.map(function(r,i){
return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:10,background:K.bg,borderRadius:6,padding:"8px 12px"}},
h("div",{style:{fontSize:11,fontWeight:600,color:K.tx,minWidth:110}},r.label),
h("div",{style:{flex:1,display:"flex",gap:6,alignItems:"center"}},
h("span",{style:{fontSize:10,color:K.g}},"G: "+(r.goodWR*100).toFixed(0)+"%"),
h("span",{style:{fontSize:10,color:K.dm}},"vs"),
h("span",{style:{fontSize:10,color:K.r}},"B: "+(r.badWR*100).toFixed(0)+"%")),
h("div",{style:{fontSize:11,fontWeight:700,color:r.diff>0?K.g:K.r,fontFamily:"JetBrains Mono,monospace"}},(r.diff>0?"+":"")+Math.round(r.diff*100)+"%"));}))) :null);
})(),
Object.keys(secs).map(function(sec){return h("div",{key:sec},
h("div",{style:{fontSize:11,fontWeight:700,color:K.dm,letterSpacing:"1px",textTransform:"uppercase",marginBottom:8,marginTop:16,paddingBottom:4,borderBottom:"1px solid "+K.bd}},sec),
secs[sec].map(function(c,i){return h(ICard,{key:i,icon:c.icon,tag:c.tag,n:c.n,headline:c.headline,body:c.body,action:c.action,alert:c.alert,meta:c.meta,meta2:c.meta2,mc:c.mc,rows:c.rows,rowLabel:c.rowLabel,lw:c.lw});}));}),

// BT vs Live gap section

(function(){
var live=trades.filter(function(t){return (t.mode||"live")==="live"&&t.entry&&t.exit&&t.shares});
var bt=trades.filter(function(t){return t.mode==="backtest"&&t.entry&&t.exit&&t.shares});
if(live.length<5||bt.length<5)return null;
var lS=gs(live),bS=gs(bt);
var lFR=live.filter(function(t){return t.followedRules==="Y"}).length/live.length;
var bFR=bt.filter(function(t){return t.followedRules==="Y"}).length/bt.length;
var lDurs=live.filter(function(t){return cDur(t)}).map(function(t){return cDur(t).m});
var bDurs=bt.filter(function(t){return cDur(t)}).map(function(t){return cDur(t).m});
var lAvgDur=lDurs.length?lDurs.reduce(function(s,x){return s+x},0)/lDurs.length:null;
var bAvgDur=bDurs.length?bDurs.reduce(function(s,x){return s+x},0)/bDurs.length:null;
// Trades per day
var lDays={};live.forEach(function(t){lDays[t.date]=(lDays[t.date]||0)+1});
var bDays={};bt.forEach(function(t){bDays[t.date]=(bDays[t.date]||0)+1});
var lTPD=Object.values(lDays).reduce(function(s,x){return s+x},0)/(Object.keys(lDays).length||1);
var bTPD=Object.values(bDays).reduce(function(s,x){return s+x},0)/(Object.keys(bDays).length||1);
// Avg capture
var lCaps=live.filter(function(t){return cMFE(t)&&cMFE(t).cp!==null}).map(function(t){return cMFE(t).cp});
var bCaps=bt.filter(function(t){return cMFE(t)&&cMFE(t).cp!==null}).map(function(t){return cMFE(t).cp});
var lCap=lCaps.length?lCaps.reduce(function(s,x){return s+x},0)/lCaps.length:null;
var bCap=bCaps.length?bCaps.reduce(function(s,x){return s+x},0)/bCaps.length:null;
var wrGap=Math.round((bS.wr-lS.wr)*100);
var rGap=(bS.ar-lS.ar).toFixed(2);
var frGap=Math.round((bFR-lFR)*100);

// Generate narrative
var lines=[];
if(Math.abs(wrGap)>=5){
lines.push(wrGap>0?"Your backtest win rate is "+Math.round(bS.wr*100)+"% vs "+Math.round(lS.wr*100)+"% live — a "+wrGap+"pt gap. Something changes when real money is on the line.":"Your live win rate ("+Math.round(lS.wr*100)+"%) actually beats backtest ("+Math.round(bS.wr*100)+"%). Your execution under pressure is solid.")}
if(Math.abs(frGap)>=10){
lines.push(frGap>0?"You follow your rules "+Math.round(bFR*100)+"% of the time in backtest but only "+Math.round(lFR*100)+"% live. That "+frGap+"pt discipline gap is measurable — and costly.":"Interesting: you\u2019re more disciplined live ("+Math.round(lFR*100)+"%) than in backtest ("+Math.round(bFR*100)+"%). Possibly more selective when it counts.")}
if(lAvgDur&&bAvgDur&&Math.abs(lAvgDur-bAvgDur)>=5){
lines.push(lAvgDur<bAvgDur?"You hold trades "+Math.round(bAvgDur)+"min in backtest but cut them to "+Math.round(lAvgDur)+"min live. You\u2019re exiting early \u2014 fear is costing you time in winners.":"You actually hold longer live ("+Math.round(lAvgDur)+"min vs "+Math.round(bAvgDur)+"min BT). That patience might be working for you, or it might mean you\u2019re hesitating to cut losers.")}
if(Math.abs(lTPD-bTPD)>=1.5){
lines.push(lTPD>bTPD?"You\u2019re taking "+lTPD.toFixed(1)+" trades/day live vs "+bTPD.toFixed(1)+" in backtest. More live trades usually means more forced setups. Watch if that extra volume is diluting your edge.":"You take fewer trades live ("+lTPD.toFixed(1)+"/day vs "+bTPD.toFixed(1)+" BT). Either you\u2019re more selective \u2014 good \u2014 or hesitation is making you miss setups.")}
if(lCap&&bCap&&Math.abs(lCap-bCap)>=0.1){
lines.push(lCap<bCap?"You capture "+Math.round(bCap*100)+"% of the move in backtest but only "+Math.round(lCap*100)+"% live. You\u2019re leaving money on the table in real trades \u2014 likely exiting before the move completes.":"Your live capture ("+Math.round(lCap*100)+"%) beats backtest ("+Math.round(bCap*100)+"%). You\u2019re actually executing better than you practice.")}
if(!lines.length){lines.push("Your live and backtest performance are closely matched across the metrics that matter. That\u2019s rare \u2014 it means your practice actually mirrors your real execution.")}

return h("div",{style:{marginTop:24,marginBottom:8}},
h("div",{style:{fontSize:11,fontWeight:700,color:K.dm,letterSpacing:"1px",textTransform:"uppercase",marginBottom:8,paddingBottom:4,borderBottom:"1px solid "+K.bd}},"Live vs Backtest — The Execution Gap"),
h("div",{style:{background:K.cd,borderRadius:10,border:"1px solid "+K.bd,padding:"16px 18px",marginBottom:12,boxShadow:K.sdw}},
lines.map(function(l,i){return h("p",{key:i,style:{fontSize:12,color:K.tx,lineHeight:1.7,marginBottom:i<lines.length-1?10:0}},l);})),
h("div",{style:{display:"flex",flexDirection:"column",gap:4}},
h(GapRow,{label:"Win Rate",live:lS.wr,bt:bS.wr,liveStr:Math.round(lS.wr*100)+"%",btStr:Math.round(bS.wr*100)+"%",gapStr:wrGap+"pt",higherIsBetter:true}),
h(GapRow,{label:"Avg R",live:lS.ar,bt:bS.ar,liveStr:lS.ar.toFixed(2)+"R",btStr:bS.ar.toFixed(2)+"R",gapStr:rGap+"R",higherIsBetter:true}),
h(GapRow,{label:"Rules Followed",live:lFR,bt:bFR,liveStr:Math.round(lFR*100)+"%",btStr:Math.round(bFR*100)+"%",gapStr:frGap+"pt",higherIsBetter:true}),
lAvgDur&&bAvgDur?h(GapRow,{label:"Avg Duration",live:lAvgDur,bt:bAvgDur,liveStr:Math.round(lAvgDur)+"m",btStr:Math.round(bAvgDur)+"m",gapStr:Math.round(lAvgDur-bAvgDur)+"m",higherIsBetter:false}):null,
h(GapRow,{label:"Trades/Day",live:lTPD,bt:bTPD,liveStr:lTPD.toFixed(1),btStr:bTPD.toFixed(1),gapStr:(lTPD-bTPD>0?"+":"")+((lTPD-bTPD).toFixed(1)),higherIsBetter:false}),
lCap&&bCap?h(GapRow,{label:"Avg Capture",live:lCap,bt:bCap,liveStr:Math.round(lCap*100)+"%",btStr:Math.round(bCap*100)+"%",gapStr:Math.round((lCap-bCap)*100)+"pt",higherIsBetter:true}):null));
})(),

// Selection Insights — wakes up when 3+ trades selected
(function(){
var selSize=analysisGroup&&analysisGroup.ids?analysisGroup.ids.size:0;
var dormant=selSize<3;
return h("div",{style:{marginTop:24,background:K.cd,borderRadius:10,border:"1px solid "+(dormant?K.bd:K.cy+"44"),padding:"16px 18px",boxShadow:K.sdw}},
h("div",{style:{fontSize:11,fontWeight:700,color:dormant?K.dm:K.cy,letterSpacing:"1px",textTransform:"uppercase",marginBottom:dormant?0:12}},"Selection Insights"),
dormant?h("div",{style:{fontSize:11,color:K.dm,marginTop:4,lineHeight:1.6}},"Select 3+ trades using the ",h("span",{style:{color:K.cy,fontWeight:600}},"SEL")," button in the Log to unlock insights on that specific group."):
(function(){
var selIds=analysisGroup.ids;
var sel=cp.filter(function(t){return selIds.has(t.id)});
var all=cp;
var sS=gs(sel),aS=gs(all);
var wrDiff=Math.round((sS.wr-aS.wr)*100);
var rDiff=(sS.ar-aS.ar).toFixed(2);
var selFR=sel.filter(function(t){return t.followedRules==="Y"}).length/(sel.length||1);
var allFR=all.filter(function(t){return t.followedRules==="Y"}).length/(all.length||1);
var selDurs=sel.filter(function(t){return cDur(t)}).map(function(t){return cDur(t).m});
var avgSelDur=selDurs.length?selDurs.reduce(function(s,x){return s+x},0)/selDurs.length:null;
var allDurs=all.filter(function(t){return cDur(t)}).map(function(t){return cDur(t).m});
var avgAllDur=allDurs.length?allDurs.reduce(function(s,x){return s+x},0)/allDurs.length:null;

// Detect anomalies and write narrative
var nLines=[];
if(wrDiff>=15){nLines.push("This group hit "+Math.round(sS.wr*100)+"% — that\u2019s "+wrDiff+" points above your average. Something was clicking. Worth asking what was different about these setups.")}
else if(wrDiff<=-15){nLines.push("Only "+Math.round(sS.wr*100)+"% win rate in this group vs your "+Math.round(aS.wr*100)+"% average. That\u2019s a "+Math.abs(wrDiff)+"pt drop. These trades had something in common that hurt you.")}
else{nLines.push("This group performed close to your baseline \u2014 "+Math.round(sS.wr*100)+"% vs your average of "+Math.round(aS.wr*100)+"%.")}
if(Math.abs(parseFloat(rDiff))>=0.5){nLines.push(parseFloat(rDiff)>0?"Avg R of "+sS.ar.toFixed(2)+" vs your normal "+aS.ar.toFixed(2)+"R. These trades weren\u2019t just winning more — they were winning bigger.":"Avg R dropped to "+sS.ar.toFixed(2)+" here vs "+aS.ar.toFixed(2)+"R overall. Even the wins may have been undersized.")}
if(selFR<allFR-0.15){nLines.push("Rules followed dropped to "+Math.round(selFR*100)+"% in this group vs "+Math.round(allFR*100)+"% normally. Discipline was off during this stretch.")}
if(avgSelDur&&avgAllDur&&Math.abs(avgSelDur-avgAllDur)>=8){nLines.push(avgSelDur>avgAllDur?"You held "+Math.round(avgSelDur)+"min on average here vs your usual "+Math.round(avgAllDur)+"min. Patience or hesitation \u2014 the results tell you which.":"Shorter holds in this group ("+Math.round(avgSelDur)+"min vs "+Math.round(avgAllDur)+"min avg). You were decisive \u2014 or reactive.")}

// Check trade density (was this an overtrading period?)
var selDates={};sel.forEach(function(t){selDates[t.date]=(selDates[t.date]||0)+1});
var selTPD=Object.values(selDates).reduce(function(s,x){return s+x},0)/(Object.keys(selDates).length||1);
var allDates={};all.forEach(function(t){allDates[t.date]=(allDates[t.date]||0)+1});
var allTPD=Object.values(allDates).reduce(function(s,x){return s+x},0)/(Object.keys(allDates).length||1);
if(selTPD>allTPD*1.5){nLines.push(selTPD.toFixed(1)+" trades/day in this group vs your average of "+allTPD.toFixed(1)+". That\u2019s "+Math.round((selTPD/allTPD-1)*100)+"% more volume than normal. The data suggests you may have been forcing it.")}

return h("div",null,
h("div",{style:{fontSize:11,color:K.dm,marginBottom:8}},sel.length+" trades selected \u00b7 "+analysisGroup.label),
nLines.map(function(l,i){return h("p",{key:i,style:{fontSize:12,color:K.tx,lineHeight:1.7,marginBottom:i<nLines.length-1?8:0}},l);}));})()); })()
);};
// === AI IMPORT TAB ===
function StepNum(p){return h("div",{style:{background:p.color||K.go,color:"#000",fontWeight:700,fontSize:11,fontFamily:"JetBrains Mono,monospace",width:22,height:22,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:1}},p.n)}
function AnnCard(p){return h("div",{style:{background:K.bg,borderRadius:6,padding:"8px 12px",borderLeft:"3px solid "+p.color,marginBottom:4}},h("div",{style:{fontSize:11,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:p.color,marginBottom:2}},p.label),h("div",{style:{fontSize:10,color:K.dm,lineHeight:1.4}},p.desc))}
var AIImportTab=function(){
var _sec=React.useState("setup"),sec=_sec[0],setSec=_sec[1];
var SECS=[["setup","1. Pine Setup"],["annotate","2. Annotate"],["prompt","3. AI Prompt"],["ref","Quick Ref"]];

var PINE_URL="https://github.com/chrispi5707-blip/trade-journal-v3/blob/main/pine_dashboard.pine";

var AI_PROMPT=`I am uploading two screenshots from TradingView — one from my trade entry and one from my trade exit. Each screenshot contains a data panel created by a Pine Script indicator.

Please read both screenshots carefully and return a single JSON object in the exact format below.

READING INSTRUCTIONS:
- The panel in the corner shows all indicator values as labeled text — read them directly
- Horizontal rays on the chart are labeled: E (entry price), STP (stop), TGT (target), X (exit), MFE (best price reached), MAE (worst drawdown), with price values visible on the y-axis
- Vertical lines mark ETIME (entry time) and XTIME (exit time)
- Manual rule labels on the chart: UHL=Y/N, LHHL=Y/N, CB=Y/N, CR=Y/N, 2C=Y/N
- Auto rules are shown in the panel under the AUTO RULES section
- If a value is not visible or unclear, use "" (empty string) — do not guess

Return ONLY the JSON object, no explanation:

{
  "date": "YYYY-MM-DD",
  "time": "HH:MM",
  "exitTime": "HH:MM",
  "ticker": "",
  "timeframe": "",
  "direction": "Long or Short",
  "type": "Reversal or Continuation",
  "mode": "live or backtest",
  "entry": "",
  "stop": "",
  "exit": "",
  "shares": "",
  "mfe": "",
  "mae": "",
  "adxAtEntry": "",
  "cloudWidthPct": "",
  "cloudDirection": "Bullish or Bearish or None",
  "rsiAtEntry": "",
  "rsiAtPeak": "",
  "rsiAtExit": "",
  "divBefore": "Bullish or Bearish or None",
  "divDuring": "Bullish or Bearish or None",
  "maeTiming": "Dip First or Run First",
  "volumeAtExit": "Below Avg or At Avg or Above Avg",
  "exitType": "Trail or Limit or Stopped",
  "sessionRead": "Trending or Ranging or Choppy or Breakout or Reversal",
  "confidence": "",
  "emotion": "calm or eager or fomo or frustrated or angry or revenge or bored",
  "emotionDuring": "",
  "emotionAfter": "",
  "followedRules": "Y or N",
  "notes": "",
  "rules": {
    "ultHL": "Y or N",
    "lhHL": "Y or N",
    "chanBreak": "Y or N",
    "chanRetest": "Y or N",
    "candleOff10": "Y or N",
    "secondCandle": "Y or N",
    "macdCross": "Y or N",
    "cloudAlign": "Y or N",
    "rsiExtreme": "Y or N",
    "cloud15m": "Y or N"
  },
  "stopMgmt": {
    "initStop": "Y or N",
    "stopChan": "Y or N",
    "trailHL": "Y or N",
    "trailFailHL": "Y or N",
    "stopMoved": "Y or N",
    "reentry": "Y or N"
  }
}`;

var _copied=React.useState(false),copied=_copied[0],setCopied=_copied[1];
function copyPrompt(){
try{navigator.clipboard.writeText(AI_PROMPT);setCopied(true);setTimeout(function(){setCopied(false)},2500)}
catch(e){}}

function Tip2(p){return h("div",{style:{background:K.bg,borderLeft:"3px solid "+K.go,padding:"7px 12px",borderRadius:"0 6px 6px 0",margin:"8px 0"}},h("div",{style:{fontSize:10,color:K.dm,lineHeight:1.5}},h("span",{style:{color:K.go,fontWeight:700}},"Tip: "),p.t))}

return h("div",null,
// Header
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"12px 16px",marginBottom:12}},
h("div",{style:{fontSize:14,fontWeight:700,color:K.go,marginBottom:4,fontFamily:"JetBrains Mono,monospace"}},"◉ AI SCREENSHOT IMPORT — BETA"),
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.6}},"Two-screenshot workflow: screenshot your chart at entry and exit → upload to Claude or any vision AI → receive ready-to-import JSON. Install the Pine Script dashboard indicator in TradingView once, then the whole process takes under 90 seconds per trade."),
h("div",{style:{marginTop:8,display:"flex",gap:6,flexWrap:"wrap"}},
h("a",{href:PINE_URL,target:"_blank",style:{padding:"5px 12px",background:K.go+"22",border:"1px solid "+K.go,borderRadius:6,color:K.go,fontSize:11,fontWeight:700,textDecoration:"none",cursor:"pointer"}},"↓ Download Pine Script"),
h("div",{style:{padding:"5px 12px",background:K.cy+"11",border:"1px solid "+K.cy+"44",borderRadius:6,color:K.dm,fontSize:10}},"Beta — accuracy improves with clean annotations"))),

// Section nav
h("div",{style:{display:"flex",gap:4,marginBottom:12,flexWrap:"wrap"}},
SECS.map(function(s){return h("button",{key:s[0],onClick:function(){setSec(s[0])},style:{padding:"5px 14px",borderRadius:6,border:"1px solid "+(sec===s[0]?K.go:K.bd),fontSize:11,fontWeight:600,cursor:"pointer",background:sec===s[0]?K.go+"22":"transparent",color:sec===s[0]?K.go:K.dm}},s[1])})),

// SECTION 1: PINE SETUP
sec==="setup"?h("div",null,
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx,marginBottom:10}},"Install the Dashboard Indicator in TradingView"),
[
["1","Open TradingView and load any chart. Click Pine Editor at the bottom of the screen.",K.go],
["2","Click New → delete all default code → paste the entire pine_dashboard.pine file contents. Download it from the link above.",K.go],
["3","Click Add to chart. A data panel appears in the top-right corner showing all your indicator values.",K.go],
["4","Click the Settings gear on the indicator. Set your EMA lengths, MACD periods, RSI length, and ADX threshold to match your system. Defaults: 9/21 EMA cloud, 10 EMA, MACD 12/26/9, RSI 14, ADX 14.",K.go],
["5","Before each trade, open indicator settings and set Direction (Long/Short), Type (Reversal/Continuation), Mode (Live/Backtest), and Screenshot Type (Entry/Exit). These appear in the panel so AI reads them correctly.",K.go]
].map(function(s){return h("div",{key:s[0],style:{display:"flex",gap:10,marginBottom:10,alignItems:"flex-start"}},
h(StepNum,{n:s[0],color:s[2]}),
h("div",{style:{fontSize:12,color:K.dm,lineHeight:1.5}},s[1]))}),
h(Tip2,{t:"The panel auto-calculates: ADX, RSI, cloud direction and width, MACD state, volume vs average, session estimate, and 5 auto-detected rules. You only need to annotate the 5 judgment-based rules manually."}),
h("div",{style:{background:K.bg,borderRadius:6,padding:"10px 14px",marginTop:8}},
h("div",{style:{fontSize:11,fontWeight:700,color:K.go,marginBottom:6}},"AUTO-DETECTED (panel reads these for you)"),
["Cloud Align","MACD Cross","RSI Extreme","15m Cloud Align","1st Candle off 10 EMA"].map(function(r){return h("div",{key:r,style:{fontSize:10,color:K.dm,padding:"2px 0"}},h("span",{style:{color:K.g,marginRight:6}},"✓"),r)}),
h("div",{style:{fontSize:11,fontWeight:700,color:K.r,marginBottom:6,marginTop:10}},"MANUAL (you annotate these on chart)"),
["Ultimate H/L","LH/HL Sequence","Channel Break","Channel Retest","2nd Candle Entry"].map(function(r){return h("div",{key:r,style:{fontSize:10,color:K.dm,padding:"2px 0"}},h("span",{style:{color:K.go,marginRight:6}},"→"),r)}))
):null,

// SECTION 2: ANNOTATIONS
sec==="annotate"?h("div",null,
h("div",{style:{fontSize:12,color:K.dm,marginBottom:10,lineHeight:1.5}},"Use TradingView's drawing tools to mark price levels. Use Horizontal Ray (Alt+H) for prices, Vertical Line for times. Double-click any drawing to edit its label — the label is what AI reads."),

h("div",{style:{fontSize:12,fontWeight:700,color:K.g,marginBottom:8,paddingBottom:4,borderBottom:"1px solid "+K.bd}},"ENTRY SCREENSHOT ANNOTATIONS"),
h(AnnCard,{color:K.g,   label:"E",      desc:"Green horizontal ray at your exact entry price. The price label on the y-axis is what AI reads."}),
h(AnnCard,{color:K.r,   label:"STP",    desc:"Red horizontal ray at your stop loss level."}),
h(AnnCard,{color:K.cy,  label:"TGT",    desc:"Blue ray at your profit target. Optional but helps AI calculate your planned R."}),
h(AnnCard,{color:K.go,  label:"ETIME",  desc:"Vertical line at your entry candle. Label it ETIME to confirm exact entry time."}),
h("div",{style:{marginTop:10,marginBottom:6,fontSize:11,fontWeight:700,color:K.go}},"Manual rules — add as text labels anywhere on the chart:"),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4}},
[["UHL=Y or UHL=N","Ultimate H/L present?"],["LHHL=Y or LHHL=N","LH/HL sequence confirmed?"],["CB=Y or CB=N","Channel Break present?"],["CR=Y or CR=N","Channel Retest confirmed?"],["2C=Y or 2C=N","2nd Candle Entry taken?"]].map(function(r){
return h("div",{key:r[0],style:{background:K.bg,borderRadius:6,padding:"6px 10px",borderLeft:"2px solid "+K.go}},
h("div",{style:{fontSize:10,fontFamily:"JetBrains Mono,monospace",color:K.go,marginBottom:2}},r[0]),
h("div",{style:{fontSize:9,color:K.dm}},r[1]))})),

h("div",{style:{fontSize:12,fontWeight:700,color:K.cy,marginBottom:8,marginTop:14,paddingBottom:4,borderBottom:"1px solid "+K.bd}},"EXIT SCREENSHOT ANNOTATIONS"),
h(AnnCard,{color:K.cy,  label:"X",      desc:"Ray at your exact exit price. Label it X."}),
h(AnnCard,{color:K.g,   label:"MFE",    desc:"Ray at the best price the trade reached — highest point for a long, lowest for a short."}),
h(AnnCard,{color:K.r,   label:"MAE",    desc:"Ray at the worst price against you during the trade."}),
h(AnnCard,{color:K.go,  label:"XTIME",  desc:"Vertical line at your exit candle."}),
h(AnnCard,{color:K.go,  label:"RSIPEAK=XX", desc:"Optional text label near the MFE ray. Example: RSIPEAK=74.2. If omitted AI estimates from panel."}),
h(Tip2,{t:"MFE and MAE: you already know these levels — you watched the trade. Drawing the ray takes 10 seconds and gives AI exact values instead of estimates."})
):null,

// SECTION 3: AI PROMPT
sec==="prompt"?h("div",null,
h("div",{style:{fontSize:12,color:K.dm,marginBottom:10,lineHeight:1.5}},"Copy the prompt below. Upload both screenshots to Claude or any vision-capable AI along with this prompt. The AI returns a JSON object you can import directly into the journal."),
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}},
h("div",{style:{fontSize:11,fontWeight:700,color:K.go}},"AI PROMPT — copy this exactly"),
h("button",{onClick:copyPrompt,style:{padding:"5px 14px",background:copied?K.g:K.cy,border:"none",borderRadius:6,color:"#000",fontSize:11,fontWeight:700,cursor:"pointer",transition:"background 0.2s"}},copied?"✓ Copied!":"Copy Prompt")),
h("div",{style:{background:K.bg,borderRadius:6,padding:"12px",fontFamily:"JetBrains Mono,monospace",fontSize:9,color:K.dm,lineHeight:1.6,maxHeight:300,overflowY:"auto",border:"1px solid "+K.bd,whiteSpace:"pre-wrap"}},AI_PROMPT),

h("div",{style:{marginTop:14,fontSize:12,fontWeight:700,color:K.tx,marginBottom:8}},"WHAT GETS AUTO-READ vs WHAT YOU FILL IN AFTER"),
h("div",{style:{display:"flex",flexDirection:"column",gap:2}},
[
["ticker · timeframe · date · time",          "Panel",    K.g,  "~99%"],
["direction · type · mode",                   "You set",  K.go, "100%"],
["entry · stop · exit prices",                "Ray labels",K.g, "~95%"],
["MFE · MAE",                                 "Ray labels",K.g, "~95%"],
["ADX · RSI · cloud · MACD",                  "Panel",    K.g,  "~98%"],
["cloudAlign · macdCross · rsiExtreme · 15m", "Panel",    K.g,  "~95%"],
["ultHL · lhHL · chanBreak · retest · 2C",    "Your annotations",K.go,"~95% if labeled"],
["shares · confidence · emotion · notes",     "Fill after",K.r, "manual"],
["stopMgmt rules · exitType",                 "Fill after",K.r, "manual"],
["divBefore · divDuring · maeTiming",         "Fill after",K.r, "manual"]
].map(function(row){return h("div",{key:row[0],style:{display:"flex",alignItems:"center",gap:8,padding:"4px 8px",background:K.bg,borderRadius:4,fontSize:10}},
h("div",{style:{flex:1,color:K.dm,fontFamily:"JetBrains Mono,monospace",fontSize:9}},row[0]),
h("div",{style:{width:110,color:row[2],fontSize:9,textAlign:"right"}},row[1]),
h("div",{style:{width:40,color:row[2],fontSize:9,textAlign:"right"}},row[3]))})),

h("div",{style:{marginTop:14,fontSize:12,fontWeight:700,color:K.tx,marginBottom:8}},"IMPORTING THE JSON"),
[
["1","Copy the JSON the AI returns","#000",K.g],
["2","Click Import JSON in the top nav bar of the journal","#000",K.g],
["3","Paste — the trade is added to your log instantly","#000",K.g],
["4","Click Edit on the trade to fill in the manual fields (shares, emotion, stop management, exit type)","#000",K.g],
["5","Verify AI-read prices — adjust by a tick or two if needed","#000",K.g]
].map(function(s){return h("div",{key:s[0],style:{display:"flex",gap:10,marginBottom:8,alignItems:"flex-start"}},
h(StepNum,{n:s[0],color:s[3]}),
h("div",{style:{fontSize:12,color:K.dm,lineHeight:1.5}},s[1]))}),
h(Tip2,{t:"Time estimate: annotate entry chart ~20s, exit chart ~30s, AI parse and import ~30s. Under 90 seconds per trade vs 3-5 minutes manual. All indicator values and prices are exact."})
):null,

// SECTION 4: QUICK REF
sec==="ref"?h("div",null,
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}},
h("div",null,
h("div",{style:{fontSize:12,fontWeight:700,color:K.g,marginBottom:8,paddingBottom:4,borderBottom:"1px solid "+K.bd}},"ENTRY SCREENSHOT SS1"),
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},
[["E","Entry price ray","Green"],["STP","Stop price ray","Red"],["TGT","Target ray (opt)","Blue"],["ETIME","Entry time vertical","Gold"],["UHL=Y/N","Ultimate H/L","Text"],["LHHL=Y/N","LH/HL sequence","Text"],["CB=Y/N","Channel break","Text"],["CR=Y/N","Chan retest","Text"],["2C=Y/N","2nd candle entry","Text"]]
.map(function(r){return h("div",{key:r[0],style:{display:"flex",gap:8,padding:"4px 8px",background:K.bg,borderRadius:4,fontSize:10,alignItems:"center"}},
h("div",{style:{width:70,fontFamily:"JetBrains Mono,monospace",color:K.go,fontSize:9}},r[0]),
h("div",{style:{flex:1,color:K.dm}},r[1]),
h("div",{style:{fontSize:9,color:K.cy}},r[2]))}))),
h("div",null,
h("div",{style:{fontSize:12,fontWeight:700,color:K.cy,marginBottom:8,paddingBottom:4,borderBottom:"1px solid "+K.bd}},"EXIT SCREENSHOT SS2"),
h("div",{style:{display:"flex",flexDirection:"column",gap:3}},
[["X","Exit price ray","Blue"],["MFE","Best price reached","Green"],["MAE","Worst drawdown","Red"],["XTIME","Exit time vertical","Gold"],["RSIPEAK=XX","RSI at MFE (opt)","Text"]]
.map(function(r){return h("div",{key:r[0],style:{display:"flex",gap:8,padding:"4px 8px",background:K.bg,borderRadius:4,fontSize:10,alignItems:"center"}},
h("div",{style:{width:70,fontFamily:"JetBrains Mono,monospace",color:K.go,fontSize:9}},r[0]),
h("div",{style:{flex:1,color:K.dm}},r[1]),
h("div",{style:{fontSize:9,color:K.cy}},r[2]))})),
h("div",{style:{marginTop:12,background:K.bg,borderRadius:6,padding:"10px 12px",border:"1px solid "+K.bd}},
h("div",{style:{fontSize:10,fontWeight:700,color:K.go,marginBottom:6}},"FILL IN AFTER IMPORT"),
["Shares","Emotion / Confidence","Exit Type","Stop Management rules","Div Before/During","MAE Timing","Notes + Screenshots"].map(function(f){return h("div",{key:f,style:{fontSize:10,color:K.dm,padding:"2px 0"}},h("span",{style:{color:K.r,marginRight:6}},"→"),f)})))),
h("div",{style:{marginTop:12,background:K.bg,borderRadius:6,padding:"10px 14px",border:"1px solid "+K.bd}},
h("div",{style:{fontSize:11,fontWeight:700,color:K.go,marginBottom:4}},"SCREENSHOT SETTINGS — change before each shot"),
h("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:6}},
[["Screenshot Type","Entry / Exit"],["Direction","Long / Short"],["Trade Type","Rev / Cont"],["Mode","Live / BT"]]
.map(function(s){return h("div",{key:s[0],style:{background:K.cd,borderRadius:4,padding:"5px 8px",fontSize:9}},
h("div",{style:{color:K.dm,marginBottom:2}},s[0]),
h("div",{style:{color:K.go,fontFamily:"JetBrains Mono,monospace"}},s[1]))})))
):null)};

// === BEGINNER TAB ===
var BeginnerTab=function(){
var _cat=React.useState("Start"),bCat=_cat[0],setBCat=_cat[1];
var _sel=React.useState(null),selId=_sel[0],setSelId=_sel[1];
var CATS=["Start","Candlesticks","Orders","Charts","Indicators","Risk & Reward","Edge vs Gambling","Paper Trading","Journal Tips","Using This Journal"];
var LESSONS=[
{id:"b_what",cat:"Start",icon:"🎯",title:"What Is Day Trading?",
summary:"Day trading means buying and selling a security within the same trading day. You're not investing — you're speculating on short-term price moves.",
detail:"Unlike investing, which is about owning a company long term, day trading is about capturing small price moves multiple times per day. You profit when you're right about direction, lose when you're wrong. The goal is to have your wins bigger than your losses and win often enough that profits outpace losses over time. Most beginners lose money — not because the strategy is bad, but because emotion overrides discipline. That's why journaling exists: to let your data make the decisions, not your gut.",
tip:"The single biggest edge a beginner can build is a written plan with rules. 'I will only trade when X and Y are true.' Every rule you skip is a tax on your account."},
{id:"b_candle1",cat:"Candlesticks",icon:"🕯",title:"What Is a Candlestick?",
summary:"A candlestick shows you four prices in one visual: where the period opened, where it closed, the highest it went, and the lowest it went.",
detail:"Each candle covers a time period — on a 1-minute chart, each candle is one minute of price action. The body (thick part) shows open to close. The wicks (thin lines above and below) show the high and low. GREEN (or hollow) body = price closed higher than it opened — buyers won that period. RED (or filled) body = price closed lower — sellers won. The size of the body shows conviction. A big green body = buyers dominated. A small body = neither side in control — indecision.",
tip:"The most important candle is not the current one — it's the one that just closed. Closed candles are facts. Open candles are noise. Train yourself to wait for the close."},
{id:"b_candle2",cat:"Candlesticks",icon:"📍",title:"Key Candlestick Patterns",
summary:"Certain candlestick shapes repeat across all markets and timeframes because they reflect consistent human psychology at price extremes.",
detail:"HAMMER: Small body at the top, long lower wick. Price fell hard but buyers pushed it back up. Bullish signal at support. SHOOTING STAR: Small body at the bottom, long upper wick. Price spiked up but sellers pushed it back down. Bearish signal at resistance. ENGULFING: A candle whose body completely covers the prior candle. Bullish engulfing (green covers prior red) = buyers took control. Bearish engulfing = sellers took control. DOJI: Body is almost flat — open and close nearly equal. Indecision. Often signals a reversal when appearing after a strong trend. INSIDE BAR: Entire candle fits inside the prior candle's high to low range. Market is coiling — a breakout is likely.",
tip:"Patterns are more reliable at key levels — prior highs/lows, EMAs, round numbers. A hammer in the middle of nowhere is noise. A hammer at the 20 EMA after a clean pullback in an uptrend is a signal."},
{id:"b_candle3",cat:"Candlesticks",icon:"🔴",title:"Wicks and What They Mean",
summary:"Wicks tell you where price was rejected. A long upper wick says 'buyers tried to push higher but sellers stepped in hard.' A long lower wick says the opposite.",
detail:"Wick analysis is often more useful than body analysis. Long upper wick = strong sellers at that level. Long lower wick = strong buyers at that level. If you see repeated long upper wicks at the same price, that's a resistance zone — sellers keep showing up there. If you see repeated long lower wicks at the same price, that's support. A candle where the wick is 2x or more longer than the body is a significant rejection. The longer the wick relative to the body, the more aggressive the rejection.",
tip:"In this journal, MFE and MAE capture the wick data for your trades. If your MFE consistently shows long upper wicks (price went well past your exit before pulling back), you may be exiting too early. If MAE shows large dips that recover, you may be stopping out of winning trades."},
{id:"b_order1",cat:"Orders",icon:"📋",title:"Market vs Limit Orders",
summary:"A market order fills immediately at whatever price is available. A limit order only fills at your specified price or better — but it might not fill at all.",
detail:"MARKET ORDER: You click buy, you get filled immediately at the current ask price. Fast but you get whatever price the market gives you. In fast-moving stocks, this can be significantly worse than the price you saw when you clicked. LIMIT ORDER: You specify the max price you'll pay (buy limit) or minimum you'll accept (sell limit). You get price certainty but not execution certainty. Your order may sit unfilled if price never reaches your limit. Most professional day traders use limit orders for entries to control their fill price, and sometimes market orders for exits when they need to get out fast.",
tip:"On liquid, fast-moving stocks like TSLA, a limit order 1-2 cents above the ask on a buy will usually fill immediately while giving you price control. This is called a 'marketable limit order' — the best of both worlds for entries."},
{id:"b_order2",cat:"Orders",icon:"🛑",title:"Stop Loss Orders",
summary:"A stop loss automatically exits your trade when price moves against you to a predetermined level. It's your financial seatbelt.",
detail:"A STOP MARKET order triggers a market order when price hits your stop level. Guaranteed to exit, but the fill might be worse than your stop price (slippage) in fast markets. A STOP LIMIT order only fills at your limit price — but in fast moves, price might blow through your stop without filling, leaving you in a losing trade much longer. For day trading liquid stocks, stop market is usually safer. The key discipline: set your stop BEFORE entering the trade, at a technically meaningful level (below a swing low, below a moving average), and do NOT move it to give the trade more room. Moving your stop when it's about to be hit is how small losses become big losses.",
tip:"Your stop location should define your position size, not the other way around. Risk Rule: (Account × risk %) ÷ (entry − stop) = max shares. If you're willing to risk $100, and your stop is $0.50 below entry, you can take 200 shares. This is position sizing and it's the foundation of professional risk management."},
{id:"b_order3",cat:"Orders",icon:"💱",title:"Bid, Ask, and Spread",
summary:"The bid is what buyers will pay right now. The ask is what sellers want right now. The spread is the gap between them — and it's a cost you pay on every trade.",
detail:"When you buy, you pay the ASK (the higher price). When you sell, you receive the BID (the lower price). If TSLA is bid at $248.50 and ask at $248.52, the spread is $0.02. You pay that spread every time you trade. For a 100-share position, a $0.02 spread is $2 of immediate loss the moment you enter. On a liquid stock like TSLA, spreads are usually 1-2 cents. On thinly traded stocks, spreads can be $0.10 or more — meaning you need the stock to move $0.10 just to break even. Always trade liquid stocks where the bid-ask spread is tight.",
tip:"Volume is the measure of liquidity. Stocks with millions of shares traded daily have tight spreads. Stocks with 50,000 shares/day have wide spreads. For day trading, stick to stocks trading at least 1 million shares per day. TSLA averages 80+ million."},
{id:"b_chart1",cat:"Charts",icon:"📊",title:"How to Read a Price Chart",
summary:"A price chart is just a visual record of every transaction that happened. Time goes left to right. Price goes bottom (cheaper) to top (more expensive).",
detail:"TIMEFRAME: The chart's timeframe determines how much time each candle represents. A 1-minute chart shows every minute of trading. A daily chart shows each full trading day as one candle. Day traders typically watch multiple timeframes — a higher timeframe (15m or 1h) for direction and context, and a lower timeframe (1m or 3m) for entry precision. HORIZONTAL LEVELS: Draw lines across prior highs and lows where price repeatedly stopped. These are your support (price bounced up from here) and resistance (price was rejected from here) levels. TRENDLINES: Connect a series of higher lows (uptrend) or lower highs (downtrend). When price breaks a trendline, the trend is weakening. VOLUME BARS: The histogram at the bottom. High volume on a strong candle = conviction. Low volume on a move = less reliable.",
tip:"The first thing to do on any chart is mark the prior session high and low, and the current session high and low. Price gravitates to these levels — they're the most traded reference points in the market."},
{id:"b_chart2",cat:"Charts",icon:"〰",title:"Moving Averages",
summary:"A moving average smooths out price noise by showing the average price over a period. It turns a jagged chart into a cleaner trend line.",
detail:"SIMPLE MOVING AVERAGE (SMA): Just the average closing price over N periods. Equal weight to all periods. EXPONENTIAL MOVING AVERAGE (EMA): More weight given to recent prices. Reacts faster to new price action. Day traders prefer EMAs. The 9 EMA and 21 EMA together form the EMA cloud used in this journal — the area between them acts as dynamic support in uptrends and resistance in downtrends. The 10 EMA is another key level: the first close above a 10 EMA after being below it can signal a trend change. The VWAP (Volume Weighted Average Price) is the most institutionally watched intraday level — big funds measure their execution quality against VWAP.",
tip:"Don't add 10 moving averages to your chart. Pick 1-3 and understand them deeply. The traders who lose are usually the ones with the most cluttered charts. Simplicity outperforms complexity for most beginners."},
{id:"b_chart3",cat:"Charts",icon:"📈",title:"Trends, Ranges, and Chop",
summary:"Markets spend time in three states: trending (clear direction), ranging (bouncing between levels), and choppy (random, directionless). Each requires a different approach.",
detail:"TRENDING: Price is making consistent higher highs and higher lows (uptrend) or lower highs and lower lows (downtrend). Momentum strategies work best here. Buy pullbacks in uptrends, sell bounces in downtrends. ADX above 25 indicates a trending environment. RANGING: Price bounces between defined support and resistance. Mean reversion works here — buy the bottom of the range, sell the top. ADX below 20. CHOPPY: Neither trending nor ranging — price moves randomly without structure. This is the most dangerous environment. Most strategies fail. The correct response to chop is to stop trading or drastically reduce size. The journal tracks your Session Read — over time you'll see if your chop detection is accurate.",
tip:"The biggest mistake beginners make is using trend-following strategies in ranging markets and reversal strategies in trending markets. Before every trade, identify: which of the three states is the market in right now?"},
{id:"b_paper1",cat:"Paper Trading",icon:"📝",title:"What Is Paper Trading?",
summary:"Paper trading means practicing with fake money in real market conditions. You see real prices and make real decisions — you just don't risk actual money.",
detail:"Most brokers offer paper trading accounts — Thinkorswim (TD Ameritrade), Webull, and Interactive Brokers all have simulators. You enter orders the same way, see fills, track your P/L — all without real money at stake. Paper trading is the essential first step for beginners. The goal is to practice your strategy enough times that you understand your win rate, your typical drawdown, and how you emotionally respond to losses — before real money is on the line.",
detail2:"THE BACKTEST MODE IN THIS JOURNAL: This is exactly where the backtest toggle becomes powerful. When you log backtest trades (using the Live/Backtest toggle), you're doing the same thing — testing your strategy against historical charts using chart replay. Log every trade the same way you would a live trade. After 50+ backtest trades, the analysis engine will show you: which setups actually have an edge, which rules matter, what your win rate is at different ADX levels. That's your system — proven before you risk a dollar.",
tip:"The biggest danger of paper trading is not taking it seriously. Trade the same size you plan to trade live. Follow your rules strictly. If you wouldn't take a trade live, don't take it in paper. The journal is what makes paper trading meaningful — otherwise it's just guessing."},
{id:"b_paper2",cat:"Paper Trading",icon:"🔬",title:"How to Use Backtest Mode",
summary:"The backtest toggle separates your practice trades from your live trades so the analysis stays clean. Here's the workflow.",
detail:"STEP 1: Load a chart on TradingView in replay mode (clock icon). This lets you step forward candle by candle through historical price action. STEP 2: When you identify a setup, toggle the form to Backtest, fill in all fields as if it were a live trade. Entry price, stop, target, rules present, emotion, session read — everything. STEP 3: Step forward through the chart until your stop or target hits. Log the exit. STEP 4: Repeat 50-100 times on the same setup. STEP 5: Switch to the Analysis tab. Your backtest data is separate from live data. Look at your rule edge analysis, your ADX buckets, your emotional state performance. This is your strategy's DNA.",
tip:"The value of backtest mode isn't just in the results — it's in the logging discipline it builds. When you force yourself to fill in every field before stepping the chart forward, you're training your brain to see those factors in live trading too."},
{id:"b_jrn1",cat:"Journal Tips",icon:"✍",title:"Why Journal at All?",
summary:"Every professional trader keeps records. Not because they enjoy paperwork — because the data reveals patterns their conscious mind can't see.",
detail:"Human memory is selective and self-serving. You remember your winners more vividly than your losers. You remember the times your instinct was right and forget the times it was wrong. You don't remember that you took 8 trades on frustrated days and lost on 7 of them — you just remember being frustrated. The journal is ruthlessly objective. After 100 trades logged with emotion, session read, ADX, rule count — the data will show you things that surprise you. Maybe you're actually 80% on reversals but only 40% on continuations. Maybe you lose every time you trade after 2pm. Maybe your win rate when Followed Rules = Y is 68% and when N it's 31%. These are the discoveries that build an edge — and you can't find them without data.",
tip:"Consistency matters more than completeness. Logging 6 fields on every trade beats logging 20 fields on some trades. Pick the fields you'll actually fill in and be religious about them. The analysis engine only works with the data you give it."},
{id:"b_jrn2",cat:"Journal Tips",icon:"🧠",title:"Emotions and Trading",
summary:"Your emotional state at entry is one of the highest-predictive fields in this journal. FOMO, Revenge, and Frustrated have the worst win rates for nearly every trader.",
detail:"Here's why: when you feel FOMO, you're chasing — entering after the move has already happened, at a worse price, with less room to your target. When you're Frustrated, your cognitive load is high and you take setups you wouldn't take when calm — you're trying to 'get it back.' When you're Revenge trading, you've already violated your daily loss limit and you're trading bigger to recover, which amplifies the disaster. The Emotional State field in this journal will eventually show you your personal emotional P/L breakdown. Most traders are profitable when Calm and losing when any negative emotion is present. The data makes this real — it's not philosophy, it's your money.",
tip:"The best trading rule that requires no technical skill: stop trading for the day when you feel frustrated, angry, or like you 'need' to make money back. Every study on trader behavior shows that negative emotion predicts worse trade selection, wider stops, bigger size, and lower win rates. Your journal will prove this with your own numbers."},
{id:"b_jrn3",cat:"Journal Tips",icon:"📐",title:"Understanding R-Multiple",
summary:"R is how you measure trade performance independent of dollar amount. 1R = you made what you risked. 2R = you made twice what you risked. -1R = you lost exactly your planned risk.",
detail:"Why R matters: if you risked $50 on a trade and made $100, that's +2R. If someone else risked $500 and made $1000, that's also +2R. The dollar amounts are different but the quality of the trade is the same. R-multiples let you compare trades across different position sizes and account sizes. A system that wins 40% of the time but averages +2R on wins and -1R on losses has an expectancy of: (0.4 × 2) + (0.6 × -1) = +0.2R per trade. That's a profitable system. Most beginners focus on win rate but the math shows that a 35% win rate system with +3R winners and -1R losers outperforms a 65% win rate system with +0.8R winners and -1R losers. Avg R is in your stat cards — watch it grow.",
tip:"If your Avg R is consistently below 0.5R, your exits are too early or your targets are too close. The journal's Exit Planning section helps you analyze whether your targets are realistic based on MFE data — whether the move had the room to hit your target, and if so, why you didn't capture it."},
// === CHARTING TOOLS ===
{id:"b_chart_tv1",cat:"Charts",icon:"🖥",title:"Getting Started with TradingView",
summary:"TradingView is the most widely used charting platform for retail traders. It's free, runs in your browser, and has every indicator and drawing tool you'll need.",
detail:"Go to tradingview.com and create a free account. On the Chart page, type any ticker in the search bar (TSLA, SPY, QQQ). The main panel is your price chart. Bottom left selects your timeframe — start with the Daily chart to get context, then drill into 15m or 5m for intraday. The toolbar on the left has drawing tools: crosshair, trendline, horizontal line, rectangle, text. The toolbar across the top lets you add indicators. Key keyboard shortcuts: Alt+T for trendline, Alt+H for horizontal line, Ctrl+Z to undo. The chart auto-saves your drawings.",
tip:"Set up a Multi-Pane layout: your primary timeframe on top (e.g. 3m), a higher timeframe below (15m or 1h). This gives you directional context without switching charts. TradingView lets you sync the crosshair across panes so both charts show the same moment in time."},
{id:"b_chart_tv2",cat:"Charts",icon:"⏪",title:"Chart Replay — Your Backtesting Tool",
summary:"TradingView's Replay mode lets you rewind any chart to any date and step forward candle by candle. This is how you practice setups without risking money.",
detail:"On any chart, click the clock icon in the top toolbar (Replay). A date picker appears — choose a historical start date. The chart rewinds to that point. Now you can step forward one candle at a time using the right arrow key, or press play to watch it unfold in real time. When you see a setup, stop, log the trade in backtest mode in this journal, then continue stepping forward to see how it played out. Log the exit. Repeat 50-100 times on the same setup. This is how you build a sample size before risking real capital.",
tip:"Use Replay on multiple date ranges — different market conditions produce different results. A setup that works beautifully in a trending October may fail in a choppy August. You want to know how your rules perform across market conditions, not just cherry-picked setups."},
{id:"b_chart_levels",cat:"Charts",icon:"—",title:"Drawing Key Levels",
summary:"Before placing any trade, mark the levels where price has repeatedly stalled, reversed, or broken through. These are your reference points for the entire session.",
detail:"PRIOR DAY HIGH AND LOW: The most watched levels intraday. Large players reference these. Mark them every morning before the open. PRIOR WEEK HIGH AND LOW: Wider context — important for swing traders and for understanding where intraday moves are reaching. ROUND NUMBERS: $400, $410, $415, $420. Humans cluster orders at round numbers. Price tends to stall or reverse at them. VWAP: Volume Weighted Average Price. Automatically shown on most platforms. Institutional benchmark — large funds measure against VWAP. Price often acts as support/resistance at VWAP intraday. HOW TO DRAW: Use the horizontal ray tool (not a full line — you want it to extend right from the level, not backward into history).",
tip:"Less is more with levels. Mark the 3-5 most significant levels and let price come to them. Traders with 15 lines on their chart can justify any entry — which means they have no real system. A chart with 3 clear levels forces discipline."},
// === INDICATORS ===
{id:"b_ind1",cat:"Indicators",icon:"📡",title:"What Indicators Actually Are",
summary:"Indicators are mathematical formulas applied to price and volume data. They don't predict the future — they describe what has already happened in a simplified visual form.",
detail:"Every indicator is derived from price. That means they lag — they confirm what price already did, they don't tell you what price will do next. This is not a bug, it's just reality. The value of indicators is in filtering noise and making patterns more visible. RSI showing overbought doesn't mean price will reverse — it means the recent move was fast and extended. MACD crossing doesn't predict a move — it shows momentum is shifting. Used correctly, indicators help you define conditions, not predict outcomes. The mistake beginners make is treating indicator signals as buy/sell orders rather than context filters.",
tip:"Two indicators that both use closing prices and look similar on the chart are not confirmation — they're the same data shown twice. Real confluence comes from different types of evidence: price structure (a key level), momentum (RSI extreme), and volume (above average). Three different categories agreeing is worth more than three similar indicators all saying the same thing."},
{id:"b_ind2",cat:"Indicators",icon:"〰",title:"EMA — Exponential Moving Average",
summary:"The EMA is a moving average that weights recent prices more heavily. It reacts faster than a simple moving average and acts as dynamic support and resistance.",
detail:"Key EMAs used by day traders: 9 EMA (very fast, used for scalping momentum), 10 EMA (intraday trend gauge — first close above/below signals potential trend change), 20/21 EMA (intermediate trend), 50 EMA (longer-term trend, swing traders watch this). The EMA Cloud in this journal uses two EMAs together — the area between them acts as a zone rather than a single line. Price inside the cloud = indecision. Price above cloud = bullish bias. Price below cloud = bearish bias. The width of the cloud tells you trend strength — wide cloud, strong trend. Narrow cloud, trend is weakening.",
tip:"Don't trade the EMA. Trade price behavior at the EMA. A candle touching the 10 EMA is just touching a line. A candle touching the 10 EMA, rejecting hard with a long wick, on above-average volume, in the direction of the higher timeframe trend — that's a setup. The EMA gives you the location. Everything else gives you the reason."},
{id:"b_ind3",cat:"Indicators",icon:"📊",title:"RSI — Relative Strength Index",
summary:"RSI measures the speed and magnitude of recent price moves on a scale of 0-100. Above 70 = overbought. Below 30 = oversold. But context matters enormously.",
detail:"RSI was designed to identify when a stock has moved too far too fast — meaning a potential reversal is coming. In ranging markets, RSI at 70+ is a reliable reversal signal. In strong trending markets, RSI can sit above 70 for extended periods without reversing — this is called a 'momentum regime' and shorting just because RSI is overbought in a trend will get you crushed. RSI DIVERGENCE is often more powerful than the absolute level: if price makes a new high but RSI makes a lower high, momentum is weakening despite price still rising. That divergence warns of a potential reversal before price confirms it. This journal tracks RSI at entry, at peak (MFE), and at exit — giving you data on whether RSI levels actually predict outcomes for your specific setups.",
tip:"RSI works best as a filter, not a signal. 'Only take long setups when RSI is below 50' is using RSI correctly — you're filtering out entries in overbought conditions. 'Short when RSI hits 70' is using RSI incorrectly in a trending market. The journal will show you over time which RSI ranges produce the best results for your strategy."},
{id:"b_ind4",cat:"Indicators",icon:"💪",title:"ADX — Average Directional Index",
summary:"ADX measures trend strength on a scale of 0-100. It does NOT tell you direction — just how strong the trend is in whichever direction it's moving.",
detail:"ADX below 20: weak trend, market is ranging or choppy. Trend-following strategies struggle here. ADX 20-25: trend beginning to develop. ADX above 25: established trend. Momentum strategies work best. ADX above 40: very strong trend — reversals are risky, continuation setups are favored. The key insight: ADX is a filter, not an entry signal. It tells you what type of market you're in so you can apply the right strategy. Using a momentum continuation strategy when ADX is 15 is using the wrong tool for the conditions — like using a hammer when you need a screwdriver. This journal tracks ADX at entry. Over time, your Rule Analysis will show exactly which ADX ranges your specific setups perform best in.",
tip:"Watch how ADX interacts with direction. ADX rising + price rising = accelerating uptrend. ADX rising + price falling = accelerating downtrend. ADX falling from above 25 = trend exhausting, potential range forming. ADX bottoming out from low levels = potential trend beginning to form."},
{id:"b_ind5",cat:"Indicators",icon:"📦",title:"MACD — Moving Average Convergence Divergence",
summary:"MACD shows the relationship between two EMAs. When the faster EMA crosses above the slower one, it signals momentum is shifting upward — and vice versa.",
detail:"MACD has three components: the MACD line (difference between 12 and 26 period EMAs), the Signal line (9 period EMA of the MACD line), and the Histogram (difference between MACD and Signal). A MACD cross above zero is a bullish momentum signal — faster average overtook slower average. A cross below zero is bearish. The histogram shows the magnitude and direction of the cross — when bars are shrinking, momentum is decelerating. Day traders often use MACD on a higher timeframe (15m or 1h) to establish directional bias, then use a lower timeframe (3m or 5m) for precise entry. A MACD bullish cross on the 15m while you're looking for longs on the 3m means multiple timeframes are aligned.",
tip:"MACD lags because it's built from moving averages which are themselves lagged. For fast intraday scalping (1-3 minute charts), MACD can be too slow to be useful as an entry trigger. It's better used as a directional filter: 'I only take longs when MACD is above zero on the 15m' rather than 'I enter when MACD crosses.'"},
// === RISK & REWARD ===
{id:"b_risk1",cat:"Risk & Reward",icon:"🛡",title:"The Foundation: Risk Per Trade",
summary:"Professional traders don't think in dollars per trade — they think in percentage of account at risk. Controlling risk per trade is what keeps you in the game long enough to find your edge.",
detail:"THE 1% RULE: Never risk more than 1-2% of your total account on any single trade. If you have a $10,000 account, maximum risk per trade is $100-$200. This sounds conservative but here's the math: if you risk 1% per trade and have a string of 10 consecutive losses (which will happen at some point to every trader), you've lost 10% of your account. That's recoverable. If you're risking 10% per trade and hit 10 losses in a row, you're wiped out. HOW POSITION SIZING WORKS: Risk amount ÷ (entry price − stop price) = maximum shares. If you'll risk $100, and your stop is $0.50 below entry, you can take 200 shares. If your stop is $1.00 below entry, you can take 100 shares. The stop location determines your size — not the other way around.",
tip:"Most beginners size positions based on how much they 'want to make' rather than how much they're willing to lose. This is backwards. Define your maximum loss first. Then work backward to position size. Every trade should be sized so that hitting your stop costs a predetermined, acceptable amount — not a surprise."},
{id:"b_risk2",cat:"Risk & Reward",icon:"⚖",title:"Risk/Reward Ratios",
summary:"A risk/reward ratio compares how much you stand to gain versus how much you stand to lose. A 2:1 ratio means your target is twice as far as your stop.",
detail:"If your stop is $0.50 below entry and your target is $1.00 above entry, your risk/reward is 2:1 (also written as 2R). At 2:1, you only need to be right 34% of the time to break even — because each win pays twice as much as each loss costs. This is the math that beginners miss: WIN RATE ALONE IS MEANINGLESS. A trader who wins 70% of trades but takes 1:3 risk/reward (risking $3 to make $1) loses money long term: (0.7 × 1) − (0.3 × 3) = −$0.20 expected per trade. A trader who wins only 40% of trades but takes 2:1 risk/reward makes money: (0.4 × 2) − (0.6 × 1) = +$0.20 expected per trade. The second trader is profitable with fewer wins because they structured their trades correctly.",
tip:"Minimum viable risk/reward for most strategies is 1.5:1. Below that, your win rate needs to be extremely high to be profitable and transaction costs eat your edge. Aim for 2:1 as a baseline. When you see a setup with 3:1 or better, that's a high-quality opportunity — your stats will confirm this over time in the analysis."},
{id:"b_risk3",cat:"Risk & Reward",icon:"🧮",title:"Expectancy — Your Edge in a Number",
summary:"Expectancy is the average amount you expect to make per dollar risked across all your trades. It's the single most important number in trading performance.",
detail:"FORMULA: Expectancy = (Win Rate × Avg Win) − (Loss Rate × Avg Loss). Example: Win Rate 45%, Avg Win 2R, Avg Loss 1R. Expectancy = (0.45 × 2) − (0.55 × 1) = 0.90 − 0.55 = +0.35R per trade. That means for every $1 you risk, you expect to make $0.35 on average over many trades. Positive expectancy = you have a statistical edge. Negative expectancy = you're losing money systematically. Most traders never calculate this. They guess based on recent performance. The journal calculates your Avg R (which is expectancy in R-terms) automatically in your stat cards. If Avg R is positive, you have edge. If negative, something in your system needs to change — and the Rule Analysis shows you exactly what.",
tip:"Expectancy requires a large sample size to be meaningful. 10 trades tells you almost nothing. 50 trades gives you a rough signal. 100+ trades gives you statistically meaningful data. This is why the journal pushes you to log consistently — every trade is a data point, and data points are what convert guessing into edge."},
// === EDGE VS GAMBLING ===
{id:"b_edge1",cat:"Edge vs Gambling",icon:"🎰",title:"Why Most Trading Is Gambling",
summary:"Gambling and trading look similar from the outside. Both involve money, probability, and outcomes you can't fully control. The difference is whether you have a mathematical edge — and whether you can measure it.",
detail:"At a casino, the house edge on roulette is 5.26%. Every spin, on average, the house keeps 5.26 cents of every dollar bet. It doesn't matter if you win 10 hands in a row — the edge is built into the math and grinds you down over time. Trading without a defined, measured system works the same way. You make some wins, some losses, but without data you don't know your actual win rate, your actual avg R, your actual expectancy. You're guessing. And random guessing has zero edge — at best. Most beginners have negative expectancy because they enter impulsively, cut winners early, and let losers run. They are, mathematically, the house's customer.",
tip:"The most dangerous trader is the one who is profitable for the wrong reasons. Three months of profits from one or two big trades with poor risk management is not an edge — it's luck that hasn't been punished yet. The journal exists to separate skill from luck by building a large enough sample size to know which one you actually have."},
{id:"b_edge2",cat:"Edge vs Gambling",icon:"📈",title:"What a Real Edge Looks Like",
summary:"A trading edge is a repeatable condition under which your strategy produces positive expectancy over a statistically significant sample size. Notice what that definition requires: repeatable, measurable, significant sample.",
detail:"A real edge has three components. First, defined entry conditions — specific, observable rules that tell you exactly when to enter. Not 'when it looks good' but 'when ADX is above 25, price breaks above a prior high with a clean candle close, and the 15m MACD is above zero.' Second, consistent execution — you take every trade that meets criteria and skip every trade that doesn't. Cherry-picking setups contaminates your data. Third, measurement — you track results over 100+ trades and calculate win rate, avg R, and expectancy. If expectancy is positive and your sample is large enough to be statistically meaningful, you have an edge. This journal builds all three pillars: it enforces rule definition, tracks execution consistency (Followed Rules metric), and calculates expectancy automatically.",
tip:"An edge is not permanent. Market conditions change. A strategy that works in a trending, high-ADX environment may fail in a choppy, low-volume environment. This is why Edge Decay Monitoring matters — it shows you when your edge is weakening before you've given back your profits. An edge is something you maintain and refine, not something you find once and own forever."},
{id:"b_edge3",cat:"Edge vs Gambling",icon:"🔬",title:"How This Journal Builds Your Edge",
summary:"Every field you fill in is a variable. Every trade is a data point. The analysis engine finds which combinations of variables produce positive outcomes — that's your edge, discovered from your own data.",
detail:"Here is the exact process: You log 50 trades with full rule data. The Rule Edge Analysis shows that when Cloud Aligned = Y, your win rate is 68%. When Cloud Aligned = N, it's 31%. That 37% difference is edge — the rule has real predictive power for your setups. The Combo Analysis shows that Cloud Aligned + MACD Cross together produce 74% win rate across 20 trades. The Conditional Edge shows that adding RSI Extreme on top of those two rules adds another 8% win rate. You now have a 3-rule minimum entry criteria backed by your own data. Your next 50 trades applying those criteria: 72% win rate. That is how a gambling problem becomes a trading business. The data makes the decisions, not the gut.",
tip:"The Followed Rules metric is the fastest path to improvement. If your win rate when Followed Rules = Y is 65% and when N is 28%, you already have your answer. Stop taking trades that don't meet your rules. You don't need a new strategy — you need discipline with the one you have. The journal proves this with your own money."},
// === PAPER TRADING (keeping existing, adding one) ===
{id:"b_paper3",cat:"Paper Trading",icon:"📋",title:"Building Your First System in Backtest Mode",
summary:"Before you risk real money, you need a hypothesis about what works. Backtest mode lets you test that hypothesis scientifically across historical market data.",
detail:"STEP 1 — Define your rules before you start. Write down exactly what conditions need to be true for you to enter a long. Be specific. 'Uptrend with momentum' is not a rule. 'Price above 10 EMA, ADX above 20, MACD above zero on 15m, clean candle close above a prior high' is a rule. STEP 2 — Log 30 backtest trades following those rules exactly. Don't skip setups that meet criteria. Don't take setups that don't. STEP 3 — Review the Rule Analysis. Which rules actually contributed to winning trades? Which were present equally in wins and losses (meaning they have no edge)? STEP 4 — Refine your rules based on data. Remove rules with no edge. Add conditions the data suggests matter. STEP 5 — Repeat with another 30 trades using refined rules. After 100 total backtest trades, you have a tested hypothesis. Then — and only then — consider a small live test.",
tip:"The most common mistake in backtesting is unconscious bias — you fast-forward past losing setups without logging them and only log the winners. This makes your backtest results look great and your live trading results look terrible. Log every setup that meets your criteria, wins and losses alike. The journal's analysis only works with clean, unbiased data."},
// === JOURNAL TIPS (keeping existing, adding one) ===
{id:"b_jrn4",cat:"Journal Tips",icon:"🗓",title:"What Changes at 20, 50, and 100 Trades",
summary:"The value of the journal compounds over time. At 20 trades you see hints. At 50 you see patterns. At 100 you have a system.",
detail:"20 TRADES: You'll start to see which emotional states correlate with losses. You'll notice if your win rate is wildly different between longs and shorts. The Rule Edge Analysis will have data but not enough to be conclusive. Use this phase to identify obvious leaks — are you losing every time you trade frustrated? Stop trading when frustrated. 50 TRADES: The Combo Analysis starts to show meaningful patterns. You'll see 2-rule combinations with enough sample size to act on. Your ADX buckets will show which market conditions suit your style. The Entry Quality Scores start showing a correlation between score and outcome. 100 TRADES: You have a statistically meaningful dataset. Your expectancy is calculable with real confidence. The Edge Decay Monitor becomes meaningful — you can see if recent performance is holding up. You now have enough data to define your A+ setup criteria and filter everything else out.",
tip:"The best use of your first 100 trades is not to make money — it's to collect clean data. Size small, follow rules strictly, log everything. The real money comes from trade 101 onward when you know what you're doing and why. Most traders want to skip to the profits. The ones who do the data work first compound faster and survive longer."},
// === USING THIS JOURNAL ===
{id:"b_use1",cat:"Using This Journal",icon:"🚀",title:"Your First Trade — Start to Finish",
summary:"Here's exactly how to log your first trade so no field gets missed and your data stays clean from day one.",
detail:"Before the trade: Fill in Date, Ticker, Timeframe, Direction (Long/Short), Type (Reversal or Continuation). Set your Entry Price, Stop Price, and Shares — these lock in your planned risk. Select your Strategy and score your Setup Rules Y/N while the setup is still in front of you. Log Emotional State at entry honestly. After the trade closes: Add Exit Price and Exit Time. Fill in MFE (the best price the trade reached) and MAE (the worst drawdown). Log ADX at Entry, RSI at Entry, Volume at Exit. Add your entry and exit screenshots. Mark Stop Management rules. Set Followed Rules Y/N — be ruthless. Then save. The whole process takes 2-3 minutes when the trade is fresh. Waiting until end of day means you forget the details that matter most.",
tip:"Screenshot discipline is the single highest-value habit beyond the trade itself. A screenshot of the entry chart at the exact moment you entered is worth more than any notes. In three months you'll be able to see exactly what your setups looked like and compare winning setup charts to losing ones visually. This is a pattern recognition tool that no amount of text notes can replicate."},
{id:"b_use2",cat:"Using This Journal",icon:"🔍",title:"Reading the Analysis — What to Look For First",
summary:"When you have 20+ trades logged, the Analysis tab starts showing real data. Here's what to look at first and what it means.",
detail:"FIRST STOP — Followed Rules stat: If you have any trades where Followed Rules = N, look at the performance difference immediately. If your N trades are losing at a dramatically higher rate than Y trades, that's your first and most important lesson. SECOND — Rule Edge Analysis: Sort by Edge (the default). The top rules are your most predictive conditions. The bottom rules (edge near zero) might be worth removing from your checklist. THIRD — Emotional State bucket: Find which emotions appear most often in your losing trades. This is usually the fastest behavioral insight to act on. FOURTH — ADX buckets: See which ADX ranges your win rate holds up in. If you're losing badly below ADX 20, stop trading when ADX is below 20. FIFTH — Min Rule Count: How many rules need to be Y before you should enter? If 5+ rules showing is your sweet spot, make that your minimum.",
tip:"The analysis gets more meaningful with every trade you add — but don't wait for perfection to start acting on it. If after 25 trades the data shows you're 0-8 when trading frustrated, that's enough data to make a rule: no trading when frustrated. You don't need 100 trades to act on obvious patterns. Act on clear signals early, refine the nuanced ones with more data."},
{id:"b_use3",cat:"Using This Journal",icon:"💡",title:"Backtest vs Live — Keeping It Clean",
summary:"The Live/Backtest toggle keeps your practice data separate from your real performance data. Never mix them — the analysis for each should reflect its own conditions.",
detail:"BACKTEST data is practice — historical chart replay trades. These trades are logged the same way as live trades but tagged as backtest so they don't contaminate your live performance stats. The analysis engine runs separately for each mode. Use backtest to: test new strategies before going live, recover from a losing streak by re-confirming your edge still works, test a rule modification before applying it live. LIVE data is real money, real execution, real emotion. This is your production system. Switch between modes using the Live/Backtest/All toggle in the top nav. The stat cards and analysis update to show only the selected mode's data. Running 'All' shows combined data — useful for seeing your biggest sample size, but be aware that backtest performance often looks better than live (real execution, slippage, and emotion are harder than replay).",
tip:"If your backtest win rate is 65% but your live win rate is 40%, the gap is usually one of three things: you're skipping setups that don't feel right (cherry-picking in reverse), slippage and emotion are costing you edge at execution, or you're subconsciously biasing your backtest. The honest answer is usually all three. Narrowing that gap is the work of serious trading development."}
];
var filtered=LESSONS.filter(function(l){return l.cat===bCat});
return h("div",null,
h("div",{style:{background:K.cd,borderRadius:8,border:"1px solid "+K.bd,padding:"12px 16px",marginBottom:12}},
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx,marginBottom:4}},"Beginner's Corner"),
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.5}},"New to trading or just getting started? This section covers the fundamentals — from reading a candle to understanding why journaling makes you a better trader. Work through each section in order, then come back as a reference. Click any card to expand.")),
h("div",{style:{display:"flex",gap:4,marginBottom:12,flexWrap:"wrap"}},
CATS.map(function(cat){return h("button",{key:cat,onClick:function(){setBCat(cat);setSelId(null)},style:{padding:"5px 12px",borderRadius:6,border:"1px solid "+(bCat===cat?K.cy:K.bd),fontSize:11,fontWeight:600,cursor:"pointer",background:bCat===cat?K.cy+"22":"transparent",color:bCat===cat?K.cy:K.dm}},cat)})),
h("div",{style:{display:"flex",flexDirection:"column",gap:8}},
filtered.map(function(l){
var isOpen=selId===l.id;
return h("div",{key:l.id,style:{background:K.cd,borderRadius:8,border:"1px solid "+(isOpen?K.cy:K.bd),padding:"12px 14px",cursor:"pointer"},onClick:function(){setSelId(isOpen?null:l.id)}},
h("div",{style:{display:"flex",alignItems:"center",gap:10}},
h("span",{style:{fontSize:22,flexShrink:0}},l.icon),
h("div",{style:{flex:1}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx}},l.title),
h("div",{style:{fontSize:10,color:K.dm,marginTop:2}},l.summary)),
h("div",{style:{fontSize:10,color:K.cy,flexShrink:0}},isOpen?"▲":"▼")),
isOpen?h("div",{style:{marginTop:10,paddingTop:10,borderTop:"1px solid "+K.bd}},
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.7,marginBottom:8}},l.detail),
l.detail2?h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.7,marginBottom:8,borderLeft:"3px solid "+K.go,paddingLeft:10}},l.detail2):null,
h("div",{style:{background:K.bg,borderRadius:6,padding:"8px 12px",borderLeft:"3px solid "+K.cy}},
h("div",{style:{fontSize:9,color:K.cy,fontWeight:700,marginBottom:3}},"KEY INSIGHT"),
h("div",{style:{fontSize:10,color:K.dm,lineHeight:1.5}},l.tip))):null)})))};


// === EXPORT/IMPORT ===
function expJ(){var b=new Blob([JSON.stringify(trades,null,2)],{type:"application/json"});var u=URL.createObjectURL(b);var a=document.createElement("a");a.href=u;a.download="trade_journal_"+new Date().toISOString().slice(0,10)+".json";a.click();URL.revokeObjectURL(u)}
function impJ(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){try{var d=JSON.parse(ev.target.result);if(Array.isArray(d))setTr(d)}catch(err){alert("Bad JSON")}};r.readAsText(f)}
function impCSV(e){var f=e.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(ev){parseCSV(ev.target.result,function(imported,err){if(err){alert("CSV error: "+err);return}if(window.confirm("Import "+imported.length+" trades from CSV? This will ADD to existing trades.")){setTr(function(prev){return prev.concat(imported)})}})};r.readAsText(f)}
// Lightbox
// Chart URL modal overlay
var chartUrlOverlay=chartUrlModal?h("div",{onClick:function(){setChartUrlModal(null)},style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.7)",zIndex:9800,display:"flex",alignItems:"center",justifyContent:"center",padding:16}},
h("div",{onClick:function(e){e.stopPropagation()},style:{background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:20,width:"100%",maxWidth:440,boxShadow:K.sdw}},
h("div",{style:{fontSize:13,fontWeight:700,color:K.tx,marginBottom:4}},"Add Daily Chart"),
h("div",{style:{fontSize:10,color:K.dm,marginBottom:14}},"Paste a TradingView link or upload an image file"),
h("div",{style:{display:"flex",gap:6,marginBottom:10}},
h("input",{type:"text",value:chartUrlInput,onChange:function(e){setChartUrlInput(e.target.value)},placeholder:"https://www.tradingview.com/chart/...",style:{flex:1,background:K.inp,border:"1px solid "+K.bd,borderRadius:6,padding:"8px 10px",color:K.tx,fontSize:12,outline:"none"}}),
h("button",{onClick:function(){if(chartUrlInput.trim()){setDayChart(chartUrlModal,chartUrlInput.trim());setChartUrlModal(null);}},style:{padding:"8px 14px",background:K.cy,border:"none",borderRadius:6,color:"#fff",fontSize:12,fontWeight:700,cursor:"pointer"}},"Save")),
h("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:10}},
h("div",{style:{flex:1,height:1,background:K.bd}}),
h("div",{style:{fontSize:10,color:K.dm}},"or"),
h("div",{style:{flex:1,height:1,background:K.bd}})),
h("button",{onClick:function(){dcDateRef.current=chartUrlModal;dcRef.current&&dcRef.current.click();setChartUrlModal(null);},style:{width:"100%",padding:"8px 0",background:K.bg,border:"1px dashed "+K.bd,borderRadius:6,color:K.dm,fontSize:12,cursor:"pointer"}},"📁 Upload image file"),
h("div",{style:{marginTop:12,textAlign:"right"}},
h("button",{onClick:function(){setChartUrlModal(null)},style:{padding:"4px 12px",background:"transparent",border:"1px solid "+K.bd,borderRadius:6,color:K.dm,fontSize:11,cursor:"pointer"}},"Cancel")))):null;

// Daily journal modal overlay
var djOverlay=djModal?h("div",{onClick:function(){setDjModal(null)},style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.7)",zIndex:9800,display:"flex",alignItems:"center",justifyContent:"center",padding:16}},
h("div",{onClick:function(e){e.stopPropagation()},style:{background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:20,width:"100%",maxWidth:520,boxShadow:K.sdw}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}},
h("div",{style:{fontSize:13,fontWeight:700,color:K.tx}},"📓 Daily Journal — "+djModal),
h("button",{onClick:function(){setDjModal(null)},style:{background:"transparent",border:"none",color:K.dm,fontSize:18,cursor:"pointer",lineHeight:1}},"×")),
h("div",{style:{fontSize:10,color:K.dm,marginBottom:12}},"Notes, observations, what you saw in the market today"),
h("textarea",{value:djText,onChange:function(e){setDjText(e.target.value)},placeholder:"Today's market was choppy in the first hour...\nI noticed my best trades came after 10:30...\nMistakes: jumped in before confirmation on trade 3...",rows:8,style:{width:"100%",background:K.inp,border:"1px solid "+K.bd,borderRadius:8,padding:"10px 12px",color:K.tx,fontSize:12,lineHeight:1.6,resize:"vertical",outline:"none",fontFamily:"'IBM Plex Sans',sans-serif",boxSizing:"border-box"}}),
h("div",{style:{display:"flex",justifyContent:"flex-end",gap:8,marginTop:10}},
h("button",{onClick:function(){setDjModal(null)},style:{padding:"6px 14px",background:"transparent",border:"1px solid "+K.bd,borderRadius:6,color:K.dm,fontSize:11,cursor:"pointer"}},"Cancel"),
h("button",{onClick:function(){
setDj(function(prev){var n=Object.assign({},prev);if(!n[djModal])n[djModal]={};n[djModal].log=djText;return n});
setDjModal(null);
},style:{padding:"6px 14px",background:K.cy,border:"none",borderRadius:6,color:"#fff",fontSize:11,fontWeight:700,cursor:"pointer"}},"Save")))):null;

// Lightbox overlay
var lbOverlay=lb?h("div",{onClick:function(){setLb(null)},style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.92)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center",cursor:"zoom-out"}},
h("img",{src:lb,alt:"",style:{maxWidth:"90vw",maxHeight:"90vh",borderRadius:8,boxShadow:"0 8px 40px rgba(0,0,0,0.8)"}}),
h("div",{onClick:function(e){e.stopPropagation();setLb(null)},style:{position:"fixed",top:16,right:24,color:"#fff",fontSize:32,cursor:"pointer",fontWeight:300,lineHeight:1,zIndex:10000}},"\u00d7")):null;
// === SESSION STOP TAB ===
function RecoveryTable(p){
var recoveryStats=p.rs;
if(!recoveryStats||Object.keys(recoveryStats).length===0)return h("div",{style:{fontSize:11,color:K.dm,padding:"12px 0"}},"Need 5+ sessions of data to build recovery statistics.");
return h("div",null,
h("div",{style:{fontSize:11,color:K.dm,marginBottom:8,lineHeight:1.6}},"When you're DOWN at each trade checkpoint, how often do you recover by end of session?"),
h("div",{style:{display:"flex",flexDirection:"column",gap:4}},
Object.values(recoveryStats).map(function(r){
if(r.neg<2)return null;
var recPct=r.negRecovery!==null?Math.round(r.negRecovery*100):null;
var avgRem=r.avgRemainingWhenDown;
var color=recPct>=60?K.g:recPct>=40?K.go:K.r;
return h("div",{key:r.n,style:{background:K.bg,borderRadius:8,padding:"10px 14px",border:"1px solid "+K.bd}},
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}},
h("span",{style:{fontSize:12,fontWeight:700,color:K.tx}},"After trade #"+r.n),
h("span",{style:{fontSize:11,color:K.dm}},r.neg+" sessions where you were down")),
h("div",{style:{display:"flex",gap:12}},
recPct!==null?h("div",{style:{textAlign:"center"}},
h("div",{style:{fontSize:22,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:color}},recPct+"%"),
h("div",{style:{fontSize:9,color:K.dm}},"recovered")):null,
avgRem!==null?h("div",{style:{textAlign:"center"}},
h("div",{style:{fontSize:22,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:avgRem>=0?K.g:K.r}},(avgRem>=0?"+$":"-$")+Math.abs(avgRem).toFixed(0)),
h("div",{style:{fontSize:9,color:K.dm}},"avg P/L from here")):null,
h("div",{style:{flex:1,display:"flex",alignItems:"center"}},
h("div",{style:{width:"100%",height:8,background:K.bd,borderRadius:4}},
recPct!==null?h("div",{style:{width:Math.min(recPct,100)+"%",height:"100%",background:color,borderRadius:4}}):null))));
})));
}
// === TOUR MODAL ===
var TOUR_SECTIONS=[
{id:"log",icon:"📋",title:"The Log",steps:[
{h:"Grouped View",b:"Your trades are grouped by day. Each day header shows date, trade count, win/loss, and total P/L at a glance. Click the header to expand or collapse the day."},
{h:"Day Header Buttons",b:"G = tag as a Good Day, B = Bad Day. 📊 = attach your full annotated daily chart. J = write daily journal notes for that session. 🗑 = delete all trades for the day."},
{h:"Trade Rows",b:"Each row shows direction (L/S), ticker, entry/exit prices, shares, duration, capture %, ADX, RSI, P/L, and R-multiple. Color-coded left border: green = win, red = loss."},
{h:"Filter Bar",b:"Filter by direction (All/Longs/Shorts), type (Rev/Cont), ticker, and sort order. Switch between Grouped and Flat view. Use Select for bulk actions."},
{h:"Live vs Backtest",b:"The mode switcher at the top of the sidebar (Live / BT / All) keeps your real trades and practice trades completely separate with their own analysis pools."},
{h:"EX and SEL Buttons",b:"EX excludes a trade from analysis without deleting it — useful for outliers. SEL marks trades for group analysis in the Insights tab."},
{h:"Multi-Select",b:"Hit Select in the filter bar to enter checkbox mode. Check individual trades or use the All button on a day header to grab the whole day. Bulk exclude or delete from the action bar."}
]},
{id:"entry",icon:"✏️",title:"Trade Entry",steps:[
{h:"Full vs Quick Mode",b:"Full mode captures everything. Quick mode is stripped down for fast entry mid-session — just the essentials. Toggle with the Quick button in the form header."},
{h:"NOW — Can't Recover Later",b:"The orange section at the top contains fields you must fill in before the trade closes: session read, confidence, emotion, and Followed Rules. Everything else can be filled later."},
{h:"Followed Rules (Y/N)",b:"The single most important field. Did this trade meet your minimum entry criteria? The data will prove exactly what rule-breaking costs you in real dollars."},
{h:"Setup Rules",b:"11 toggles for your technical criteria: Ultimate H/L, LH/HL, Channel Break, Channel Retest, 1st Candle 10EMA, 2nd Candle Entry, MACD Cross, Cloud Align, RSI Extreme, 15m Cloud. Y/N for each."},
{h:"MFE and MAE",b:"MFE = best price the trade reached (Maximum Favorable Excursion). MAE = worst drawdown during the trade (Maximum Adverse Excursion). These unlock capture % and exit analysis."},
{h:"Screenshots",b:"Drag and drop, upload a file, or paste a URL. Entry and exit screenshots stored separately. Click any thumbnail in the log to zoom full screen."},
{h:"AI Import",b:"Take two TradingView screenshots (entry + exit) with the Pine Script overlay active. Paste into AI Import and Claude reads all your indicator values and pre-fills the form."}
]},
{id:"analysis",icon:"🔬",title:"Raw Data Analysis",steps:[
{h:"Rule Edge Analysis",b:"Every rule ranked by its edge: win rate when the rule is Y minus win rate when N. Sorted highest to lowest. This tells you which rules actually matter vs which are noise."},
{h:"Bucket Analysis",b:"Groups trades by numeric ranges — ADX, RSI, cloud width, duration, confidence, emotion, time of day, trade number of day. Shows which conditions produce your best results."},
{h:"Your Read vs System Read",b:"Compares your manual session tag (Trending/Choppy/etc.) against what the ADX and cloud width data actually measured. Mismatch vs match performance. Quantifies whether your market read is an asset or liability."},
{h:"Top Setup Combos",b:"Ranks all 2-rule and 3-rule combinations by win rate and R. Requires 5+ trades per combo. These are your actual best setups discovered from data — not what you think works."},
{h:"Conditional Edge",b:"When Rule A is Y, what does adding Rule B give you? Shows the incremental value of each rule when others are already present. Requires 8+ trades."},
{h:"Entry Quality Scores",b:"Weights each rule by its edge contribution, scores every trade 0-100. Scatter plot of score vs P/L outcome. Over time this becomes your pre-trade quality gate."},
{h:"Edge Decay Monitoring",b:"Rolling window showing all-time vs last 20 vs last 10 performance for every rule and combo. Flags when recent performance diverges from your historical average. Shows when your edge is dying before you give back months of profits."}
]},
{id:"insights",icon:"💡",title:"Insights",steps:[
{h:"What Insights Does",b:"The Insights tab synthesizes your data into coaching-style narrative cards — not raw tables. It tells you what the data means, not just what the numbers are."},
{h:"Good Day / Bad Day Comparison",b:"Tag days as G or B in the log. Insights shows rule-by-rule breakdowns of what behaves differently on your good days vs bad days. Often reveals a single pattern that separates them."},
{h:"Live vs Backtest Gap",b:"Compares your execution metrics side by side: win rate, rules followed, avg R, duration, capture %. The gap between backtest and live is where most traders lose money invisibly."},
{h:"Selection Insights",b:"Mark 3+ trades with SEL in the log. Insights analyzes that specific group vs your baseline — win rate, R, duration, overtrading score. Use it to study a streak, a rough patch, or any period you want to understand."},
{h:"Insight Cards",b:"Generated from 10+ trade patterns — emotional state costs, rule adherence rates, session timing, divergence alignment, MAE timing. Each card shows sample size and actionability score."}
]},
{id:"equity",icon:"📈",title:"Equity & Dashboard",steps:[
{h:"Cumulative P/L Chart",b:"SVG line chart with hover tooltips per trade. Zero line visible. Shows your equity curve over time — the shape tells you if you're consistently growing or spiking and giving back."},
{h:"Period Breakdown",b:"Toggle Daily / Weekly / Monthly / Quarterly. Horizontal bars per period showing P/L, trade count, and wins. Spot which weeks or months you're consistently profitable vs struggling."},
{h:"Dashboard",b:"Stat cards with donut charts for rule adherence and emotion breakdown. Sparkline equity curve. Best/worst streak tracking. Overview of your entire trading performance at a glance."},
{h:"P/L Adjustments",b:"Each period in the equity view has a small +/- adjustment field for commissions, fees, or corrections. Adjustments display separately and don't affect analysis."}
]},
{id:"tools",icon:"🛠️",title:"Tools",steps:[
{h:"Session Stop Engine",b:"Tells you — based on YOUR historical data — when to stop trading. Built from your own sessions: after trade #N when you're down $X, you historically recover only Y% of the time. Real numbers, not rules of thumb."},
{h:"Heatmap",b:"Win rate and P/L heat mapped by day of week and hour of day. Instantly surfaces your best and worst trading windows. Is Tuesday morning your edge? Is Friday afternoon a consistent drain?"},
{h:"Daily Log Tab",b:"Each day expanded with pre/mid/post journal fields, trade list with edit buttons, and scoring fields. The journaling layer lives here — write before, during, and after each session."},
{h:"Strategies",b:"Create named strategies with their own rule sets. Assign trades to strategies for separate performance tracking. Compare your Channel Reversal vs your Continuation strategy side by side."},
{h:"AI Import",b:"Paste TradingView screenshots into the AI Import tab. Claude Vision reads your Pine Script overlay and pre-fills the trade entry form. Confirm or adjust values before saving."}
]},
{id:"settings",icon:"⚙️",title:"Settings & Data",steps:[
{h:"Export / Import",b:"Export all your trades as JSON — your data, always portable. Import JSON to restore or migrate. CSV import template also available for bulk historical entry."},
{h:"Light / Dark Mode",b:"Toggle in the Settings panel at the bottom of the sidebar. Your preference saves automatically."},
{h:"Clear All Data",b:"Wipes all trades and settings. Requires typing CONFIRM. Irreversible — export first if you want a backup."},
{h:"localStorage Limit",b:"Data is stored locally in your browser. Typically 5-10MB limit. If you add many large screenshots this can fill up — export JSON regularly as a backup. Cloud storage is coming in v1 paid."},
{h:"Beta Access",b:"You're on the beta version. Features are being actively developed. Use the thumbs down icon on any response to give feedback. Your data carries forward into future versions."}
]}
];

function TourModal(){
if(!showTour)return null;
var sec=TOUR_SECTIONS[tourSection];
return h("div",{onClick:function(){setShowTour(false)},style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,.8)",zIndex:9900,display:"flex",alignItems:"center",justifyContent:"center",padding:16}},
h("div",{onClick:function(e){e.stopPropagation()},style:{background:K.cd,borderRadius:14,border:"1px solid "+K.bd,width:"100%",maxWidth:640,maxHeight:"85vh",display:"flex",flexDirection:"column",boxShadow:K.sdw}},
// Header
h("div",{style:{display:"flex",alignItems:"center",gap:10,padding:"16px 20px",borderBottom:"1px solid "+K.bd,flexShrink:0}},
h("div",{style:{fontSize:18}},sec.icon),
h("div",{style:{flex:1}},
h("div",{style:{fontSize:14,fontWeight:700,color:K.tx}},sec.title),
h("div",{style:{fontSize:10,color:K.dm}},tourSection+1+" of "+TOUR_SECTIONS.length+" sections")),
h("button",{onClick:function(){setShowTour(false)},style:{background:"transparent",border:"none",color:K.dm,fontSize:20,cursor:"pointer",lineHeight:1,padding:"0 4px"}},"×")),
// Section tabs
h("div",{style:{display:"flex",gap:4,padding:"10px 16px",borderBottom:"1px solid "+K.bd,flexWrap:"wrap",flexShrink:0}},
TOUR_SECTIONS.map(function(s,i){return h("button",{key:s.id,onClick:function(){setTourSection(i)},style:{padding:"4px 10px",borderRadius:5,border:"1px solid "+(i===tourSection?K.cy:K.bd),background:i===tourSection?K.cy+"22":"transparent",color:i===tourSection?K.cy:K.dm,fontSize:10,fontWeight:i===tourSection?700:400,cursor:"pointer"}},s.icon+" "+s.title);})),
// Steps
h("div",{style:{flex:1,overflowY:"auto",padding:"16px 20px",display:"flex",flexDirection:"column",gap:12}},
sec.steps.map(function(step,i){return h("div",{key:i,style:{background:K.bg,borderRadius:8,padding:"12px 14px",borderLeft:"3px solid "+K.cy}},
h("div",{style:{fontSize:12,fontWeight:700,color:K.tx,marginBottom:4}},step.h),
h("div",{style:{fontSize:11,color:K.dm,lineHeight:1.7}},step.b));})),
// Footer nav
h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 20px",borderTop:"1px solid "+K.bd,flexShrink:0}},
h("button",{onClick:function(){setTourSection(function(p){return Math.max(0,p-1)})},disabled:tourSection===0,style:{padding:"6px 16px",borderRadius:6,border:"1px solid "+K.bd,background:"transparent",color:tourSection===0?K.dm:K.tx,fontSize:11,cursor:tourSection===0?"default":"pointer"}},"← Previous"),
h("div",{style:{fontSize:10,color:K.dm}},sec.steps.length+" topics in this section"),
h("button",{onClick:function(){if(tourSection<TOUR_SECTIONS.length-1){setTourSection(function(p){return p+1})}else{setShowTour(false)}},style:{padding:"6px 16px",borderRadius:6,border:"none",background:K.cy,color:"#fff",fontSize:11,fontWeight:700,cursor:"pointer"}},tourSection<TOUR_SECTIONS.length-1?"Next →":"Done ✓"))));
}
var SessionStopTab=function(){
var cp=mf.filter(function(t){return t.entry&&t.exit&&t.shares&&t.time;});

// Build session-level data: group by date, compute cumulative P/L by trade sequence
var sessions=um(function(){
var byDate={};
cp.forEach(function(t){if(!byDate[t.date])byDate[t.date]=[];byDate[t.date].push(t);});
return Object.keys(byDate).sort().map(function(date){
var trades2=byDate[date].slice().sort(function(a,b){return(a.time||"").localeCompare(b.time||"")});
var running=0;var curve=trades2.map(function(t,i){running+=cPL(t).pl;return{n:i+1,pl:running,time:t.time,emotion:t.emotion,followedRules:t.followedRules};});
var final=running;var peak=Math.max.apply(null,curve.map(function(c){return c.pl;}));var trough=Math.min.apply(null,curve.map(function(c){return c.pl;}));
return{date:date,curve:curve,final:final,peak:peak,trough:trough,n:trades2.length};
});
},[cp.length,md]);

// Recovery stats: given I'm down $X at trade N, what do I historically make from here?
var recoveryStats=um(function(){
if(sessions.length<5)return null;
// For each trade number checkpoint (1,2,3,4,5+), bucket sessions by P/L at that point
// and compute what they made from that point to end of session
var checkpoints=[1,2,3,4,5];
var result={};
checkpoints.forEach(function(n){
var data=[];
sessions.forEach(function(s){
var atN=s.curve.find(function(c){return c.n===n;});
if(!atN)return;
var remaining=s.final-atN.pl;
data.push({plAtN:atN.pl,remaining:remaining,recovered:remaining>0});
});
if(data.length<3)return;
// Bucket by P/L at that point
var neg=data.filter(function(d){return d.plAtN<0;});
var pos=data.filter(function(d){return d.plAtN>=0;});
var negRecovery=neg.length?neg.filter(function(d){return d.recovered;}).length/neg.length:null;
var avgRemaining=data.reduce(function(s,d){return s+d.remaining;},0)/data.length;
var avgRemainingWhenDown=neg.length?neg.reduce(function(s,d){return s+d.remaining;},0)/neg.length:null;
result[n]={n:n,total:data.length,neg:neg.length,pos:pos.length,negRecovery:negRecovery,avgRemaining:avgRemaining,avgRemainingWhenDown:avgRemainingWhenDown};
});
return result;
},[sessions.length]);

// Current session score — multi-factor
var todayStr=new Date().toISOString().slice(0,10);
var todayTrades=mf.filter(function(t){return t.date===todayStr&&t.entry&&t.exit&&t.shares;}).sort(function(a,b){return(a.time||"").localeCompare(b.time||"");});
var todayCurve=function(){var r=0;return todayTrades.map(function(t,i){r+=cPL(t).pl;return{n:i+1,pl:r,emotion:t.emotion,followedRules:t.followedRules};});};
var curve=todayCurve();
var currentPL=curve.length?curve[curve.length-1].pl:0;
var tradeCount=todayTrades.length;

// Score factors (0-100 each, weighted)
var factors=[];
if(sessions.length>=5){
// Factor 1: Current P/L vs historical distribution at this trade count
if(recoveryStats&&recoveryStats[Math.min(tradeCount,5)]){
var rs2=recoveryStats[Math.min(tradeCount,5)];
if(currentPL<0&&rs2.avgRemainingWhenDown!==null){
var coverRatio=(rs2.avgRemainingWhenDown+currentPL)/Math.abs(currentPL);
var f1Score=Math.max(0,Math.min(100,Math.round(coverRatio*100)));
factors.push({label:"Recovery potential",score:f1Score,detail:"Historical avg recovery from this point: "+(rs2.avgRemainingWhenDown>=0?"+$":"-$")+Math.abs(rs2.avgRemainingWhenDown).toFixed(0)});
}}

// Factor 2: Rule adherence today
var todayFollowed=todayTrades.filter(function(t){return t.followedRules==="Y";}).length;
var adherenceRate=tradeCount>0?todayFollowed/tradeCount:1;
var f2Score=Math.round(adherenceRate*100);
if(tradeCount>0)factors.push({label:"Rule adherence today",score:f2Score,detail:todayFollowed+"/"+tradeCount+" trades followed rules"});

// Factor 3: Emotion at last trade
var lastEmotion=todayTrades.length?todayTrades[todayTrades.length-1].emotion:"";
var emotionScores={calm:90,confident:85,eager:70,bored:55,frustrated:25,fomo:20,angry:15,revenge:5};
if(lastEmotion){
var f3Score=emotionScores[lastEmotion]||50;
factors.push({label:"Current emotional state",score:f3Score,detail:"Last logged: "+lastEmotion});
}

// Factor 4: Win rate on last 3 trades
if(tradeCount>=3){
var last3=todayTrades.slice(-3);
var last3wins=last3.filter(function(t){return cPL(t).pl>0;}).length;
var f4Score=Math.round(last3wins/3*100);
factors.push({label:"Last 3 trade momentum",score:f4Score,detail:last3wins+"/3 recent wins"});
}

// Factor 5: Trade count vs your historical best stopping point
var allTradeNums=sessions.map(function(s){return s.n;});
var avgTradeCount=allTradeNums.reduce(function(a,b){return a+b;},0)/allTradeNums.length;
if(tradeCount>0){
var f5Score=tradeCount<=Math.round(avgTradeCount)?75:Math.max(10,Math.round((1-(tradeCount-avgTradeCount)/avgTradeCount)*75));
factors.push({label:"Trade count vs your average",score:f5Score,detail:"You avg "+avgTradeCount.toFixed(1)+" trades/day. Today: "+tradeCount});
}
}

var overallScore=factors.length?Math.round(factors.reduce(function(s,f){return s+f.score;},0)/factors.length):null;
var recommendation=overallScore===null?"No data yet":overallScore>=65?"Keep Trading":overallScore>=40?"Size Down":overallScore>=20?"Pause & Review":"Stop Trading";
var recColor=overallScore===null?K.dm:overallScore>=65?K.g:overallScore>=40?K.go:overallScore>=20?"#fd9644":K.r;

// Historical recovery table

if(sessions.length<3)return h("div",{style:{padding:"48px 20px",textAlign:"center"}},
h("div",{style:{fontSize:48,marginBottom:16}},"🛑"),
h("div",{style:{fontSize:18,fontWeight:700,color:K.tx,marginBottom:8}},"Session Stop Engine"),
h("div",{style:{fontSize:13,color:K.dm,maxWidth:400,margin:"0 auto",lineHeight:1.7}},"Log at least 3 full sessions and this engine will tell you — based on YOUR data — when the statistics say it's time to stop."),
h("div",{style:{fontSize:11,color:K.dm,marginTop:12}},sessions.length+" sessions logged so far. Need 3 to activate."));

return h("div",null,
// Header
h("div",{style:{background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:"16px 20px",marginBottom:16}},
h("div",{style:{fontSize:15,fontWeight:700,color:K.tx,marginBottom:4}},"🛑 Session Stop Engine"),
h("div",{style:{fontSize:12,color:K.dm,lineHeight:1.6}},"Built from your "+sessions.length+" logged sessions. Every factor below is calculated from your own historical data — not generic rules.")),

// Today's live score (only show if trades today)
tradeCount>0?h("div",{style:{background:K.cd,borderRadius:12,border:"2px solid "+recColor+"55",padding:"20px 24px",marginBottom:16}},
h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:12}},
h("div",null,
h("div",{style:{fontSize:11,color:K.dm,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:4}},"Today's Session — "+tradeCount+" trades"),
h("div",{style:{fontSize:28,fontWeight:700,color:recColor}},recommendation),
h("div",{style:{fontSize:13,color:K.dm,marginTop:4}},"Session P/L: ",h("span",{style:{color:fmtColor(currentPL),fontFamily:"JetBrains Mono,monospace",fontWeight:700}},fmtMain(currentPL,null)))),
overallScore!==null?h("div",{style:{textAlign:"center"}},
h(Donut,{value:overallScore,size:88,thick:10,color:recColor}),
h("div",{style:{fontSize:10,color:K.dm,marginTop:4}},"Continue score")):null),
factors.length>0?h("div",{style:{marginTop:16,display:"flex",flexDirection:"column",gap:6}},
factors.map(function(f,i){
var fc=f.score>=65?K.g:f.score>=40?K.go:K.r;
return h("div",{key:i,style:{display:"flex",alignItems:"center",gap:10}},
h("div",{style:{width:120,fontSize:11,color:K.tx,flexShrink:0}},f.label),
h("div",{style:{flex:1,height:6,background:K.bd,borderRadius:3}},
h("div",{style:{width:f.score+"%",height:"100%",background:fc,borderRadius:3}})),
h("div",{style:{width:34,fontSize:11,fontFamily:"JetBrains Mono,monospace",color:fc,textAlign:"right",flexShrink:0}},f.score),
h("div",{style:{fontSize:10,color:K.dm,minWidth:160}},f.detail));})):null):
h("div",{style:{background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:"16px 20px",marginBottom:16,fontSize:12,color:K.dm}},"No trades logged today yet. Score activates when you start your session."),

// Live drawdown status card
(function(){
if(!recoveryStats||Object.keys(recoveryStats).length===0||currentPL>=0)return null;
var snapN=Math.min(tradeCount||1,5);
var rs3=recoveryStats[snapN];
if(!rs3||rs3.neg<2)return null;
var recPct=rs3.negRecovery!==null?Math.round(rs3.negRecovery*100):null;
var avgRem=rs3.avgRemainingWhenDown;
var col=recPct>=60?K.g:recPct>=40?K.go:K.r;
return h("div",{style:{background:K.cd,borderRadius:12,border:"2px solid "+col+"55",padding:"16px 20px",marginBottom:16}},
h("div",{style:{fontSize:13,fontWeight:700,color:K.tx,marginBottom:10}},
"You are down $"+Math.abs(currentPL).toFixed(0)+" after "+tradeCount+" trade"+(tradeCount!==1?"s":"")),
h("div",{style:{display:"flex",gap:16,alignItems:"center",flexWrap:"wrap"}},
recPct!==null?h("div",{style:{textAlign:"center",minWidth:80}},
h("div",{style:{fontSize:36,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:col}},recPct+"%"),
h("div",{style:{fontSize:10,color:K.dm}},"historical"),
h("div",{style:{fontSize:10,color:K.dm}},"recovery rate"),
h("div",{style:{fontSize:9,color:K.dm}},"("+rs3.neg+" sessions)")):null,
avgRem!==null?h("div",{style:{textAlign:"center",minWidth:80}},
h("div",{style:{fontSize:36,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:avgRem>=0?K.g:K.r}},(avgRem>=0?"+$":"-$")+Math.abs(avgRem).toFixed(0)),
h("div",{style:{fontSize:10,color:K.dm}},"avg P/L"),
h("div",{style:{fontSize:10,color:K.dm}},"from here to close")):null,
h("div",{style:{flex:1,minWidth:160,padding:"12px 16px",borderRadius:8,background:col+"22",border:"1px solid "+col+"44",textAlign:"center"}},
h("div",{style:{fontSize:14,fontWeight:700,color:col,marginBottom:6}},
recPct>=60?"Keep going":recPct>=40?"Caution — 50/50":"Stop here"),
h("div",{style:{fontSize:10,color:K.dm,lineHeight:1.5}},
recPct>=60?"You dig out from this hole more than half the time. Stay disciplined."
:recPct>=40?"Roughly even odds from this point. Be very selective or size down significantly."
:"You rarely recover from this deficit at trade "+snapN+". Protect what you have left."))));
})(  ),

// Recovery stats table
h("div",{style:{background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:"16px 20px",marginBottom:16}},
h("div",{style:{fontSize:13,fontWeight:700,color:K.tx,marginBottom:12}},"Recovery Statistics by Checkpoint"),
h(RecoveryTable,{rs:recoveryStats})),

// Session history
h("div",{style:{background:K.cd,borderRadius:12,border:"1px solid "+K.bd,padding:"16px 20px"}},
h("div",{style:{fontSize:13,fontWeight:700,color:K.tx,marginBottom:12}},"Session History"),
h("div",{style:{display:"flex",flexDirection:"column",gap:4}},
sessions.slice().reverse().slice(0,20).map(function(s,i){
return h("div",{key:s.date,style:{display:"flex",alignItems:"center",gap:10,padding:"8px 12px",background:K.bg,borderRadius:8,fontSize:11}},
h("div",{style:{width:80,color:K.dm,flexShrink:0}},s.date.slice(5)),
h("div",{style:{width:20,color:K.dm,flexShrink:0}},s.n+"tr"),
h("div",{style:{flex:1,height:6,background:K.bd,borderRadius:3}},
h("div",{style:{width:Math.min(Math.abs(s.final)/10,100)+"%",height:"100%",background:s.final>=0?K.g:K.r,borderRadius:3}})),
h("div",{style:{width:70,fontWeight:700,fontFamily:"JetBrains Mono,monospace",color:fmtColor(s.final),textAlign:"right",flexShrink:0}},fmtMain(s.final,null)));}))));};

var lc=trades.filter(function(t){return(t.mode||"live")==="live"}).length;
var bc=trades.filter(function(t){return(t.mode||"live")==="backtest"}).length;

// Click outside to close menus
ue(function(){
function handler(e){if(!e.target.closest("[data-menu]"))setOpenMenu(null);}
document.addEventListener("mousedown",handler);
return function(){document.removeEventListener("mousedown",handler);}
},[]);

function NavBtn(p){
var active=[].concat(p.views||[]).indexOf(vw)>=0;
return h("button",{"data-menu":p.id,onClick:function(e){e.stopPropagation();setOpenMenu(openMenu===p.id?null:p.id);if(!p.children)setVw(p.id);},
style:{padding:"5px 11px",borderRadius:6,border:"1px solid "+(active?K.cy+"66":K.bd),fontSize:11,fontWeight:600,cursor:"pointer",
background:active?K.cy+"22":"transparent",color:active?K.cy:K.dm,whiteSpace:"nowrap",display:"flex",alignItems:"center",gap:4}},
p.label,p.children?h("span",{style:{fontSize:8,color:active?K.cy:K.dm}},"▾"):null);}

function DropMenu(p){
if(openMenu!==p.id)return null;
return h("div",{"data-menu":p.id,style:{position:"absolute",top:"100%",left:0,marginTop:4,background:K.cd,border:"1px solid "+K.bd,borderRadius:10,
minWidth:p.width||160,zIndex:9000,padding:6,boxShadow:"0 8px 32px rgba(0,0,0,.6)"}},p.children);}

function MenuItem(p){
return h("button",{onClick:function(){setVw(p.view);setOpenMenu(null);},
style:{display:"flex",alignItems:"center",gap:8,width:"100%",padding:"7px 12px",border:"none",background:vw===p.view?K.cy+"22":"transparent",
color:vw===p.view?K.cy:K.tx,fontSize:11,fontWeight:600,cursor:"pointer",borderRadius:6,textAlign:"left"}},
p.icon?h("span",{style:{fontSize:14}},p.icon):null,p.label);}

function Divider(){return h("div",{style:{height:1,background:K.bd,margin:"4px 6px"}});}

return h("div",{style:{background:K.bg,minHeight:"100vh",color:K.tx,fontFamily:"'IBM Plex Sans',-apple-system,sans-serif",display:"flex"}},
sf?rF():null,
h(TourModal,null),
chartUrlOverlay,
djOverlay,
lbOverlay,
h("div",{className:"tj-sidebar"+(sbCollapsed?" sb-mini":"")},
h("button",{className:"sb-toggle",onClick:function(){setSbCollapsed(function(p){return !p})},title:sbCollapsed?"Expand":"Collapse"},sbCollapsed?"›":"‹"),
h("div",{className:"sb-brand"},
  h("div",{className:"sb-logo"},"📈"),
  h("div",{className:"sb-brand-text"},
    h("div",{className:"sb-app-name"},"Trade Journal"),
    h("div",{className:"sb-app-badge"},"Beta"))),
h("div",{className:"sb-cta-wrap"},
  h("button",{className:"sb-cta",onClick:oN,title:"New Trade"},
    h("span",{className:"sb-cta-icon"},"+"),
    h("span",{className:"sb-cta-text"},"New Trade")),
  h("button",{className:"sb-quick-btn",onClick:oQ,title:"Quick Entry"},
    h("span",{className:"sb-link-icon"},"⚡"),h("span",{className:"sb-link-label"},"Quick Entry")),
  h("div",{className:"sb-mode-row"},
    h("button",{className:"sb-mode-btn"+(md==="live"?" m-live":""),onClick:function(){sMd("live")}},"Live ("+lc+")"),
    h("button",{className:"sb-mode-btn"+(md==="backtest"?" m-bt":""),onClick:function(){sMd("backtest")}},"BT ("+bc+")"),
    h("button",{className:"sb-mode-btn"+(md==="all"?" m-all":""),onClick:function(){sMd("all")}},"All"))),
h("div",{className:"sb-sec-label"},"Main"),
h("button",{className:"sb-link"+(vw==="log"?" sb-active":""),onClick:function(){setVw("log")},title:"Log"},h("span",{className:"sb-link-icon"},"📋"),h("span",{className:"sb-link-label"},"Log"),vw==="log"?h("span",{className:"sb-link-dot"}):null),
h("button",{className:"sb-link"+(vw==="dashboard"?" sb-active":""),onClick:function(){setVw("dashboard")},title:"Dashboard"},h("span",{className:"sb-link-icon"},"📊"),h("span",{className:"sb-link-label"},"Dashboard")),
h("button",{className:"sb-link"+(vw==="insights"?" sb-active":""),onClick:function(){setVw("insights")},title:"Insights"},h("span",{className:"sb-link-icon"},"💡"),h("span",{className:"sb-link-label"},"Insights")),
h("button",{className:"sb-link"+(vw==="equity"?" sb-active":""),onClick:function(){setVw("equity")},title:"Equity"},h("span",{className:"sb-link-icon"},"📈"),h("span",{className:"sb-link-label"},"Equity")),
h("div",{className:"sb-sec-label"},"Analysis"),
h("button",{className:"sb-link"+(vw==="rules"?" sb-active":""),onClick:function(){setVw("rules")},title:"Raw Data"},h("span",{className:"sb-link-icon"},"🔬"),h("span",{className:"sb-link-label"},"Raw Data")),
h("button",{className:"sb-link"+(vw==="heatmap"?" sb-active":""),onClick:function(){setVw("heatmap")},title:"Heatmap"},h("span",{className:"sb-link-icon"},"🗓"),h("span",{className:"sb-link-label"},"Heatmap")),
h("button",{className:"sb-link"+(vw==="daily"?" sb-active":""),onClick:function(){setVw("daily")},title:"Daily Log"},h("span",{className:"sb-link-icon"},"📅"),h("span",{className:"sb-link-label"},"Daily Log")),
h("div",{className:"sb-sec-label"},"Tools"),
h("button",{className:"sb-link"+(vw==="session_stop"?" sb-active":""),onClick:function(){setVw("session_stop")},title:"Session Stop"},h("span",{className:"sb-link-icon"},"🛑"),h("span",{className:"sb-link-label"},"Session Stop")),
h("button",{className:"sb-link"+(vw==="strategies"?" sb-active":""),onClick:function(){setVw("strategies")},title:"Strategies"},h("span",{className:"sb-link-icon"},"🗂"),h("span",{className:"sb-link-label"},"Strategies")),
h("button",{className:"sb-link"+(vw==="aiimport"?" sb-active":""),onClick:function(){setVw("aiimport")},title:"AI Import"},h("span",{className:"sb-link-icon"},"🤖"),h("span",{className:"sb-link-label"},"AI Import")),
h("div",{className:"sb-sec-label"},"Learn"),
h("button",{className:"sb-link"+(vw==="education"?" sb-active":""),onClick:function(){setVw("education")},title:"Education"},h("span",{className:"sb-link-icon"},"📚"),h("span",{className:"sb-link-label"},"Education")),
h("button",{className:"sb-link"+(vw==="news"?" sb-active":""),onClick:function(){setVw("news")},title:"Market News"},h("span",{className:"sb-link-icon"},"📰"),h("span",{className:"sb-link-label"},"Market News")),
h("button",{className:"sb-link"+(vw==="beginner"?" sb-active":""),onClick:function(){setVw("beginner")},title:"Beginner Guide"},h("span",{className:"sb-link-icon"},"🌱"),h("span",{className:"sb-link-label"},"Beginner Guide")),
h("div",{style:{marginTop:"auto"}}),
h("button",{"data-menu":"settings",className:"sb-link",onClick:function(){setOpenMenu(openMenu==="settings"?null:"settings")},title:"Settings"},h("span",{className:"sb-link-icon"},"⚙"),h("span",{className:"sb-link-label"},"Settings")),
openMenu==="settings"?h("div",{"data-menu":"settings",style:{background:themeMode==="light"?"#f7f9fc":"#111520",border:"1px solid "+(themeMode==="light"?"#e2e6ee":"#1e2840"),borderRadius:8,margin:"4px 8px",padding:"8px",maxHeight:380,overflowY:"auto"}},
  h("div",{style:{fontSize:9,color:K.dm,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:6}},"Appearance"),
  h("div",{style:{display:"flex",gap:4,marginBottom:6}},
    h("button",{onClick:function(){setRMode("dollar")},style:{flex:1,padding:"5px 0",borderRadius:5,border:"1px solid "+(rMode==="dollar"?K.g:K.bd),background:rMode==="dollar"?K.g+"22":"transparent",color:rMode==="dollar"?K.g:K.dm,fontSize:10,fontWeight:700,cursor:"pointer"}},"$ Dollar"),
    h("button",{onClick:function(){setRMode("R")},style:{flex:1,padding:"5px 0",borderRadius:5,border:"1px solid "+(rMode==="R"?K.cy:K.bd),background:rMode==="R"?K.cy+"22":"transparent",color:rMode==="R"?K.cy:K.dm,fontSize:10,fontWeight:700,cursor:"pointer"}},"R Multiple")),
  h("div",{style:{display:"flex",gap:4,marginBottom:8}},
    h("button",{onClick:function(){if(themeMode!=="dark")toggleTheme()},style:{flex:1,padding:"6px 0",borderRadius:5,border:"1px solid "+(themeMode==="dark"?K.cy:K.bd),background:themeMode==="dark"?K.cy+"22":"transparent",color:themeMode==="dark"?K.cy:K.dm,fontSize:10,fontWeight:700,cursor:"pointer"}},"\uD83C\uDF19 Dark"),
    h("button",{onClick:function(){if(themeMode!=="light")toggleTheme()},style:{flex:1,padding:"6px 0",borderRadius:5,border:"1px solid "+(themeMode==="light"?K.go:K.bd),background:themeMode==="light"?K.go+"22":"transparent",color:themeMode==="light"?K.go:K.dm,fontSize:10,fontWeight:700,cursor:"pointer"}},"\u2600\uFE0F Light")),
  h("div",{style:{height:1,background:K.bd,margin:"6px 0"}}),
  h("div",{style:{display:"flex",gap:3,flexWrap:"wrap",marginBottom:6}},
    h("button",{onClick:expJ,style:{flex:1,padding:"5px 4px",background:"transparent",border:"1px solid "+K.bd,borderRadius:5,color:K.dm,fontSize:9,cursor:"pointer"}},"Export"),
    h("button",{onClick:function(){ir.current&&ir.current.click()},style:{flex:1,padding:"5px 4px",background:"transparent",border:"1px solid "+K.bd,borderRadius:5,color:K.dm,fontSize:9,cursor:"pointer"}},"Import"),
    h("button",{onClick:function(){if(window.confirm("Clear ALL data?")){if(window.confirm("Delete all "+trades.length+" trades?")){setTr([]);localStorage.removeItem("tj5")}}},style:{flex:1,padding:"5px 4px",background:"transparent",border:"1px solid "+K.r,borderRadius:5,color:K.r,fontSize:9,cursor:"pointer"}},"\u26A0 Clear")),
  h("button",{onClick:function(){document.getElementById("tos-modal").style.display="flex"},style:{width:"100%",padding:"5px 4px",background:"transparent",border:"1px solid "+K.bd,borderRadius:5,color:K.dm,fontSize:9,cursor:"pointer",marginBottom:6}},"\uD83D\uDCCB Terms of Use"),
  h("button",{onClick:function(){setShowTour(true);setTourSection(0);setOpenMenu(null)},style:{width:"100%",padding:"5px 4px",background:K.cy+"15",border:"1px solid "+K.cy+"55",borderRadius:5,color:K.cy,fontSize:9,cursor:"pointer",marginBottom:6,fontWeight:700}},"🗺 Feature Walkthrough"),
  h("div",{style:{height:1,background:K.bd,margin:"4px 0"}}),
  h("div",{style:{fontSize:9,color:K.dm,fontWeight:700,textTransform:"uppercase",letterSpacing:"0.5px",margin:"6px 0 4px"}},"Stop Mgmt Rules"),
  h("div",{style:{display:"flex",flexDirection:"column",gap:3}},stopRules.map(function(r,i){return h("div",{key:r.k,style:{display:"flex",alignItems:"center",gap:4}},
    h("input",{value:r.l,onChange:function(e){var v=e.target.value;setStopRules(function(p){var n=p.slice();n[i]=Object.assign({},n[i],{l:v});return n})},style:{flex:1,background:K.bg,border:"1px solid "+K.bd,borderRadius:4,padding:"3px 6px",color:K.tx,fontSize:10,outline:"none"}}),
    h("button",{onClick:function(){setStopRules(function(p){return p.filter(function(_,j){return j!==i})})},style:{background:"transparent",border:"none",color:K.r,cursor:"pointer",fontSize:14,lineHeight:1,padding:"0 4px"}},"\u00D7"))})),
  h("div",{style:{display:"flex",gap:4,marginTop:4}},
    h("button",{onClick:function(){setStopRules(function(p){return p.concat([{k:"custom_"+Date.now(),l:"New Rule"}])})},style:{flex:1,padding:"4px",background:"transparent",border:"1px solid "+K.g,borderRadius:5,color:K.g,fontSize:9,cursor:"pointer"}},"+ Add"),
    h("button",{onClick:function(){if(window.confirm("Reset to defaults?")){setStopRules(DEFAULT_STOP_RULES)}},style:{padding:"4px 8px",background:"transparent",border:"1px solid "+K.bd,borderRadius:5,color:K.dm,fontSize:9,cursor:"pointer"}},"Reset"))):null,
h("div",{style:{height:8}})),
h("div",{className:"tj-main"+(sbCollapsed?" main-mini":"")},
h("input",{ref:ir,type:"file",accept:".json",onChange:impJ,style:{display:"none"}}),
h("input",{ref:cr,type:"file",accept:".csv",onChange:impCSV,style:{display:"none"}}),
h("input",{ref:dcRef,type:"file",accept:"image/*",onChange:function(e){
  var file=e.target.files&&e.target.files[0];
  if(!file||!dcDateRef.current)return;
  var reader=new FileReader();
  reader.onload=function(ev){setDayChart(dcDateRef.current,ev.target.result);};
  reader.readAsDataURL(file);
  e.target.value="";
},style:{display:"none"}}),
multiSelIds.size>0?h("div",{style:{position:"fixed",bottom:32,left:"50%",transform:"translateX(-50%)",background:K.cd,border:"1px solid "+K.bd,borderRadius:12,padding:"10px 16px",display:"flex",alignItems:"center",gap:10,zIndex:8500,boxShadow:K.sdw}},
  h("span",{style:{fontSize:11,color:K.dm}},multiSelIds.size+" selected"),
  h("button",{onClick:bulkExclude,style:{padding:"5px 12px",borderRadius:6,border:"1px solid "+K.bd,background:"transparent",color:K.dm,fontSize:11,cursor:"pointer",fontWeight:600}},"Exclude"),
  h("button",{onClick:bulkDelete,style:{padding:"5px 12px",borderRadius:6,border:"1px solid "+K.r,background:K.r+"22",color:K.r,fontSize:11,cursor:"pointer",fontWeight:600}},"Delete"),
  h("button",{onClick:clearMultiSel,style:{padding:"5px 12px",borderRadius:6,border:"1px solid "+K.bd,background:"transparent",color:K.dm,fontSize:11,cursor:"pointer"}},"Cancel")):null,
h("div",{className:"tj-page"},
vw==="log"?rL():null,
vw==="dashboard"?h(DashboardTab,null):null,
vw==="insights"?h(InsightsTab,null):null,
vw==="daily"?h(DailyLogTab,null):null,
vw==="rules"?rR():null,
vw==="equity"?rEq():null,
vw==="heatmap"?h(HeatmapTab,null):null,
vw==="strategies"?rStrats():null,
vw==="education"?h(EduTab,null):null,
vw==="news"?h(NewsTab,null):null,
vw==="beginner"?h(BeginnerTab,null):null,
vw==="aiimport"?h(AIImportTab,null):null,
vw==="session_stop"?h(SessionStopTab,null):null)))}
// Root always visible now
ReactDOM.createRoot(document.getElementById("root")).render(h(App));
}catch(err){var re=document.getElementById("root");re.style.display='block';re.innerHTML='<div style="color:#ff4757;padding:20px;font-family:monospace;white-space:pre-wrap">ERROR: '+err.message+'\n\n'+err.stack+'</div>';}
</script>
</body></html>
